---
phase: 16.4-metadata-invariant-retrievability-audit
plan: 03
subsystem: search, audit
tags: [gemini-file-search, retrievability, query-strategy, hit-rate, audit]

requires:
  - phase: 16.4-02
    provides: "All 1,748 non-skipped files have file_primary_topics; 40 Episodes batch-extracted and re-uploaded with identity headers"
provides:
  - "Exhaustive retrievability audit of all 1,749 indexed files x 3 query strategies"
  - "Per-series hit rate tables with minimum viable strategy recommendation"
  - "12 structural failures documented with affirmative evidence"
  - "A7 configuration recommendation: max_misses=2, no exclusions, stem-only query"
affects: [16.4-04, check_stability.py]

tech-stack:
  added: []
  patterns:
    - "Async resumable audit pattern with JSON progress file keyed by {file_path}_{strategy}"
    - "Three-strategy retrievability testing: stem-only, stem+aspects, topics+course"
    - "S1 OR S2 fallback chain for maximum coverage (99.3%)"

key-files:
  created:
    - scripts/retrievability_audit.py
    - .planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-results.json
    - .planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-hit-rates.md
  modified: []

key-decisions:
  - "Strategy 2 (stem+aspects) is the single best strategy at 97.5%, but S1 OR S2 fallback achieves 99.3%"
  - "Strategy 3 (topics+course without stem) is not viable at 22.8% -- filename stem is essential"
  - "12 structural failures are caused by semantic homogeneity within series, not metadata gaps"
  - "max_misses=0 is NOT achievable -- 0.69% structural failure rate is fundamental to semantic search"
  - "A7 recommendation: max_misses=2 with no exclusions, stem-only query for simplicity"

patterns-established:
  - "Async audit with semaphore-controlled concurrency and per-batch progress saves"
  - "Fallback chain pattern: try simple query first, enrich only on miss"

duration: 80min
completed: 2026-02-25
---

# Phase 16.4 Plan 03: Comprehensive Retrievability Audit Summary

**Exhaustive audit of 1,749 files x 3 query strategies: S1 (stem-only) 96.7%, S2 (stem+aspects) 97.5%, S1->S2 fallback 99.3%, 12 structural failures documented with affirmative evidence**

## Performance

- **Duration:** 80 min (script creation ~10 min, S1 run ~20 min, S2 run ~23 min, S3 run ~24 min, analysis ~3 min)
- **Started:** 2026-02-25T19:46:11Z
- **Completed:** 2026-02-25T21:06:36Z
- **Tasks:** 2
- **Files created:** 3

## Accomplishments

- Built `scripts/retrievability_audit.py` with async concurrency, exponential backoff, and JSON-based resumability
- Tested all 1,749 indexed files across 3 query strategies (5,247 total API calls, 0 errors)
- Identified Strategy 2 (stem + aspects) as best single strategy at 97.5%, with S1->S2 fallback achieving 99.3%
- Documented 12 files that fail all 3 strategies with specific failure evidence (semantic homogeneity within series)
- Produced per-series hit rate breakdown across 9 series, revealing Office Hour files as the primary S1 weakness category
- Proved zero-tolerance (max_misses=0) is NOT achievable with affirmative evidence -- recommended max_misses=2

## Task Commits

Each task was committed atomically:

1. **Task 1: Build retrievability audit script** - `4463a2d` (feat)
2. **Task 2: Run all 3 strategies and produce hit rate analysis** - `ec12ad4` (docs)

## Files Created/Modified

- `scripts/retrievability_audit.py` - Standalone async audit script: 3 strategies, resumable JSON progress, Rich summary tables
- `.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-results.json` - Raw results (5,247 entries, ~89K lines)
- `.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-hit-rates.md` - Per-series hit rate tables, strategy analysis, A7 recommendation

## Decisions Made

1. **Keyring username is `api_key` (underscore), not `api-key` (hyphen)** -- plan had incorrect credential name; fixed per Rule 1 (bug).
2. **Strategy 3 provides zero incremental value** -- S1 OR S2 OR S3 = 99.3%, same as S1 OR S2. The 12 structural failures cannot be resolved by any query formulation tested.
3. **S1->S2 fallback is the recommended A7 strategy** -- S1 alone is 96.7% and simpler; S2 recovers 46 additional files (mostly Office Hour). Combined: 99.3%.
4. **max_misses=2 recommended for A7** -- with sample_size=20, P(2+ structural misses) = 0.9%, providing sufficient margin to catch real degradation while avoiding false UNSTABLE verdicts.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed keyring credential username**
- **Found during:** Task 1 (script creation)
- **Issue:** Plan specified `keyring.get_password("objlib-gemini", "api-key")` (hyphen) but all other scripts and the actual keyring entry use `api_key` (underscore)
- **Fix:** Changed to `keyring.get_password("objlib-gemini", "api_key")`
- **Files modified:** scripts/retrievability_audit.py
- **Verification:** Script successfully retrieves API key and makes API calls
- **Committed in:** 4463a2d (Task 1 commit)

**2. [Rule 1 - Bug] Fixed series detection for ITOE Advanced Topics directory**
- **Found during:** Task 1 (script creation)
- **Issue:** Plan specified `/ITOE Addenda/` in series detection but actual file paths use `/ITOE Advanced Topics/`
- **Fix:** Used `/ITOE Advanced Topics/` in detect_series() function
- **Files modified:** scripts/retrievability_audit.py
- **Verification:** Series breakdown matches 16.4-02 audit output (9 series with correct counts)
- **Committed in:** 4463a2d (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes essential for correct operation. No scope creep.

## Issues Encountered

None -- all 5,247 API calls completed with 0 errors. Strategy runs completed in 20-24 minutes each at concurrency 10.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Plan 16.4-04 (A7 Update + Zero-Tolerance Validation) is fully unblocked:
- Empirical data available: 99.3% achievable with S1->S2 fallback, 12 structural failures documented
- A7 recommendation clear: max_misses=2 with no exclusion filters, stem-only query
- Raw results JSON available for any follow-up analysis
- The 12 structural failures are affirmatively documented with specific files, queries, and returned IDs

**Key input for 16.4-04:** Whether to implement the S1->S2 fallback in A7 (raising hit rate from 96.7% to 99.3%) or keep the simpler S1-only with max_misses=2. The simpler approach is recommended unless the team requires stricter tolerance.

## Self-Check: PASSED

- All 3 created files verified to exist on disk
- Both task commits (4463a2d, ec12ad4) verified in git log
- Results JSON validated: 5,247 entries across 3 strategies

---
*Phase: 16.4-metadata-invariant-retrievability-audit*
*Completed: 2026-02-25*
