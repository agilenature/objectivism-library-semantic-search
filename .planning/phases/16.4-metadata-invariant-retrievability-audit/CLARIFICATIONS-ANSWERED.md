# CLARIFICATIONS-ANSWERED.md

## Phase 16.4: Metadata Pipeline Invariant + Comprehensive Retrievability Audit

**Generated:** 2026-02-25
**Mode:** YOLO (balanced strategy — synthesis recommendations selected)
**Source:** Auto-generated by discuss-phase-ai --yolo

---

## Decision Summary

**Total questions:** 7
**Tier 1 (Blocking):** 2 answered
**Tier 2 (Important):** 3 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

### Q1: Corpus Count — 1,749 or 1,809?

**YOLO DECISION:** **Option A — confirm via DB query in Plan 16.4-01**

**Rationale:**
- Confidence level: ✅ Consensus
- The 1,809 figure most likely reflects scanner-approved non-book files that will be discovered by the routing audit and re-extracted. The difference (~60) matches the ITOE OH cohort size, and ITOE OH was flagged as having bypassed AI extraction.
- Plan 16.4-01 must begin with a DB diagnostic query before any code changes:
  ```sql
  -- Expected result: ~60 (the non-compliant files)
  SELECT COUNT(*) FROM files
  WHERE ai_metadata_status = 'approved'
    AND (primary_topics IS NULL OR json_array_length(primary_topics) < 8)
    AND file_size_bytes < {BOOK_SIZE_BYTES};
  ```
- The exact count from this query becomes the authoritative delta. Plans 16.4-02 and 16.4-03 must be updated with the confirmed final corpus count.
- Strategy: Confirm-first, then proceed. Do not assume 1,809 — let the DB prove it.

---

### Q2: Is max_misses=0 Achievable for Episode Files?

**YOLO DECISION:** **Let Plan 16.4-03 data decide — do not pre-exclude or pre-conclude**

**Rationale:**
- Confidence level: ⚠️ Recommended (synthesis)
- The ROADMAP explicitly says SC4 allows "documenting residual failures with affirmative evidence" if no strategy achieves 100%. This is not a failure of the phase — it is an acceptable outcome.
- Plan 16.4-03 should attempt all 3 query strategies for Episodes without exclusion. If Episodes cannot achieve top-5 retrieval under any strategy, SC4 requires documenting:
  (a) what discriminating factor would be needed
  (b) why identity headers are insufficient for this series
- SC5 (A7 update) should then use the best-performing strategy even if it doesn't achieve 100% for Episodes — and if Episodes structurally fail, Plan 16.4-04 must make an explicit decision: is "zero exclusions" achievable, or does it require concluding that Episodes require a different retrieval approach (a v3 scope item)?
- Do NOT raise tolerance or add exclusion filters in Plan 16.4-04 without explicit user decision after seeing the audit data.

---

## Tier 2: Important Decisions

### Q3: Book-Size Threshold Value and Units

**YOLO DECISION:** **Empirically derived — largest successfully-extracted file × 1.5**

**Rationale:**
- Confidence level: ⚠️ Recommended
- Plan 16.4-01 runs this before setting the constant:
  ```bash
  # Find largest .txt file that has primary_topics (successfully extracted)
  python -c "
  import sqlite3, json
  conn = sqlite3.connect('data/library.db')
  row = conn.execute('''
    SELECT f.path, f.file_size_bytes
    FROM files f
    JOIN file_primary_topics fpt ON f.id = fpt.file_id
    WHERE f.file_type = '.txt'
    ORDER BY f.file_size_bytes DESC LIMIT 1
  ''').fetchone()
  print(row)
  "
  ```
- Set `BOOK_SIZE_BYTES` in `src/objlib/constants.py` to `largest_extracted_bytes * 1.5`
- Comment must document: "Derived from largest successfully-extracted file as of Phase 16.4. Mistral batch model: {model_name}."
- All current `ai_metadata_status='skipped'` files must exceed this threshold; all `approved` or `pending` non-book files must be below it. The routing audit confirms this.

---

### Q4: Retrievability Audit — Query Strategy Templates

**YOLO DECISION:** **Three strategies with top-5 threshold as proposed**

**Rationale:**
- Confidence level: ⚠️ Recommended (synthesis)

**Strategy 1 (Stem-only):**
```python
query = stem  # e.g., "Objectivist Logic Class 09-02"
```

**Strategy 2 (Stem + top-3 aspects):**
```python
aspects = topic_aspects[:3] if topic_aspects else []
query = f"{stem} {' '.join(aspects)}"
```
- Falls back to stem-only if `topic_aspects` is NULL/empty

**Strategy 3 (Course + top-3 topics):**
```python
topics = primary_topics[:3] if primary_topics else []
query = f"{course_name} {' '.join(topics)}"
```
- Falls back to topics-only if `course_name` is NULL

**Hit threshold:** File counts as "found" if its `gemini_store_doc_id` prefix appears in **any of the top-5 results** returned by the Gemini File Search API for that query.

**Audit output format:** Per-file-per-strategy JSON with: `{file_id, strategy, query, found, rank, top5_ids, timestamp}`. Per-series hit rate table (rows = series, columns = strategy). Grand total hit rate table.

---

### Q5: Routing Enforcement — Pre-Upload Check or FSM Guard?

**YOLO DECISION:** **Option A — two-layer check without FSM modification**

**Rationale:**
- Confidence level: ⚠️ Recommended
- Layer 1: Fix `_get_pending_files()` in `batch_orchestrator.py` to include all file types (.txt, .md) and to query `primary_topics IS NULL OR json_array_length(primary_topics) < 8` (not just by extension or ai_metadata_status alone).
- Layer 2: Add a pre-upload invariant check in `get_fsm_pending_files()` (or equivalent upload gate function) that raises if a non-book file lacks `primary_topics`. This prevents a scan-approved non-book file from slipping through to upload.
- No FSM modification — consistent with Phase 12/13 decisions locking down the state machine.

---

## Tier 3: Polish Decisions

### Q6: Retrievability Audit Script — Resumability Mechanism

**YOLO DECISION:** **JSON progress file, keyed by `{file_id}_{strategy_num}`**

Progress saved to: `.planning/phases/16.4-metadata-invariant-retrievability-audit/audit-progress.json`
Format:
```json
{
  "metadata": {"started_at": "...", "total_files": 1809, "strategies": 3},
  "results": {
    "file_id_123_1": {"found": true, "rank": 2, "query": "...", "top5": [...], "ts": "..."},
    "file_id_123_2": {"found": false, "rank": null, "query": "...", "top5": [...], "ts": "..."}
  }
}
```
Script skips entries already present in results dict on resume.

---

### Q7: A7 Consecutive STABLE Runs — Time Gap

**YOLO DECISION:** **At least 1 hour between runs, fresh session required for each**

Consistent with Phase 16.3 gate protocol. Both runs must be in separate Claude Code sessions (/clear between them). Results logged to STATE.md temporal stability table.

---

## Plan-Level Implications

| Decision | Affects | Action |
|----------|---------|--------|
| Q1: Corpus count confirmed by DB query | Plan 16.4-01 first task | Run diagnostic before any code changes |
| Q3: Threshold empirically derived | Plan 16.4-01 | Run file size query, set constant, grep verify |
| Q4: 3 query templates defined | Plan 16.4-03 | Implement retrievability_audit.py with these templates |
| Q2: Episode achievability empirical | Plan 16.4-03/04 | Audit → data → explicit decision in Plan 16.4-04 |
| Q5: Two-layer routing enforcement | Plan 16.4-01 | Fix `_get_pending_files()` + add upload gate check |
| Q6: Resumable audit | Plan 16.4-03 | JSON progress file from the start |
| Q7: 1-hour gap, fresh sessions | Plan 16.4-04 | Per Phase 12 temporal stability protocol |

---

## Next Steps

1. ✅ Clarifications answered (YOLO mode)
2. ⏭ Proceed to `/gsd:plan-phase 16.4` to create Plan 16.4-01

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Generated: 2026-02-25*
