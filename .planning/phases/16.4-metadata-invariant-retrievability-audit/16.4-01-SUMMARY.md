---
phase: 16.4-metadata-invariant-retrievability-audit
plan: 01
subsystem: extraction
tags: [constants, batch-orchestrator, routing, metadata-invariant, sqlite]

# Dependency graph
requires:
  - phase: 16.3-gemini-file-search-retrievability-research
    provides: "All 1,749 files re-uploaded with identity headers; ITOE OH batch-extracted"
provides:
  - "BOOK_SIZE_BYTES named constant in src/objlib/constants.py"
  - "Book routing in batch_orchestrator.py (byte check before read_text)"
  - "41 pending files ready for re-extraction (40 Episodes + 1 Book)"
  - "60 OH files approved (needs_review cleared)"
  - "0 failed_validation, 0 needs_review in corpus"
  - "Full grep audit of ai_metadata_status (77 refs, 0 violations)"
affects: [16.4-02, 16.4-03, 16.4-04]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Named constants for routing thresholds in constants.py"]

key-files:
  created:
    - src/objlib/constants.py
  modified:
    - src/objlib/extraction/batch_orchestrator.py

key-decisions:
  - "BOOK_SIZE_BYTES = 830,000 (1.5x the 552KB boundary file)"
  - "Byte check placed BEFORE read_text -- book files never loaded into memory"
  - "Two-tier skip: BOOK_SIZE_BYTES (structural routing) + MAX_DOCUMENT_TOKENS (Mistral limit)"
  - "Layer 2 upload gate verified sound at state.py:714-717, no change needed"
  - "No grep audit violations found in 77 ai_metadata_status references across 7 files"

patterns-established:
  - "Named constant pattern: routing thresholds live in src/objlib/constants.py"
  - "Byte check before content read: structural routing avoids loading files into memory"

# Metrics
duration: 3min
completed: 2026-02-25
---

# Phase 16.4 Plan 01: Routing Invariant Audit Summary

**BOOK_SIZE_BYTES=830,000 constant defined, batch_orchestrator routing fixed, 41 files reset to pending, 60 OH approved, full grep audit clean**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-25T19:12:49Z
- **Completed:** 2026-02-25T19:16:08Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Defined BOOK_SIZE_BYTES = 830,000 in src/objlib/constants.py with empirical derivation
- Added book routing check BEFORE read_text in batch_orchestrator.py (books never loaded into memory)
- Reset 40 failed_validation Episode files + 1 skipped Book to pending for re-extraction
- Approved 60 needs_review OH files (all had file_primary_topics confirmed)
- Verified Layer 2 upload gate (get_fsm_pending_files) requires approved + EXISTS file_primary_topics
- Full grep audit of 77 ai_metadata_status references across 7 source files: 0 violations

## Diagnostic Baseline (recorded before any changes)

| Query | Description | Result |
|-------|-------------|--------|
| Q1 | Indexed file count | 1,749 |
| Q2 | failed_validation count | 40 (all Episodes) |
| Q3 | Skipped .txt below threshold | 1 (Philosophy - Who Needs It, 552,798 bytes) |
| Q4 | needs_review indexed count | 60 (ITOE OH files) |
| Q5 | Approved without file_primary_topics | 0 |
| Q6 | All skipped .txt with sizes | 1 (same as Q3) |

## Post-Reset DB State

| Status | Count |
|--------|-------|
| approved | 1,708 |
| pending | 41 |
| failed_validation | 0 |
| needs_review | 0 |

## Task Commits

Each task was committed atomically:

1. **Task 1: Diagnostic DB queries + define BOOK_SIZE_BYTES constant** - `d4fad1a` (feat)
2. **Task 2: Fix routing code + reset DB state + grep audit** - `6158dbb` (feat)

## Files Created/Modified
- `src/objlib/constants.py` - New file: BOOK_SIZE_BYTES = 830,000 named constant with empirical derivation
- `src/objlib/extraction/batch_orchestrator.py` - Added BOOK_SIZE_BYTES import, _mark_book() helper, byte-size check before read_text in extraction loop

## Grep Audit Findings (per file)

| File | Refs | Findings |
|------|------|----------|
| src/objlib/constants.py | 1 | Comment documenting BOOK_SIZE_BYTES. No violation. |
| src/objlib/database.py | 20 | Schema definitions, migration SQL, helper functions. No hardcoded categories. No inline thresholds. No violation. |
| src/objlib/extraction/batch_orchestrator.py | 5 | _get_pending_files, _save_extracted_metadata, _mark_failed, _mark_oversized, _mark_book. BOOK_SIZE_BYTES is sole byte threshold. No violation. |
| src/objlib/extraction/orchestrator.py | 2 | Synchronous extraction path. No category routing. No violation. |
| src/objlib/upload/state.py | 4 | Pre-FSM upload gate + FSM upload gate. Layer 2 verified at lines 714-717 (requires approved + EXISTS file_primary_topics). No violation. |
| src/objlib/extraction/review.py | 5 | Display + interactive review. User-driven only. No violation. |
| src/objlib/cli.py | 30+ | CLI commands, audit conditions, format classification. No hardcoded category routing. No inline byte thresholds. No violation. |

**Total references audited:** 77
**Violations found:** 0

## Decisions Made
- BOOK_SIZE_BYTES = 830,000 bytes (1.5x the 552KB boundary file, rounded to 830,000) -- per locked decision #3 from plan
- Byte check placed BEFORE read_text to avoid loading large book files into memory
- Existing MAX_DOCUMENT_TOKENS check kept as separate concern (Mistral context window limit)
- Layer 2 upload gate (state.py:714-717) verified sound, no modification needed
- All 60 needs_review files confirmed to have file_primary_topics before approving

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- 41 files pending re-extraction (40 Episodes + 1 Book below threshold)
- Ready for Plan 16.4-02: batch-extract these 41 files, re-upload with identity headers, extend audit command with per-series breakdown
- BOOK_SIZE_BYTES constant available for any future routing code
- All invariant checks pass: 0 failed_validation, 0 needs_review, Layer 2 gate sound

---
*Phase: 16.4-metadata-invariant-retrievability-audit*
*Completed: 2026-02-25*
