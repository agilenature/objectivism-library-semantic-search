---
phase: 16.4-metadata-invariant-retrievability-audit
plan: 02
subsystem: metadata, search
tags: [mistral-batch, gemini-file-search, metadata-audit, identity-headers, batch-extract]

requires:
  - phase: 16.4-01
    provides: "BOOK_SIZE_BYTES constant, routing fix, 41 files reset to pending, 60 OH approved"
provides:
  - "All 1,749 indexed files have file_primary_topics (except 1 skipped Book)"
  - "Per-series breakdown in metadata audit command"
  - "Condition 6 structural invariant enforcement"
  - "40 Episode files re-uploaded with updated identity headers"
  - "scripts/re_upload_phase164.py for targeted re-upload"
affects: [16.4-03, 16.4-04, 16-02]

tech-stack:
  added: []
  patterns:
    - "Per-series SQL CASE for corpus breakdown"
    - "Batch-extract retry pattern for Mistral JSON format failures"

key-files:
  created:
    - scripts/re_upload_phase164.py
    - .planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-02-audit-output.txt
  modified:
    - src/objlib/cli.py
    - data/library.db

key-decisions:
  - "Book file (Philosophy Who Needs It, 552KB) skipped by _mark_oversized (~115K tokens > 100K MAX_DOCUMENT_TOKENS) -- below BOOK_SIZE_BYTES threshold but exceeds Mistral context window"
  - "Only 40 Episode files re-uploaded (not 41): skipped Book has no new primary_topics to inject into Tags"
  - "ITOE Advanced Topics path pattern corrected from plan's ITOE Addenda"
  - "5 Mistral failures retried successfully (non-deterministic JSON format issues)"

patterns-established:
  - "Per-series audit breakdown: CASE-based series classification for corpus analysis"
  - "Condition 6 structural invariant: all indexed non-skipped files MUST have file_primary_topics"

duration: 20min
completed: 2026-02-25
---

# Phase 16.4 Plan 02: Structural Metadata Quality Audit Summary

**Batch-extract 40 Episode files + 1 Book, re-upload with identity headers, metadata audit exits 0 with per-series breakdown for all 1,749 indexed files**

## Performance

- **Duration:** 20 min
- **Started:** 2026-02-25T19:20:28Z
- **Completed:** 2026-02-25T19:40:42Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Batch-extracted 40 Episode files with 8 primary_topics each (Mistral Batch API, 2 rounds)
- 1 Book file correctly skipped (~115K tokens exceeds Mistral context window)
- All 40 needs_review files approved, 60 OH files already approved from prior session
- 40 Episode files re-uploaded with updated identity headers (Tags field reflects new primary_topics)
- Store-sync cleaned 15 orphans, final state: DB=1749, Store=1749, Orphans=0
- Metadata audit extended with Condition 6 (structural invariant) and per-series breakdown table
- All 6 audit conditions PASS, exit code 0
- Per-series breakdown: 9 series, all non-Book series at 100% topics coverage

## Task Commits

Each task was committed atomically:

1. **Task 1: Batch-extract 41 pending files** - `8001e8b` (feat)
2. **Task 2: Approve + re-upload + store-sync + audit extension** - `6c00b9d` (feat)

## Files Created/Modified
- `src/objlib/cli.py` - Added Condition 6 (indexed non-skipped without topics), per-series breakdown table, fixed ITOE Advanced Topics path
- `scripts/re_upload_phase164.py` - Targeted re-upload script for 40 Phase 16.4 Episode files
- `data/library.db` - 40 Episodes extracted + approved, 1 Book skipped, 40 files re-uploaded with new gemini_file_id/gemini_store_doc_id
- `.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-02-audit-output.txt` - Captured audit output showing exit 0

## Decisions Made
- Book file (552KB) was NOT caught by BOOK_SIZE_BYTES (830KB) but WAS caught by MAX_DOCUMENT_TOKENS (100K). This is correct behavior -- the two-tier skip system works as designed.
- Only 40 Episode files re-uploaded (not 41 as plan anticipated) because the Book file was skipped with no new primary_topics.
- Fixed ITOE path pattern: actual directory is "ITOE Advanced Topics", not "ITOE Addenda" as specified in plan.
- 5 Mistral batch failures (JSON array instead of object, missing confidence_score) retried successfully on second pass -- non-deterministic Mistral response format issues.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed ITOE Advanced Topics path pattern**
- **Found during:** Task 2 (Per-Series Breakdown)
- **Issue:** Plan specified `ITOE Addenda` but actual directory name is `ITOE Advanced Topics`
- **Fix:** Changed CASE expression from `LIKE '%/ITOE Addenda/%'` to `LIKE '%/ITOE Advanced Topics/%'`
- **Files modified:** src/objlib/cli.py
- **Verification:** Per-series breakdown now shows ITOE AT (30) and ITOE AT OH (28) correctly
- **Committed in:** 6c00b9d (Task 2 commit)

**2. [Rule 1 - Bug] Retried 5 Mistral batch-extract failures**
- **Found during:** Task 1 (Batch-extract)
- **Issue:** 5 Episode files failed with Mistral JSON format issues (array instead of object, missing confidence_score)
- **Fix:** Reset to pending and re-ran batch-extract; all 5 succeeded on retry
- **Files modified:** data/library.db
- **Verification:** All 40 Episode files have 8 primary_topics each
- **Committed in:** 8001e8b (Task 1 commit)

**3. [Rule 3 - Blocking] file_metadata_ai has created_at not updated_at**
- **Found during:** Task 2 (re-upload script)
- **Issue:** Plan referenced `fma.updated_at` but schema uses `created_at`
- **Fix:** Used `created_at` + `prompt_version='batch-v1'` to identify Phase 16.4 files
- **Files modified:** scripts/re_upload_phase164.py
- **Verification:** Dry run correctly identified 40 Episode files
- **Committed in:** 6c00b9d (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (2 bugs, 1 blocking)
**Impact on plan:** All auto-fixes necessary for correctness. No scope creep.

## Issues Encountered
- Store-sync found 15 orphans after re-upload (expected: old store docs replaced by upload-first sequence but delete_old_store_doc runs after import, creating brief overlap). All cleaned.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 1,749 indexed files have file_primary_topics (precondition for Plan 16.4-03 retrievability audit)
- Per-series breakdown available for targeted query strategy analysis
- Condition 6 structural invariant enforced -- no future indexed file can slip through without topics
- Ready for Plan 16.4-03: comprehensive retrievability audit across all 1,749 files

## Per-Series Final State

| Series | Total | Topics | Coverage |
|--------|-------|--------|----------|
| Books | 27 | 26 | 96% (1 skipped) |
| Episodes | 333 | 333 | 100% |
| ITOE | 32 | 32 | 100% |
| ITOE AT | 30 | 30 | 100% |
| ITOE AT OH | 28 | 28 | 100% |
| ITOE OH | 16 | 16 | 100% |
| MOTM | 468 | 468 | 100% |
| OL | 50 | 50 | 100% |
| Other | 765 | 765 | 100% |
| **Total** | **1749** | **1748** | **99.9%** |

## Self-Check: PASSED

All files verified present:
- src/objlib/cli.py (Per-Series Breakdown, Condition 6)
- scripts/re_upload_phase164.py (targeted re-upload script)
- .planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-02-audit-output.txt (audit artifact)
- .planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-02-SUMMARY.md (this file)

All commits verified:
- 8001e8b (Task 1: batch-extract)
- 6c00b9d (Task 2: approve + re-upload + audit extension)

---
*Phase: 16.4-metadata-invariant-retrievability-audit*
*Completed: 2026-02-25*
