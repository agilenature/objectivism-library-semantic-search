# Phase 16.4 Plan 03: Retrievability Audit Hit Rate Analysis

**Audit date:** 2026-02-25
**Store:** objectivism-library (fileSearchStores/objectivismlibrary-9xl9top0qu6u)
**Files tested:** 1,749 (all indexed, no exclusions)
**Top-K threshold:** 5 (file must appear in top 5 grounding chunks)
**Total API calls:** 5,247 (1,749 x 3 strategies)
**Total errors:** 0

---

## Section 1: Global Hit Rates

| Strategy | Description | Total Files | Hits | Misses | Hit Rate |
|----------|-------------|-------------|------|--------|----------|
| 1 (Stem-only) | `"What is '{stem}' about?"` | 1749 | 1691 | 58 | 96.7% |
| 2 (Stem+aspects) | stem query + top-3 topic_aspects | 1749 | 1706 | 43 | 97.5% |
| 3 (Topics+course) | course dir + top-3 primary_topics | 1749 | 399 | 1350 | 22.8% |

**Strategy 3 is not viable.** Removing the filename stem and using only course+topics loses all file-specific discrimination. The course directory name + 3 topic tags match hundreds of files equally.

**Strategy 2 is the single best strategy** at 97.5%, improving on Strategy 1 (96.7%) by recovering 46 files (primarily Office Hour files where aspect enrichment provides discriminating content).

---

## Section 2: Per-Series Breakdown

| Series | Total | S1 Hits | S1% | S2 Hits | S2% | S3 Hits | S3% |
|--------|-------|---------|-----|---------|-----|---------|-----|
| Books | 27 | 25 | 92.6% | 23 | 85.2% | 7 | 25.9% |
| Episodes | 333 | 333 | 100.0% | 332 | 99.7% | 36 | 10.8% |
| ITOE | 32 | 27 | 84.4% | 27 | 84.4% | 7 | 21.9% |
| ITOE AT | 30 | 25 | 83.3% | 21 | 70.0% | 6 | 20.0% |
| ITOE AT OH | 28 | 8 | 28.6% | 24 | 85.7% | 1 | 3.6% |
| ITOE OH | 16 | 7 | 43.8% | 15 | 93.8% | 3 | 18.8% |
| MOTM | 468 | 467 | 99.8% | 467 | 99.8% | 65 | 13.9% |
| OL | 50 | 40 | 80.0% | 44 | 88.0% | 8 | 16.0% |
| Other | 765 | 759 | 99.2% | 753 | 98.4% | 266 | 34.8% |
| **TOTAL** | **1749** | **1691** | **96.7%** | **1706** | **97.5%** | **399** | **22.8%** |

**Key per-series observations:**

1. **Episodes (333 files): 100% on S1, 99.7% on S2.** Unique numeric IDs in filenames provide perfect discrimination. The identity header Title field makes these trivially retrievable.

2. **ITOE AT OH (28 files): 28.6% on S1, 85.7% on S2.** Most dramatic improvement from aspect enrichment. Office Hour files have generic stems like "ITOE Advanced Topics - Class XX-YY - Office Hour" -- multiple files share nearly identical stems. S2's aspect enrichment provides the differentiating signal.

3. **ITOE OH (16 files): 43.8% on S1, 93.8% on S2.** Same pattern as ITOE AT OH -- Office Hour files benefit most from aspect enrichment.

4. **ITOE AT (30 files): 83.3% on S1, 70.0% on S2.** S2 is WORSE here. The aspect text apparently confuses the search for non-Office-Hour class files where the stem alone was more discriminating.

5. **OL (50 files): 80.0% on S1, 88.0% on S2.** Moderate improvement from aspects.

6. **MOTM (468 files): 99.8% on both S1 and S2.** Nearly perfect -- MOTM filenames are highly unique (date + topic slug).

7. **Other (765 files): 99.2% on S1, 98.4% on S2.** Slight regression on S2 -- some generic aspects dilute the stem signal.

---

## Section 3: Minimum Viable Strategy Recommendation

### Single Strategy

No single strategy achieves 100% hit rate:
- Strategy 2 is best at **97.5%** (43 misses)
- Strategy 1 is second at **96.7%** (58 misses)
- Strategy 3 is not viable at **22.8%** (1350 misses)

### Fallback Chain Analysis

| Combination | Hits | Hit Rate | Residual Misses |
|-------------|------|----------|-----------------|
| S1 OR S2 (try S1, fallback S2) | 1737 | **99.3%** | 12 |
| S1 OR S3 | 1698 | 97.1% | 51 |
| S2 OR S3 | 1709 | 97.7% | 40 |
| S1 OR S2 OR S3 | 1737 | **99.3%** | 12 |

**The S1-then-S2 fallback chain achieves 99.3%.** Adding S3 provides zero additional recovery (the same 12 files fail all 3 strategies). Therefore S3 adds no value in any combination.

### Recovery Pattern

- **S2 recovers 46 files that S1 misses** (primarily Office Hour files across ITOE AT OH, ITOE OH series)
- **S1 recovers 31 files that S2 misses** (ITOE AT non-OH files, some Books, some Other)
- The two strategies are **complementary, not overlapping** -- each recovers a different failure category

### Recommended Strategy for A7

**Primary: Strategy 1 (stem-only)**
**Fallback: Strategy 2 (stem + aspects) on S1 misses only**

Rationale: S1 is simpler, faster (no DB lookup), and achieves 96.7%. The fallback to S2 recovers 46 additional files at the cost of one additional API call per miss. Combined hit rate: 99.3%.

### Rank Distribution

Strategy 1 rank distribution (of 1691 hits):
| Rank | Count | Cumulative |
|------|-------|------------|
| 1 | 1635 (96.7%) | 96.7% |
| 2 | 33 (2.0%) | 98.7% |
| 3 | 7 (0.4%) | 99.1% |
| 4 | 6 (0.4%) | 99.4% |
| 5 | 10 (0.6%) | 100.0% |

96.7% of S1 hits are at rank 1. The identity header (Title = stem) provides strong discrimination.

---

## Section 4: Residual Failure Analysis

**12 files fail ALL 3 strategies.** These are structural failures that cannot be resolved by query strategy alone.

### Failure Category A: Class-number files in heavily overlapping series (10 files)

These are course lecture files where the class number alone does not discriminate the file from other classes in the same course. The identity header contains the stem, but the semantic content of adjacent classes is highly similar.

| # | File | Series | Failure Pattern |
|---|------|--------|-----------------|
| 1 | ITOE - Class 02-01.txt | ITOE | Returns ITOE Classes from wrong sessions |
| 2 | ITOE Advanced Topics - Class 09-02.txt | ITOE AT | Returns other ITOE AT classes |
| 3 | ITOE Advanced Topics - Class 10-02.txt | ITOE AT | Returns other ITOE AT classes |
| 4 | ITOE Advanced Topics - Class 13-02 - Office Hour.txt | ITOE AT OH | Returns other ITOE AT OH files |
| 5 | ITOE Advanced Topics - Class 14-01 - Office Hour.txt | ITOE AT OH | Returns other ITOE AT OH files |
| 6 | ITOE Advanced Topics - Class 14-02 - Office Hour.txt | ITOE AT OH | Returns EMPTY top-5 (S1), returns other ITOE AT OH files (S2/S3) |
| 7 | ITOE - Class 10-01 - Office Hour.txt | ITOE OH | Returns other ITOE/ITOE AT files |
| 8 | Objectivist Logic - Class 03-01.txt | OL | Returns other OL class files |
| 9 | Objectivist Logic - Class 15-02 - Open Office Hour.txt | OL | Returns other OL class files |
| 10 | MOTM_2021-05-16_History-of-the-Objectivist-movement-a-personal-account-part.txt | MOTM | Returns other "History of the Objectivist movement" parts |

**Root cause:** These files are members of series where multiple files share highly similar content (same course, same philosophical topics). The class number is in the identity header Title field, but Gemini's semantic search ranks by content similarity, not exact title match. When 30+ files in the same course all discuss epistemology/concept_formation, the specific class number is insufficient to discriminate.

**Evidence:** For every failing file, the top-5 returned IDs belong to other files from the SAME course/series. Gemini returns the right series but the wrong class number.

### Failure Category B: Books with common titles (2 files)

| # | File | Series | Failure Pattern |
|---|------|--------|-----------------|
| 11 | Ayn Rand - Atlas Shrugged (1971).txt | Books | Returns other Ayn Rand book files (Fountainhead, etc.) |
| 12 | existence doesn't mean physical existence.txt | Books | Returns epistemology/metaphysics files from various series |

**Root cause for Atlas Shrugged:** The query "What is 'Ayn Rand - Atlas Shrugged (1971)' about?" returns IDs that correspond to other Ayn Rand works. Atlas Shrugged is a 500K+ word novel -- the store document is very large and the query "about?" is too generic to surface it ahead of more focused analytical texts about the same themes.

**Root cause for "existence doesn't mean physical existence":** This is a very short excerpt file with a descriptive title that matches concepts discussed across many other files (existence, physical existence, consciousness). The title is a philosophical claim shared by many ITOE and epistemology files.

### Summary of Residual Failures

All 12 failures share a common structural cause: **semantic homogeneity within a series or topic cluster**. The target file's content is so similar to neighboring files that no query strategy can reliably distinguish it in top-5. This is a fundamental limitation of semantic search -- not a metadata or header problem.

---

## Section 5: A7 Recommendation

### Recommended Implementation

**Query strategy:** S1 (stem-only) with S2 (stem+aspects) fallback

```python
# Primary query (Strategy 1)
stem = Path(filename).stem
query = f"What is '{stem}' about?"

# If not found in top-5, fallback to Strategy 2
# (retrieve top-3 aspects from file_metadata_ai)
query = f"What is '{stem}' about? Topics: {aspect_str}"
```

**Expected hit rate:** 99.3% (1737/1749) with the fallback chain.

### Zero-Tolerance Assessment

**max_misses=0 is NOT achievable** with any single strategy or combination of strategies tested.

The 12 residual failures (0.7%) are structural: they result from semantic homogeneity within series, not from missing metadata or incorrect query construction. All 12 files:
1. Have correct identity headers (Title, Course, Class, Topic, Tags)
2. Have AI-extracted metadata (topic_aspects, primary_topics)
3. Are correctly indexed in the store (confirmed by other files in the same series being found)
4. Return results from the same series (proving the store is searched correctly)

**The failures are in ranking, not retrieval.** The files are in the store and are being searched, but their semantic similarity to 10-30 neighboring files means the target file does not consistently appear in the top 5.

### Recommended A7 Configuration

```python
max_misses = 2  # 12 structural failures / 1749 files = 0.7%
                # With sample_size=20: expected miss ~0.14 per run
                # Tolerance of 2 provides 14x safety margin

# No exclusion filters. All 1,749 files in scope.
# Use S1 query (stem-only) for simplicity and consistency.
# S2 fallback adds complexity and only matters at exhaustive scale.
```

**Rationale for max_misses=2:**
- 12/1749 structural failures = 0.69% base rate
- With random sampling of 20 files: P(miss) per file = 0.69%
- Expected misses per run = 0.14
- P(2+ misses in 20 samples) = 0.009 (0.9%) -- acceptably rare for false UNSTABLE verdict
- P(3+ misses in 20 samples) = 0.0004 (0.04%) -- very rare
- max_misses=2 avoids false UNSTABLE while catching real degradation (if miss rate jumps to 5%+, P(3+ misses) = 7.5%)

**Alternative: If the team wants stricter tolerance,** implement the S1->S2 fallback chain in A7 itself. This raises the hit rate to 99.3% (12 misses), making max_misses=1 viable at sample_size=20 (P(2+ misses) = 0.004%). However, this doubles the API cost for missed files and adds complexity.

---

*Analysis based on exhaustive audit of all 1,749 indexed files. Data in 16.4-03-results.json.*
