---
phase: 16.4-metadata-invariant-retrievability-audit
plan: 04
type: execute
wave: 4
depends_on: ["16.4-03"]
files_modified:
  - scripts/check_stability.py
autonomous: false

must_haves:
  truths:
    - "A7 query strategy matches the minimum viable strategy confirmed by Plan 16.4-03"
    - "A7 max_misses = 0 with no exclusion filters"
    - "A7 uses top-5 threshold (not top-10)"
    - "check_stability.py exits 0 in two consecutive fresh-session runs"
    - "Two runs separated by at least 1 hour"
    - "Both runs are fresh Claude sessions (no memory of prior run)"
  artifacts:
    - path: "scripts/check_stability.py"
      provides: "Updated A7 with audit-confirmed query strategy and zero tolerance"
      contains: "max_misses = 0"
  key_links:
    - from: "scripts/check_stability.py"
      to: "data/library.db"
      via: "sqlite3 queries for file sampling"
      pattern: "gemini_state.*indexed"
    - from: "scripts/check_stability.py"
      to: "Gemini API"
      via: "generate_content with FileSearch"
      pattern: "generate_content"
---

<objective>
Update check_stability.py A7 to use the audit-confirmed minimum viable query strategy from Plan 16.4-03, set max_misses=0 with zero exclusion filters, and achieve two consecutive fresh-session STABLE runs separated by at least 1 hour.

Purpose: This is the BLOCKING gate for Phase 16-02 (temporal stability protocol). A7 must prove that every sampled file is independently retrievable under the confirmed query strategy -- not by exclusion or tolerance, but by structural correctness.

Output: Updated `scripts/check_stability.py`, two consecutive STABLE runs logged.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-CONTEXT.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-RESEARCH.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-01-SUMMARY.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-02-SUMMARY.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-SUMMARY.md
@.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-03-hit-rates.md
@scripts/check_stability.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update A7 with audit-confirmed query strategy</name>
  <files>scripts/check_stability.py</files>
  <action>
  Update `_check_targeted_searchability()` in `scripts/check_stability.py` (lines ~444-634) based on Plan 16.4-03's findings.

  CHANGES REQUIRED:

  1. **Remove ALL exclusion filters.** The current sampling query (lines ~500-510) must NOT exclude any file category. The query should be exactly:
  ```sql
  SELECT filename, gemini_store_doc_id, gemini_file_id, metadata_json
  FROM files
  WHERE gemini_state = 'indexed'
    AND gemini_store_doc_id IS NOT NULL
  ORDER BY RANDOM()
  LIMIT ?
  ```
  Remove any `AND filename NOT LIKE '%Episode%'` or `AND file_path NOT LIKE '%Office Hour%'` clauses. Remove the Episode/OH exclusion docstring comments.
  Zero exclusions means ALL indexed files are in the sampling pool.

  2. **Set max_misses = 0.** The current code at line ~623 already has `max_misses = 0`. Verify it is not overridden or conditioned on anything. Remove any tolerance variables or `--tolerance` flags.

  3. **Update query construction** to use the minimum viable strategy from Plan 16.4-03's hit-rates.md.

  READ the hit-rates.md file first to determine which strategy won:
  - If Strategy 1 (Stem-only) achieved 100% or best global hit rate: keep current stem-based query `f"{stem} about"` but verify the "about" suffix matches the audit format.
  - If Strategy 2 (Stem+aspects): update query construction to include top-3 topic_aspects from file_metadata_ai.
  - If Strategy 3 (Topics+course): update query construction to use course + top-3 primary_topics.
  - If a multi-strategy fallback approach was recommended: implement try-strategy-1-then-fallback-to-strategy-2 pattern within the loop. Specifically:
    a. Try the primary strategy first
    b. If the target file is NOT found in top-5, try the fallback strategy
    c. Record which strategy succeeded (for verbose logging)
    d. Only count as a miss if ALL strategies fail for the file

  4. **Use top-5 threshold** (not top-10). Change `chunks[:10]` to `chunks[:5]` in the matching loop (line ~589). Per locked decision #4, "found" means appearing in top-5.

  5. **Update docstring** to remove Episode/OH exclusion language. Replace with:
  ```
  Zero exclusions: all 1,749 indexed files are in the sampling pool.
  Query strategy: [name from hit-rates.md] -- confirmed by comprehensive
  retrievability audit (Plan 16.4-03, {date}).
  Threshold: file must appear in top-5 grounding chunks.
  Max misses: 0 (zero tolerance).
  ```

  6. **Also need topic_aspects/primary_topics lookups if strategy 2 or 3 won.** The current A7 only queries DB for metadata_json (scanner metadata). If strategy 2/3 is selected, add queries to file_metadata_ai and/or file_primary_topics within the sampling loop.

  7. **Log query string in verbose mode.** The current verbose logging already prints the query. Ensure it also logs the top-5 returned IDs for debugging:
  ```python
  if self._verbose_mode:
      chunk_ids = [getattr(getattr(c, "retrieved_context", None), "title", "?")
                   for c in (chunks or [])[:5]]
      self._verbose(f"Assertion 7: top-5 IDs for '{filename}': {chunk_ids}")
  ```
  </action>
  <verify>
  1. `grep -n "max_misses" scripts/check_stability.py` shows `max_misses = 0` with no conditions
  2. `grep -n "Episode\|Office Hour\|exclude" scripts/check_stability.py` returns NO exclusion logic (only documentation references are acceptable)
  3. `grep -n "chunks\[:5\]" scripts/check_stability.py` confirms top-5 threshold
  4. If hit-rates.md recommended multi-strategy fallback: run `python scripts/check_stability.py --store objectivism-library --db data/library.db --sample-count 20 --verbose` and manually confirm from verbose output that at least one file exercised the fallback branch (i.e., verbose output shows "strategy 1 miss, trying strategy 2" or similar for at least one file). If no file exercised the fallback in a 20-sample run, re-run with `--sample-count 50` to increase the chance of hitting a fallback-dependent file.
  5. `python scripts/check_stability.py --store objectivism-library --db data/library.db --sample-count 5 --verbose` runs without errors, samples from full pool
  </verify>
  <done>A7 uses audit-confirmed query strategy, max_misses=0, zero exclusion filters, top-5 threshold. If multi-strategy fallback was recommended, fallback branch is implemented and exercised. Code runs without errors on a small sample.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Two consecutive fresh-session STABLE runs (1+ hour apart)</name>
  <what-built>
  Updated check_stability.py A7 with:
  - Zero exclusion filters (all 1,749 files in sampling pool)
  - max_misses = 0 (zero tolerance)
  - Audit-confirmed query strategy from Plan 16.4-03
  - Top-5 matching threshold
  - Multi-strategy fallback (if recommended by hit-rates.md)
  </what-built>
  <how-to-verify>
  **Run 1 (now, in this session):**

  ```bash
  python scripts/check_stability.py \
    --store objectivism-library \
    --db data/library.db \
    --sample-count 20 \
    --verbose
  ```

  Expected: All 7 assertions PASS, exit code 0.
  Record: timestamp, full output, A7 sampled files and results.

  If Run 1 FAILS:
  - Check which assertion failed
  - If A7: which files missed? Cross-reference against Plan 16.4-03 hit-rates.md
  - If the missed file was a known residual failure from the audit, this is expected
  - Decide: adjust strategy, increase sample, or accept with documented limitation

  **Run 2 (at least 1 hour later, FRESH session -- /clear first):**

  Per locked decision #7: at least 1 hour between runs, fresh Claude sessions required.

  ```bash
  # In a NEW Claude session:
  python scripts/check_stability.py \
    --store objectivism-library \
    --db data/library.db \
    --sample-count 20 \
    --verbose
  ```

  Expected: All 7 assertions PASS, exit code 0.
  Record: timestamp, full output, A7 sampled files and results.

  **Both runs must show:**
  - "STABLE" verdict
  - A7: N/N sampled files retrievable (no exclusions)
  - Timestamps separated by >= 1 hour

  After both runs succeed, update STATE.md temporal stability log:
  ```
  Phase 16.4 A7 zero-tolerance validation:
  - Run 1 (YYYY-MM-DD HH:MM:SS UTC): STABLE -- [details]
  - Run 2 (YYYY-MM-DD HH:MM:SS UTC): STABLE -- [details] (1h+ gap from Run 1)
  ```
  </how-to-verify>
  <resume-signal>
  After both STABLE runs complete (1+ hour gap), type "both runs STABLE" with timestamps.
  If Run 1 or Run 2 fails, describe which assertion failed and the specific output.
  </resume-signal>
</task>

</tasks>

<verification>
Phase 16.4-04 is complete when:
1. check_stability.py A7 has zero exclusion filters
2. max_misses = 0 (zero tolerance)
3. Query strategy matches Plan 16.4-03's minimum viable strategy
4. Top-5 matching threshold used
5. Multi-strategy fallback implemented if recommended by hit-rates.md
6. Two consecutive runs both exit 0 (STABLE)
7. Runs separated by >= 1 hour
8. Both runs in fresh sessions
9. STATE.md updated with temporal stability log entries
</verification>

<success_criteria>
- check_stability.py exits 0 in two consecutive fresh-session runs
- A7 uses audit-confirmed query strategy with max_misses=0 and zero exclusions
- Top-5 threshold for "found" determination
- Multi-strategy fallback exercised if applicable
- Runs separated by at least 1 hour
- STATE.md temporal stability log updated
- Phase 16.4 gate PASSED -- Phase 16-02 unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/16.4-metadata-invariant-retrievability-audit/16.4-04-SUMMARY.md`
</output>
