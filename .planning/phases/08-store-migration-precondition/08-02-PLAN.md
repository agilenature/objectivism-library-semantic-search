---
phase: 08-store-migration-precondition
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/migrate_phase8.py
autonomous: false

must_haves:
  truths:
    - "The store 'objectivism-library' exists and has an active resource name"
    - "The store 'objectivism-library-test' no longer exists"
    - "A pre-flight check showed the old store's document count and DB files-losing-state count before the user confirmed"
    - "The migration handles all 4 recovery states if re-run"
  artifacts:
    - path: "scripts/migrate_phase8.py"
      provides: "Store migration steps (pre-flight, create new, delete old) appended to existing schema/state migration"
      contains: "objectivism-library"
  key_links:
    - from: "scripts/migrate_phase8.py"
      to: "Gemini File Search API"
      via: "genai.Client().file_search_stores.create/delete/get/list"
      pattern: "file_search_stores"
    - from: "scripts/migrate_phase8.py"
      to: "data/library.db"
      via: "Records new store resource name in library_config table"
      pattern: "library_config"
---

<objective>
Execute the irreversible store migration: pre-flight check with user confirmation, create permanent `objectivism-library` store, delete old `objectivism-library-test` store.

Purpose: Establishes the clean baseline store for all subsequent v2.0 phases. Search goes offline from this point until Phase 12. This is the highest-stakes operation in Phase 8.

Output: Updated migration script with store migration step, permanent store created, old store deleted, store resource name saved in library_config.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-store-migration-precondition/08-CONTEXT.md
@.planning/phases/08-store-migration-precondition/08-RESEARCH.md
@.planning/phases/08-store-migration-precondition/CLARIFICATIONS-ANSWERED.md
@.planning/phases/08-store-migration-precondition/08-01-SUMMARY.md
@src/objlib/upload/client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add store migration step to scripts/migrate_phase8.py</name>
  <files>scripts/migrate_phase8.py</files>
  <action>
Extend the existing `scripts/migrate_phase8.py` (created in 08-01) with a store migration step. Add a new `--step` argument: `schema` (step 1 from 08-01), `store` (step 2 from this plan), or `all` (default, runs both sequentially). When run with `--step store` or `--step all`, the script executes the store migration after the schema/state migration.

**Add `--store-old` (default: `objectivism-library-test`) and `--store-new` (default: `objectivism-library`) arguments.**

**Store migration flow:**

1. **Load API key from keyring:**
   ```python
   import keyring
   api_key = keyring.get_password("objlib-gemini", "api_key")
   if not api_key:
       print("ERROR: No API key in keyring. Run: python -m objlib setup", file=sys.stderr)
       sys.exit(2)
   ```

2. **Resolve existing stores by display name:**
   ```python
   from google import genai
   from google.genai import types

   client = genai.Client(api_key=api_key)

   old_store = None
   new_store = None
   for store in client.file_search_stores.list():
       dn = getattr(store, "display_name", None)
       if dn == args.store_old:
           old_store = store
       elif dn == args.store_new:
           new_store = store
   ```

3. **Recovery logic (4 states per locked decision Q2):**
   - `old_store and not new_store`: Normal path -- proceed with full migration
   - `not old_store and new_store`: Migration already complete -- print "Store migration already done. '{args.store_new}' exists." and skip store step
   - `not old_store and not new_store`: Limbo -- print "ERROR: Migration partially failed. Neither '{args.store_old}' nor '{args.store_new}' found. Create '{args.store_new}' manually: `python -c \"from google import genai; c=genai.Client(api_key='...'); print(c.file_search_stores.create(config={'display_name': '{args.store_new}'}).name)\"`" Exit 2.
   - `old_store and new_store`: Step 1 done, Step 2 pending -- skip creation, proceed to deletion

4. **Pre-flight check (MIGR-01):**
   Only when `old_store` exists (normal path or old+new state):

   a. Get document count:
   ```python
   old_store_info = client.file_search_stores.get(name=old_store.name)
   doc_count = getattr(old_store_info, "active_documents_count", None)
   if doc_count is None:
       # Fallback: paginate and count
       from rich.console import Console
       from rich.spinner import Spinner
       console = Console()
       with console.status("Counting store documents..."):
           docs = list(client.file_search_stores.documents.list(parent=old_store.name))
       doc_count = len(docs)
   ```

   b. Get DB uploaded count:
   ```python
   import sqlite3
   conn = sqlite3.connect(args.db)
   uploaded_count = conn.execute("SELECT COUNT(*) FROM files WHERE status='uploaded'").fetchone()[0]
   conn.close()
   ```

   c. Check for raw file resources (Q9 -- warn only):
   ```python
   raw_files = list(client.files.list())
   raw_warning = f"\n  Warning: {len(raw_files)} raw file resources found (auto-expire in 48hr)" if raw_files else ""
   ```

   d. Display pre-flight panel (Rich):
   ```python
   from rich.panel import Panel
   panel_text = (
       f"Store '{args.store_old}': {doc_count} documents\n"
       f"DB: {uploaded_count} files with status='uploaded' (already reset to 'untracked')\n"
       f"\n"
       f"AI metadata (metadata_json, entities): PRESERVED\n"
       f"\n"
       f"This operation is IRREVERSIBLE.\n"
       f"Search will be offline until Phase 12 completes."
       f"{raw_warning}"
   )
   console.print(Panel(panel_text, title="Pre-flight Check", border_style="yellow"))
   ```

   e. Confirmation (unless `--yes`):
   ```python
   if not args.yes:
       response = input("Proceed? Type 'yes' to confirm: ")
       if response.strip() != "yes":
           print("Aborted.")
           sys.exit(0)
   ```

   f. If `--dry-run`: print "DRY RUN -- store migration not executed" and exit 0.

5. **Step 1: Create new store (only if new_store is None):**
   ```python
   console.print("Creating store '{args.store_new}'...")
   created = client.file_search_stores.create(
       config={"display_name": args.store_new}
   )
   assert created.name, "Store creation failed: empty resource name"
   new_store_name = created.name
   console.print(f"  Created: {new_store_name}")
   ```

6. **Step 2: Delete old store (only if old_store exists):**
   ```python
   console.print(f"Deleting store '{args.store_old}' (force=True)...")
   client.file_search_stores.delete(
       name=old_store.name,
       config=types.DeleteFileSearchStoreConfig(force=True),
   )
   console.print(f"  Deleted: {old_store.name}")
   ```
   **CRITICAL: `force=True` is required per research Pitfall 1.** Without it, deletion of a non-empty store raises FAILED_PRECONDITION.

7. **Save new store resource name to library_config:**
   ```python
   conn = sqlite3.connect(args.db)
   conn.execute(
       "INSERT OR REPLACE INTO library_config (key, value, updated_at) "
       "VALUES ('gemini_store_name', ?, strftime('%Y-%m-%dT%H:%M:%f', 'now'))",
       (new_store_name,)
   )
   conn.commit()
   conn.close()
   console.print(f"  Saved store name to library_config: {new_store_name}")
   ```

8. **Verify (post-migration):**
   ```python
   # Verify new store exists
   verify_store = client.file_search_stores.get(name=new_store_name)
   assert verify_store.display_name == args.store_new

   # Verify old store is gone
   old_still_exists = False
   for store in client.file_search_stores.list():
       if getattr(store, "display_name", None) == args.store_old:
           old_still_exists = True
           break
   assert not old_still_exists, f"Old store '{args.store_old}' still exists after deletion!"
   ```

9. **Print store migration summary.**

Handle all Gemini API errors with try/except, printing clear error messages and exiting 2 on API failures.

Use SYNC Gemini API calls (not async) since this is a standalone script -- `client.file_search_stores.*` not `client.aio.file_search_stores.*`. This keeps the migration script simple and avoids asyncio complexity for a one-time operation.
  </action>
  <verify>
1. Run with `--dry-run` first to verify pre-flight:
   `python scripts/migrate_phase8.py --step store --dry-run`
   Expected: Shows store doc count, DB count, pre-flight panel, prints "DRY RUN", exits 0.

2. Verify old store still exists (dry run didn't delete):
   `python -c "from google import genai; import keyring; c=genai.Client(api_key=keyring.get_password('objlib-gemini','api_key')); print([s.display_name for s in c.file_search_stores.list()])"`
   Expected: Contains 'objectivism-library-test'.

3. Syntax check the script:
   `python -c "import ast; ast.parse(open('scripts/migrate_phase8.py').read()); print('Syntax OK')"`
   Expected: "Syntax OK"
  </verify>
  <done>
Store migration step is implemented with pre-flight check, 4-state recovery logic, create-before-delete ordering, force=True on deletion, and post-migration verification. Syntax validation passes and dry-run succeeds. Human checkpoint (Task 2) covers functional correctness of the live migration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Store migration script with pre-flight check, create-before-delete ordering, and force deletion. The migration:
1. Shows pre-flight panel with old store document count and DB file count
2. Creates 'objectivism-library' store (verifies name field)
3. Deletes 'objectivism-library-test' store (with force=True)
4. Saves new store resource name to library_config
5. Handles all 4 recovery states if re-run
  </what-built>
  <how-to-verify>
**Step 1:** Run dry-run to see the pre-flight check:
```bash
python scripts/migrate_phase8.py --step store --dry-run
```
Verify: Pre-flight panel shows store doc count (~2,038) and DB uploaded count.

**Step 2:** Execute the store migration for real:
```bash
python scripts/migrate_phase8.py --step store
```
Type 'yes' when prompted. Watch for:
- "Creating store 'objectivism-library'..." with resource name printed
- "Deleting store 'objectivism-library-test' (force=True)..." confirmation
- Post-migration verification passing

**Step 3:** Verify stores:
```bash
python -c "from google import genai; import keyring; c=genai.Client(api_key=keyring.get_password('objlib-gemini','api_key')); stores=[s.display_name for s in c.file_search_stores.list()]; print(stores); assert 'objectivism-library' in stores; assert 'objectivism-library-test' not in stores; print('OK')"
```

**Step 4:** Re-run to verify idempotency:
```bash
python scripts/migrate_phase8.py --step store --yes
```
Should print "Store migration already done" and exit 0.

**Step 5:** Verify library_config:
```bash
python -c "import sqlite3; c=sqlite3.connect('data/library.db'); print(c.execute(\"SELECT value FROM library_config WHERE key='gemini_store_name'\").fetchone()[0])"
```
Should print a `fileSearchStores/...` resource name.
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 verification steps pass, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `objectivism-library` store exists in the Gemini account
2. `objectivism-library-test` store does NOT exist
3. library_config table has `gemini_store_name` key with the new store's resource name
4. Pre-flight check showed correct counts before user confirmed
5. Script handles re-run gracefully (idempotent)
</verification>

<success_criteria>
- New permanent store 'objectivism-library' created and verified
- Old store 'objectivism-library-test' deleted with force=True
- Store resource name persisted to library_config for future reference
- Migration is idempotent: re-running detects completion and skips
- Pre-flight check provided clear information for user decision
</success_criteria>

<output>
After completion, create `.planning/phases/08-store-migration-precondition/08-02-SUMMARY.md`
</output>
