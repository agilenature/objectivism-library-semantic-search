# CLARIFICATIONS-ANSWERED.md

## Phase 8: Store Migration Precondition â€” Decisions Made

**Generated:** 2026-02-19
**Mode:** YOLO (balanced strategy â€” consensus options chosen, safety-first for irreversible operations)
**Source:** Auto-generated by discuss-phase-ai --yolo

---

## Decision Summary

**Total questions:** 10
**Tier 1 (Blocking):** 4 answered
**Tier 2 (Important):** 4 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

### Q1: How Should Assertion 5 ("Search Returns Results") Behave on an Empty Store?

**YOLO DECISION: Option A â€” Vacuous pass when store is empty**

**Implementation spec:**
- Assertion 5 checks: "IF count of files with `gemini_state='indexed'` > 0, THEN a sample query must return at least 1 citation."
- IF count = 0 (store empty): Assertion 5 returns PASS with message "N/A â€” store is empty (0 indexed files)"
- Same logic applies to Assertion 6 (citation resolution): only runs if Assertion 5 actually produced results
- No mode flags, no smoke-test documents, no special modes
- Count invariant (Assertion 1) drives whether Assertions 5 and 6 are evaluated

**Rationale:** âœ… Consensus. Cleanest implementation. Empty store is a valid STABLE state post-Phase 8. Avoids smoke-test document complexity that would need to be tracked or purged before Phase 12.

---

### Q2: Migration Operation Order â€” Create First or Delete First?

**YOLO DECISION: Option A â€” Create new store BEFORE deleting old store**

**Implementation spec:**
1. Pre-flight check: read old store doc count, read DB files-losing-state count, show summary, require explicit "yes" confirmation
2. Step 1: `create_store('objectivism-library')` â€” verify `name` field is non-empty on response
3. Step 2: `delete_store('objectivism-library-test')` â€” only after Step 1 confirmed
4. Recovery logic: if script is re-run, check states:
   - Old exists, New absent: Step 1 failed â†’ retry from Step 1
   - Old absent, New present: Steps 1+2 both completed â†’ migration done, skip
   - Old absent, New absent: Limbo â†’ print "Migration partially failed. Old store gone. Create new store manually or restore backup." Exit 2.
   - Old present, New present: Step 1 succeeded but Step 2 not yet run â†’ skip Step 1, run Step 2

**Rationale:** âœ… Consensus. Strictly safer. "Single confirmed operation" in MIGR-02 means single user confirmation, not single API call.

---

### Q3: SQLite Schema Migration Approach

**YOLO DECISION: Option A â€” Raw SQL ALTER TABLE with backup**

**Implementation spec:**
```python
# Before any schema changes:
import shutil
shutil.copy('data/library.db', 'data/library.db.bak-phase8')

# Verify integrity before:
conn.execute("PRAGMA integrity_check")  # must return "ok"

# Schema migration (in single transaction):
with conn:
    conn.execute("ALTER TABLE files ADD COLUMN gemini_store_doc_id TEXT")
    conn.execute("ALTER TABLE files ADD COLUMN gemini_state TEXT DEFAULT 'untracked'")
    conn.execute("ALTER TABLE files ADD COLUMN gemini_state_updated_at TEXT")

# Verify columns added:
cols = [row[1] for row in conn.execute("PRAGMA table_info(files)")]
assert 'gemini_store_doc_id' in cols
assert 'gemini_state' in cols
assert 'gemini_state_updated_at' in cols

# Verify sacred columns untouched:
assert 'metadata_json' in cols
```

**Do NOT use:** ORM migration tools, `alembic`, `django migrate`, or any auto-generation that might attempt table recreation.

**Rationale:** âœ… Consensus. SQLite supports ALTER TABLE ADD COLUMN with DEFAULT natively. Explicit is safer than automatic. Backup ensures recovery from any unexpected failure.

---

### Q4: Should gemini_file_id Also Be Nulled During MIGR-04 Reset?

**YOLO DECISION: Option A â€” Also null gemini_file_id**

**Implementation spec (complete MIGR-04 reset statement):**
```sql
UPDATE files
SET gemini_state = 'untracked',
    gemini_store_doc_id = NULL,
    gemini_file_id = NULL,
    gemini_state_updated_at = :migration_ts
WHERE status = 'uploaded'
```

Where `:migration_ts` is the migration start time in ISO 8601 UTC format (e.g., `2026-02-19T10:30:00.000000+00:00`).

**Sacred columns (MUST NOT be touched):**
- `metadata_json` â€” AI-extracted metadata
- Any rows in `entity_mentions`, `person_mentions`, or other entity tables

**Verification after reset:**
```sql
SELECT COUNT(*) FROM files WHERE gemini_state = 'untracked'  -- should match previously-uploaded count
SELECT COUNT(*) FROM files WHERE gemini_file_id IS NOT NULL AND status = 'uploaded'  -- should be 0
SELECT COUNT(*) FROM files WHERE metadata_json IS NULL  -- should match pre-migration count
```

**Rationale:** âœ… Consensus. `gemini_file_id` is a Gemini state column, not AI metadata. Leaving it with stale/expired references creates dead pointers that could confuse FSM logic in Phase 12.

---

## Tier 2: Important Decisions

### Q5: gemini_state_updated_at During Migration

**YOLO DECISION: Option A â€” Migration start timestamp**

**Implementation spec:**
```python
from datetime import datetime, timezone
migration_ts = datetime.now(timezone.utc).isoformat()
# Use migration_ts as the :migration_ts parameter in the MIGR-04 UPDATE
```

Format: ISO 8601 with UTC timezone and microsecond precision (Python's default isoformat() output).

**Rationale:** âš ï¸ Strong single-provider recommendation (Perplexity). NULL would break stuck-transition detection. Per-row timestamps add no analytical value.

---

### Q6: Exit Code Semantics â€” ERROR vs UNSTABLE Boundary

**YOLO DECISION: Option A â€” Prerequisite failures = ERROR, invariant failures = UNSTABLE**

**Implementation spec:**

EXIT 2 (ERROR) â€” prerequisites not met, cannot run assertions:
- Store name provided does not exist (API returns 404 or similar)
- Gemini API key missing or invalid
- SQLite DB file not found at expected path
- `files` table missing expected columns (`gemini_state`, `gemini_store_doc_id`)
- Any unhandled exception during prerequisite checks

EXIT 1 (UNSTABLE) â€” prerequisites pass, at least one assertion fails:
- Assertion 1 fails: count(indexed DB files) â‰  count(store documents)
- Assertion 2 fails: DB file has gemini_state='indexed' but no store document found
- Assertion 3 fails: store document found with no matching DB record
- Assertion 4 fails: any file has gemini_state='uploading' (stuck transition)
- Assertion 5 fails: store has indexed files but sample query returns 0 citations
- Assertion 6 fails: citations returned but don't resolve to DB records

EXIT 0 (STABLE) â€” all prerequisites pass AND all applicable assertions pass (N/A assertions counted as pass)

**Rationale:** âš ï¸ Perplexity-primary with implicit Gemini support. Clear boundary enables useful gate semantics across all 8 validation waves.

---

### Q7: check_stability.py Architecture

**YOLO DECISION: Option A â€” Standalone script at scripts/check_stability.py**

**Implementation spec:**
- File location: `scripts/check_stability.py`
- CLI arguments: `--store <store-name>` (required), `--db <path>` (default: `data/library.db`), `--verbose`/`-v`
- Pattern: `if __name__ == '__main__': sys.exit(main())`
- `main()` function importable from tests
- Uses existing `GeminiFileSearchClient` and DB connection logic from objlib package
- Does NOT require `objlib` Typer CLI to be invoked â€” imports internal modules directly

**Example invocation:**
```bash
python scripts/check_stability.py --store objectivism-library
python scripts/check_stability.py --store objectivism-library --verbose
python scripts/check_stability.py --store objectivism-library-test  # â†’ exits 2
```

**Rationale:** âš ï¸ Both providers and the spec itself point to standalone script. Independence from app lifecycle is critical for an external gate instrument.

---

### Q8: Pre-flight Check â€” Count Acquisition Strategy

**YOLO DECISION: Option A â€” Check store metadata first, fall back to paginated list**

**Implementation spec:**
1. Call `get_store('objectivism-library-test')` or equivalent â€” inspect response object fields
2. If response has `active_documents_count` or similar count field â†’ use it directly
3. If no count field available â†’ call `list_store_documents()` with pagination; show Rich spinner
4. Also execute: `SELECT COUNT(*) FROM files WHERE status='uploaded'` for DB-side count
5. Pre-flight output:
```
â”Œâ”€ Pre-flight Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store 'objectivism-library-test': 2,038 documents        â”‚
â”‚ DB: 818 files with status='uploaded' (will be reset)     â”‚
â”‚                                                           â”‚
â”‚ AI metadata (metadata_json, entities): PRESERVED âœ“       â”‚
â”‚                                                           â”‚
â”‚ âš  This operation is IRREVERSIBLE.                        â”‚
â”‚   Search will be offline until Phase 12 completes.       â”‚
â”‚                                                           â”‚
â”‚ Proceed? Type 'yes' to confirm:                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rationale:** âš ï¸ Gemini-primary recommendation. Performance matters for UX; looking hung during a 2,038-doc iteration would be alarming.

---

## Tier 3: Polish Decisions

### Q9: Explicit Deletion of Old Gemini File API Resources

**YOLO DECISION: No explicit deletion â€” verify and warn only**

**Implementation spec:**
```python
# During pre-flight, after counting store documents:
old_files = list(gemini_client.list_files())  # Files API (not store documents)
if old_files:
    console.print(f"[yellow]Warning: {len(old_files)} raw file resources found. These expire automatically after 48hr.[/yellow]")
# Do NOT block migration or attempt deletion of these files
```

**Rationale:** ğŸ” Feb 17 uploads are 48hr+ expired â€” raw files should already be gone. If any remain, they'll auto-expire. Not worth the complexity of iterating and deleting.

---

### Q10: Store Creation Parameters

**YOLO DECISION: display_name only**

**Implementation spec:**
```python
new_store = gemini_client.create_store(display_name='objectivism-library')
assert new_store.name, "Store creation failed: no name returned"
# Store the resource name for future reference:
# e.g., 'fileSearchStores/abc123' â€” used in all subsequent phase operations
```

**Rationale:** ğŸ” Gemini File Search API does not expose user-configurable chunking for File Search stores (unlike Vector Stores). API defaults are correct.

---

## Summary of All YOLO Decisions

| Q | Decision | Confidence |
|---|----------|------------|
| Q1 | Assertion 5/6: vacuous pass on empty store | âœ… Consensus |
| Q2 | Create new store BEFORE deleting old | âœ… Consensus |
| Q3 | Raw SQL ALTER TABLE + backup | âœ… Consensus |
| Q4 | Also null gemini_file_id during reset | âœ… Consensus |
| Q5 | gemini_state_updated_at = migration timestamp | âš ï¸ Strong |
| Q6 | EXIT 2=prereq fail, EXIT 1=invariant fail | âš ï¸ Strong |
| Q7 | Standalone scripts/check_stability.py | âš ï¸ Strong |
| Q8 | Check store metadata first, fall back to list | âš ï¸ Strong |
| Q9 | No raw file deletion (verify + warn only) | ğŸ” Reasonable |
| Q10 | display_name only for store creation | ğŸ” Reasonable |

---

## Next Steps

1. âœ… Clarifications answered (YOLO mode)
2. â­ Proceed to `/gsd:plan-phase 8`
3. ğŸ“‹ Review YOLO decisions before implementation if desired

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy, safety-first for irreversible operations)*
*Human review recommended before final implementation*
*Generated: 2026-02-19*
