---
phase: 17-rxpy-tui
plan: 04
type: execute
wave: 4
depends_on: ["17-02", "17-03"]
files_modified:
  - tests/test_uat_tui_behavioral.py
autonomous: true

must_haves:
  truths:
    - "All 7 behavioral invariants pass against the RxPY-migrated code"
    - "Pre-UAT contract values match post-UAT measured values"
    - "The full test suite (test_tui.py + test_uat_tui_behavioral.py) passes with zero failures"
  artifacts:
    - path: "tests/test_uat_tui_behavioral.py"
      provides: "7 behavioral invariant tests passing against RxPY-migrated code"
      min_lines: 200
  key_links:
    - from: "tests/test_uat_tui_behavioral.py"
      to: "src/objlib/tui/app.py"
      via: "ObjlibApp with RxPY pipeline"
      pattern: "make_app|ObjlibApp"
    - from: "tests/test_uat_tui_behavioral.py"
      to: "src/objlib/tui/widgets/search_bar.py"
      via: "SearchBar with Subject-based input"
      pattern: "pilot\\.press"
---

<objective>
Post-implementation UAT validation: confirm behavioral parity after RxPY migration.

Purpose: Run the identical 7 behavioral invariant tests created in plan 17-02
against the RxPY-migrated codebase from plan 17-03. The gate is that all 7
invariants pass with results matching the pre-UAT contract.

This is the FINAL gate for Phase 17. If all 7 pass, behavioral parity is confirmed
and Phase 18 is unblocked.

Output: All 7 UATs passing against the migrated code. Full test suite green.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-rxpy-reactive-observable-pipeline-for-tui-event-streams-validated-by-pre-post-uats/17-02-SUMMARY.md
@.planning/phases/17-rxpy-reactive-observable-pipeline-for-tui-event-streams-validated-by-pre-post-uats/17-03-SUMMARY.md
@src/objlib/tui/app.py
@src/objlib/tui/widgets/search_bar.py
@src/objlib/tui/rx_pipeline.py
@tests/test_uat_tui_behavioral.py
@tests/test_tui.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run post-UAT behavioral validation and fix any parity gaps</name>
  <files>tests/test_uat_tui_behavioral.py</files>
  <action>
**Step A: Run the UAT suite against the migrated code**

Run: `python -m pytest tests/test_uat_tui_behavioral.py -v -s`

If all 7 tests pass, proceed to Step D.

**Step B: If any test fails, diagnose the root cause**

For each failure, determine whether it is:
1. **A genuine behavioral regression** -- the RxPY pipeline changed observable
   behavior. Fix the pipeline code (in app.py, search_bar.py, or rx_pipeline.py)
   to restore the original behavior. Do NOT change the test assertions.
2. **A test timing sensitivity issue** -- the pilot.pause() durations need
   adjustment because the RxPY pipeline has slightly different timing
   characteristics than the manual debounce. Acceptable adjustments:
   - Increase positive wait from 0.35 to 0.45 (max 0.5)
   - Decrease negative wait from 0.05 to 0.02 (min 0.01)
   - These are timing tolerances, not behavioral changes.
3. **A test infrastructure issue** -- the test was coupled to the old
   SearchRequested message or @work pattern. Update the test to use the
   new pipeline-compatible approach while keeping the same behavioral assertion.

**Do NOT change behavioral assertions.** The contract is:
- Invariant 1: 0 calls before debounce, 1 call after
- Invariant 2: 1 call immediately on Enter, still 1 after debounce window
- Invariant 3: Latest query's results are shown, not stale
- Invariant 4: Filter change triggers re-search
- Invariant 5: History navigation works, search delta matches pre-UAT
- Invariant 6: Empty query clears immediately
- Invariant 7: Error resets is_searching, pipeline continues

**Step C: Fix and re-run**

After each fix, re-run the failing test:
`python -m pytest tests/test_uat_tui_behavioral.py::test_name -v -s`

Continue until all 7 pass.

**Step D: Run the full test suite**

Run: `python -m pytest tests/test_tui.py tests/test_uat_tui_behavioral.py -v`

If any existing test_tui.py test fails due to the RxPY migration:
- Tests that use `app.post_message(SearchRequested(...))` may need updating
  because SearchBar no longer handles SearchRequested. These tests should either:
  (a) Drive input through `pilot.press()` instead, OR
  (b) Use `search_bar._enter_subject.on_next(query)` to inject into the pipeline.
- Tests that assert on `mock_search_service.search.call_count` after a
  `post_message` may need timing adjustments since the pipeline processes
  asynchronously.

Fix any test_tui.py tests that broke due to the migration, while preserving
their behavioral assertions. Document each change with a comment:
`# Updated for RxPY pipeline (plan 17-04): <what changed and why>`

**Step E: Verify no @work remnants**

Run:
- `grep -r '@work' src/objlib/tui/` -- should return 0 matches
- `grep -r '_debounce_timer' src/objlib/tui/` -- should return 0 matches
- `grep -r '_debounce_gen' src/objlib/tui/` -- should return 0 matches
- `grep -r 'SearchRequested' src/objlib/tui/widgets/search_bar.py` -- should return 0 matches
  (SearchBar no longer posts this message)
  </action>
  <verify>
Run: `cd /Users/david/projects/objectivism-library-semantic-search && python -m pytest tests/test_uat_tui_behavioral.py tests/test_tui.py -v`

All tests pass (both UAT suite and existing test suite).

Run: `grep -c '@work' src/objlib/tui/app.py` -- returns 0.
Run: `grep -c '_debounce_timer' src/objlib/tui/widgets/search_bar.py` -- returns 0.
Run: `grep -c 'switch_map' src/objlib/tui/app.py` -- returns >= 1.
  </verify>
  <done>
All 7 behavioral invariant tests pass against the RxPY-migrated code:
1. Debounce: 0 calls at 50ms, 1 call after debounce window
2. Enter: fires immediately, no double-fire
3. Stale cancellation: latest query wins
4. Filter trigger: search re-runs on filter change
5. History navigation: matches pre-UAT baseline
6. Empty query: clears immediately
7. Error containment: is_searching resets, pipeline continues

Full test suite (test_tui.py + test_uat_tui_behavioral.py) passes with zero failures.
No @work, _debounce_timer, or _debounce_gen remnants in TUI code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full project test suite and verify no regressions</name>
  <files></files>
  <action>
Run the full project test suite to confirm no regressions outside TUI:

`python -m pytest tests/ -v -x --timeout=60`

This verifies:
1. All existing tests pass (not just TUI tests)
2. No import breakage from the reactivex addition to pyproject.toml
3. No side effects from the SearchBar/ObjlibApp refactoring

If any non-TUI test fails, investigate. The Phase 17 changes are TUI-layer only
(locked constraint: "RxPY is TUI-layer concern only") so non-TUI test failures
would indicate an unexpected coupling that must be diagnosed and fixed.
  </action>
  <verify>
Run: `cd /Users/david/projects/objectivism-library-semantic-search && python -m pytest tests/ -v --timeout=60`

All tests pass. Exit code 0.
  </verify>
  <done>
Full project test suite passes with zero failures. RxPY migration has no
regressions outside the TUI layer. Phase 17 gate: PASS.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_uat_tui_behavioral.py -v` -- all 7 UATs pass
- `python -m pytest tests/test_tui.py -v` -- all existing TUI tests pass
- `python -m pytest tests/ -v --timeout=60` -- full suite passes
- `grep -c '@work' src/objlib/tui/app.py` returns 0
- `grep -c '_debounce_timer' src/objlib/tui/widgets/search_bar.py` returns 0
- `grep -c 'switch_map' src/objlib/tui/app.py` returns >= 1
- `grep -c 'combine_latest' src/objlib/tui/app.py` returns >= 1
</verification>

<success_criteria>
PHASE 17 GATE: All 7 behavioral invariants pass with the RxPY-migrated code,
matching the pre-UAT contract from plan 17-02. The full test suite passes
with zero failures. Manual debounce/generation-tracking replaced by RxPY
operators. @work(exclusive=True) replaced by switch_map + defer_task().
Scattered filter-refire unified into combine_latest pipeline.
Phase 18 is UNBLOCKED.
</success_criteria>

<output>
After completion, create `.planning/phases/17-rxpy-reactive-observable-pipeline-for-tui-event-streams-validated-by-pre-post-uats/17-04-SUMMARY.md`
</output>
