---
phase: 16.1-stability-instrument-correctness-audit
plan: 02
subsystem: database, search, testing
tags: [sqlite, substr, gemini-file-search, citations, stability-instrument]

# Dependency graph
requires:
  - phase: 16.1-01
    provides: SPIKE-EVIDENCE.md with 7 challenges answered, fix locations, identity contract confirmation
provides:
  - SUBSTR-based store_doc_prefix lookup in database.py (covers all 1,749 indexed files)
  - 4-pass citation enrichment pipeline (filename -> store_doc_prefix -> gemini_file_id -> API fallback)
  - Fixed check_stability.py A6 (SUBSTR prefix extraction) and A7 (Episode exclusion, topic query, exact prefix match, zero tolerance)
affects: [16.1-03, 16-02, 16-03, 17]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "SUBSTR(col, 1, INSTR(col, '-') - 1) for exact prefix extraction (no LIKE in ID-resolution queries)"
    - "Store doc prefix as primary citation resolution path (covers NULL gemini_file_id files)"

key-files:
  created: []
  modified:
    - scripts/check_stability.py
    - src/objlib/database.py
    - src/objlib/search/citations.py
    - tests/test_search.py

key-decisions:
  - "A7 matching changed from substring 'in' operator to explicit split('-')[0] == comparison (functionally equivalent but more explicit; spike confirmed both work)"
  - "Episode exclusion uses LIKE 'Episode %' for filename pattern filter only -- acceptable since this is row selection, not ID resolution"
  - "Zero tolerance (max_misses=0) with 4/20 initial failures -- triaged to Plan 16.1-03 re-validation"

patterns-established:
  - "SUBSTR-IN pattern: extract prefix from compound ID column using SUBSTR/INSTR, then match with IN clause"
  - "Multi-pass citation enrichment: each pass narrows unmatched set before trying next lookup strategy"

# Metrics
duration: 8min
completed: 2026-02-24
---

# Phase 16.1 Plan 02: Stability Instrument Fix Summary

**SUBSTR-based store_doc_prefix lookup for A6 citation resolution + A7 Episode exclusion, topic query, exact prefix match, zero tolerance**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-24T13:40:08Z
- **Completed:** 2026-02-24T13:48:XX Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- A6 citation resolution now uses SUBSTR prefix extraction from gemini_store_doc_id -- resolves all 1,749 files including 1,075 with NULL gemini_file_id (previously 2/5 citations unresolvable)
- A7 per-file searchability excludes 333 Episode files (zero discriminating metadata), uses topic metadata in query fallback chain, uses explicit prefix comparison, and enforces zero tolerance
- Production citation pipeline extended with `get_file_metadata_by_store_doc_prefix()` as pass 2 in 4-pass lookup chain -- eliminates "[Unresolved file #N]" for NULL gemini_file_id files in TUI search
- All 463 existing tests pass with no regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix check_stability.py A6 and A7** - `624e650` (fix)
2. **Task 2: Add store_doc_prefix lookup to database.py and citations.py** - `edffc3a` (feat)

## Files Created/Modified

- `scripts/check_stability.py` - A6: SUBSTR prefix extraction in _check_citation_resolution; A7: Episode exclusion, topic fallback, explicit prefix match, zero tolerance in _check_targeted_searchability
- `src/objlib/database.py` - New get_file_metadata_by_store_doc_prefix() method using SUBSTR-IN query (no LIKE)
- `src/objlib/search/citations.py` - 4-pass lookup chain in enrich_citations(): filename -> store_doc_prefix -> gemini_file_id -> API fallback
- `tests/test_search.py` - Added get_file_metadata_by_store_doc_prefix mock to _FakeDB

## Decisions Made

1. **A7 matching: explicit prefix comparison over substring `in`** -- The spike confirmed both work correctly, but `split('-')[0] ==` is more explicit about the identity contract. Changed per plan's must_have preference.

2. **Episode exclusion uses LIKE** -- `filename LIKE 'Episode %'` is used only for row selection (which files to exclude from sampling), NOT for ID resolution. The constraint "no LIKE in any new DB lookup" applies to ID-resolution queries. Episode exclusion by filename pattern is acceptable.

3. **Zero tolerance initial failure rate** -- 4/20 = 20% miss rate on first run. Failed files:
   - `Perception - Class 07-01 - Office Hour.txt` -- topic == stem, "Office Hour" is generic
   - `Objectivist Logic - Class 04-02 - Office Hours.txt` -- topic == stem, "Office Hours" is generic
   - `MOTM_2024-05-05_New-Thoughts-on-the-Problem-of-Universals.txt` -- topic "New Thoughts on the Problem of Universals" (query-specificity gap)
   - `MOTM_2022-04-17_History-of-the-Objectivist-Movement-personal-Part.txt` -- topic "History of the Objectivist Movement personal Part" (query-specificity gap)

   These are query-specificity failures at the Gemini search ranking level, not matching or indexing bugs. To be triaged in Plan 16.1-03 re-validation.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added mock method to _FakeDB in test_search.py**
- **Found during:** Task 2 (Add store_doc_prefix lookup)
- **Issue:** `_FakeDB` mock in tests/test_search.py lacked `get_file_metadata_by_store_doc_prefix()` method, causing test_unmatched to fail with AttributeError
- **Fix:** Added `get_file_metadata_by_store_doc_prefix(self, prefixes)` returning empty dict to _FakeDB class
- **Files modified:** tests/test_search.py
- **Verification:** All 463 tests pass
- **Committed in:** edffc3a (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary fix for test compatibility. No scope creep.

## Issues Encountered

- **A7 initial run exits 1:** 4/20 files not found at zero tolerance. This is expected behavior -- the zero-tolerance setting correctly surfaces query-specificity gaps. A6 now PASSES (all 5 citations resolve). The residual A7 failures are query construction quality issues, not code bugs, to be addressed in Plan 16.1-03 re-validation baseline.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Plan 16.1-03 (re-validation) is unblocked: check_stability.py has all fixes, production citation pipeline has store_doc_prefix lookup
- A7 zero-tolerance failures (4/20 on initial run with random sample) need empirical assessment with larger sample in Plan 16.1-03
- The 440 "Other" files where topic == stem remain a moderate risk category for A7 misses
- After Plan 16.1-03 re-validation, Phase 16-02 (temporal stability T+4h/T+24h/T+36h) can proceed

## Self-Check: PASSED

All files exist, both commits verified, all content assertions confirmed.

---
*Phase: 16.1-stability-instrument-correctness-audit*
*Completed: 2026-02-24*
