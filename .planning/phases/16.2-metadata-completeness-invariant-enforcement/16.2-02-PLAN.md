---
phase: 16.2-metadata-completeness-invariant-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["16.2-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "objlib metadata audit exits 0 — all 4 invariant conditions pass"
    - "Bernstein Heroes .md file has primary_topics populated in file_primary_topics junction table"
    - "No silent-pending files remain (zero pending files with non-enrichable extensions)"
    - "Phase 16.3 readiness: MOTM at 100% primary_topics coverage"
    - "Phase 16.3 readiness: Other-stem at 100% primary_topics coverage"
    - "Total files satisfying the invariant = 1885 (every DB-tracked file)"
  artifacts: []
  key_links:
    - from: "objlib metadata audit"
      to: "exit code"
      via: "typer.Exit(code=0)"
      pattern: "AUDIT PASSED"
---

<objective>
Verify the metadata completeness invariant holds across all 1,885 DB-tracked files: run the audit command, confirm exit 0, validate specific files (Bernstein Heroes .md), and confirm Phase 16.3 readiness (MOTM and Other-stem at 100% primary_topics coverage).

Purpose: Gate check before Phase 16.3 can proceed. The audit command must confirm that every file either has primary_topics or is explicitly skipped with a named reason. This plan is pure verification — no code changes.

Output: Verified audit passing, specific file checks, Phase 16.3 readiness confirmation.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16.2-metadata-completeness-invariant-enforcement/16.2-CONTEXT.md
@.planning/phases/16.2-metadata-completeness-invariant-enforcement/16.2-01-SUMMARY.md
@src/objlib/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run metadata audit and verify all invariant conditions pass</name>
  <files></files>
  <action>
**Step 1: Run the audit command and capture output.**
```bash
python -m objlib metadata audit --db data/library.db
echo "Exit code: $?"
```
Expected: All 4 conditions PASS, exit code 0. If exit code is 1, diagnose which condition failed.

**If Condition 1 fails (approved without primary_topics):**
- Query: `sqlite3 data/library.db "SELECT f.file_path, f.ai_metadata_status FROM files f WHERE f.ai_metadata_status = 'approved' AND NOT EXISTS (SELECT 1 FROM file_primary_topics pt WHERE pt.file_path = f.file_path) LIMIT 10"`
- If files are 'extracted' not yet 'approved': run `python -m objlib metadata approve --db data/library.db` then re-run audit.
- If files genuinely lack AI metadata: investigate whether batch-extract missed them. Re-run `python -m objlib metadata batch-extract --db data/library.db` if pending files remain.

**If Condition 2 fails (skipped without reason):**
- Query: `sqlite3 data/library.db "SELECT file_path, ai_metadata_status FROM files WHERE ai_metadata_status = 'skipped' AND (error_message IS NULL OR error_message = '') LIMIT 10"`
- Re-run `python -m objlib metadata mark-unsupported --db data/library.db` if epub files were missed.

**If Condition 3 fails (pending non-enrichable):**
- Query: `sqlite3 data/library.db "SELECT file_path, ai_metadata_status FROM files WHERE ai_metadata_status = 'pending' AND file_path NOT LIKE '%.txt' AND file_path NOT LIKE '%.md' LIMIT 10"`
- Re-run mark-unsupported to catch remaining files.

**If Condition 4 fails (Phase 16.3 readiness):**
- Identify which category is below 100%: MOTM or Other-stem
- Query the specific failing files and determine if they need batch-extract or have a different issue

**Step 2: Verify Bernstein Heroes .md file specifically.**
```bash
sqlite3 data/library.db "SELECT f.file_path, f.ai_metadata_status, GROUP_CONCAT(pt.topic_tag, ', ') as topics FROM files f LEFT JOIN file_primary_topics pt ON f.file_path = pt.file_path WHERE f.file_path LIKE '%Bernstein%' OR f.filename LIKE '%Bernstein%' GROUP BY f.file_path"
```
Expected: The Bernstein Heroes .md file has `ai_metadata_status = 'approved'` and a comma-separated list of primary_topics from CONTROLLED_VOCABULARY.

Also verify the scanner-extracted topic field is present (Phase 16.3 will use this):
```bash
sqlite3 data/library.db "SELECT file_path, json_extract(metadata_json, '$.topic') as topic FROM files WHERE file_path LIKE '%Bernstein%'"
```

**Step 3: Verify no silent-pending files remain.**
```bash
sqlite3 data/library.db "SELECT ai_metadata_status, SUBSTR(file_path, -4) as ext, COUNT(*) FROM files GROUP BY ai_metadata_status, ext ORDER BY ai_metadata_status, ext"
```
Expected: No pending files except possibly failed_validation retries. All .pdf, .html, .docx, .epub should be 'skipped'. All .txt and .md should be 'approved'.

**Step 4: Confirm Phase 16.3 readiness row.**
Run the audit command output and verify the Phase 16.3 Readiness table shows:
- MOTM: 100% coverage (total = with_topics)
- Other-stem: 100% coverage (total = with_topics)

If either is below 100%, this is a blocker. Investigate the specific files and run batch-extract on any remaining pending enrichable files.

Additionally, run a spot-check on MOTM quality — confirm the re-extracted primary_topics are NOT all-boilerplate:
```bash
sqlite3 data/library.db "SELECT f.file_path, GROUP_CONCAT(pt.topic_tag, ', ') as topics FROM files f JOIN file_primary_topics pt ON f.file_path = pt.file_path WHERE f.file_path LIKE '%/MOTM/%' AND f.ai_metadata_status = 'approved' LIMIT 5"
```
Expected: Topics include specific terms beyond the core 5 branches (ethics, epistemology, metaphysics, reason, values). The re-extraction should produce discriminating topics like `immigration`, `capitalism`, `individual_rights`, etc.

**Step 5: Record final counts for the summary.**
```bash
sqlite3 data/library.db "
SELECT 'Total files' as metric, COUNT(*) as value FROM files
UNION ALL
SELECT 'Approved with topics', COUNT(*) FROM files f WHERE f.ai_metadata_status = 'approved' AND EXISTS (SELECT 1 FROM file_primary_topics pt WHERE pt.file_path = f.file_path)
UNION ALL
SELECT 'Skipped with reason', COUNT(*) FROM files f WHERE f.ai_metadata_status = 'skipped' AND error_message IS NOT NULL AND error_message != ''
UNION ALL
SELECT 'Pending enrichable', COUNT(*) FROM files WHERE ai_metadata_status = 'pending' AND (file_path LIKE '%.txt' OR file_path LIKE '%.md')
UNION ALL
SELECT 'Invariant violations', (
  SELECT COUNT(*) FROM files f WHERE f.ai_metadata_status = 'approved' AND NOT EXISTS (SELECT 1 FROM file_primary_topics pt WHERE pt.file_path = f.file_path)
) + (
  SELECT COUNT(*) FROM files WHERE ai_metadata_status = 'skipped' AND (error_message IS NULL OR error_message = '')
) + (
  SELECT COUNT(*) FROM files WHERE ai_metadata_status = 'pending' AND file_path NOT LIKE '%.txt' AND file_path NOT LIKE '%.md'
)
"
```
Expected: Invariant violations = 0.
  </action>
  <verify>
1. `python -m objlib metadata audit --db data/library.db; echo $?` outputs 0
2. Bernstein .md file has primary_topics rows in file_primary_topics
3. No pending files with non-enrichable extensions exist
4. MOTM coverage = 100% in audit readiness output
5. Other-stem coverage = 100% in audit readiness output
6. MOTM spot-check shows non-generic topics (not all-boilerplate)
  </verify>
  <done>
- `objlib metadata audit` exits 0 — all 4 invariant conditions PASS
- Bernstein Heroes .md has primary_topics populated (confirmed via SQL)
- No silent-pending files remain
- Phase 16.3 readiness: MOTM at 100%, Other-stem at 100%
- MOTM quality spot-check confirms non-generic primary_topics after re-extraction
- Phase 16.2 gate PASSED — Phase 16.3 is unblocked for metadata-header intervention
  </done>
</task>

</tasks>

<verification>
Phase 16.2 overall verification:
1. `python -m objlib metadata audit --db data/library.db` exits 0
2. All 1,885 files satisfy the invariant: each has primary_topics OR is skipped with reason
3. Bernstein Heroes .md file has primary_topics from Mistral extraction
4. MOTM files have discriminating (non-boilerplate) primary_topics
5. Phase 16.3 readiness confirmed: MOTM 100%, Other-stem 100%
</verification>

<success_criteria>
- Audit exits 0 with all conditions green
- Bernstein .md confirmed enriched
- Phase 16.3 readiness confirmed at 100% for both target categories
- Phase 16.2 gate PASSED
</success_criteria>

<output>
After completion, create `.planning/phases/16.2-metadata-completeness-invariant-enforcement/16.2-02-SUMMARY.md`
</output>
