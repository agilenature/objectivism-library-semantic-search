---
phase: 16.2-metadata-completeness-invariant-enforcement
plan: 01
subsystem: database, cli
tags: [sqlite, typer, rich, mistral-batch, metadata-invariant, audit]

# Dependency graph
requires:
  - phase: 16.1-stability-instrument-correctness-audit
    provides: "Corpus categorization (Episode/MOTM/Other-stem/Other-discriminating), _unparsed_filename flag"
provides:
  - "metadata mark-unsupported CLI command (format classification + backfill + quality check)"
  - "metadata audit CLI command (4 invariant conditions + Phase 16.3 readiness)"
  - "_get_pending_files() .md extension fix"
  - "Upload gate: get_fsm_pending_files() requires approved + file_primary_topics"
  - "297 Episode files freshly extracted via Mistral Batch API"
  - "21 books backfilled with file_primary_topics from existing JSON"
  - "All 136 non-enrichable files marked skipped with named reasons"
affects: [16.2-02, 16.3, fsm-upload pipeline, metadata pipeline]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Structural quality check pattern: Signal A (scanner topic NULL) + Signal B (all-boilerplate primary_topics at >40% corpus frequency)"
    - "Upload gate pattern: SQL EXISTS subquery on junction table as precondition"
    - "Backfill-from-JSON pattern: read AI metadata_json, filter through CONTROLLED_VOCABULARY, INSERT OR IGNORE"

key-files:
  created: []
  modified:
    - "src/objlib/cli.py (mark-unsupported + audit commands)"
    - "src/objlib/extraction/batch_orchestrator.py (.md filter fix)"
    - "src/objlib/upload/state.py (upload gate)"

key-decisions:
  - "Signal A uses files.metadata_json (scanner topic), catches 333 Episode files with NULL topic"
  - "Signal B boilerplate threshold at 40% identifies 5 topics: epistemology, ethics, metaphysics, rational_egoism, values"
  - "MOTM files NOT caught by quality check (all 468 have scanner topic populated) -- only Episode + 4 other files reset"
  - "Backfilled files excluded from quality check to prevent resetting valid data"
  - "Upload gate enforces scan -> batch-extract -> approve -> upload ordering invariant"
  - "40 Episode files failed Mistral extraction (JSON format issues) -- remain at failed_validation for retry"

patterns-established:
  - "metadata audit: read-only invariant check with exit 0/1 for CI/automation"
  - "mark-unsupported: one-pass remediation command (format classification + backfill + quality check + reset)"
  - "Upload gate: EXISTS(file_primary_topics) as SQL precondition in get_fsm_pending_files()"

# Metrics
duration: 26min
completed: 2026-02-24
---

# Phase 16.2 Plan 01: Metadata Completeness Invariant Enforcement Summary

**Two new CLI commands (mark-unsupported + audit), .md filter fix, upload gate, 297 Episode files re-extracted via Mistral Batch, 21 books backfilled -- audit exits 0 with all 4 invariant conditions passing and Phase 16.3 readiness at 100%**

## Performance

- **Duration:** 26 min
- **Started:** 2026-02-24T18:34:14Z
- **Completed:** 2026-02-24T19:00:53Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments
- Implemented `metadata mark-unsupported` command: marks 136 non-enrichable files as skipped with reasons, backfills 21 books with primary_topics from existing JSON, detects and resets 337 quality-failed files to pending
- Implemented `metadata audit` command: checks 4 invariant conditions + Phase 16.3 readiness table, exits 0/1
- Fixed `_get_pending_files()` to include .md files (Bernstein Heroes book now enrichable)
- Added upload gate to `get_fsm_pending_files()` and `get_files_to_reset_for_enriched_upload()` requiring approved metadata + file_primary_topics
- Batch-extracted 337 pending files via Mistral Batch API: 297 succeeded (18.4 min), 40 failed validation
- All 297 newly-extracted files approved; audit exits 0

## Task Commits

Each task was committed atomically:

1. **Task 1: mark-unsupported command + .md fix + backfill + quality check** - `5656d5d` (feat)
2. **Task 2: batch-extract + audit command** - `10ef3c3` (feat)
3. **Task 3: upload gate in state.py** - `656dd03` (feat)

## Files Created/Modified
- `src/objlib/cli.py` - Added `metadata mark-unsupported` and `metadata audit` commands (~440 lines)
- `src/objlib/extraction/batch_orchestrator.py` - Fixed `_get_pending_files()` SQL to include `.md` extension
- `src/objlib/upload/state.py` - Added metadata completeness gate to `get_fsm_pending_files()` and `get_files_to_reset_for_enriched_upload()`

## Decisions Made
- **Signal A scope:** Uses `files.metadata_json` (scanner metadata), NOT `file_metadata_ai.metadata_json`. This catches 333 Episode files with NULL scanner topic. MOTM files are NOT caught (all 468 have scanner topic from filename slug).
- **Boilerplate threshold:** 40% corpus frequency identifies 5 topics as boilerplate: epistemology, ethics, metaphysics, rational_egoism, values. These are the 5 core branches that appear in >40% of the 1,727 files with topics.
- **Quality check scope:** 337 files reset to pending (333 Signal A + 6 Signal B - 2 overlap). Zero MOTM files caught. This differs from the plan's expectation of "all 469 MOTM" because MOTM files have populated scanner topic and non-boilerplate primary_topics.
- **Approval threshold:** Used 50% confidence (all newly-extracted files were at 56% or 81%) to approve 297 files. This is a standard Mistral extraction confidence for episode transcripts.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Quality check caught different files than plan expected**
- **Found during:** Task 1 (quality check)
- **Issue:** Plan expected "all 469 MOTM files" to be caught by quality check. Actual: 0 MOTM files caught. MOTM files all have populated scanner topic (Signal A miss) and non-boilerplate primary_topics (Signal B miss). Instead, 333 Episode files + 4 other files were caught.
- **Fix:** No code fix needed -- the algorithm is correct. The plan's expectation was based on the hypothesis that MOTM files had NULL topic and generic-only topics, which was wrong for scanner topic (468/468 populated). The quality check correctly identified the actual quality-failed files.
- **Files modified:** None
- **Verification:** Audit passes with all conditions satisfied. Episode files were the correct target for re-extraction.
- **Committed in:** Part of Task 1 commit

**2. [Rule 3 - Blocking] 40 Episode files failed Mistral extraction**
- **Found during:** Task 2 (batch-extract)
- **Issue:** 40 Episode transcript files failed with "Mistral returned JSON array instead of JSON object" -- a known Mistral response format issue with short/unusual transcripts.
- **Fix:** These files are at `failed_validation` status with their error recorded. They can be retried with `batch-extract` in a future pass. They do not block the audit (they're not approved, so Condition 1 doesn't apply).
- **Files modified:** None (DB status updated by batch_orchestrator)
- **Verification:** Audit exits 0. These 40 files are correctly classified as extraction failures.
- **Committed in:** N/A (data-only, no code change)

**3. [Rule 3 - Blocking] 1 file too large for Mistral extraction**
- **Found during:** Task 2 (batch-extract)
- **Issue:** "Ayn Rand - Philosophy - Who Needs It.txt" exceeds Mistral's ~100K token context window.
- **Fix:** Automatically marked as `skipped` with reason by the existing batch_orchestrator oversized-file handling.
- **Files modified:** None (existing behavior)
- **Verification:** File at `skipped` status with error_message.
- **Committed in:** N/A (data-only)

---

**Total deviations:** 3 documented (1 expectation mismatch, 2 blocking data issues)
**Impact on plan:** No code changes needed. Quality check algorithm is correct; the plan's expected MOTM catch was based on stale hypothesis. 40+1 extraction failures are expected Mistral limitations, not code bugs.

## Issues Encountered
- Batch extraction took ~18.4 minutes for 337 files (within expected 20-60 min range)
- 40 Episode files with short/unusual transcripts fail Mistral JSON format constraint -- known issue, retriable

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Audit exits 0: all 4 invariant conditions pass
- Phase 16.3 readiness: MOTM 468/468, MOTM scanner topic 468/468, Other-stem 443/443 -- all at 100%
- Upload gate enforced: no file can reach fsm-upload without approved metadata + primary_topics
- 40 Episode files at failed_validation can be retried in a future batch-extract pass (not blocking)
- Plan 16.2-02 can verify audit and close Phase 16.2

## Self-Check: PASSED

All files exist, all commits verified, all artifacts present in codebase.

---
*Phase: 16.2-metadata-completeness-invariant-enforcement*
*Completed: 2026-02-24*
