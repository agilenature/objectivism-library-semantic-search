# Plan 16.6-03: A7 Update + Stability Gate

**Phase:** 16.6 — Corpus-Relative Aspect Differentiation (CRAD)
**Status:** NOT STARTED
**Prerequisite:** Plan 16.6-02 COMPLETE (all 63 files re-uploaded, ≤5 escalations)
**Autonomous:** No — requires fresh sessions for each stability run

---

## Goal

Update `check_stability.py` A7 to use CRAD discrimination phrases as the primary query for
files with validated phrases, replacing the stochastic S4a cascade. Run 3 consecutive
fresh-session STABLE checks to confirm zero stochastic variance. Permanently integrate
the `Discrimination:` field into `header_builder.py`. Phase 16.6 gate: PASS if all 3 runs
are STABLE with 100% A7 hit rate.

---

## Background: Why A7 Must Change

Current A7 in `check_stability.py`:
- S1 query: `"What is '{stem}' about?"` → 63 files fail this consistently
- S4a fallback: top-3 rarest aspects → finds most files but is STOCHASTIC (rank variance)
- Result: A7 is non-deterministic for the 63 S1-failing files

After CRAD:
- 63 files have validated, corpus-relative discrimination phrases in `file_discrimination_phrases`
- These phrases are stored in the identity header (`Discrimination:` field) — they are indexed by Gemini
- A7 should use the CRAD phrase as the primary query for these files (before even trying S4a)
- CRAD phrases are deterministic (validated at rank ≤ 5 with zero variance in Plan 16.6-01/02)

**The A7 query hierarchy after this plan:**
1. S1: `"What is '{stem}' about?"` — try first
2. CRAD phrase: `file_discrimination_phrases.phrase` — if S1 fails and phrase exists
3. S4a: rarest-3-aspects (unchanged fallback for files without CRAD phrase or if CRAD fails)
4. S4b cascade: S4c through S4f (unchanged last resort)

---

## Tasks

### Task 1: Update `header_builder.py` permanently

Add `Discrimination:` field to the identity header template:

```python
def build_identity_header(file_path: str, conn) -> str:
    # ... existing fields: Title, Course, Class, Topic, Tags, Aspects ...

    # NEW: Add Discrimination field if CRAD phrase exists
    discrimination = ""
    row = conn.execute(
        "SELECT phrase FROM file_discrimination_phrases WHERE filename = ?",
        (Path(file_path).name,)
    ).fetchone()
    if row and row[0]:
        discrimination = f"Discrimination: {row[0]}\n"

    header = (
        "--- DOCUMENT METADATA ---\n"
        f"Title: {title}\n"
        f"Course: {course}\n"
        f"Class: {class_num}\n"
        f"Topic: {topic}\n"
        f"Tags: {tags}\n"
        f"Aspects: {aspects}\n"
        f"{discrimination}"  # empty string if no CRAD phrase
        "--- END METADATA ---\n"
    )
    return header
```

**Validation:** Build header for `ITOE AT - Class 14-01 - OH.txt` — should include:
`Discrimination: Zeno's arrow paradox`

### Task 2: Update `check_stability.py` A7

Locate the A7 implementation in `scripts/check_stability.py` (around line 624-674 based on
session context). Add CRAD phrase lookup BEFORE S4a fallback:

```python
def get_crad_phrase(filename: str, conn) -> str | None:
    """Look up CRAD discrimination phrase for a file."""
    row = conn.execute(
        "SELECT phrase, validation_status FROM file_discrimination_phrases WHERE filename = ?",
        (filename,)
    ).fetchone()
    if row and row[1] == 'validated':
        return row[0]
    return None

# In A7 assertion:
for filename in sample_files:
    # S1 attempt
    rank = query_gemini(f"What is '{Path(filename).stem}' about?", filename)
    if rank is not None and rank <= max_rank:
        record_hit(filename, strategy="S1", rank=rank)
        continue

    # NEW: CRAD phrase attempt (before S4a)
    crad_phrase = get_crad_phrase(filename, conn)
    if crad_phrase:
        rank = query_gemini(crad_phrase, filename)
        if rank is not None and rank <= max_rank:
            record_hit(filename, strategy="CRAD", rank=rank)
            continue

    # S4a fallback (unchanged)
    s4a_query = build_s4a_query(filename, corpus_freq_map, conn)
    rank = query_gemini(s4a_query, filename)
    if rank is not None and rank <= max_rank:
        record_hit(filename, strategy="S4a", rank=rank)
        continue

    # S4b cascade (unchanged)
    # ...
```

**Key constraint:** CRAD phrases are only used if `validation_status = 'validated'`. Escalated
files still fall through to S4a.

### Task 3: Run 3 consecutive fresh-session STABLE checks

**Each check must be in a NEW Claude Code session** (run `/clear` or start new terminal).

**Protocol for each run:**
```bash
# Fresh session, no prior context
python scripts/check_stability.py --store objectivism-library --sample-count 20
```

**Expected output after CRAD update:**
```
A7 (per-file retrieval): ✅ PASS — 20/20 found
  - S1: 18/20 files (rank ≤ 20)
  - CRAD: 2/20 files (rank ≤ 5, deterministic)
  - S4a: 0/20 files (no stochastic fallback needed)
```

**Stochastic variance check:** For any file retrieved via CRAD, confirm the rank is identical
across all 3 runs. Log ranks per file per run. If any CRAD-retrieved file shows rank variance
(e.g., rank 2 in run 1, rank 4 in run 2), flag as stochastic and revise the phrase.

**Gate criteria:** All 3 runs must show:
- `check_stability.py` exits 0 (STABLE)
- A7: 20/20 hits (zero misses)
- Zero files retrieved only via S4a from the sample
- CRAD-retrieved files: identical rank across all 3 runs

### Task 4: Resolve any escalated files from Plan 16.6-02

If Plan 16.6-02 produced escalated files (validation_rank > 5), handle them before the 3
stability runs:
1. Review the file's aspects manually
2. Apply S4f strategy (course + primary_topic + class_number from filename) as phrase
3. Validate manually: query Gemini once, confirm rank ≤ 5
4. Update `file_discrimination_phrases` with revised phrase
5. Re-upload the file with updated identity header

### Task 5: Update STATE.md and SUMMARY

Update `.planning/STATE.md`:
- Phase 16.6 COMPLETE
- Add temporal stability log entries for all 3 A7 runs
- Note: CRAD phrases now in identity headers for 63 files; A7 updated to use CRAD before S4a

Create `16.6-03-SUMMARY.md`:
- Gate: PASS or FAIL
- A7 hit rates per strategy (S1 / CRAD / S4a)
- Stochastic variance: zero confirmed
- Files using CRAD phrases: count and series breakdown
- Phase 17 unblocked: yes/no

---

## Validation Gates

- [ ] `header_builder.py` includes `Discrimination:` field (conditional on `file_discrimination_phrases` entry)
- [ ] `check_stability.py` A7 uses CRAD phrase before S4a for validated files
- [ ] Run 1 (fresh session): all 7 assertions PASS, A7 20/20
- [ ] Run 2 (fresh session): all 7 assertions PASS, A7 20/20
- [ ] Run 3 (fresh session): all 7 assertions PASS, A7 20/20
- [ ] CRAD-retrieved files: identical rank in all 3 runs (zero stochastic variance)
- [ ] `16.6-03-SUMMARY.md` committed with per-run A7 breakdown
- [ ] Phase 16.6 marked COMPLETE in STATE.md
- [ ] Phase 17 UNBLOCKED in STATE.md

---

## Files Created/Modified

- `src/objlib/upload/header_builder.py` — permanent `Discrimination:` field
- `scripts/check_stability.py` — A7 updated with CRAD phrase lookup before S4a
- `.planning/phases/16.6-crad/16.6-03-SUMMARY.md` — gate results
- `.planning/STATE.md` — Phase 16.6 COMPLETE; Phase 17 UNBLOCKED
