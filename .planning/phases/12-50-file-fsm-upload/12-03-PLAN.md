---
phase: 12-50-file-fsm-upload
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/objlib/cli.py
autonomous: false

must_haves:
  truths:
    - "50 files complete FSM lifecycle UNTRACKED -> INDEXED with non-null gemini_store_doc_id (SC1)"
    - "Bidirectional cross-verification passes: 0 missing DB->Store, 0 orphans Store->DB (SC2)"
    - "check_stability.py exits 0 at T=0 (SC5)"
    - "SUMMARY.md records verbatim: check_stability output, 2 DB count queries, store-sync dry-run, 5 TUI queries, timestamp"
    - "SUMMARY.md records verbatim: full list of 50 uploaded file_paths with gemini_store_doc_id (for T+24h SC2 cross-check per Q4/Q5 locked decisions)"
  artifacts:
    - path: ".planning/phases/12-50-file-fsm-upload/12-03-SUMMARY.md"
      provides: "T=0 baseline with verbatim raw output for all verification data points"
      min_lines: 50
  key_links:
    - from: "src/objlib/cli.py"
      to: "src/objlib/upload/orchestrator.py"
      via: "fsm-upload CLI command invokes FSMUploadOrchestrator.run_fsm()"
      pattern: "FSMUploadOrchestrator"
---

<objective>
Execute the 50-file FSM-managed upload against the live Gemini API, then run the T=0 temporal stability baseline capturing all verification data verbatim.

Purpose: This is the first real end-to-end proof that the FSM pipeline works against the live Gemini API. The T=0 SUMMARY.md becomes the baseline for all subsequent temporal checks.

Output: 50 files indexed in objectivism-library store, T=0 SUMMARY.md with verbatim verification data, CLI command for FSM uploads.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-50-file-fsm-upload/12-CONTEXT.md
@.planning/phases/12-50-file-fsm-upload/12-RESEARCH.md
@.planning/phases/12-50-file-fsm-upload/12-01-SUMMARY.md
@.planning/phases/12-50-file-fsm-upload/12-02-SUMMARY.md
@src/objlib/cli.py
@src/objlib/upload/orchestrator.py
@scripts/check_stability.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fsm-upload CLI command and execute 50-file upload</name>
  <files>src/objlib/cli.py</files>
  <action>
**1. Add `fsm-upload` command to CLI:**

Add a new Typer command `fsm_upload` (CLI name: `fsm-upload`) to `src/objlib/cli.py` that:
- Takes `--store` (default: read from library_config table), `--limit` (default: 50), `--reset-existing` (default: False) options
- Instantiates `FSMUploadOrchestrator` with appropriate config
- Calls `orchestrator.run_fsm(store_name)`
- Reports summary to console

Pattern from existing `upload_enriched` command but using FSMUploadOrchestrator.

**2. Pre-flight verification before upload:**

Before running the upload, verify:
- `list_store_documents()` returns 0 documents (clean baseline per Pitfall 7)
- All 50 selected files have `gemini_state='untracked'` and `gemini_store_doc_id IS NULL`
- DB is at V10 (PRAGMA user_version = 10)

If any check fails, report and abort.

**3. Execute the 50-file upload:**

Run: `python -m objlib fsm-upload --store objectivism-library --limit 50`

The command selects first 50 alphabetically by file_path WHERE gemini_state='untracked' AND filename LIKE '%.txt' (per Q4 locked decision).

Monitor progress. If any files end in FAILED state after the first pass, the retry mechanism in _process_fsm_batch should handle them. If still FAILED after retry, use `retry_failed_file()` manually and re-run.

**4. Post-upload gate policy (Q7):**

After upload completes:
- Check: `SELECT COUNT(*) FROM files WHERE gemini_state = 'failed'` -- if > 0, run retry_failed_file() for each, then re-upload
- Continue retrying until all 50 are indexed or a non-transient failure is identified
- Zero-failure gate: SC1 requires all 50 indexed with non-null gemini_store_doc_id
  </action>
  <verify>
DB check: `python -c "
import sqlite3
db = sqlite3.connect('data/library.db')
indexed = db.execute(\"SELECT COUNT(*) FROM files WHERE gemini_state='indexed'\").fetchone()[0]
has_doc = db.execute(\"SELECT COUNT(*) FROM files WHERE gemini_store_doc_id IS NOT NULL\").fetchone()[0]
print(f'Indexed: {indexed}, Has store doc ID: {has_doc}')
assert indexed == 50, f'Expected 50 indexed, got {indexed}'
assert has_doc == 50, f'Expected 50 with doc ID, got {has_doc}'
print('SC1 PASSED: 50/50 indexed with non-null gemini_store_doc_id')
"` -- SC1 passes.
  </verify>
  <done>
fsm-upload CLI command works. 50 files uploaded through FSM lifecycle and reached gemini_state='indexed' with non-null gemini_store_doc_id. SC1 passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: T=0 baseline -- SC2 cross-verification, stability check, SUMMARY.md</name>
  <files>.planning/phases/12-50-file-fsm-upload/12-03-SUMMARY.md</files>
  <action>
Execute ALL of these checks and record output VERBATIM in SUMMARY.md.

**Check 1: check_stability.py (SC5)**
```bash
python scripts/check_stability.py --store objectivism-library
echo "Exit code: $?"
```
Record full output and exit code. Must be exit 0 (STABLE).

**Check 2: DB count queries**
```sql
SELECT COUNT(*) FROM files WHERE gemini_state='indexed';
-- Expected: 50

SELECT COUNT(*) FROM files WHERE gemini_store_doc_id IS NOT NULL;
-- Expected: 50
```
Record exact numbers.

**Check 3: store-sync dry-run**
```bash
python -m objlib store-sync --store objectivism-library
```
Record full output. Expected: 50 canonical documents, 0 orphans.

**Check 4: SC2 bidirectional cross-verification (Q6 locked algorithm)**
Write and run a Python script (can be inline or a temporary script):

Step A (DB -> Store): For each of 50 files with gemini_state='indexed':
- Read gemini_store_doc_id from DB
- Call documents.get(name=gemini_store_doc_id)
- Confirm no 404 -- document exists in store
- Count missing documents

Step B (Store -> DB): Call list_store_documents()
- Count total documents (expected: 50)
- For each document, check if its name matches any DB gemini_store_doc_id
- Count orphans (store has it, DB doesn't)

Pass condition: 0 missing + 0 orphans + count = 50.

Record the script output verbatim.

**Check 5: 5 TUI search queries**
Run these 5 specific queries in the TUI (or via CLI search) and record results verbatim:

1. `python -m objlib --store objectivism-library search "What is the nature of concepts?"`
2. `python -m objlib --store objectivism-library search "How does Objectivism define morality?"`
3. `python -m objlib --store objectivism-library search "What is the role of reason in human life?"`
4. `python -m objlib --store objectivism-library search "Ayn Rand's theory of rights"`
5. `python -m objlib --store objectivism-library search "relationship between epistemology and ethics"`

Record each query's output verbatim. These same 5 queries will be re-run at T+24h for comparison.

NOTE: With only 50 files indexed (not the full 1,748), some queries may return fewer results. This is expected. The point is to establish a baseline and verify no `[Unresolved file #N]` appears.

**Check 6: SC3 reset verification**
Select 5 of the 50 indexed files. Run reset on them:
- Get store document count before: `list_store_documents()` count
- Reset 5 files via _reset_existing_files_fsm()
- Get store document count after
- Verify count decreased by exactly 5
- Verify 5 files have gemini_state='untracked' in DB
- Then re-upload the 5 files to restore them to indexed state

Record all counts and file paths.

**Check 7: 50-file path manifest (Q4/Q5 locked decision)**
Record the full list of uploaded file paths with their store doc IDs verbatim:
```sql
SELECT file_path, gemini_store_doc_id FROM files WHERE gemini_state='indexed' ORDER BY file_path;
```
Record all 50 rows verbatim. This is the corpus manifest that T+24h (12-05) uses for SC2 cross-check.

**Check 8: Timestamp**
Record the exact ISO timestamp of when T=0 checks completed.

**SUMMARY.md structure:**
The SUMMARY.md must include ALL of the above as raw verbatim output, not summaries. A fresh Claude session at T+4h must be able to compare numbers directly.
  </action>
  <verify>
The SUMMARY.md file exists at `.planning/phases/12-50-file-fsm-upload/12-03-SUMMARY.md` and contains:
- check_stability.py output with exit code 0
- DB counts: both showing 50
- store-sync dry-run output showing 50 canonical, 0 orphans
- SC2 cross-verification output showing 0 missing + 0 orphans
- 5 TUI query results with no [Unresolved file #N]
- SC3 reset verification showing store count decreased by 5 then restored
- ISO timestamp
  </verify>
  <done>
T=0 baseline captured with verbatim output for all 7 verification data points. SC1 (50/50 indexed), SC2 (bidirectional cross-verification passes), SC3 (reset deletes store docs, count decreases by 5), SC5 (check_stability exit 0) all verified. 5 TUI queries recorded for T+24h comparison.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>50-file FSM-managed upload completed against live Gemini API with T=0 temporal stability baseline recorded in SUMMARY.md. All success criteria SC1, SC2, SC3, SC5 verified at T=0.</what-built>
  <how-to-verify>
    1. Review 12-03-SUMMARY.md for completeness -- all 8 data points present with verbatim output
    2. Confirm check_stability.py shows STABLE (exit 0)
    3. Confirm no [Unresolved file #N] in TUI query results
    4. Confirm SC3 reset test shows store count decreased by 5
    5. Confirm 50-file path manifest recorded verbatim (file_path + gemini_store_doc_id for all 50)
    6. Note the T=0 timestamp -- T+4h check should happen ~4 hours later
  </how-to-verify>
  <resume-signal>Type "approved" to confirm T=0 baseline is acceptable, or describe issues</resume-signal>
</task>

</tasks>

<verification>
SC1: 50/50 files indexed with non-null gemini_store_doc_id
SC2: Bidirectional cross-verification 0 missing + 0 orphans
SC3: Store doc count decreases by 5 during reset, then restored
SC5: check_stability.py exit 0
T=0 SUMMARY.md: All 7 data points recorded verbatim
</verification>

<success_criteria>
- 50 files at gemini_state='indexed' with gemini_store_doc_id IS NOT NULL
- check_stability.py exit 0
- SC2 bidirectional cross-verification passes (0 missing, 0 orphans)
- SC3 reset test passes (store count decreases by 5)
- 12-03-SUMMARY.md has all verbatim data for fresh-session comparison
- No [Unresolved file #N] in any TUI query result
</success_criteria>

<output>
After completion, the SUMMARY.md IS the artifact for this plan (12-03-SUMMARY.md).
</output>
