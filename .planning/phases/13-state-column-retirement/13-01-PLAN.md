---
phase: 13-state-column-retirement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/migrations/phase13-status-inventory.md
autonomous: true

must_haves:
  truths:
    - "Every query site reading legacy status column is inventoried with file path, line number, old query, new query, and module/function"
    - "Every write site setting legacy status column is inventoried with the same detail"
    - "The inventory is committed to the repository as a Markdown table at docs/migrations/phase13-status-inventory.md"
    - "Preconditions are verified: zero NULL gemini_state values, zero transient states, zero LOCAL_DELETE or missing status values"
    - "gemini_state persists as plain string enum confirmed by sqlite3 CLI output"
  artifacts:
    - path: "docs/migrations/phase13-status-inventory.md"
      provides: "Complete inventory of all status column references with migration mapping"
      contains: "Category A"
  key_links:
    - from: "docs/migrations/phase13-status-inventory.md"
      to: "13-02-PLAN.md"
      via: "Inventory drives all code changes in plan 02"
      pattern: "Migration Action"
---

<objective>
Audit every reference to the legacy `status` column across the entire codebase and produce the committed inventory artifact required by SC-1. Verify all preconditions for the V11 migration.

Purpose: SC-1 requires a complete inventory committed to the repository. SC-2 requires sqlite3 CLI verification of plain string storage. SC-3 requires the migration window scope to be documented. This plan produces the artifact that drives all code changes in plan 13-02.

Output: `docs/migrations/phase13-status-inventory.md` -- committed to repository.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-state-column-retirement/13-RESEARCH.md
@.planning/phases/13-state-column-retirement/13-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify migration preconditions via live database queries</name>
  <files>No files modified -- verification only</files>
  <action>
Run the following sqlite3 CLI queries against `data/library.db` and record EXACT output:

1. **gemini_state NULL check (must be 0):**
   ```bash
   sqlite3 data/library.db "SELECT COUNT(*) FROM files WHERE gemini_state IS NULL"
   ```

2. **gemini_state transient check (must be 0):**
   ```bash
   sqlite3 data/library.db "SELECT COUNT(*) FROM files WHERE gemini_state IN ('uploading', 'processing')"
   ```

3. **Status distinct values:**
   ```bash
   sqlite3 data/library.db "SELECT status, COUNT(*) FROM files GROUP BY status"
   ```

4. **gemini_state distinct values (SC-2 plain string verification):**
   ```bash
   sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files"
   ```
   Confirm output shows ONLY plain strings: `indexed` and `untracked`. No binary, pickle, or object repr artifacts.

5. **LOCAL_DELETE/missing check (must be 0):**
   ```bash
   sqlite3 data/library.db "SELECT COUNT(*) FROM files WHERE status IN ('LOCAL_DELETE', 'missing')"
   ```

6. **Current schema version:**
   ```bash
   sqlite3 data/library.db "PRAGMA user_version"
   ```
   Must be 10.

7. **Cross-tabulation for migration sanity:**
   ```bash
   sqlite3 data/library.db "SELECT status, gemini_state, COUNT(*) FROM files GROUP BY status, gemini_state"
   ```

If ANY precondition fails (NULL gemini_state count > 0, transient state count > 0), STOP and report. These would mean Phase 8/12 state is inconsistent and migration cannot proceed.
  </action>
  <verify>All 7 queries run successfully. gemini_state NULL count = 0. Transient state count = 0. LOCAL_DELETE/missing count = 0. PRAGMA user_version = 10. DISTINCT gemini_state shows only plain strings.</verify>
  <done>All migration preconditions verified with sqlite3 CLI output recorded verbatim.</done>
</task>

<task type="auto">
  <name>Task 2: Create the committed inventory artifact at docs/migrations/phase13-status-inventory.md</name>
  <files>docs/migrations/phase13-status-inventory.md</files>
  <action>
Create the directory `docs/migrations/` if it does not exist. Then create `docs/migrations/phase13-status-inventory.md` with the following structure. The content comes from the research in `13-RESEARCH.md` -- the grep work is already done. This task commits the artifact in the format required by SC-1.

**The document MUST contain these sections:**

1. **Header** with date, phase, purpose, and precondition verification results (from Task 1 output).

2. **Migration Window Scope** (SC-3): Document explicitly that:
   - `gemini_state` has been the sole authoritative column since Phase 8 (V9 migration, 2026-02-20)
   - `status` has been stale/frozen since Phase 8 -- no FSM code path writes to it as the primary state
   - Phase 12 FSM transitions included dual-write lines for backward compatibility only
   - Phase 13 closes the migration window permanently: V11 migration physically drops the `status` column
   - There is NO open-ended dual-write period -- the window ends with plan 13-02 execution

3. **Category A: SQL READ Sites** -- Markdown table with columns: File | Line(s) | Current Query Pattern | Migration Action | Module/Function

   Populate from 13-RESEARCH.md Category A. Every row from the research inventory must be present. Key mappings:
   - `status != 'LOCAL_DELETE'` -> `NOT is_deleted`
   - `status = 'uploaded'` -> `gemini_state = 'indexed'`
   - `status = 'pending'` or `status = ?` (PENDING) -> `gemini_state = 'untracked'`
   - `status = 'missing'` -> `missing_since IS NOT NULL`
   - `status NOT IN ('LOCAL_DELETE', 'MISSING')` -> `NOT is_deleted AND missing_since IS NULL`
   - `GROUP BY status` -> `GROUP BY gemini_state`
   - `SELECT status` -> `SELECT gemini_state`
   - `status != 'skipped'` -> REMOVE filter (no skipped after migration; they are just untracked)

4. **Category B: SQL WRITE Sites** -- Same table format. Include:
   - 5 FSM dual-write sites (state.py lines 532, 627, 674, 808; recovery.py line 553) -- action: remove `status = '...'` from UPDATE
   - Legacy write sites in state.py, recovery.py, orchestrator.py, sync/orchestrator.py, database.py, cli.py -- action: remove status SET or replace with is_deleted/missing_since operation

5. **Category C: Schema/Infrastructure** -- Table covering:
   - SCHEMA_SQL status column definition (database.py line 31-32) -> update to V11 schema
   - SCHEMA_SQL idx_status index (line 49) -> remove
   - SCHEMA_SQL log_status_change trigger (lines 72-79) -> remove
   - UPSERT_SQL status references (lines 497-510) -> remove status from UPSERT
   - FileStatus enum (models.py lines 10-18) -> remove entirely
   - FileRecord.status field (models.py line 43) -> remove
   - FileRecord.to_dict status (models.py line 49) -> remove
   - scanner.py FileRecord construction (line 256) -> remove status= param

6. **Category D: Tests** -- Table listing every test file with status references and migration action.

7. **Category E: Scripts** -- Table listing shell scripts with status queries.

8. **Category F: Non-Status References (NO CHANGE)** -- Brief summary noting these were audited and confirmed to reference other uses of "status" (TUI status bar, Mistral batch status, entity extraction status, etc.), NOT the files.status column.

9. **Locked Decisions Summary** -- List all 10 locked decisions from the discuss phase for executor reference:
   - gemini_state already authoritative
   - No backfill needed
   - Physical DROP COLUMN in V11
   - CHECK constraint on gemini_state in V11
   - V7 full table rebuild pattern
   - TUI labels: display gemini_state as-is
   - --set-pending flags: REMOVE
   - is_deleted replaces LOCAL_DELETE
   - missing_since replaces status='missing'
   - Legacy upload path methods: Claude's discretion

10. **V11 Migration SQL** -- Include the complete V11 SQL from 13-RESEARCH.md (the files_v11 CREATE TABLE, INSERT ... SELECT, DROP, RENAME, index recreation, trigger recreation). This serves as the spec for plan 13-02.
  </action>
  <verify>
1. File exists at `docs/migrations/phase13-status-inventory.md`
2. Contains all 6 categories (A through F) with complete row counts matching research:
   - Category A: ~30 read sites
   - Category B: ~18 write sites
   - Category C: ~8 schema references
   - Category D: ~8 test files
   - Category E: ~6 scripts
3. Contains Migration Window Scope section
4. Contains V11 Migration SQL
5. Contains precondition verification results
6. `grep -c "Migration Action" docs/migrations/phase13-status-inventory.md` returns multiple matches (column header in each table)
  </verify>
  <done>Complete inventory artifact committed at docs/migrations/phase13-status-inventory.md with all status column references categorized, mapped to new equivalents, and the migration window scope explicitly documented. SC-1 and SC-3 artifacts are satisfied.</done>
</task>

</tasks>

<verification>
- `sqlite3 data/library.db "SELECT COUNT(*) FROM files WHERE gemini_state IS NULL"` returns 0
- `sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files"` returns only `indexed` and `untracked` (plain strings, SC-2)
- `docs/migrations/phase13-status-inventory.md` exists and contains all categories A-F
- The inventory covers all Python files under src/, tests/, scripts/ per locked decision #6
- No deferred items (error persistence model, NOT NULL constraint) appear in the inventory
</verification>

<success_criteria>
1. All migration preconditions pass (zero NULLs, zero transient states, user_version=10)
2. `docs/migrations/phase13-status-inventory.md` committed to repository with complete tables
3. Every status reference from the research inventory (80+ sites) is present in the artifact
4. Migration window scope is explicitly documented with start date (Phase 8) and end date (Phase 13 plan 02)
5. V11 migration SQL is included as the spec for plan 13-02
</success_criteria>

<output>
After completion, create `.planning/phases/13-state-column-retirement/13-01-SUMMARY.md`
</output>
