# CLARIFICATIONS-ANSWERED.md

## Phase 13: State Column Retirement â€” Stakeholder Decisions

**Generated:** 2026-02-22
**Mode:** YOLO (balanced strategy â€” project-context-aware)
**Source:** Auto-generated from multi-provider synthesis; tailored to project state after Phase 12

---

## Decision Summary

**Total questions:** 7
**Tier 1 (Blocking):** 4 answered
**Tier 2 (Important):** 2 answered
**Tier 3 (Polish):** 1 answered

---

## Tier 1: Blocking Decisions

### Q1: Status Value Mapping

**YOLO DECISION: `gemini_state` is already authoritative â€” `status` is legacy metadata only**

**Rationale:**
- Confidence level: âœ… Consensus with project-context refinement
- Phase 8 reset ALL files to `gemini_state = 'untracked'`; the `status` column reflects v1 upload history, not current Gemini state
- `gemini_state` has been the FSM-only write target since Phase 8 â€” it is the ground truth
- The `13-01` audit plan must first run `SELECT DISTINCT status FROM files` to discover actual values, but the mapping approach is: **no code reads `status` to determine current state; all reads switch to `gemini_state`**
- If any legacy code reads `status` to drive logic (e.g., `WHERE status = 'uploaded'`), it maps to equivalent `gemini_state` predicates (e.g., `WHERE gemini_state = 'indexed'`)

**Mapping policy:**
- Legacy `status = 'uploaded'` â†’ query rewrites to `gemini_state = 'indexed'` (semantically equivalent for read-site migration)
- Legacy `status = 'pending'` â†’ `gemini_state = 'untracked'`
- Legacy `status = 'failed'` â†’ `gemini_state = 'failed'`
- Legacy `status = 'skipped'` â†’ `gemini_state = 'untracked'`
- Legacy `status IS NULL` â†’ `gemini_state IS NOT NULL` (should not occur post-Phase-8)
- Unknown values â†’ `gemini_state = 'untracked'` (safe default)

**The committed inventory artifact lists the QUERY SITE mapping (old read â†’ new read), not a data backfill.**

---

### Q2: Are Any Code Paths Still Writing to `status`?

**YOLO DECISION: Assumed write-frozen; 13-01 audit must verify**

**Rationale:**
- Confidence level: âš ï¸ Assumed correct based on Phase 12 FSM write audit (SC-4)
- Phase 12 SC-4 confirmed all 6 `gemini_state` write sites go through FSM transition methods
- The `status` column was NOT updated during the Phase 12 50-file upload
- Strategy: grep for `status` in write contexts (`UPDATE files SET status`, `.status =`) in 13-01 as the first deliverable
- If any writes are found, they must be eliminated before 13-02 proceeds

**Audit commands:**
```bash
grep -rn "SET status" src/ tests/ scripts/
grep -rn "\.status\s*=" src/ tests/ scripts/
grep -rn '"status".*=.*?' src/ tests/ scripts/
```

---

### Q3: SC-1 Inventory Format

**YOLO DECISION: Markdown table at `docs/migrations/phase13-status-inventory.md`**

**Rationale:**
- Confidence level: âœ… Consensus
- Format: Markdown table with columns: File Path | Line | Old Code | New Code | Notes
- Generated by a ripgrep audit script in plan 13-01; committed directly
- Post-migration, add a grep check in the test suite or CI that fails if any `status` column references remain (other than the DROP migration itself)
- This satisfies SC-1 literally: "a complete list committed to the repository"

**Template format:**
```markdown
| File | Line | Old Query | New Query | Notes |
|------|------|-----------|-----------|-------|
| src/objlib/database.py | 142 | WHERE status = 'uploaded' | WHERE gemini_state = 'indexed' | list_uploaded() |
```

---

### Q4: Migration Window End â€” DROP COLUMN in Phase 13 plan 13-02

**YOLO DECISION: Physical `DROP COLUMN status` in plan 13-02 via V11 DB migration**

**Rationale:**
- Confidence level: âœ… Consensus (OpenAI + Perplexity) + project context supports clean drop
- The migration window started at Phase 8 and ends at Phase 13 â€” this is the "contract" phase in expand-migrate-contract
- ~1,748 rows makes SQLite table rewrite fast (milliseconds)
- A clean DROP eliminates the migration window permanently and prevents future confusion
- If any query site was missed in the inventory, the DROP causes an immediate, obvious error â€” better than silent stale reads
- Schedule: plan 13-01 completes audit; plan 13-02 drops column and verifies all tests pass

**Migration scope for 13-02:**
1. V11 DB migration: `ALTER TABLE files DROP COLUMN status` + `ADD CONSTRAINT CHECK gemini_state IN (...)` (via table rewrite)
2. Remove all `status` column references from ORM/SQL code
3. Run full test suite
4. Verify sqlite3 CLI confirms column is gone and `gemini_state` values are plain strings

---

## Tier 2: Important Decisions

### Q5: DB CHECK Constraint for `gemini_state`

**YOLO DECISION: Add `CHECK (gemini_state IN ('untracked','uploading','processing','indexed','failed'))` in the V11 migration**

**Rationale:**
- Confidence level: âš ï¸ 2 providers recommend; defense-in-depth aligns with project's HOSTILE distrust posture
- The V11 migration that drops `status` also adds the CHECK constraint â€” both changes in one table rewrite
- SQLite validates CHECK on INSERT/UPDATE; any invalid value causes error immediately
- This satisfies FSM-03: "stable across library version upgrades" â€” the DB itself rejects invalid states even if FSM library changes behavior

**Implementation note:** SQLite CHECK constraints are added via CREATE TABLE, so the V11 migration must rebuild the table using the standard SQLite pattern: create new table â†’ copy data â†’ drop old â†’ rename new.

---

### Q6: Plan Granularity

**YOLO DECISION: Keep 2 plans as designed (13-01 audit, 13-02 migration)**

**Rationale:**
- Confidence level: âœ… Roadmap spec + likely small scope given FSM isolation
- The FSM architecture means `status` reads are probably concentrated in the database layer (`src/objlib/database.py`) and scanner/sync modules
- If 13-01 audit reveals > 20 distinct query sites, reassess â€” otherwise 2 plans is right
- The plans are already well-scoped: audit first, execute second, gate between

---

## Tier 3: Polish

### Q7: TUI Label Compatibility

**YOLO DECISION: Display `gemini_state` values as-is; no translation layer**

**Rationale:**
- Confidence level: ğŸ” 1 provider; low risk
- TUI displays search results, citations, and file metadata â€” not raw status strings from DB
- Any filter/status display in TUI that shows states should use `gemini_state` values directly: `'indexed'`, `'failed'`, `'untracked'` are already user-meaningful
- No label translation layer is warranted â€” adds complexity without UX benefit

---

## Key Constraints for Planner

1. **13-01 starts with live DB audit** â€” run `SELECT DISTINCT status FROM files` and write audit commands before writing any migration code
2. **Inventory artifact is SC-1 deliverable** â€” `docs/migrations/phase13-status-inventory.md` committed in 13-01
3. **No backfill needed** â€” Phase 8 pre-populated all `gemini_state` values; verify no NULLs as a precondition
4. **DROP COLUMN in 13-02** â€” clean end to migration window; V11 migration handles both DROP + CHECK constraint
5. **Full test suite must pass after 13-02** â€” SC-4 gate; no behavioral change visible to user
6. **sqlite3 CLI verification** â€” run `SELECT DISTINCT gemini_state FROM files` after migration for SC-2

---

## Next Steps

1. âœ… Clarifications answered (YOLO mode)
2. â­ Proceed to `/gsd:plan-phase 13`
3. ğŸ“‹ Review YOLO decisions â€” especially Q1 mapping (verify actual status values in live DB before finalizing plan)

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy + project-context-aware)*
*Human review recommended for Q1 mapping before implementation â€” actual live DB values must drive the mapping*
*Generated: 2026-02-22*
