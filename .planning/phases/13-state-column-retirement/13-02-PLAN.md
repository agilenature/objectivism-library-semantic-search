---
phase: 13-state-column-retirement
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/objlib/database.py
  - src/objlib/models.py
  - src/objlib/scanner.py
  - src/objlib/cli.py
  - src/objlib/upload/state.py
  - src/objlib/upload/recovery.py
  - src/objlib/upload/orchestrator.py
  - src/objlib/sync/orchestrator.py
  - src/objlib/extraction/batch_orchestrator.py
  - src/objlib/extraction/sampler.py
  - tests/test_database.py
  - tests/test_database_crud.py
  - tests/test_upload.py
  - tests/test_fsm.py
  - tests/test_schema.py
  - tests/test_search.py
  - tests/test_browse_filter.py
  - tests/conftest.py
  - scripts/monitor_upload.sh
  - scripts/monitor_enriched_upload.sh
  - scripts/watch_progress.sh
  - scripts/check_status.sh
  - scripts/monitor_extraction.sh
autonomous: true

must_haves:
  truths:
    - "The status column is physically absent from the files table after V11 migration"
    - "gemini_state has a CHECK constraint limiting values to the 5 valid FSM states"
    - "is_deleted column exists and replaces all LOCAL_DELETE semantics"
    - "No Python code imports or references FileStatus enum"
    - "No SQL query in src/ references the status column"
    - "All tests pass with zero failures"
    - "sqlite3 CLI confirms gemini_state stores plain strings with CHECK constraint"
    - "TUI and CLI commands work without behavioral change"
  artifacts:
    - path: "src/objlib/database.py"
      provides: "V11 migration SQL, updated SCHEMA_SQL without status, updated UPSERT_SQL without status"
      contains: "MIGRATION_V11_SQL"
    - path: "src/objlib/models.py"
      provides: "FileRecord without status field, no FileStatus enum"
      min_lines: 20
    - path: "src/objlib/upload/state.py"
      provides: "FSM transition methods without dual-write status lines"
      contains: "transition_to_uploading"
  key_links:
    - from: "src/objlib/database.py"
      to: "data/library.db"
      via: "V11 migration executes on DB open"
      pattern: "version < 11"
    - from: "src/objlib/database.py"
      to: "src/objlib/models.py"
      via: "FileRecord used in upsert_file"
      pattern: "FileRecord"
    - from: "src/objlib/scanner.py"
      to: "src/objlib/models.py"
      via: "FileRecord construction without status param"
      pattern: "FileRecord\\("
    - from: "src/objlib/upload/state.py"
      to: "src/objlib/database.py"
      via: "FSM transitions write gemini_state only (no status)"
      pattern: "gemini_state"
---

<objective>
Execute the V11 migration: drop the legacy status column, add is_deleted + CHECK constraint on gemini_state, rewrite all code references, and achieve a fully passing test suite.

Purpose: SC-2 (plain string enum with CHECK), SC-3 (migration window closed by physical DROP), SC-4 (all TUI/CLI/tests pass). This is the execution plan that implements every line item from the 13-01 inventory.

Output: All production code, tests, and scripts updated. V11 migration applied to live database. Full test pass.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-state-column-retirement/13-RESEARCH.md
@.planning/phases/13-state-column-retirement/13-01-SUMMARY.md
@docs/migrations/phase13-status-inventory.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: V11 migration SQL, SCHEMA_SQL update, models/scanner cleanup, UPSERT_SQL, and all source code rewrites</name>
  <files>
    src/objlib/database.py
    src/objlib/models.py
    src/objlib/scanner.py
    src/objlib/cli.py
    src/objlib/upload/state.py
    src/objlib/upload/recovery.py
    src/objlib/upload/orchestrator.py
    src/objlib/sync/orchestrator.py
    src/objlib/extraction/batch_orchestrator.py
    src/objlib/extraction/sampler.py
    scripts/monitor_upload.sh
    scripts/monitor_enriched_upload.sh
    scripts/watch_progress.sh
    scripts/check_status.sh
    scripts/monitor_extraction.sh
  </files>
  <action>
**IMPORTANT: Read the 13-01 SUMMARY and the inventory artifact at docs/migrations/phase13-status-inventory.md FIRST. The inventory is the authoritative reference for every change. The line numbers below are from research time -- always verify against current file content before editing.**

**Back up the database before any migration work:**
```bash
cp data/library.db data/library.db.backup-pre-phase13
```

Execute changes in this order (infrastructure first, then code sites):

---

**Step 1: models.py -- Remove FileStatus enum and FileRecord.status**

1. **Remove the entire `FileStatus` class** (lines 10-20). This enum is being retired.
2. **Remove `status: FileStatus = FileStatus.PENDING`** from the FileRecord dataclass (line 43).
3. **Remove `d["status"] = self.status.value`** from `to_dict()` (line 49).
4. Keep `MetadataQuality` enum, `OperationState` enum, and all other classes untouched.
5. Remove the `Enum` import if no longer used (check if MetadataQuality uses it -- it does, so keep it).

---

**Step 2: scanner.py -- Remove status from FileRecord construction**

Remove `status=FileStatus.PENDING` from the FileRecord constructor call (line 256). Also remove the `FileStatus` import at the top of the file.

---

**Step 3: database.py -- V11 migration, SCHEMA_SQL, UPSERT_SQL, and all query rewrites**

This is the largest file. Changes grouped by section:

**3a. Update SCHEMA_SQL (lines 17-100):**
- Remove the `status` column definition (lines 31-32)
- Add `is_deleted INTEGER NOT NULL DEFAULT 0,` in its place (after metadata_quality, before error_message)
- Add CHECK constraint to gemini_state: find where gemini_state is defined in SCHEMA_SQL (it may not be there since it was added via ALTER TABLE in V9 -- if absent, add it to SCHEMA_SQL):
  ```sql
  gemini_state TEXT NOT NULL DEFAULT 'untracked'
      CHECK(gemini_state IN ('untracked','uploading','processing','indexed','failed')),
  ```
- Also add all V9/V10 columns to SCHEMA_SQL if not already present (gemini_store_doc_id, gemini_state, gemini_state_updated_at, version, intent_type, intent_started_at, intent_api_calls_completed) so fresh databases get the complete modern schema.
- Remove `CREATE INDEX IF NOT EXISTS idx_status ON files(status);` (line 49)
- Add `CREATE INDEX IF NOT EXISTS idx_gemini_state ON files(gemini_state);` if not present
- Remove the `log_status_change` trigger (lines 72-80)
- Keep the `update_files_timestamp` trigger
- Keep `_processing_log` table (historical data preserved)

**3b. Add MIGRATION_V11_SQL string constant** (after MIGRATION_V10_SQL around line 495):
Use the complete V11 SQL from 13-RESEARCH.md. Key elements:
- `DROP TABLE IF EXISTS files_v11` (safety)
- `CREATE TABLE files_v11 (...)` -- full column list WITHOUT status, WITH is_deleted, WITH gemini_state CHECK constraint, WITH gemini_state NOT NULL DEFAULT 'untracked'
- `INSERT INTO files_v11 (...) SELECT ..., CASE WHEN status = 'LOCAL_DELETE' THEN 1 ELSE 0 END, ... FROM files` -- maps status='LOCAL_DELETE' to is_deleted=1
- `DROP TABLE files`
- `ALTER TABLE files_v11 RENAME TO files`
- Recreate all indexes (idx_content_hash, idx_metadata_quality, idx_intent_type, idx_gemini_state -- NO idx_status)
- Recreate update_files_timestamp trigger (NO log_status_change trigger)

**3c. Update _setup_schema() method** to:
- Add `if version < 11:` block that runs MIGRATION_V11_SQL via `self.conn.execute("PRAGMA foreign_keys = OFF")` then `self.conn.executescript(MIGRATION_V11_SQL)` then `self.conn.execute("PRAGMA foreign_keys = ON")` then sets user_version = 11
- Add fresh-database shortcut: if version == 0 (just created by SCHEMA_SQL), set `PRAGMA user_version = 11` and skip all migrations. This prevents V7 migration from running against a fresh schema that has no status column.

**3d. Update UPSERT_SQL (lines 497-510):**
Remove `status` from the INSERT column list, remove the `?` placeholder for status, and remove the entire `status = CASE ... END` block from ON CONFLICT. The UPSERT should be:
```sql
INSERT INTO files(file_path, content_hash, filename, file_size,
                  metadata_json, metadata_quality)
VALUES (?, ?, ?, ?, ?, ?)
ON CONFLICT(file_path) DO UPDATE SET
    content_hash = excluded.content_hash,
    file_size = excluded.file_size,
    metadata_json = excluded.metadata_json,
    metadata_quality = excluded.metadata_quality
```

**3e. Update upsert_file() and upsert_files() methods:**
Remove `record.status.value` from the parameter tuple passed to UPSERT_SQL. The tuple should be `(record.file_path, record.content_hash, record.filename, record.file_size, record.metadata_json, record.metadata_quality.value)` -- 6 values, not 7.

**3f. Remove the FileStatus import** from database.py (line 13: `from objlib.models import FileRecord, FileStatus, MetadataQuality` -> `from objlib.models import FileRecord, MetadataQuality`).

**3g. Remove update_file_status() method entirely** (around line 919-920).

**3h. Rewrite mark_deleted()** (around line 724):
Change `SET status = ?` with `FileStatus.LOCAL_DELETE.value` to `SET is_deleted = 1`. No status value needed.

**3i. Rewrite mark_missing()** (around line 1596):
Remove `status = 'missing'` from the SET clause. Keep only `missing_since = ?` SET.

**3j. Rewrite get_missing_files()** (around lines 1616, 1625):
Change `WHERE status = 'missing'` to `WHERE missing_since IS NOT NULL`.

**3k. Rewrite all `status != 'LOCAL_DELETE'` filters** (approximately 12 sites listed in inventory Category A):
Replace each with `NOT is_deleted` or `is_deleted = 0`. Sites: lines 705, 802, 955, 975, 1008, 1044, 1082, 1408, 1416-1430, 1488, 1499, 1506.

**3l. Rewrite `status = 'uploaded'` queries:**
- Line 878: `WHERE status = 'uploaded' AND gemini_file_id IS NOT NULL` -> `WHERE gemini_state = 'indexed'`
- Line 1493: `AND status = 'uploaded'` -> `AND gemini_state = 'indexed'`

**3m. Rewrite `status = ? (PENDING)` query** (line 903):
Change to `WHERE gemini_state = 'untracked'`.

**3n. Rewrite get_status_counts()** (lines 734-737):
Change `SELECT status, COUNT(*) ... GROUP BY status` to `SELECT gemini_state, COUNT(*) ... GROUP BY gemini_state`.

**3o. Rewrite get_file_with_sync_data()** (lines 1752, 1765):
Remove `status` from SELECT list. Replace `row["status"]` with `row["gemini_state"]` if still needed, or remove.

**3p. Rewrite get_all_active_files_with_mtime()** (line 1779):
Change `WHERE status NOT IN (?, ?)` (LOCAL_DELETE, MISSING) to `WHERE NOT is_deleted AND missing_since IS NULL`.

---

**Step 4: cli.py -- Status command, purge, metadata show, --set-pending removal**

1. **Status command display** (lines 261-269): Rewrite `get_status_counts()` display to show gemini_state counts per locked decision #8 (display values as-is).
2. **Purge command** (line 378): Change `WHERE status = 'LOCAL_DELETE'` to `WHERE is_deleted = 1`.
3. **Metadata show** (lines 2047, 2058): Replace `row['status']` with `row['gemini_state']` in display output.
4. **REMOVE --set-pending flags** per locked decision #9:
   - `metadata update --set-pending` (line 2158): Remove the `--set-pending` option and the SQL that sets `status = 'pending'`
   - `metadata batch-update --set-pending` (line 2256): Remove the option and SQL
   - Wave 2 extraction `--set-pending` (line 2698): Remove the option and SQL

---

**Step 5: upload/state.py -- Remove dual-write and legacy methods**

**5a. Remove dual-write lines from FSM transition methods** (5 sites -- CRITICAL):
- `transition_to_uploading` (line 532): Remove `, status = 'uploading'` from the UPDATE SET clause
- `transition_to_indexed` (line 627): Remove `, status = 'uploaded'` from the UPDATE SET clause
- `transition_to_failed` (line 674): Remove `, status = 'failed'` from the UPDATE SET clause
- `finalize_reset` (line 808): Remove `, status = 'pending'` from the UPDATE SET clause

**5b. Legacy methods** -- Claude's discretion:
- `get_pending_files()` (line 101): Either remove entirely or rewrite to use `gemini_state = 'untracked'`. If `UploadOrchestrator` (non-FSM) still calls it, rewrite; if not, remove.
- `get_uploading_files()` (line 115): Same -- rewrite or remove.
- `record_upload_intent()` (line 148): Remove `status = 'uploading'` SET.
- `record_import_success()` (line 202): Remove `status = 'uploaded'` SET.
- `record_upload_failure()` (line 219): Remove `status = 'failed'` SET.
- `get_enriched_pending_files()` (line 404): Remove `f.status = 'pending'` filter or replace.
- `get_files_to_reset()` (lines 450, 457, 489): Remove `f.status` references.

**Approach for legacy methods:** Check if any active code path calls them. If `FSMUploadOrchestrator` is the only upload path used (which it is since Phase 12), these legacy methods are dead code. Either remove them or leave with updated queries -- use your judgment. The safer approach is to update queries (so they don't crash if accidentally called) and add a deprecation comment.

---

**Step 6: upload/recovery.py -- Remove dual-write and legacy recovery**

1. `retry_failed_file` (line 553): Remove `, status = 'pending'` from UPDATE SET clause.
2. Lines 192, 297-300, 371, 382: Remove or update legacy recovery path status writes. These set `status = 'uploaded'`, `status = 'pending'`, etc. Remove the status SET from each UPDATE.

---

**Step 7: upload/orchestrator.py -- _reset_existing_files**

Line 685: Remove `SET status = 'pending'` from the UPDATE in `_reset_existing_files()`.

---

**Step 8: sync/orchestrator.py -- Local delete operations**

- Line 439-440: Change `WHERE status = 'LOCAL_DELETE'` to `WHERE is_deleted = 1`
- Line 453: Change `SET status = 'uploaded'` to `SET is_deleted = 0`

---

**Step 9: extraction modules**

- `batch_orchestrator.py` line 361: Remove `AND status != 'skipped'` filter entirely (no skipped files after migration -- they are just untracked in gemini_state).
- `sampler.py` line 56: Change `AND status != 'LOCAL_DELETE'` to `AND NOT is_deleted`.

---

**Step 10: Shell scripts**

Update all 5 shell scripts listed in Category E to replace `status` with `gemini_state` in their SQL queries. Also update `scripts/check_stability.py` line 13 and 190 comment references. Leave `scripts/migrate_phase8.py` unchanged (historical).

---

**Step 11: Run V11 migration on live database**

After all code changes are saved:
```bash
python -c "from objlib.database import Database; db = Database('data/library.db'); db.close()"
```
This triggers `_setup_schema()` which runs the V11 migration.

Verify:
```bash
sqlite3 data/library.db "PRAGMA user_version"
# Must return 11

sqlite3 data/library.db ".schema files" | grep -c "status"
# Must return 0 (no status column in schema)

sqlite3 data/library.db "SELECT sql FROM sqlite_master WHERE type='table' AND name='files'" | grep "CHECK.*gemini_state"
# Must show the CHECK constraint

sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files"
# Must show only 'indexed' and 'untracked'

sqlite3 data/library.db "SELECT COUNT(*) FROM files WHERE is_deleted = 1"
# Must return 0 (no LOCAL_DELETE rows existed)

sqlite3 data/library.db "SELECT name FROM sqlite_master WHERE type='trigger'"
# Must show update_files_timestamp only (no log_status_change)
```
  </action>
  <verify>
1. `sqlite3 data/library.db "PRAGMA user_version"` returns 11
2. `sqlite3 data/library.db ".schema files"` shows no `status` column, shows `is_deleted` column, shows CHECK on gemini_state
3. `sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files"` returns only plain strings
4. `grep -rn "FileStatus" src/objlib/` returns zero matches (enum fully removed from production code)
5. `grep -rn "\.status" src/objlib/models.py` returns zero matches for FileRecord.status
6. All 5 FSM dual-write sites confirmed clean (no status= in transition methods)
  </verify>
  <done>
V11 migration applied (user_version=11). status column physically dropped. is_deleted column added. CHECK constraint on gemini_state active. FileStatus enum removed. All production code and scripts rewritten to use gemini_state/is_deleted/missing_since. No code in src/ references the legacy status column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all tests and verify full test suite passes</name>
  <files>
    tests/test_database.py
    tests/test_database_crud.py
    tests/test_upload.py
    tests/test_fsm.py
    tests/test_schema.py
    tests/test_search.py
    tests/test_browse_filter.py
    tests/conftest.py
  </files>
  <action>
**Read the current test files first.** The status column no longer exists in the database schema, so every test that inserts rows with a status value, asserts on status values, or references FileStatus must be updated.

---

**tests/conftest.py (lines 128-137):**
The `populated_db` fixture inserts rows with a `status` column. Remove `status` from all INSERT statements in fixtures. If the fixture creates FileRecord objects, remove the `status=` kwarg.

---

**tests/test_fsm.py (lines 54, 61-69, 255, 296, 308, 366, 435, 453, 476, 503, 534):**
1. `_insert_test_file()` helper inserts rows with a `status` column. Remove `status` from the INSERT column list and VALUES. The test file should only set `gemini_state` for FSM tests.
2. All test setup calls passing `status="uploaded"` or `status="failed"` -- remove the `status=` param. These tests care about `gemini_state`, not legacy status.

---

**tests/test_upload.py (lines 228-234, 251-267, 313-317, 347-368, 406-431):**
1. All INSERT statements with `status` column -- remove status.
2. Assertions checking `row["status"]` -- rewrite to check `row["gemini_state"]` where appropriate.
3. Tests for pending files: change `status = 'pending'` assertions to `gemini_state = 'untracked'`.
4. Tests for failed files: change `status = 'failed'` assertions to `gemini_state = 'failed'`.
5. Tests for uploaded files: change `status = 'uploaded'` assertions to `gemini_state = 'indexed'`.

---

**tests/test_database.py (lines 22-32, 70, 84-121, 125-136, 144-200):**
1. `_make_record()` helper: Remove `status=FileStatus.PENDING` param. Remove `FileStatus` import.
2. `update_file_status` tests (lines 84-121): **Remove entirely** since the method is removed.
3. `mark_deleted` tests (lines 125-136): Rewrite assertions from `status == 'LOCAL_DELETE'` to `is_deleted == 1`.
4. `get_status_counts` tests (lines 144-200): Rewrite to test `gemini_state` counts instead of legacy status counts.
5. Status change tests: Remove or rewrite (the trigger no longer exists).

---

**tests/test_database_crud.py (lines 39-91, 139-156, 353):**
1. Status assertions in CRUD tests (lines 39-91): Remove status column from assertions. Assert on other columns.
2. `update_file_status` tests (lines 139-156): **Remove entirely**.
3. `mark_missing` test (line 353): Rewrite to assert `missing_since IS NOT NULL` instead of `status == 'missing'`.
4. Note: Lines 279-290 reference `entity_extraction_status` -- this is a DIFFERENT column, do NOT change.

---

**tests/test_schema.py (lines 115-149):**
1. Trigger tests that test `log_status_change`: **Remove these tests entirely** -- the trigger no longer exists.
2. If there are tests for the status CHECK constraint, replace with tests for the gemini_state CHECK constraint:
   ```python
   # Test gemini_state CHECK constraint
   with pytest.raises(sqlite3.IntegrityError):
       cursor.execute("INSERT INTO files (file_path, content_hash, filename, file_size, gemini_state) VALUES ('test', 'hash', 'test.txt', 100, 'INVALID')")
   ```
3. Add a test verifying `is_deleted` column exists with default 0.

---

**tests/test_search.py (lines 167-198):**
Custom schema setup that includes a `status` column. Remove `status` from the CREATE TABLE in the test's schema setup. Add `is_deleted INTEGER NOT NULL DEFAULT 0` if needed for the test's queries.

---

**tests/test_browse_filter.py (line 95):**
Replace `status=FileStatus.LOCAL_DELETE` with direct `is_deleted = 1` mechanism (whatever the test uses to mark a file as deleted).

---

**After all test updates, run the full test suite:**
```bash
cd /Users/david/projects/objectivism-library-semantic-search && python -m pytest tests/ -v 2>&1
```

If any test fails:
1. Read the failure traceback
2. Identify if it is a remaining status reference (fix it)
3. Identify if it is a schema mismatch (the test's in-memory DB schema doesn't match V11)
4. Fix and re-run until ALL tests pass

**CRITICAL: Tests that create in-memory databases** will use SCHEMA_SQL directly (not migrations). Since SCHEMA_SQL was updated in Task 1 to the V11 schema (no status column, has is_deleted, has gemini_state CHECK), these tests should work. But verify that test fixtures creating custom schemas are updated too.

**Final verification grep:**
```bash
grep -rn "FileStatus" tests/
grep -rn "\.status" tests/ | grep -v "entity_extraction_status\|ai_metadata_status\|batch.*status\|extraction.*status\|status_bar\|status.*message"
```
Both should return zero matches for legacy files.status references.
  </action>
  <verify>
1. `python -m pytest tests/ -v` passes with ZERO failures
2. `grep -rn "FileStatus" tests/` returns zero matches
3. `grep -rn "from objlib.models import.*FileStatus" tests/ src/` returns zero matches anywhere
4. `grep -rn "'status'" src/objlib/database.py` returns zero matches in active code (historical V7 migration strings are acceptable)
5. Behavioral check: `python -m objlib status` runs without error and displays gemini_state counts
  </verify>
  <done>
All tests pass after migration. No test references FileStatus enum or legacy status column. The full test suite validates the V11 schema including is_deleted, gemini_state CHECK constraint, and all rewritten queries. SC-4 (all TUI/CLI/tests pass with no behavioral change) is satisfied.
  </done>
</task>

</tasks>

<verification>
**SC-1:** `docs/migrations/phase13-status-inventory.md` committed (from plan 13-01) with complete mapping
**SC-2:** `sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files"` shows only plain strings; CHECK constraint enforced at DB level
**SC-3:** Migration window closed -- status column physically dropped in V11; docs/migrations/phase13-status-inventory.md documents the window scope
**SC-4:** `python -m pytest tests/ -v` passes; `python -m objlib status` works; `python -m objlib --store objectivism-library search "test"` works (if store accessible)

**Post-migration database verification:**
```bash
sqlite3 data/library.db "PRAGMA user_version"                    # 11
sqlite3 data/library.db ".schema files" | grep status            # empty (no status column)
sqlite3 data/library.db ".schema files" | grep is_deleted        # shows column
sqlite3 data/library.db ".schema files" | grep CHECK             # shows gemini_state CHECK
sqlite3 data/library.db "SELECT DISTINCT gemini_state FROM files" # indexed, untracked
sqlite3 data/library.db "SELECT COUNT(*) FROM files"              # 1884
sqlite3 data/library.db "SELECT name FROM sqlite_master WHERE type='trigger'" # update_files_timestamp only
```

**Code-level verification:**
```bash
grep -rn "FileStatus" src/ tests/     # zero matches
grep -rn "files\.status\b" src/       # zero matches (excluding comments/strings about historical context)
```
</verification>

<success_criteria>
1. PRAGMA user_version = 11
2. files table has no status column (confirmed by .schema)
3. files table has is_deleted INTEGER NOT NULL DEFAULT 0
4. files table has CHECK(gemini_state IN ('untracked','uploading','processing','indexed','failed'))
5. log_status_change trigger does not exist
6. FileStatus enum does not exist in models.py
7. No Python file in src/ imports FileStatus
8. UPSERT_SQL has 6 columns (no status)
9. All 5 FSM dual-write sites cleaned (no status= in UPDATE)
10. --set-pending flags removed from CLI
11. `python -m pytest tests/ -v` passes with zero failures
12. `python -m objlib status` displays gemini_state counts correctly
13. 1884 files preserved in database (zero data loss)
</success_criteria>

<output>
After completion, create `.planning/phases/13-state-column-retirement/13-02-SUMMARY.md`
</output>
