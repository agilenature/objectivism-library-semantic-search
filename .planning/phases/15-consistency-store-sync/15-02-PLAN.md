---
phase: 15-consistency-store-sync
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - governance/store-sync-contract.md
  - src/objlib/upload/recovery.py
autonomous: false

must_haves:
  truths:
    - "store-sync ongoing role is explicitly classified (scheduled + targeted post-run) and justified by measured lag data from 15-01"
    - "FSM/store-sync contract is documented: FSM owns state writes, store-sync owns read-verification, disagreement resolves by downgrading to FAILED"
    - "downgrade_to_failed() function exists and can transition INDEXED files to FAILED when store-sync detects inconsistency"
    - "check_stability.py reports STABLE at T=0, T+4h, and T+24h after the 70-file corpus is indexed"
  artifacts:
    - path: "governance/store-sync-contract.md"
      provides: "FSM/store-sync contract documentation with reconciliation policy"
      min_lines: 80
      contains: "disagreement resolution"
    - path: "src/objlib/upload/recovery.py"
      provides: "downgrade_to_failed() function (7th authorized write site)"
      contains: "downgrade_to_failed"
  key_links:
    - from: "governance/store-sync-contract.md"
      to: "src/objlib/upload/recovery.py"
      via: "contract references downgrade_to_failed() as the resolution mechanism"
      pattern: "downgrade_to_failed"
    - from: "src/objlib/upload/recovery.py"
      to: "data/library.db"
      via: "direct DB write: SET gemini_state='failed' WHERE gemini_state='indexed'"
      pattern: "gemini_state = 'failed'"
---

<objective>
Define the FSM/store-sync contract, implement the FSM downgrade mechanism, and verify
temporal stability at T=0, T+4h, and T+24h after the 70-file corpus is indexed.

Purpose: Establish the authoritative reconciliation policy between FSM state and empirical
searchability, and confirm the system remains stable over time -- completing all VLID-07
success criteria.

Output:
- `governance/store-sync-contract.md` -- FSM/store-sync contract with reconciliation policy
- `downgrade_to_failed()` function in recovery.py -- 7th authorized write site
- Temporal stability confirmed at T=0, T+4h, T+24h
- Phase 15 SUMMARY with VLID-07 gate verdict
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-consistency-store-sync/15-CONTEXT.md
@.planning/phases/15-consistency-store-sync/15-RESEARCH.md
@.planning/phases/15-consistency-store-sync/CLARIFICATIONS-ANSWERED.md
@.planning/phases/15-consistency-store-sync/15-01-SUMMARY.md
@src/objlib/upload/recovery.py
@src/objlib/upload/state.py
@scripts/check_stability.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement downgrade_to_failed() and create FSM/store-sync contract document</name>
  <files>src/objlib/upload/recovery.py, governance/store-sync-contract.md</files>
  <action>
**Part A: Add `downgrade_to_failed()` to recovery.py**

Add a new standalone async function at the end of `src/objlib/upload/recovery.py` (after the
existing `retry_failed_file()` function). This is the 7th authorized write site for
gemini_state (the 6th is `retry_failed_file()`).

```python
async def downgrade_to_failed(
    state: AsyncUploadStateManager, file_path: str, reason: str
) -> bool:
    """Downgrade an INDEXED file to FAILED when store-sync detects inconsistency.

    This is the reconciliation mechanism documented in governance/store-sync-contract.md.
    When store-sync (empirical searchability) is authoritative and determines that a file
    marked INDEXED is not actually searchable after 300s, this function downgrades the
    FSM state to FAILED so the existing retry_failed_file() -> re-upload path can handle it.

    This is the 7th authorized gemini_state write site.
    Write sites inventory:
      1. transition_to_uploading (state.py)
      2. transition_to_processing (state.py)
      3. transition_to_indexed (state.py)
      4. transition_to_failed (state.py)
      5. finalize_reset (state.py)
      6. retry_failed_file (recovery.py)
      7. downgrade_to_failed (recovery.py) -- THIS FUNCTION

    Args:
        state: Async SQLite state manager.
        file_path: Primary key of the file to downgrade.
        reason: Human-readable reason for the downgrade (logged in error_message column).

    Returns:
        True if the file was successfully downgraded, False if no matching row
        (file not in INDEXED state or not found).
    """
    db = state._ensure_connected()
    now = state._now_iso()
    cursor = await db.execute(
        """UPDATE files
           SET gemini_state = 'failed',
               error_message = ?,
               gemini_state_updated_at = ?,
               version = version + 1
           WHERE file_path = ?
             AND gemini_state = 'indexed'""",
        (reason, now, file_path),
    )
    await db.commit()
    if cursor.rowcount == 1:
        logger.warning(
            "Downgraded %s from INDEXED to FAILED: %s", file_path, reason
        )
    return cursor.rowcount == 1
```

Add a simple test to verify the function works. Create a test in the existing test file
or verify by running a quick inline check:
- Insert a test row with gemini_state='indexed'
- Call downgrade_to_failed()
- Verify gemini_state changed to 'failed' and error_message is set
- Verify version incremented
- Verify calling on a non-indexed file returns False

**Part B: Create governance/store-sync-contract.md**

Create `governance/store-sync-contract.md` with the following structure. Content is informed
by the locked decisions in 15-CONTEXT.md and the measurement results from 15-01-SUMMARY.md.

The document must contain these sections:

1. **Contract Statement**
   - "FSM owns state transitions via API success codes; store-sync verifies actual
     searchability; disagreement is resolved by downgrading FSM state."

2. **Ownership Boundaries**
   - FSM (upload pipeline): writes gemini_state transitions (untracked -> uploading ->
     processing -> indexed, or -> failed at any point). Source of truth for "what the
     pipeline reported."
   - store-sync: reads Gemini store state and performs empirical verification. Source of
     truth for "what the store actually contains."
   - Neither system may override the other's writes WITHOUT following the reconciliation
     policy below.

3. **Disagreement Resolution Policy** (per locked decision #4)
   - Condition: FSM says gemini_state='indexed' but store-sync cannot verify searchability
     (targeted search query fails to return the file after 300s).
   - Action:
     a. Log as INCONSISTENT with timestamp, file_path, query used, and failure details.
     b. Call `downgrade_to_failed(state, file_path, "store-sync: targeted search failed
        after 300s")` -- the 7th authorized write site.
     c. The file enters the existing retry path: `retry_failed_file()` (6th write site)
        transitions FAILED -> UNTRACKED, then the next upload batch re-uploads it.
   - No new FSM states (VERIFY_FAILED, ORPHAN_REMOTE, etc.) -- per deferred decisions.
   - No auto-deletes from the store -- operator must run `store-sync --no-dry-run` explicitly.

4. **store-sync Ongoing Role** (per locked decision #7)
   - Classification: **Scheduled + targeted post-run**
   - After each `fsm-upload` batch run: run `store-sync --store objectivism-library` to
     clear retry-path orphans (addresses the known blocker from STATE.md).
   - After any batch >50 files: run comprehensive store-sync validation.
   - Emergency trigger: check_stability.py reports UNSTABLE -> investigate and run store-sync.
   - Escalation clause: if Phase 15 measurement showed failure_rate > 0, upgrade to
     routine-after-every-batch. (Reference 15-01-SUMMARY.md for actual measured value.)
   - "store-sync is a post-batch reconciliation tool, not an upload-pipeline component."

5. **Import-to-Searchable Lag Characterization** (from 15-01-SUMMARY.md)
   - Copy the P50/P95/P99-max values from 15-01 results.
   - Listing gap analysis (T_listed vs T_searchable).
   - Failure rate and any observed anomalies.
   - Statistical caveat: "P99/max from n=20 is an empirical bound, not a statistical P99.
     Statistical P99 requires n >= 100."

6. **Temporal Stability Protocol** (per locked decision #8)
   - check_stability.py is stateless (new process, new DB connection, new API client).
   - SKEPTICAL posture: script output is authoritative; Claude reads and reports verbatim.
   - Fresh Claude sessions NOT required for T+4h/T+24h (unlike Phase 12 HOSTILE posture).
   - Schedule: T=0 (after Plan 15-02 T1 completes), T+4h, T+24h.

7. **Authorized Write Sites Inventory** (updated)
   - List all 7 gemini_state write sites with file, function, and transition.
   - This replaces any prior partial inventories.

**Part C: Run check_stability.py for T=0 baseline**

Run: `python scripts/check_stability.py --store objectivism-library --verbose`

Record the raw output verbatim. This is the T=0 baseline for the temporal stability
protocol. Expected: STABLE with 70 indexed files (50 Phase 12 + 20 Phase 15-01).

Verify via store-sync: `python -m objlib store-sync --store objectivism-library`
Record orphan count (should be 0).
  </action>
  <verify>
1. `python -c "from objlib.upload.recovery import downgrade_to_failed; print('import OK')"`
2. `governance/store-sync-contract.md` exists and contains "disagreement resolution"
3. `governance/store-sync-contract.md` contains "downgrade_to_failed"
4. `governance/store-sync-contract.md` contains P50/P95/P99-max values from 15-01
5. `governance/store-sync-contract.md` contains "7th authorized write site" or equivalent
6. `python scripts/check_stability.py --store objectivism-library` exits 0
7. Existing tests still pass: `python -m pytest tests/ -x -q`
  </verify>
  <done>
downgrade_to_failed() function exists in recovery.py as the 7th authorized write site.
FSM/store-sync contract documented in governance/store-sync-contract.md with reconciliation
policy, store-sync role classification, lag characterization from 15-01, and write site
inventory. check_stability.py reports STABLE at T=0 with 70 indexed files.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Temporal stability verification at T+4h and T+24h</name>
  <what-built>
Plan 15-02 Task 1 created:
- downgrade_to_failed() in recovery.py (7th write site)
- governance/store-sync-contract.md with full reconciliation policy
- T=0 baseline from check_stability.py (STABLE, 70 indexed files)

Now waiting for temporal stability checks per SC4:
- check_stability.py must report STABLE at T=0, T+4h, and T+24h
  </what-built>
  <how-to-verify>
**T+4h check** (run ~4 hours after Task 1 completes):
```bash
python scripts/check_stability.py --store objectivism-library --verbose
```
Expected: STABLE, 70 indexed files, 0 orphans, all 6 assertions pass.
Compare with T=0 output in the SUMMARY from Task 1 -- any deltas?

**T+24h check** (run ~24 hours after Task 1 completes):
```bash
python scripts/check_stability.py --store objectivism-library --verbose
python -m objlib store-sync --store objectivism-library
```
Expected: STABLE, 70 indexed files, 0 orphans.

SKEPTICAL posture: fresh Claude session is NOT required. Run the scripts and report
verbatim output. Script output is authoritative.

After both checks pass, update the SUMMARY with T+4h and T+24h results and declare
VLID-07 gate verdict.
  </how-to-verify>
  <resume-signal>
After T+24h check passes: type "T+24h STABLE" with the check_stability.py output.
If any check fails: type "UNSTABLE" with the output and details.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Finalize VLID-07 gate verdict and produce SUMMARY</name>
  <files>governance/store-sync-contract.md</files>
  <action>
After T+4h and T+24h checks pass (from Task 2 checkpoint), finalize everything:

**Step 1: Update governance/store-sync-contract.md**
Add the temporal stability section with verbatim results:
- T=0 timestamp and check_stability.py output (from Task 1)
- T+4h timestamp and output (from Task 2 checkpoint)
- T+24h timestamp and output (from Task 2 checkpoint)
- Verdict: "Temporal stability confirmed -- no drift observed between T=0 and T+24h"

**Step 2: Declare VLID-07 gate verdict**
Review all 4 success criteria for Phase 15:

SC1: Import-to-searchable lag measured empirically with P50/P95/P99 using at least 20
     test imports with targeted per-file queries -> check 15-01-SUMMARY.md

SC2: store-sync ongoing role explicitly defined as scheduled + targeted post-run,
     justified by measured lag and failure data -> check governance/store-sync-contract.md

SC3: FSM/store-sync contract documented with disagreement resolution policy ->
     check governance/store-sync-contract.md

SC4: check_stability.py reports STABLE at T=0, T+4h, T+24h -> check Task 2 results

If all 4 pass: VLID-07 = PASS.
If any fail: document the failure and what's needed for gap closure.

**Step 3: Create 15-02-SUMMARY.md**
Create `.planning/phases/15-consistency-store-sync/15-02-SUMMARY.md` with:
- VLID-07 gate verdict (PASS or FAIL with details)
- Contract artifacts created (governance/store-sync-contract.md)
- Code changes (downgrade_to_failed in recovery.py)
- Temporal stability results (T=0, T+4h, T+24h)
- Lag measurement cross-reference (from 15-01)
- Impact on Phase 16: what the contract means for the full 1748-file upload

**Step 4: Update STATE.md**
Update `.planning/STATE.md`:
- Phase 15 status: COMPLETE (if VLID-07 PASS)
- Phase 16 status: UNBLOCKED (if Phase 15 gate passed)
- Add decision: downgrade_to_failed is 7th authorized write site
- Add decision: store-sync role = scheduled + targeted post-run
  </action>
  <verify>
1. `.planning/phases/15-consistency-store-sync/15-02-SUMMARY.md` exists
2. SUMMARY contains VLID-07 verdict
3. `governance/store-sync-contract.md` contains temporal stability section
4. `.planning/STATE.md` updated with Phase 15 status
  </verify>
  <done>
Phase 15 Plan 02 complete. VLID-07 gate verdict declared. FSM/store-sync contract
documented. Temporal stability confirmed at T=0, T+4h, T+24h. STATE.md updated.
Phase 16 unblocked (if PASS).
  </done>
</task>

</tasks>

<verification>
Phase 15 Plan 02 verification checklist:
1. downgrade_to_failed() exists in recovery.py and imports correctly
2. governance/store-sync-contract.md contains all 7 required sections
3. Contract references measured lag data from Plan 15-01
4. Disagreement resolution policy matches locked decision #4 exactly
5. store-sync role matches locked decision #7 (scheduled + targeted post-run)
6. check_stability.py reports STABLE at T=0, T+4h, and T+24h
7. VLID-07 gate verdict declared
8. STATE.md updated
</verification>

<success_criteria>
- downgrade_to_failed() function works (INDEXED -> FAILED transition)
- FSM/store-sync contract documented with reconciliation policy
- store-sync ongoing role explicitly defined and justified by measured data
- check_stability.py STABLE at T=0, T+4h, T+24h after 70 indexed files
- VLID-07 gate verdict: PASS (all 4 success criteria met)
- Phase 16 unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/15-consistency-store-sync/15-02-SUMMARY.md`
</output>
