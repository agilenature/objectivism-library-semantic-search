# CLARIFICATIONS-ANSWERED.md

## Phase 10: Transition Atomicity Spike â€” Stakeholder Decisions

**Generated:** 2026-02-20
**Mode:** YOLO (balanced strategy â€” consensus options selected)
**Source:** Auto-generated by discuss-phase-ai --yolo

---

## Decision Summary

**Total questions:** 9
**Tier 1 (Blocking):** 4 answered
**Tier 2 (Important):** 3 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

### Q1: Write-Ahead Intent Representation

**YOLO DECISION: Option A â€” Extra columns on `files` table**

Three columns added to `files` table in Plan 10-01 DB migration:
- `intent_type TEXT` â€” NULL or `'reset_intent'` (extensible for future transitions)
- `intent_started_at TEXT` â€” ISO timestamp when intent was recorded
- `intent_api_calls_completed INTEGER` â€” 0, 1, or 2 (progress tracker)

**Rationale:** No new FSM states (preserves Phase 9's 5-state enum). Recovery query is `WHERE intent_type IS NOT NULL` â€” no joins, no schema complexity. Intent columns are NULL for all files not in a multi-step transition (vast majority of the time). The `intent_type` string allows future intent types to be distinguished if needed.

**Implications for Plan 10-01:**
- Add DB migration: 3 new columns on `files` with `DEFAULT NULL`
- Recovery crawler: `SELECT * FROM files WHERE intent_type IS NOT NULL`
- Txn A writes intent; Txn B clears intent + increments version

---

### Q2: Reset Transition End State

**YOLO DECISION: UNTRACKED**

FSM path for successful reset: `INDEXED â†’ (intent recorded) â†’ (API calls) â†’ UNTRACKED`

After reset:
- `gemini_state = 'untracked'`
- `gemini_store_doc_id = NULL`
- `gemini_file_id = NULL`
- `intent_type = NULL` (cleared)
- `version = version + 1`

**Rationale:** Semantically correct â€” both remote resources have been deleted, the file is back to its pre-upload state. The upload pipeline discovers it via `WHERE gemini_state='untracked'` and starts fresh. `UPLOADING` would imply an active upload is in progress, which it isn't.

**Note:** The roadmap's phrasing "INDEXEDâ†’UPLOADING reset transition" describes the *purpose* of the reset (so the file can be re-uploaded), not the literal end state. The literal FSM path ends at `UNTRACKED`.

---

### Q3: OCC Version + Intent Atomicity Boundary

**YOLO DECISION: Two-transaction structure; version incremented only at Txn B**

**Txn A (pre-API):**
```sql
UPDATE files
SET intent_type = 'reset_intent',
    intent_started_at = ?,
    intent_api_calls_completed = 0
WHERE file_path = ?
  AND gemini_state = 'indexed'
  AND version = ?
-- rowcount check: if 0, another transition won the race
```

**Between API calls (progress tracking):**
```sql
UPDATE files SET intent_api_calls_completed = ? WHERE file_path = ?
-- No OCC check needed; intent columns are not versioned
```

**Txn B (finalize):**
```sql
UPDATE files
SET gemini_state = 'untracked',
    gemini_store_doc_id = NULL,
    gemini_file_id = NULL,
    intent_type = NULL,
    intent_started_at = NULL,
    intent_api_calls_completed = NULL,
    version = version + 1,
    gemini_state_updated_at = ?
WHERE file_path = ?
  AND version = ?
  AND intent_type = 'reset_intent'
-- rowcount check: if 0, something very wrong (intent was cleared by another process)
```

---

### Q4: Safe-Delete Wrappers for Idempotency

**YOLO DECISION: Option A â€” 404 = success, all other errors re-raise**

Both `safe_delete_store_document()` and `safe_delete_file()` wrappers follow this pattern:
```python
try:
    await client.delete_store_document(doc_name)
except google.api_core.exceptions.NotFound:
    pass  # Already deleted; idempotent outcome
except Exception:
    raise  # Auth errors, quota errors, etc. â†’ propagate to FAILED
```

**Empirical verification required in Plan 10-01:** Confirm the exact exception class the `google-genai` SDK raises for 404. Expected: `google.api_core.exceptions.NotFound`. Test with an already-deleted resource before wiring into recovery.

---

## Tier 2: Important Decisions

### Q5: Recovery Crawler Scope

**YOLO DECISION: Option A â€” Startup blocking + optional background monitor (detect only)**

**Plan 10-02 implements:**
1. `startup_recovery(db)` â€” runs at app startup; blocks until all `intent_type IS NOT NULL` files are recovered; logs each recovery at INFO level
2. Optional: `background_recovery_monitor(db, interval=300)` â€” async background task; detects intents older than 30 minutes; logs WARNING but does NOT auto-recover

**Startup recovery scan order:** By `intent_started_at ASC` (oldest first). Each file recovery acquires the `FileLockManager` lock for that file (prevents race with any concurrent transition attempt).

**What "UPLOADING with no active upload" means:** Files in `gemini_state='uploading'` with no active upload task at startup are NOT automatically reset â€” this is deferred to Phase 13's state migration work. Phase 10 only recovers files with `intent_type IS NOT NULL`.

---

### Q6: FAILED State Escape Path

**YOLO DECISION: Option A â€” Explicit CLI command `objlib recover --failed`**

**FSM transitions from FAILED:**
- `FAILED â†’ UNTRACKED` (via `retry` event) â€” clears intent columns, re-enables upload pipeline

**Plan 10-02 implements:**
1. The `retry` FSM transition from FAILED to UNTRACKED
2. CLI command `objlib recover --failed [--file PATH]` that triggers retry on all (or one) FAILED file
3. No automatic retry loops â€” `startup_recovery` does NOT retry FAILED files

**Rationale:** Satisfies FSM-02 ("no stuck state requires manual SQL") because the escape is `objlib recover --failed`, not a SQL command. Prevents infinite retry loops. Operator controls when to retry.

**What FAILED retains:** `intent_type` and `intent_api_calls_completed` are preserved in FAILED state as audit context. Cleared only after successful retry.

---

### Q7: Crash Simulation Test Methodology

**YOLO DECISION: Option A â€” Mock side_effect + asyncio.CancelledError**

**Three crash point tests (Plan 10-01):**

**Crash Point 1** â€” After `delete_store_document()`, before `delete_file()`:
```python
# Mock: delete_store_document succeeds, delete_file raises Exception
# Assert: DB has intent_api_calls_completed=1, gemini_state='indexed'
# Recovery: safe_delete_file() via 404 wrapper; finalizes to 'untracked'
```

**Crash Point 2** â€” After `delete_file()`, before Txn B finalize:
```python
# Mock: both API calls succeed, then raise CancelledError before Txn B
# Assert: DB has intent_api_calls_completed=2, gemini_state='indexed'
# Recovery: skips both API calls (intent_api_calls_completed=2); runs Txn B only
```

**Crash Point 3** â€” During Txn B (DB write crash):
```python
# Simulate: Txn B fails (mock aiosqlite execute to raise)
# Assert: DB has intent_api_calls_completed=2, gemini_state='indexed' still
# Recovery: same as Crash Point 2 â€” all API calls done, just re-run Txn B
```

Each test: (a) inject crash, (b) instantiate fresh `RecoveryCrawler`, (c) run recovery, (d) assert `gemini_state='untracked'`, `intent_type=NULL`, no SQL executed manually.

---

## Tier 3: Polish Decisions

### Q8: Observability

**YOLO DECISION:** Minimal for Phase 10.

Recovery crawler logs: `logger.info(f"Recovered {file_path}: {intent_type} cp={api_calls_completed}")` for each file recovered.

`objlib status` command should show: `Files with pending intent: N`. If N > 0, suggest running `startup_recovery()`.

No dedicated `intents list` CLI command in Phase 10 (can add in Phase 13 when status column is retired).

---

### Q9: SC3 Simplicity Measurement

**YOLO DECISION:** Line count criterion.

Success Criterion 3 is satisfied when:
- The recovery crawler's `recover_file()` function (the function that handles one file with an active intent) has â‰¤ total lines of the `transition_reset()` function
- Each crash point test is a single focused test function â‰¤ 40 lines
- Recovery code has zero retry loops (linear step resumption only)

No formal cyclomatic complexity measurement required for Phase 10 spike.

---

## Architectural Summary

The write-ahead intent pattern for Phase 10:

```
INDEXED
  â”‚
  â”‚ Txn A: write intent_type='reset_intent', intent_api_calls_completed=0
  â”‚        (WHERE gemini_state='indexed' AND version=N)
  â”‚
  â”œâ”€â”€ [CRASH POINT 1] â”€â”€â”€ Recovery: safe_delete_store_document (404=ok), progress to cp=1
  â”‚                                  then proceed to CP2 path
  â–¼
  delete_store_document()  â†’  intent_api_calls_completed = 1
  â”‚
  â”œâ”€â”€ [CRASH POINT 2] â”€â”€â”€ Recovery: safe_delete_file (404=ok), progress to cp=2
  â”‚                                  then run Txn B
  â–¼
  delete_file()            â†’  intent_api_calls_completed = 2
  â”‚
  â”œâ”€â”€ [CRASH POINT 3] â”€â”€â”€ Recovery: all APIs done (cp=2), just run Txn B
  â”‚
  â”‚ Txn B: gemini_state='untracked', clear IDs, clear intent, version=N+1
  â”‚
  â–¼
UNTRACKED (clean slate, ready for re-upload)
```

---

## Next Steps

1. âœ… Clarifications answered (YOLO mode)
2. â­ Proceed to `/gsd:plan-phase 10` to create 10-01-PLAN.md and 10-02-PLAN.md
3. ğŸ“‹ Review YOLO decisions before Plan 10-01 implementation if desired

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Generated: 2026-02-20*
