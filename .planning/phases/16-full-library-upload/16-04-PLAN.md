---
phase: 16-full-library-upload
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/objlib/search/client.py
  - src/objlib/services/search.py
  - src/objlib/tui/app.py
  - src/objlib/tui/widgets/results.py
  - src/objlib/cli.py
autonomous: true

must_haves:
  truths:
    - "GeminiSearchClient.query() requests top_k=20 by default"
    - "CLI search command accepts --top-k N flag"
    - "TUI results panel shows 'N citations retrieved' banner"
    - "Each citation card shows its rank as '1 / N', '2 / N', etc."
    - "Scroll hints appear when citations extend beyond visible area"
  artifacts:
    - path: "src/objlib/search/client.py"
      provides: "top_k parameter in query() and query_with_retry()"
      contains: "top_k"
    - path: "src/objlib/services/search.py"
      provides: "top_k threaded through SearchService.search()"
      contains: "top_k"
    - path: "src/objlib/tui/widgets/results.py"
      provides: "Rank display, citation count banner, scroll hints"
      contains: "citations retrieved"
    - path: "src/objlib/cli.py"
      provides: "--top-k CLI flag on search command"
      contains: "top_k"
  key_links:
    - from: "src/objlib/tui/app.py"
      to: "src/objlib/services/search.py"
      via: "search_service.search() call passes through top_k"
      pattern: "search_service.search"
    - from: "src/objlib/services/search.py"
      to: "src/objlib/search/client.py"
      via: "query_with_retry passes top_k to query()"
      pattern: "query_with_retry.*top_k|query.*top_k"
    - from: "src/objlib/search/client.py"
      to: "google.genai types.FileSearch"
      via: "top_k parameter in FileSearch constructor"
      pattern: "FileSearch.*top_k"
---

<objective>
Implement TUI-09: top_k=20 default retrieval, --top-k CLI flag, citation count display, per-citation rank position, and scroll discoverability hints.

Purpose: Deliver the search quality and citation experience improvements required by TUI-09 (REQUIREMENTS.md). Users will see up to 4x more results (20 vs ~5 default), with clear rank indicators and scroll affordances for navigating large result sets.

Output: Updated search pipeline (client -> service -> TUI/CLI) with top_k support and enhanced citation display.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-full-library-upload/16-CONTEXT.md
@.planning/phases/16-full-library-upload/16-RESEARCH.md
@src/objlib/search/client.py
@src/objlib/services/search.py
@src/objlib/tui/app.py
@src/objlib/tui/widgets/results.py
@src/objlib/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread top_k through search pipeline and add CLI flag</name>
  <files>
    src/objlib/search/client.py
    src/objlib/services/search.py
    src/objlib/cli.py
  </files>
  <action>
Three files to update, threading `top_k` from CLI/TUI through to the Gemini SDK:

**1. GeminiSearchClient.query() — src/objlib/search/client.py**

Add `top_k: int = 20` parameter to `query()` method signature (after `metadata_filter`, before `model`). Pass it to the `types.FileSearch` constructor:

```python
def query(
    self,
    query: str,
    metadata_filter: str | None = None,
    top_k: int = 20,
    model: str = "gemini-2.5-flash",
) -> Any:
    config = types.GenerateContentConfig(
        tools=[
            types.Tool(
                file_search=types.FileSearch(
                    file_search_store_names=[self._store_resource_name],
                    metadata_filter=metadata_filter,
                    top_k=top_k,
                )
            )
        ],
    )
    return self._client.models.generate_content(
        model=model,
        contents=query,
        config=config,
    )
```

Add `top_k: int = 20` parameter to `query_with_retry()` as well, and pass it through:

```python
def query_with_retry(
    self,
    query: str,
    metadata_filter: str | None = None,
    top_k: int = 20,
    model: str = "gemini-2.5-flash",
) -> Any:
    return self.query(query, metadata_filter=metadata_filter, top_k=top_k, model=model)
```

**2. SearchService.search() — src/objlib/services/search.py**

Add `top_k: int = 20` parameter to `search()` method signature (after `mode`). Thread it through to `query_with_retry`:

```python
async def search(
    self,
    query: str,
    filters: list[str] | None = None,
    expand: bool = True,
    rerank: bool = True,
    mode: str = "learn",
    top_k: int = 20,
) -> SearchResult:
```

Update the `asyncio.to_thread` call that invokes `query_with_retry` to pass `top_k`:

```python
response = await asyncio.to_thread(
    self._search_client.query_with_retry,
    search_query,
    metadata_filter=metadata_filter,
    top_k=top_k,
)
```

**3. CLI search command — src/objlib/cli.py**

Add a `--top-k` option to the `search` command (at line ~1349, after the existing options):

```python
top_k: Annotated[
    int, typer.Option("--top-k", help="Max citation chunks to retrieve (default: 20)")
] = 20,
```

Then find where `query_with_retry` is called in the search command body and pass `top_k=top_k`. Look for the line that calls `search_client.query_with_retry(search_query, ...)` and add `top_k=top_k` to the call.

Run `pytest tests/ -x -q` after changes.
  </action>
  <verify>
1. `grep -n "top_k" src/objlib/search/client.py` shows parameter in query() and query_with_retry()
2. `grep -n "top_k" src/objlib/services/search.py` shows parameter threaded through search()
3. `grep -n "top-k\|top_k" src/objlib/cli.py` shows CLI flag
4. `python -c "from objlib.search.client import GeminiSearchClient; import inspect; sig = inspect.signature(GeminiSearchClient.query); print(sig)"` shows top_k parameter
5. `pytest tests/ -x -q` passes
  </verify>
  <done>
top_k=20 is the default across the entire search pipeline. CLI exposes --top-k flag. SearchService threads it to the Gemini SDK. No regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: TUI citation count, rank display, and scroll hints</name>
  <files>
    src/objlib/tui/widgets/results.py
    src/objlib/tui/app.py
  </files>
  <action>
Update the TUI results display per locked decision #3: flat chunk list (up to 20), rank = chunk index + 1, "N citations retrieved" banner, scroll hint when overflow detected.

**1. ResultItem rank display — results.py**

Modify `ResultItem.__init__()` to accept `total_count: int` and display the rank. The constructor signature becomes:

```python
def __init__(self, citation: Citation, result_index: int, total_count: int) -> None:
```

In the Rich Text display construction, prepend the rank before the filename:

```python
# Line 1: rank + filename
display.append(f"[{result_index + 1} / {total_count}]", style="bold magenta")
display.append("  ")
display.append(display_title, style="bold")
display.append("\n")
```

Store `total_count` as `self.total_count = total_count` for potential later use.

**2. ResultsList citation count banner and scroll hints — results.py**

Update `update_results()` to show the citation count banner and scroll hints:

```python
def update_results(self, citations: list[Citation]) -> None:
    self.remove_children()
    if not citations:
        self.mount(Static("No results found"))
    else:
        # Citation count banner (TUI-09)
        banner = Static(
            f"[bold]{len(citations)} citations retrieved[/bold]",
            id="citation-banner",
        )
        self.mount(banner)

        for i, citation in enumerate(citations):
            self.mount(ResultItem(citation, i, len(citations)))

        # Scroll hint (TUI-09) -- always show when > 3 results
        # (more than 3 citations almost certainly overflows viewport)
        if len(citations) > 3:
            hint = Static(
                "[dim italic]  arrow-up/arrow-down to scroll  |  PgUp/PgDn for pages[/dim italic]",
                id="scroll-hint",
            )
            self.mount(hint)
```

Add CSS for the banner and scroll hint. Add to `ResultsList.DEFAULT_CSS`:

```python
DEFAULT_CSS = """
ResultsList {
    width: 100%;
    height: 1fr;
}
#citation-banner {
    padding: 0 2;
    color: $text-muted;
    text-style: bold;
}
#scroll-hint {
    padding: 0 2;
    color: $text-disabled;
    text-style: italic;
    dock: bottom;
}
"""
```

**3. ObjlibApp._run_search() status bar — app.py**

Update the status bar text in `_run_search()` (around line 257-260) to show citation count consistently:

Change:
```python
count = len(self.results)
truncated_query = query[:30]
self.query_one("#status-bar", Static).update(
    f"{count} results | {truncated_query} | Ctrl+P: Commands"
)
```
To:
```python
count = len(self.results)
truncated_query = query[:30]
self.query_one("#status-bar", Static).update(
    f"{count} citations retrieved | {truncated_query} | Ctrl+P: Commands"
)
```

Run `pytest tests/ -x -q` after changes.
  </action>
  <verify>
1. `grep -n "citations retrieved" src/objlib/tui/widgets/results.py` shows banner text
2. `grep -n "total_count" src/objlib/tui/widgets/results.py` shows rank parameter
3. `grep -n "scroll-hint\|arrow-up" src/objlib/tui/widgets/results.py` shows scroll hint
4. `grep -n "citations retrieved" src/objlib/tui/app.py` shows status bar update
5. `python -c "from objlib.tui.widgets.results import ResultItem, ResultsList; print('Import OK')"` succeeds
6. `pytest tests/ -x -q` passes
  </verify>
  <done>
TUI displays: "N citations retrieved" banner, per-citation rank "[1 / 20]", and scroll hints when results exceed visible area. Status bar shows citation count. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. GeminiSearchClient.query() has top_k=20 default
2. SearchService.search() threads top_k through
3. CLI search has --top-k flag
4. TUI ResultItem shows rank "[N / total]"
5. TUI ResultsList shows "N citations retrieved" banner
6. Scroll hints appear for large result sets
7. All existing tests pass
</verification>

<success_criteria>
Phase 16 SC7: TUI search results display citation count, per-citation rank position, and scroll hints.
TUI-09 requirement fully implemented: top_k=20 default, --top-k CLI flag, citation count display, rank position per citation, scroll discoverability hints.
</success_criteria>

<output>
After completion, create `.planning/phases/16-full-library-upload/16-04-SUMMARY.md`
</output>
