---
phase: 16-full-library-upload
plan: 03
type: execute
wave: 2
depends_on: ["16-01", "16-04"]
files_modified:
  - Canon.json
autonomous: false

must_haves:
  truths:
    - "TUI launches without crash against full ~1,748-file corpus"
    - "Live search returns results with rank display and citation count (TUI-09)"
    - "No '[Unresolved file #N]' appears in any search result"
    - "Browse mode navigates the full library structure"
    - "Canon.json updated to reflect TUI module"
  artifacts:
    - path: "Canon.json"
      provides: "Updated canon reflecting TUI module"
      contains: "tui"
    - path: ".planning/phases/16-full-library-upload/16-03-SUMMARY.md"
      provides: "Phase 07-07 smoke test results"
      contains: "queries recorded verbatim"
  key_links:
    - from: "src/objlib/cli.py"
      to: "src/objlib/tui/__init__.py"
      via: "tui command -> run_tui() with correct default store"
      pattern: "run_tui"
---

<objective>
Execute Phase 07-07: structured manual TUI integration smoke test against the full live ~1,748-file corpus. Verify all Phase 7 success criteria plus TUI-09 enhancements. Update Canon.json.

Purpose: This is the deferred v1.0 TUI smoke test (07-07), now running against the full production corpus -- a far more meaningful test than against the empty/50-file store it was originally planned for. Combined with TUI-09 verification (rank display, citation count, scroll hints).

Output: Structured manual walkthrough results recorded verbatim. Canon.json updated.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-full-library-upload/16-01-SUMMARY.md
@.planning/phases/16-full-library-upload/16-04-SUMMARY.md
@.planning/phases/07-interactive-tui/07-07-PLAN.md
@Canon.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-flight verification and Canon.json update</name>
  <files>
    Canon.json
  </files>
  <action>
**Step 1: Verify TUI imports and service wiring**
```bash
python -c "
from objlib.tui import run_tui, DEFAULT_STORE_NAME
print(f'DEFAULT_STORE_NAME: {DEFAULT_STORE_NAME}')
assert DEFAULT_STORE_NAME == 'objectivism-library', f'Wrong default: {DEFAULT_STORE_NAME}'

from objlib.tui.app import ObjlibApp
from objlib.tui.widgets import NavTree, SearchBar, ResultsList, PreviewPane, FilterPanel
from objlib.tui.providers import ObjlibCommands
print('ALL IMPORTS OK')
"
```

**Step 2: Verify service facade with real database**
```bash
python -c "
import asyncio
from objlib.services import LibraryService
svc = LibraryService('data/library.db')
cats = asyncio.run(svc.get_categories())
print(f'Categories: {len(cats)}')
courses = asyncio.run(svc.get_courses())
print(f'Courses: {len(courses)}')
count = asyncio.run(svc.get_file_count())
print(f'Files: {count}')
"
```

**Step 3: Verify top_k parameter is in place (TUI-09)**
```bash
python -c "
import inspect
from objlib.search.client import GeminiSearchClient
sig = inspect.signature(GeminiSearchClient.query)
print(f'query signature: {sig}')
assert 'top_k' in sig.parameters, 'top_k missing from query()'
print(f'top_k default: {sig.parameters[\"top_k\"].default}')
"
```

**Step 4: Run full test suite**
```bash
pytest tests/ -x -q
```

**Step 5: Update Canon.json**
Read Canon.json. Add `"src/objlib/tui/"` to the `folders` array if not already present. Verify `"src/objlib/services/"` is present. Write updated Canon.json.
  </action>
  <verify>
1. DEFAULT_STORE_NAME == 'objectivism-library'
2. All TUI imports succeed
3. LibraryService returns real data from library.db
4. top_k parameter present in GeminiSearchClient.query() with default 20
5. Test suite passes
6. Canon.json includes tui folder
  </verify>
  <done>Pre-flight checks pass. Canon.json updated. TUI-09 parameters verified. Ready for manual walkthrough.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete TUI application (Phase 7 + TUI-09 enhancements) running against the full ~1,748-file production corpus in the objectivism-library store. This is the Phase 07-07 structured manual walkthrough (locked decision #7).
  </what-built>
  <how-to-verify>
Launch the TUI:
```bash
python -m objlib tui
```

**1. Live search with TUI-09 rank display (TUI-01 + TUI-09):**
Run 5+ diverse queries. For each, record verbatim:
- The query text
- Number of citations returned (banner should show "N citations retrieved")
- First 3 citation titles with their rank display (e.g., "[1 / 20] filename.txt")
- Whether any "[Unresolved file #N]" appears (MUST NOT appear)

Suggested queries:
a) "What is the nature of individual rights?"
b) "Aristotle's influence on Objectivism"
c) "capitalism and morality"
d) "aesthetic theory art Romanticism"
e) "epistemology concept formation"

**2. Browse mode (TUI-02):**
- Click tree nodes to expand categories and courses
- Verify file count badges
- Click a file -- preview shows document text

**3. Three-pane layout (TUI-03):**
- Verify navigation (left), results (center), preview (right)
- Resize terminal narrow (<80 cols) -- layout adjusts
- Resize wide (140+ cols) -- all three panes visible

**4. Filters (TUI-04):**
- Select a category filter -- search re-runs
- Select difficulty level -- results filter
- Clear filters -- full results return

**5. Scroll hints (TUI-09):**
- After a search with many results, verify scroll hint text appears at bottom
- Verify arrow keys scroll through citations
- Verify PgUp/PgDn work

**6. Error handling:**
- If API error occurs: error notification appears, TUI does not crash

**7. Command palette (TUI-08):**
- Ctrl+P opens palette
- Type "synth" -- "Synthesize Results" appears

Record ALL observations verbatim in the SUMMARY.
  </how-to-verify>
  <resume-signal>Type "approved" if TUI meets all criteria (Phase 7 + TUI-09), or describe specific issues. Include the 5+ query results recorded verbatim.</resume-signal>
</task>

</tasks>

<verification>
1. TUI launches without crash
2. 5+ diverse queries return results with rank display and citation count
3. No "[Unresolved file #N]" in any result
4. Browse mode navigates full library structure
5. Filters affect search results
6. Scroll hints visible for large result sets
7. Command palette functional
8. Canon.json updated
9. All test suite passes
</verification>

<success_criteria>
Phase 16 SC4 (reinforced): [Unresolved file #N] absent from all TUI search results (5+ diverse queries).
Phase 16 SC6: Phase 07-07 TUI integration smoke test passes against full corpus. Canon.json updated.
Phase 16 SC7: TUI-09 citation experience (rank, count, scroll hints) verified in manual walkthrough.
</success_criteria>

<output>
After completion, create `.planning/phases/16-full-library-upload/16-03-SUMMARY.md`

CRITICAL: Record ALL query results verbatim -- query text, citation count, citation titles with ranks, any issues observed. This is the Phase 07-07 evidence record.
</output>
