# CLARIFICATIONS-ANSWERED.md

## Phase 16: Full Library Upload ‚Äî Stakeholder Decisions

**Generated:** 2026-02-23
**Mode:** YOLO (balanced strategy)
**Source:** Auto-generated by discuss-phase-ai ‚Äî synthesized from OpenAI gpt-5.2, Gemini Pro, Perplexity

---

## Decision Summary

**Total questions:** 8
**Tier 1 (Blocking):** 4 answered
**Tier 2 (Important):** 2 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

### Q1: How should the orchestrator handle 429 rate limit errors?

**YOLO DECISION: Option A ‚Äî In-place retry for 429s (no FAILED transition)**

**Rationale:**
- Confidence: ‚úÖ All 3 providers agree
- 429 is a client throttle signal, not a file-level failure
- The upload coroutine catches 429 before any FSM transition occurs
- Retry policy: exponential backoff with full jitter, base 1s, max 60s, max 5 attempts
- Only transitions to FAILED if non-429 error or all 5 retry attempts exhausted
- The existing c=10 + asyncio.Semaphore infrastructure is unchanged

**Sub-decisions:**
- Max retries for 429: **5** (consistent with distributed systems best practice for transient errors)
- Jitter type: **full jitter** (random(0, delay)) to prevent thundering herd at c=10

---

### Q2: What defines "success" for the upload?

**YOLO DECISION: Option A ‚Äî Zero non-indexed after complete remediation loop**

**Rationale:**
- Confidence: ‚úÖ All 3 providers agree
- The 5% silent failure rate at 50-file scale (~87 files at full scale) is expected and documented
- Success criterion #1 ("all ~1,748 files have gemini_state='indexed'") is evaluated AFTER the remediation loop
- Remediation sequence: first upload pass ‚Üí store-sync targeted pass ‚Üí downgrade_to_failed on non-searchable ‚Üí retry_failed_file() second pass ‚Üí final state check
- Consistent with Phase 15 store-sync contract (VLID-07 gate)
- A "partial upload + retry" is a normal execution path, not a failure

**Phase gate definition:**
- PASS: `SELECT COUNT(*) FROM files WHERE gemini_state != 'indexed'` = 0 after remediation loop
- FAIL: Any files remain non-indexed after retry pass

---

### Q3: TUI-09 rank position ‚Äî per chunk or per file?

**YOLO DECISION: Option A ‚Äî Flat list per chunk (up to 20 entries)**

**Rationale:**
- Confidence: ‚ö†Ô∏è 2 of 3 providers; consistent with ROADMAP explicit wording
- ROADMAP says "grounding_chunks is ordered by relevance (index 0 = most relevant), so rank communicates importance"
- "Each citation shows its retrieval rank" ‚Äî citation = individual grounding chunk, not a file
- Flat list matches existing citation model in TUI
- Display format per citation: `"[N / 20]  filename ‚Äî snippet"`
- "N citations retrieved" banner at top of results pane (where N = actual count returned, ‚â§ top_k)
- Scroll hint appears when citation list height > results panel viewport height

**Sub-decisions:**
- Visual grouping of same-file citations: **no** (YOLO: keep simple; defer to user feedback)
- Scroll hint format: **"‚Üë/‚Üì to scroll"** appearing as footer when overflow detected

---

### Q4: Assertion 7 --sample-count for Phase 16 checks?

**YOLO DECISION: Option A ‚Äî 20 samples**

**Rationale:**
- Confidence: ‚ö†Ô∏è 2 providers; clear statistical argument
- 20 samples = 1.1% coverage at 1,748 files
- Existing tolerance formula: max(1, 20//5) = 4 misses acceptable (matches confirmed 5-20% query-specificity gap from Phase 15)
- No code change to check_stability.py ‚Äî just pass `--sample-count 20` in all Phase 16 check commands
- Both T=0 and T+4h/T+24h/T+36h checks use --sample-count 20

---

## Tier 2: Important Decisions

### Q5: store-sync timing relative to upload completion?

**YOLO DECISION: Option A ‚Äî 60s cooldown ‚Üí store-sync dry-run ‚Üí check_stability ‚Üí store-sync actual if needed**

**Rationale:**
- Confidence: ‚ö†Ô∏è Consistent with Phase 15 import-to-searchable characterization
- 60s cooldown ensures P95 (10.1s) import-to-searchable lag has resolved before stability check
- Sequence for 16-01 completion:
  1. Upload run completes
  2. Wait 60s
  3. `store-sync --dry-run` to inspect orphan count
  4. `store-sync --actual` if orphans found
  5. `check_stability.py --store objectivism-library --sample-count 20` (T=0)
  6. Record all output verbatim in 16-01-SUMMARY.md
- No automated store-sync during active upload (race condition risk)

---

### Q6: RecoveryCrawler at startup of upload command?

**YOLO DECISION: Option A ‚Äî RecoveryCrawler called automatically at startup**

**Rationale:**
- Confidence: ‚ö†Ô∏è 2 providers; consistent with Phase 10 design intent
- `fsm-upload` command calls `RecoveryCrawler.recover_all()` before starting new upload batch
- Ensures files stuck in `uploading`/`processing` from prior interrupted run are recovered
- Idempotent: no effect if no stuck files
- Confirmed Phase 10 design: RecoveryCrawler is startup recovery mechanism (see STATE.md Phase 10 decisions)

---

## Tier 3: Polish Decisions

### Q7: Phase 07-07 TUI smoke test format?

**YOLO DECISION: Option A ‚Äî Structured manual walkthrough**

**Rationale:**
- Confidence: üîç Project pattern match
- Run 5+ diverse search queries in TUI against full corpus
- Record results verbatim in 16-03-SUMMARY.md
- Assertions: (1) results returned, (2) no `[Unresolved file #N]`, (3) citations show rank (TUI-09), (4) scroll functional, (5) error notification doesn't crash TUI
- Canon.json updated to reflect TUI module after pass
- Automation deferred: personal-use tool; Textual pilot test infrastructure cost not justified

---

### Q8: File count denominator for success criterion #1?

**YOLO DECISION: Option A ‚Äî Record exact count at start of 16-01**

**Rationale:**
- Confidence: üîç Simple verification step
- Run `objlib status` at start of 16-01 execution
- Record the exact UNTRACKED (+ failed from any prior partial runs) count as the denominator
- Document in 16-01-SUMMARY.md: "Denominator: N files (from scanner, UNTRACKED state)"
- Success criterion #1 passes when `SELECT COUNT(*) FROM files WHERE gemini_state != 'indexed'` = 0

---

## Implementation Constraints (from decisions above)

**Upload orchestrator (16-01):**
- RecoveryCrawler.recover_all() at startup (before new batch)
- 429 caught pre-FSM-transition ‚Üí exponential backoff (base 1s, max 60s, jitter, max 5 retries)
- c=10 concurrency (Phase 14 validated)
- After completion: 60s cooldown ‚Üí store-sync dry-run ‚Üí store-sync actual ‚Üí check_stability --sample-count 20

**Stability checks (16-02):**
- All check_stability.py calls: `--store objectivism-library --sample-count 20`
- T=0/T+4h/T+24h/T+36h cadence (Phase 12 protocol)
- Fresh Claude session for each temporal check (/clear before starting ‚Äî same as Phase 12)

**TUI-09 (16-04):**
- `GeminiFileSearchClient.query(top_k=20)` as default
- `--top-k N` CLI override
- Flat chunk list; rank = chunk index + 1; "N citations retrieved" banner
- Scroll hint when citations overflow viewport

**Phase 07-07 (16-03):**
- Manual walkthrough, 5+ diverse queries
- Record verbatim output in 16-03-SUMMARY.md
- Canon.json update after pass

---

## Next Steps

1. ‚úÖ Clarifications answered (YOLO mode)
2. ‚è≠ Proceed to `/gsd:plan-phase 16`
3. üìã Review YOLO decisions before final implementation if needed

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Synthesis sources: OpenAI gpt-5.2, Gemini Pro, Perplexity Sonar Deep Research*
*Generated: 2026-02-23*
