---
phase: 16.5-strategy4-rarest-aspect-exhaustive-audit
plan: 03
subsystem: metadata, audit
model_profile: quality
autonomous: true

requires:
  - phase: 16.5-02
    provides: "0/1,749 misses confirmed with S1→S4a→S4b chain"
provides:
  - "objlib metadata audit exits 0 for all 1,749 files"
  - "All 6+ audit conditions verified PASS post-16.5 fix"
  - "16.5-03-audit-output.txt committed as artifact"
affects: [16.5-04]

goal: |
  Run the full metadata quality audit against all 1,749 indexed files to confirm
  no metadata regressions were introduced and all structural invariants hold.
  This is the required quality gate between the retrievability fix and A7 update.

tech-stack:
  added: []
  patterns:
    - "Run objlib metadata audit with all conditions; parse exit code"
---

# Phase 16.5 Plan 03: Exhaustive Metadata Quality Audit

## Context

After implementing the S4 query fix (Plan 16.5-01) and confirming 0/1749 misses (Plan 16.5-02),
this plan runs the full metadata audit to verify all structural invariants hold.

No document changes were made in Plans 16.5-01 or 16.5-02 (query-side fix only), so the
metadata audit is expected to pass quickly. This plan serves as the required quality gate.

## Locked Decisions

1. **All 1,749 indexed files are in scope** — no exclusions
2. **Audit must exit 0** — any non-zero exit is a gate failure requiring investigation
3. **No metadata changes** — if any condition fails, investigate root cause rather than
   bypassing the gate

## Tasks

### Task 1: Run metadata audit

```bash
python -m objlib metadata audit --db data/library.db
```

Expected output: 6+ conditions all PASS, exit code 0.

Expected to see (per Phase 16.4-02 baseline):
- Condition 1: Files with ai_metadata_status but no extraction result → 0
- Condition 2: Files with failed_validation → 0
- Condition 3: Files with needs_review → 0
- Condition 4: Files indexed without AI metadata → 0
- Condition 5: Files with wrong number of primary_topics → 0
- Condition 6: Indexed non-skipped files without file_primary_topics → 0
- Per-series breakdown: all 9 series at expected coverage

### Task 2: Capture and verify output

Save output:
```bash
python -m objlib metadata audit --db data/library.db \
  > .planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-03-audit-output.txt
echo "Exit code: $?"
```

### Task 3: Spot-check topic_aspects quality for the 12 formerly-failing files

For the 12 files that required S4 to be retrieved, verify their topic_aspects are:
- Non-empty (already confirmed in 16.4 investigation)
- Non-boilerplate (aspects are specific enough to be used as discriminating queries)
- Correctly populated in file_metadata_ai with is_current=1

```bash
python3 -c "
import sqlite3, json
conn = sqlite3.connect('data/library.db')
failures = [
    'ITOE - Class 02-01.txt',
    'ITOE Advanced Topics - Class 09-02.txt',
    'ITOE Advanced Topics - Class 10-02.txt',
    'ITOE Advanced Topics - Class 13-02 - Office Hour.txt',
    'ITOE Advanced Topics - Class 14-01 - Office Hour.txt',
    'ITOE Advanced Topics - Class 14-02 - Office Hour.txt',
    'ITOE - Class 10-01 - Office Hour.txt',
    'Objectivist Logic - Class 03-01.txt',
    'Objectivist Logic - Class 15-02 - Open Office Hour.txt',
    'MOTM_2021-05-16_History-of-the-Objectivist-movement-a-personal-account-part.txt',
    \"Ayn Rand - Atlas Shrugged (1971).txt\",
    \"existence doesn't mean physical existence.txt\",
]
for fname in failures:
    row = conn.execute(
        'SELECT fma.metadata_json FROM files f JOIN file_metadata_ai fma ON fma.file_path = f.file_path AND fma.is_current = 1 WHERE f.file_path LIKE ?',
        (f'%{fname}',)
    ).fetchone()
    if row:
        meta = json.loads(row[0])
        aspects = meta.get('topic_aspects', [])
        print(f'OK ({len(aspects)} aspects): {fname[:60]}')
    else:
        print(f'MISSING METADATA: {fname}')
conn.close()
"
```

All 12 should show "OK" with non-zero aspect count.

## Validation Gates

- [ ] `objlib metadata audit` exits 0
- [ ] All 6+ conditions PASS
- [ ] Per-series breakdown shows same coverage as Phase 16.4-02 baseline
- [ ] 16.5-03-audit-output.txt saved as artifact
- [ ] Spot-check: all 12 formerly-failing files have non-empty topic_aspects

## Commit

```
docs(audit): Phase 16.5-03 metadata quality audit verified (all conditions pass, exit 0)
```
