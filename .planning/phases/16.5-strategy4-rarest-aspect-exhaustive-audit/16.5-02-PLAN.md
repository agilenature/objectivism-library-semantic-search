---
phase: 16.5-strategy4-rarest-aspect-exhaustive-audit
plan: 02
subsystem: audit
model_profile: quality
autonomous: true

requires:
  - phase: 16.5-01
    provides: "S4 strategy in retrievability_audit.py; 12/12 validation passed"
provides:
  - "Exhaustive S1→S4a→S4b audit of all 1,749 files; 0-miss target achieved"
  - "Per-file optimal strategy recorded in results JSON"
  - "Updated 16.5-02-hit-rates.md with comparison to Phase 16.4-03 baseline"
affects: [16.5-03, 16.5-04]

goal: |
  Run the complete retrievability audit for all 1,749 indexed files using the
  S1→S4a→S4b fallback chain. Zero misses required. Any remaining miss after all
  strategies is a gate failure requiring investigation before proceeding.

tech-stack:
  added: []
  patterns:
    - "Fallback chain: S1 miss → try S4a → try S4b → record final result"
    - "Progress file keyed by {file_path}_strategy to enable resume"
---

# Phase 16.5 Plan 02: Exhaustive Retrievability Audit (All 1,749 Files)

## Context

Plan 16.5-01 proved the S4 strategy works for all 12 known structural failures.
This plan runs the full 1,749-file audit with the S1→S4a→S4b chain.

## Locked Decisions

1. **All 1,749 indexed files are tested — NO sampling, NO exclusions** (Episodes, Books, OH all included)
2. **Zero miss tolerance** — any remaining miss is a gate failure
3. **TOP_K = 5** (same as Phase 16.4-03)
4. **Strategy chain: S1 → S4a → S4b** (if S1 hits, skip S4; if S4a hits, skip S4b)
5. **Concurrency = 10** (same as Phase 16.4-03, proven stable at 5,247 calls with 0 errors)
6. **New progress file** (don't reuse Phase 16.4-03 progress — different strategy keys)

## Tasks

### Task 1: Run exhaustive S1 audit (all 1,749 files)

```bash
python scripts/retrievability_audit.py \
  --store objectivism-library \
  --db data/library.db \
  --strategy 1 \
  --progress-file .planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-02-progress.json \
  --concurrency 10
```

Expected: ~20-25 min, ~1,749 API calls. Based on Phase 16.4-03, S1 achieves 96.7% (58 misses).

### Task 2: Run S4a audit on S1 misses

For each file that was a miss under S1, run strategy 4:
```bash
python scripts/retrievability_audit.py \
  --store objectivism-library \
  --db data/library.db \
  --strategy 4 \
  --misses-only  # Only run on files that missed S1 in the current progress file
  --progress-file .planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-02-progress.json \
  --concurrency 10
```

Alternative if `--misses-only` not implemented: run strategy 4 on all files (the progress
file will skip files already found). Then the analysis identifies which S1 misses were
recovered by S4a.

Expected: ~58 additional API calls for S1 misses only.

### Task 3: Run S4b audit on remaining misses

For files that miss both S1 and S4a, run strategy 5 (S4b):
```bash
python scripts/retrievability_audit.py \
  --store objectivism-library \
  --db data/library.db \
  --strategy 5 \
  --misses-only \
  --progress-file .planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-02-progress.json \
  --concurrency 10
```

Expected: ~12-20 additional API calls for files missing S1 AND S4a.

### Task 4: Analyze results and verify 0 misses

Run the built-in analysis of `retrievability_audit.py` to produce:
1. Global hit rate table (S1, S4a, S4b, combined)
2. Per-series breakdown
3. List of any remaining misses (must be 0)

**If 0 misses:** Commit and proceed to Plan 16.5-03.

**If N > 0 misses:** For each remaining miss:
1. Check the file exists in the store (documents.get())
2. Review its topic_aspects and try manual S4 formulations
3. If found manually: add a file-specific query override mechanism
4. If truly unresolvable: document with affirmative evidence (the specific queries tried,
   the actual top-5 returned, why the file's content cannot be discriminated)
5. Gate FAILS until 0 misses OR compelling evidence that a specific file is fundamentally
   irretrievable (extremely rare edge case requiring user decision)

### Task 5: Save hit-rates analysis

Commit the results to:
- `.planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-02-results.json`
- `.planning/phases/16.5-strategy4-rarest-aspect-exhaustive-audit/16.5-02-hit-rates.md`

The hit-rates.md must include:
- Comparison to Phase 16.4-03 baseline (S1: 96.7%, S2: 97.5%, S1→S2: 99.3%)
- New rates: S1 alone, S4a alone, S1→S4a, S1→S4a→S4b
- Per-series breakdown with all strategies
- Confirmation that 0/1,749 misses achieved

## Validation Gates

- [ ] Exhaustive audit of all 1,749 files complete (S1 + S4a + S4b fallback chain)
- [ ] 0/1,749 misses in combined S1→S4a→S4b chain
- [ ] Results JSON saved with per-file strategy breakdown
- [ ] Hit-rates.md saved showing improvement vs. Phase 16.4-03 baseline
- [ ] All 12 known structural failures appear as "found" in results

## Commit

```
docs(audit): Phase 16.5-02 exhaustive retrievability audit results (0/1749 misses with S4)
```
