# Phase 16.5 Root Cause Investigation

**Completed:** 2026-02-25 (inline during Phase 16.4-03 decision checkpoint)

---

## Investigation Summary

After Phase 16.4-03's exhaustive audit found 12 structural failures (S1 OR S2 fallback = 99.3%),
a root cause investigation was conducted to determine whether 0 misses is achievable and what
would be required to reach it.

**Investigation method:** For each of the 12 failing files, test targeted queries using
various formulations of their `topic_aspects` against the live Gemini File Search store.

---

## Key Findings

### Finding 1: All 12 failures are retrievable with the right query

Every one of the 12 structural failures is `STATE_ACTIVE` in the store and CAN be retrieved
via a targeted aspect-based query. There are NO truly unresolvable files.

This disproves the Phase 16.4-03 characterization of these as "fundamental limitations of
semantic search." The limitation was in the query formulation, not the underlying embedding.

### Finding 2: Aspects ARE already in the identity header

The `build_identity_header()` function in `header_builder.py` already includes an `Aspects:` field
(added in commit `350db6c`, Phase 16.3-03 production remediation). All 1,749 files already
have their topic_aspects in their indexed document content.

This rules out "aspects not in document" as the root cause.

### Finding 3: Root cause is query formulation, not document content

The query strategies S1-S3 fail for these files because they dilute the file-unique signal:

| Strategy | Query Form | Why It Fails |
|----------|-----------|--------------|
| S1 (stem-only) | `"What is 'ITOE AT - Class 14-02 - OH' about?"` | Stem has zero semantic weight; all ITOE AT OH files are semantically equivalent to this query |
| S2 (stem+aspects) | `"What is 'stem' about? Topics: aspect1 aspect2 aspect3"` | The "What is about?" preamble overwhelms the aspect signal; compound query shifts embedding toward the generic ITOE topic |
| S3 (topics+course) | `"{course}: {primary_topics}"` | Removes all file-specific signals |

**Strategy 4 (S4) works because:** It uses file-unique aspects as the ENTIRE query with no
generic preamble. This makes the query embedding semantically close to the specific content
of the target file, not to the generic course.

### Finding 4: S4 algorithm is automatable

The following 2-step S4 algorithm reliably finds all 12 failures:

**S4a:** Take the 3 rarest aspects (sorted by corpus frequency, ascending), strip markdown,
concatenate raw (no preamble). This covers 10/12 failures.

**S4b (fallback):** Take rarest aspect + course_dir_name. This covers the remaining 2/12
(ITOE AT 14-02: "Kant ethics ITOE Advanced Topics Office Hour").

---

## All 12 Failures: Confirmed Retrievable

| # | File | Prefix | S4 Query | Rank |
|---|------|--------|----------|------|
| 1 | ITOE - Class 02-01.txt | 2fla52b31ij8 | "active consciousness percepts as base of knowledge sensation vs perception" | 1 |
| 2 | ITOE AT - Class 09-02.txt | 95d5sd3fxvai | "hierarchy of knowledge measurement omission perceptual level concepts narrowing by relation" | 1 |
| 3 | ITOE AT - Class 10-02.txt | 8k0ewovpha1u | "conceptual hierarchy crow epistemology open-ended concepts" | 5 |
| 4 | ITOE AT - Class 13-02 - OH | tugi05603of4 | "measurements omitted in concept formation generic vs. brand sense of philosophy fundamentality of philosophy" | 4 |
| 5 | ITOE AT - Class 14-01 - OH | ktrni4ue3g9u | "Zeno's arrow paradox" | 1 |
| 6 | ITOE AT - Class 14-02 - OH | v7lxy6147dnl | "Kant ethics ITOE Advanced Topics Office Hour" | 1 |
| 7 | ITOE - Class 10-01 - OH | 664iem0u5n4t | "sensory qualities entity perception pre-perceptual awareness" | 5 |
| 8 | OL - Class 03-01.txt | yg8styspnybm | "differentiation between awards rewards prizes" | 2 |
| 9 | OL - Class 15-02 - Open OH | tgxf0vm1zbdv | "Aristotle's solution to change Heraclitus paradox" | 2 |
| 10 | MOTM history part | 1gwiarqoy1hz | "Leonard Peikoff contributions objectivist movement" | 1 |
| 11 | Ayn Rand - Atlas Shrugged | dy8nxqbiu5zd | "mind on strike productivity and parasitism moral sanction of the victim" | 2 |
| 12 | existence file | hzz2tbevracf | "existence axiom scope consciousness as existent attributes widest abstraction" | 1-2 |

---

## Root Cause Statement

**Root cause:** The retrievability audit strategies S1-S3 use query formulations that prevent
file-unique aspect signals from dominating the semantic embedding. Specifically:

1. S1 uses the filename stem, which for class-number files (ITOE AT Class 14-02) and
   semantically homogeneous content (existence book) has no discriminating power
2. S2 prepends "What is '{stem}' about?" â€” this generic phrase shifts the query's semantic
   centroid toward the course/topic cluster rather than the specific file
3. S3 is not viable (removes the filename entirely)

The fix is **Strategy 4 (S4):** query using only the rarest corpus aspects for each file,
with no generic preamble. The corpus-frequency ranking ensures the most discriminating
aspects are prioritized.

---

## Fix Implementation

**No document changes needed.** All 1,749 files already have:
- Correct `file_primary_topics` (8 per file, enforced by Phase 16.4-01/02)
- Correct `topic_aspects` in `file_metadata_ai` (all 1,749, confirmed Phase 16.4-02)
- `Aspects:` field in identity header (added in Phase 16.3-03 commit `350db6c`)

**Code change needed:** Add S4 to `scripts/retrievability_audit.py` and
`scripts/check_stability.py` A7 as a fallback when S1 fails.

**S4 implementation:**
```python
def build_s4_query(file_path, corpus_freq_map, conn):
    """Build S4 query: rarest-aspect-first, no preamble."""
    aspects = get_topic_aspects(file_path, conn)
    course = PurePosixPath(file_path).parent.name
    # Sort by corpus frequency ascending (rarest first)
    sorted_aspects = sorted(aspects, key=lambda a: corpus_freq_map.get(a, 0))
    # Strip markdown
    cleaned = [re.sub(r'[*_`]', '', a) for a in sorted_aspects]
    # S4a: top-3 rarest concatenated
    s4a = ' '.join(cleaned[:3])
    # S4b: rarest aspect + course (disambiguation fallback)
    s4b = f"{cleaned[0]} {course}" if cleaned else None
    return s4a, s4b

def build_corpus_freq_map(conn):
    """Build corpus-wide aspect frequency map. O(n) DB query."""
    freq = {}
    for mj, in conn.execute("SELECT metadata_json FROM file_metadata_ai WHERE is_current=1"):
        try:
            for a in json.loads(mj).get('topic_aspects', []):
                freq[a] = freq.get(a, 0) + 1
        except: pass
    return freq
```

---

*Investigation date: 2026-02-25*
*Investigator: Claude Sonnet 4.6 (inline session during Phase 16.4)*
