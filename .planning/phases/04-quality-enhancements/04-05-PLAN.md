---
phase: 04-quality-enhancements
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - src/objlib/cli.py
  - src/objlib/search/formatter.py
  - src/objlib/search/__init__.py
autonomous: false

must_haves:
  truths:
    - "search command accepts --synthesize, --rerank/--no-rerank, --no-expand, --track-evolution, --mode learn|research, --debug flags"
    - "search --synthesize produces cited synthesis output in the CLI"
    - "search --track-evolution groups results by difficulty tier with optional per-tier synthesis"
    - "session start/list/resume/note/export commands are functional"
    - "glossary suggest/add/list commands manage synonyms.yml"
    - "Passages are cached in SQLite on every search for citation stability"
    - "Query expansion shows expanded terms in CLI output"
  artifacts:
    - path: "src/objlib/cli.py"
      provides: "Enhanced search command with all Phase 4 flags, session and glossary command groups"
      contains: "synthesize"
    - path: "src/objlib/search/formatter.py"
      provides: "Synthesis display, concept evolution display"
      exports: ["display_synthesis", "display_concept_evolution"]
    - path: "src/objlib/search/__init__.py"
      provides: "Updated search package exports"
  key_links:
    - from: "src/objlib/cli.py"
      to: "src/objlib/search/reranker.py"
      via: "rerank_passages call in search command"
      pattern: "rerank_passages"
    - from: "src/objlib/cli.py"
      to: "src/objlib/search/synthesizer.py"
      via: "synthesize_answer call in search command"
      pattern: "synthesize_answer"
    - from: "src/objlib/cli.py"
      to: "src/objlib/search/expansion.py"
      via: "expand_query call in search command"
      pattern: "expand_query"
    - from: "src/objlib/cli.py"
      to: "src/objlib/session/manager.py"
      via: "SessionManager in session commands"
      pattern: "SessionManager"
---

<objective>
Wire all Phase 4 modules into the CLI: enhance the search command with reranking, synthesis, query expansion, concept evolution, and difficulty ordering flags; add session management commands; add glossary management commands; cache passages in SQLite; add synthesis and concept evolution display formatters.

Purpose: This is the integration plan that connects all the independent modules (reranker, synthesizer, sessions, expansion) into a cohesive user experience. Without this wiring, the individual modules are unused library code.
Output: Fully functional enhanced search command with all Phase 4 capabilities accessible via CLI flags and commands.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-quality-enhancements/04-CONTEXT.md
@.planning/phases/04-quality-enhancements/CLARIFICATIONS-ANSWERED.md
@.planning/phases/04-quality-enhancements/04-01-SUMMARY.md
@.planning/phases/04-quality-enhancements/04-02-SUMMARY.md
@.planning/phases/04-quality-enhancements/04-03-SUMMARY.md
@.planning/phases/04-quality-enhancements/04-04-SUMMARY.md
@src/objlib/cli.py
@src/objlib/search/formatter.py
@src/objlib/search/__init__.py
@src/objlib/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced search command with all Phase 4 flags and pipeline</name>
  <files>src/objlib/cli.py</files>
  <action>
Modify the existing `search` function in `cli.py` to add Phase 4 capabilities. This is the most critical integration task.

**Step 1: Add new CLI flags to the search command signature:**

```python
@app.command()
def search(
    ctx: typer.Context,
    query: Annotated[str, typer.Argument(help="Semantic search query")],
    filter: Annotated[list[str] | None, typer.Option("--filter", "-f", help="Metadata filter (field:value)")] = None,
    limit: Annotated[int, typer.Option("--limit", "-l", help="Max results to display")] = 10,
    model: Annotated[str, typer.Option("--model", "-m", help="Gemini model for search")] = "gemini-2.5-flash",
    # Phase 4 flags:
    synthesize: Annotated[bool, typer.Option("--synthesize", help="Generate multi-document synthesis with citations")] = False,
    rerank: Annotated[bool, typer.Option("--rerank/--no-rerank", help="Rerank results with Gemini Flash (default: on)")] = True,
    expand: Annotated[bool, typer.Option("--expand/--no-expand", help="Expand query with philosophical synonyms (default: on)")] = True,
    track_evolution: Annotated[bool, typer.Option("--track-evolution", help="Group results by difficulty progression")] = False,
    mode: Annotated[str, typer.Option("--mode", help="Result ordering: 'learn' (intro-first) or 'research' (pure relevance)")] = "learn",
    debug: Annotated[bool, typer.Option("--debug", help="Write debug log to ~/.objlib/debug.log")] = False,
) -> None:
```

**Step 2: Implement the enhanced search pipeline inside the function body:**

Use deferred imports (matching existing pattern in cli.py) for all Phase 4 modules:

```python
    from objlib.search.expansion import expand_query
    from objlib.search.reranker import rerank_passages, apply_difficulty_ordering
    from objlib.search.synthesizer import synthesize_answer, apply_mmr_diversity
    from objlib.search.formatter import display_synthesis, display_concept_evolution
```

Pipeline order:
1. **Query expansion** (if `expand` is True):
   - Call `expand_query(query)` -> (expanded_query, expansions_applied)
   - Display expansions: `console.print(f"[dim]Expanded:[/dim] {' + '.join(expansions_applied)}")` if any expansions applied
   - Use expanded_query for the search, but keep original query for display

2. **Gemini File Search** (existing code, but use expanded query and request top_k=50):
   - Modify the query_with_retry call to search with the expanded query string
   - The existing GeminiSearchClient doesn't have a top_k parameter exposed. The FileSearch tool's grounding already returns multiple chunks. Keep the existing search call but display up to 50 results (the limit flag is for display, not retrieval).

3. **Extract and enrich citations** (existing code, unchanged)

4. **Cache passages** in SQLite (new):
   - After enriching citations, for each citation with text:
     - Generate passage_id as UUID5 from (file_path + content_hash_of_text) for deterministic IDs
     - Call `db.upsert_passage(passage_id, file_id, content_hash, passage_text)`
   - Use `import uuid` and `import hashlib` for UUID5 and content hash

5. **Reranking** (if `rerank` is True and len(citations) > 1):
   - Call `rerank_passages(state.gemini_client, query, citations)`
   - If reranking returns the same list (failure), show warning: `console.print("[yellow]Reranking unavailable -- showing Gemini ranking[/yellow]")`

6. **Difficulty ordering** (always, after rerank):
   - Call `apply_difficulty_ordering(citations, mode=mode)`

7. **Session event logging** (if active session):
   - Check `SessionManager.get_active_session_id()`
   - If active, create SessionManager with db.conn and add 'search' event with payload: {query, expanded_query, result_count, doc_ids}

8. **Display branch:**
   - If `track_evolution`: call `display_concept_evolution(citations, query, state.gemini_client, console, no_synthesis=False)` (see Task 2)
   - Elif `synthesize`: call synthesis pipeline (see below) and display
   - Else: existing `display_search_results(...)` call

9. **Synthesis display** (if `synthesize`):
   - Apply MMR diversity: `diverse_citations = apply_mmr_diversity(citations)`
   - Call `synthesize_answer(state.gemini_client, query, diverse_citations)`
   - If result is None, show warning and fall back to display_search_results
   - If result is SynthesisOutput, call `display_synthesis(result, diverse_citations, console)`
   - Log 'synthesize' event to session if active

10. **Debug logging** (if `debug`):
    - At start of function, configure a file handler to `~/.objlib/debug.log`
    - Log timing for each pipeline stage
    - Log any errors/warnings

**Step 3: Update _GEMINI_COMMANDS:**

The search command already uses the callback for Gemini init. No change needed here since "search" is already in `_GEMINI_COMMANDS`.

**Important implementation details:**
- Keep ALL existing search behavior intact when no Phase 4 flags are used (backward compatible)
- Use try/except around each Phase 4 stage for graceful degradation
- The `mode` parameter should only accept "learn" or "research" — validate at the start
- The passage caching uses the Database context manager already in the search function (`with Database(state.db_path) as db:`)
  </action>
  <verify>
Run `python -c "from objlib.cli import app; print('CLI loads OK')"` — should import without error (all Phase 4 imports are deferred).
Run `python -m objlib search --help` — should show all new flags (--synthesize, --rerank/--no-rerank, --expand/--no-expand, --track-evolution, --mode, --debug).
  </verify>
  <done>Search command enhanced with complete Phase 4 pipeline: expansion -> search -> cache -> rerank -> difficulty ordering -> synthesis/evolution/standard display. All flags functional. Backward compatible.</done>
</task>

<task type="auto">
  <name>Task 2: Synthesis and concept evolution display formatters + session/glossary commands</name>
  <files>src/objlib/search/formatter.py, src/objlib/search/__init__.py, src/objlib/cli.py</files>
  <action>
**Part A: Add display functions to `src/objlib/search/formatter.py`**

Add two new display functions after the existing ones:

1. **`display_synthesis`**
```python
def display_synthesis(
    synthesis: SynthesisOutput,
    citations: list[Citation],
    console: Console | None = None,
) -> None:
```
Display format:
- If synthesis.bridging_intro: print it as an intro paragraph
- For each claim: print `"- {claim.claim_text} [{claim.citation.file_id}]"` with the quote in dim below: `"  [dim]"{claim.citation.quote}"[/dim]"`
- If synthesis.bridging_conclusion: print as concluding paragraph
- All wrapped in a Panel with title="Synthesis" and border_style="magenta"

Import `SynthesisOutput` from `objlib.search.models` (TYPE_CHECKING only).

2. **`display_concept_evolution`**
```python
def display_concept_evolution(
    citations: list[Citation],
    query: str,
    client: Any | None = None,
    console: Console | None = None,
    no_synthesis: bool = False,
) -> None:
```
Per locked decision (ADVN-01, Q6):
- Group citations by difficulty tier: introductory, intermediate, advanced. Use `citation.metadata.get("difficulty", "")`. Unknown goes to intermediate.
- For each non-empty tier, display a Panel with title=f"{tier.title()} Level" and border_style matching tier (green=intro, yellow=intermediate, red=advanced).
- Show top 3 citations per tier with: title, course, year/week metadata, text excerpt (truncated to 200 chars).
- If client is provided and not no_synthesis: call Gemini Flash for a one-sentence synthesis per tier. Use TierSynthesis model from objlib.search.models. Display the synthesis sentence at the top of each tier panel. Wrap in try/except — on failure, skip synthesis for that tier.
- If no citations in any tier, show "[dim]No results at this level.[/dim]"

**Part B: Update `src/objlib/search/__init__.py`**

Add new exports:
```python
from objlib.search.formatter import display_synthesis, display_concept_evolution
from objlib.search.expansion import expand_query, load_glossary
from objlib.search.reranker import rerank_passages, apply_difficulty_ordering
from objlib.search.synthesizer import synthesize_answer, apply_mmr_diversity, validate_citations
```

Update `__all__` list to include all new exports.

**Part C: Add session and glossary command groups to `src/objlib/cli.py`**

Add after the existing command groups (entities_app):

```python
# Session command group
session_app = typer.Typer(help="Manage research sessions (start, list, resume, note, export)")
app.add_typer(session_app, name="session")

# Glossary command group
glossary_app = typer.Typer(help="Manage query expansion glossary")
app.add_typer(glossary_app, name="glossary")
```

**Session commands** (add at end of cli.py or in a logical section):

1. `session_app.command("start")` — `name: str | None = None, db_path: Path = Path("data/library.db")`. Creates session, prints ID and name. Suggests `export OBJLIB_SESSION={id}` for auto-attach.

2. `session_app.command("list")` — `db_path: Path = Path("data/library.db")`. Table of sessions with id (truncated to 8 chars), name, created, events count.

3. `session_app.command("resume")` — `session_id: str, db_path: Path = Path("data/library.db")`. Uses find_by_prefix for short IDs. Displays timeline via SessionManager.display_timeline.

4. `session_app.command("note")` — `text: str, db_path: Path = Path("data/library.db")`. Requires OBJLIB_SESSION env var. Adds note event.

5. `session_app.command("export")` — `session_id: str, output: Path | None = None, db_path: Path = Path("data/library.db")`. Exports to Markdown file. Prints output path.

**Glossary commands:**

1. `glossary_app.command("list")` — Loads and displays synonyms.yml in a Rich table. Columns: Term, Synonyms.

2. `glossary_app.command("add")` — `term: str, synonyms: list[str]`. Calls expansion.add_term(). Prints confirmation.

3. `glossary_app.command("suggest")` — `term: str, store: str = "objectivism-library-test", db_path: Path = Path("data/library.db")`. Uses Gemini Flash to suggest synonyms for the term. Prints suggestions with instruction: "Run `glossary add {term} syn1 syn2` to accept." This command needs Gemini access — get API key from keyring, create client inline (like view command pattern, not through callback).

All session/glossary commands use deferred imports and the Database context manager. Follow existing cli.py patterns for db_path options and error handling.
  </action>
  <verify>
Run `python -m objlib session --help` — should show start, list, resume, note, export subcommands.
Run `python -m objlib glossary --help` — should show list, add, suggest subcommands.
Run `python -m objlib glossary list` — should display the curated glossary in a table.
Run `python -m objlib search --help` — should show all Phase 4 flags.
  </verify>
  <done>Synthesis and concept evolution displays render properly in Rich. Session commands (start/list/resume/note/export) are functional. Glossary commands (list/add/suggest) are functional. All Phase 4 features wired into CLI.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 4 search enhancement pipeline: query expansion, reranking, difficulty ordering, synthesis with citations, concept evolution tracking, session management, and glossary management.</what-built>
  <how-to-verify>
    1. Run `python -m objlib glossary list` -- verify ~50 Objectivist terms displayed in table
    2. Run `python -m objlib --store objectivism-library-test search "What is the nature of free will?"` -- verify query expansion shows expanded terms, results are reranked
    3. Run `python -m objlib --store objectivism-library-test search "egoism" --mode learn` -- verify introductory results appear first
    4. Run `python -m objlib --store objectivism-library-test search "concept formation" --track-evolution` -- verify results grouped by difficulty tier
    5. Run `python -m objlib --store objectivism-library-test search "What is the relationship between reason and emotion?" --synthesize` -- verify multi-paragraph synthesis with inline citations
    6. Run `python -m objlib session start "Test Session"` -- verify session created
    7. Run `export OBJLIB_SESSION=<session-id>` then run a search -- verify session captures event
    8. Run `python -m objlib session resume <session-id>` -- verify timeline display
    9. Run `python -m objlib session export <session-id>` -- verify Markdown file created
    10. Run `python -m objlib --store objectivism-library-test search "rights" --no-rerank --no-expand` -- verify flags work to disable features
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `python -m objlib search --help` shows all Phase 4 flags
- `python -m objlib session --help` shows all session subcommands
- `python -m objlib glossary list` displays curated glossary
- Search with --synthesize produces cited synthesis or graceful fallback
- Search with --track-evolution groups by difficulty tier
- Session start/resume/note/export workflow completes end-to-end
- Search with --no-rerank --no-expand disables those features
- All existing search behavior unchanged when no Phase 4 flags used
</verification>

<success_criteria>
- All 7 ADVN requirements functional through CLI flags
- Search pipeline: expansion -> retrieval -> passage cache -> rerank -> difficulty order -> display/synthesis/evolution
- Session management: create, list events, resume timeline, add notes, export Markdown
- Glossary management: list terms, add terms, LLM-assisted suggestions
- Graceful degradation at every stage (reranker, synthesis, expansion)
- Backward compatible — default search behavior unchanged
- Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-enhancements/04-05-SUMMARY.md`
</output>
