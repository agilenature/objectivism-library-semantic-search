# CLARIFICATIONS-ANSWERED.md

## Phase 4: Quality Enhancements — Stakeholder Decisions

**Generated:** 2026-02-17
**Mode:** YOLO (balanced strategy — consensus options prioritized)
**Source:** Auto-generated by discuss-phase-ai --yolo

---

## Decision Summary

**Total gray areas:** 9
**Tier 1 (Blocking):** 5 answered
**Tier 2 (Important):** 2 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

---

### Q1: Reranking Model & Hosting (ADVN-02)

**YOLO DECISION: Option A — Gemini Flash LLM-based reranking**

**Rationale:**
- Confidence: ✅ Consensus (Gemini + Perplexity)
- Project uses Gemini exclusively — no new dependencies introduced
- LLM reranker understands Objectivist philosophical terminology natively
- Avoids ~150MB PyTorch/sentence-transformers installation
- Single API call per search (~0.5–2s acceptable for research tool)
- Strategy: Use existing stack, avoid dependency sprawl

**Implementation spec:**
- Send top-50 Gemini grounding passages to Gemini Flash in one structured prompt
- Prompt: "Given this query, rank these passages 1–50 by relevance. Return a JSON array of passage indices."
- Cache reranked order in session event if session is active
- `--rerank` flag (default: on); `--no-rerank` to skip for speed

**Sub-decisions:**
- Q1a (offline requirement): **No** — Gemini Flash call per rerank is acceptable
- Q1b (latency budget): **Up to 3 seconds** for reranking step is acceptable
- Q1c (metadata in reranking): **Yes** — include difficulty and course in reranker context to allow philosophically-aware ordering

---

### Q2: Multi-Document Synthesis Architecture (ADVN-03)

**YOLO DECISION: Option A — opt-in `--synthesize` flag**

**Rationale:**
- Confidence: ✅ Consensus (all providers recommend opt-in)
- Default search experience (current excerpt display) remains unchanged
- Synthesis is a power feature for deep research sessions
- Lower default latency and cost
- Strategy: Preserve existing UX, add capability without disrupting baseline

**Implementation spec:**
- `search "query" --synthesize` triggers the synthesis pipeline
- Pipeline: retrieve top-50 → rerank → MMR diversity filter (max 2 passages per file, prefer distinct courses/weeks) → submit top 5–10 to Gemini Flash for structured synthesis
- Falls back to labeled excerpts if fewer than 5 passages available ("Insufficient sources for synthesis — showing top excerpts")

**Sub-decisions:**
- Q2a (contradiction handling): **Explicit attribution** — "Source A (OPAR Ch.4) states X; Source B (ITOE Lec.3) states Y" — never silently merge conflicting claims
- Q2b (answer length): **150–300 words** target — concise enough for CLI, long enough to be substantive
- Q2c (minimum passages): **5 passages minimum** before synthesis triggers; otherwise fall back

---

### Q3: Inline Citation Enforcement (ADVN-04)

**YOLO DECISION: Option A — exact-quote substring validation**

**Rationale:**
- Confidence: ✅ Consensus (OpenAI explicitly, Gemini aligned)
- Philosophical attribution requires precision — paraphrase is insufficient
- Prevents silent hallucinations in source attribution
- Python post-validation is deterministic and inspectable
- Strategy: Strict enforcement with graceful fallback

**Implementation spec:**
- Each claim: `{claim_text: str, citation: {file_id: str, passage_id: str, quote: str (20–60 words)}}`
- Python validation: quote must be exact substring of stored passage text (after whitespace normalization, case-insensitive)
- On failure: re-prompt once with specific validation errors included
- If second attempt fails: display labeled excerpts with clear attribution (no synthesized claims)
- Use Pydantic model to enforce output schema from Gemini Flash

**Sub-decisions:**
- Q3a (bridging sentences): **Allowed** — transitions and connective sentences not containing factual assertions are exempt from citation requirement
- Q3b (fallback on failure): **Silent fall back to excerpts** — show "Synthesis validation failed — showing source excerpts" message, not hard error
- Q3c (citation reference): **passage_id (stable)** — requires passages table; provides reproducibility for session resume

---

### Q4: Query Expansion Source of Truth (ADVN-05)

**YOLO DECISION: Option A — curated `synonyms.yml` glossary**

**Rationale:**
- Confidence: ✅ Consensus (OpenAI explicitly, Perplexity hybrid approach)
- Philosophical terminology precision is non-negotiable — LLM may conflate Objectivist technical terms
- Human-curated glossary prevents "egoism" expanding to "narcissism" or "reason" to "rationalism"
- Transparent to user (expanded terms shown in CLI output)
- Strategy: Control quality, provide LLM-assisted discovery as tool not automation

**Implementation spec:**
- File: `src/objlib/search/synonyms.yml` (versioned in repo)
- Seed entries (~50 core terms):
  - altruism → [self-sacrifice, selflessness, other-ism, service]
  - rational self-interest → [egoism, ethical egoism, selfishness, self-interest]
  - epistemology → [theory of knowledge, cognition, knowledge]
  - concept formation → [abstraction, unit economy, integration]
  - context dropping → [evasion, stolen concept, context]
  - prime mover → [first cause, uncaused cause, self-moved mover] (with note: reject in Objectivism)
  - (etc., seeded from Phase 6 controlled vocabulary)
- Expansion: automatic by default, limit to top 2 synonyms per matched term
- CLI shows: `[Expanded query: "pride" + "moral ambitiousness" + "self-esteem"]`
- `--no-expand` flag disables expansion for precision searches
- `glossary suggest <term>` command: LLM proposes synonyms, user must run `glossary add` to accept

**Sub-decisions:**
- Q4a (opt-in vs default): **Automatic by default** — expansion improves recall without user effort; `--no-expand` available
- Q4b (single vs multi-word): **Both** — single terms expand if in glossary; multi-word phrases also supported
- Q4c (term weighting): **Yes** — original query term boosted (appears twice in expanded string: `"pride pride moral-ambitiousness self-esteem"`)

---

### Q5: Session Data Model & Resume Semantics (ADVN-07)

**YOLO DECISION: Option A — snapshot semantics, append-only event log**

**Rationale:**
- Confidence: ✅ Consensus (OpenAI + Gemini)
- Research continuity requires seeing what you saw — live rerun breaks session integrity
- SQLite is already in use; append-only is simple and reliable
- Snapshot semantics enable reproducibility and debugging
- Strategy: Reliability over freshness; explicit rerun always available

**Implementation spec:**
- Tables in `library.db`:
  - `sessions (id TEXT PRIMARY KEY, name TEXT, created_at TEXT, updated_at TEXT)`
  - `session_events (id TEXT PRIMARY KEY, session_id TEXT, event_type TEXT, payload_json TEXT, created_at TEXT)`
- Event types: `search` (query + expanded_query + result_doc_ids + passage_ids), `view` (doc_id), `synthesize` (query + synthesis_text + cited_passage_ids), `note` (text)
- Commands:
  - `session start [name]` — create new session, auto-generate name if omitted
  - `session list` — table of sessions with last_updated and event count
  - `session resume <id>` — display saved timeline, offer rerun
  - `session note "text"` — append note to active session
  - `session export <id>` — write Markdown file to current directory
- Auto-attach to active session: if `OBJLIB_SESSION` env var set, append events automatically

**Sub-decisions:**
- Q5a (append-only vs editable): **Append-only** — simpler, auditable; no item deletion
- Q5b (resume behavior): **Display saved timeline** — rerun is explicit user action, creates new events
- Q5c (Markdown export): **Yes** — `session export` writes `.md` file; useful for sharing research notes

---

## Tier 2: Important Decisions

---

### Q6: Concept Evolution Definition (ADVN-01)

**YOLO DECISION: Option A — pedagogical progression by difficulty tier**

**Rationale:**
- Confidence: ⚠️ Recommended (OpenAI)
- Difficulty metadata is consistent (extracted in Phase 6 for all files)
- Year/week is sparser and less meaningful across courses
- Pedagogical grouping matches stated goal: "from intro to advanced"
- Strategy: Use richest available metadata, avoid prerequisite graph engineering in Phase 4

**Implementation spec:**
- `--track-evolution` flag on `search` command
- Groups top results by difficulty tier: Introductory → Intermediate → Advanced
- Shows top 3 passages per tier with metadata (course, year, week)
- Optional: one Gemini Flash synthesis sentence per tier (can be disabled with `--no-synthesis`)
- Display format: labeled tier sections, not interleaved list

**Sub-decisions:**
- Q6a (synthesis per tier): **Yes** — one synthesis sentence per tier by default; `--no-synthesis` to show excerpts only
- Q6b (standalone command): **No** — `search --track-evolution` sufficient; add `concept_track` alias later if users request it

---

### Q7: Difficulty-Aware Ordering Precedence (ADVN-06)

**YOLO DECISION: Option A — two-stage ordering with `--mode learn/research`**

**Rationale:**
- Confidence: ⚠️ Recommended (OpenAI)
- Preserves semantic precision while adding learning-oriented UX
- Mode flags give user explicit control without changing defaults silently
- Strategy: Precision-first with learning overlay, not learning-first

**Implementation spec:**
- Stage 1: Full semantic rerank (all results ordered by relevance)
- Stage 2: Within top-20 window, reorder by `(difficulty_bucket, rerank_score)`:
  - intro → intermediate → advanced
  - Within each bucket: sorted by rerank_score descending
- Default mode: `--mode learn` (difficulty boost active)
- Alternative: `--mode research` (pure rerank score, no difficulty adjustment)
- Mode is per-command flag, not persisted in session

**Sub-decisions:**
- Q7a (default mode): **`--mode learn`** as default — matches the primary use case (self-directed philosophical study)
- Q7b (auto-infer mode): **No** — too ambiguous; user chooses explicitly

---

## Tier 3: Polish Decisions

---

### Q8: Passage Identity & Stable IDs

**YOLO DECISION: Yes — add `passages` table to library.db**

**Rationale:** Required by inline citation enforcement (Q3) and session resume (Q5). UUID-based stability ensures citations remain valid across queries.

**Implementation spec:**
```sql
CREATE TABLE passages (
    passage_id TEXT PRIMARY KEY,      -- UUID4
    file_id TEXT NOT NULL,            -- FK to files.gemini_file_id
    content_hash TEXT,                -- SHA256 of passage_text
    passage_text TEXT NOT NULL,
    source TEXT DEFAULT 'gemini_grounding',
    is_stale BOOLEAN DEFAULT FALSE,
    created_at TEXT,
    last_seen_at TEXT
);
```
- Upsert on each search response (INSERT OR IGNORE, then UPDATE last_seen_at)
- Mark `is_stale=TRUE` when file content_hash changes
- No automatic garbage collection in Phase 4 (defer to Phase 5)

**Sub-decision:**
- Q8a (garbage collection): **Defer** — no GC in Phase 4; revisit in Phase 5 cleanup

---

### Q9: Error Handling & Graceful Degradation

**YOLO DECISION: Graceful degradation with prominent warnings**

**Rationale:** Research tool users prefer seeing something over a hard failure. Explicit warnings ensure users know when they're seeing degraded output.

**Implementation spec:**
- Gemini search failure: retry 3× with exponential backoff (2s, 4s, 8s), then fail with actionable message
- Reranker failure: show yellow warning panel "⚠ Reranking unavailable — showing Gemini ranking" and continue
- Synthesis validation failure (after re-prompt): show yellow warning "⚠ Citation validation failed — showing source excerpts" and display labeled excerpts
- `--debug` flag: write structured JSON log to `~/.objlib/debug.log` (timestamp, stage, duration, errors)
- All failures stored as `error` event in active session

**Sub-decision:**
- Q9a (degradation visibility): **Prominent** — yellow Rich warning panel, not footnote — users should know when output is degraded

---

## Architecture Overview (For Planning)

Based on all YOLO decisions, Phase 4 introduces:

**New files:**
- `src/objlib/search/reranker.py` — Gemini Flash LLM-based reranking
- `src/objlib/search/synthesizer.py` — Multi-document synthesis pipeline
- `src/objlib/search/citations.py` (extend) — Claim-level citation enforcement
- `src/objlib/search/expansion.py` — Query expansion engine
- `src/objlib/search/synonyms.yml` — Curated glossary (~50 Objectivist terms)
- `src/objlib/session/manager.py` — Session CRUD and event logging
- `src/objlib/session/commands.py` — `session start/list/resume/note/export` CLI commands

**Database additions:**
- `passages` table in library.db
- `sessions` table in library.db
- `session_events` table in library.db

**CLI additions:**
- `search --synthesize` — opt-in synthesis mode
- `search --rerank/--no-rerank` — control reranking
- `search --no-expand` — disable query expansion
- `search --track-evolution` — pedagogical progression view
- `search --mode learn|research` — difficulty-aware ordering
- `session start/list/resume/note/export` — session management
- `glossary suggest/add/list` — glossary management

---

## Next Steps

1. ✅ Clarifications answered (YOLO mode)
2. ⏭ Proceed to `/gsd:plan-phase 4`
3. Review YOLO decisions before implementation — particularly Q1 (reranker) and Q4 (glossary seed terms)

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Generated: 2026-02-17*
