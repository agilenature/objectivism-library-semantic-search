---
phase: 07-interactive-tui
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/objlib/tui/widgets/results.py
  - src/objlib/tui/widgets/preview.py
autonomous: true

must_haves:
  truths:
    - "ResultsList displays search citations with title, course, excerpt in a scrollable container"
    - "ResultsList fires ResultSelected message when user clicks or presses Enter on a result"
    - "PreviewPane displays full document text with search term highlighting"
    - "PreviewPane supports citation jump via text-search fallback (find excerpt, scroll to it)"
    - "PreviewPane gracefully degrades when file is unavailable (disk not mounted)"
  artifacts:
    - path: "src/objlib/tui/widgets/results.py"
      provides: "ResultsList widget and ResultItem widget"
      contains: "class ResultsList"
    - path: "src/objlib/tui/widgets/preview.py"
      provides: "PreviewPane widget with highlighting and citation jump"
      contains: "class PreviewPane"
  key_links:
    - from: "src/objlib/tui/widgets/results.py"
      to: "src/objlib/tui/messages.py"
      via: "posts ResultSelected message"
      pattern: "ResultSelected"
    - from: "src/objlib/tui/widgets/preview.py"
      to: "src/objlib/services/library.py"
      via: "reads file content for document display"
      pattern: "get_file_content"
---

<objective>
Build the results list and document preview widgets -- the center and right panes of the TUI.

Purpose: ResultsList renders search results as a scrollable list of citation cards with metadata (TUI-03: results in the middle pane). PreviewPane shows full document text with highlighting and citation jump (TUI-06: click citation to jump to source). Together they complete the three-pane reading experience.

Output: `ResultsList` widget that renders Citation objects and fires selection events. `PreviewPane` widget that displays documents with term highlighting and citation text-search scrolling.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-interactive-tui/07-CONTEXT.md
@.planning/phases/07-interactive-tui/07-RESEARCH.md
@.planning/phases/07-interactive-tui/07-01-SUMMARY.md
@.planning/phases/07-interactive-tui/07-02-SUMMARY.md

Key models to reference:
@src/objlib/models.py (Citation dataclass: index, title, uri, text, document_name, confidence, file_path, metadata)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResultsList widget with citation cards and selection</name>
  <files>src/objlib/tui/widgets/results.py</files>
  <action>
Create `src/objlib/tui/widgets/results.py` with two classes:

**Class `ResultItem(Static)`** -- a single search result card:
1. DEFAULT_CSS:
   ```
   ResultItem {
       padding: 1 2;
       margin: 0 0 1 0;
       background: $surface;
       border: solid $primary-background;
       height: auto;
   }
   ResultItem:hover {
       background: $primary-background;
   }
   ResultItem.-selected {
       border: solid $accent;
       background: $primary-background-darken-1;
   }
   ```

2. Constructor: `__init__(self, citation: Citation, result_index: int)`
   - Store `self.citation = citation` and `self.index = result_index`
   - Build Rich Text display:
     - Line 1: `[bold]{citation.title}[/bold]` (filename)
     - Line 2: Course/difficulty/year from `citation.metadata` if available (e.g., "OPAR | intermediate | 2023")
     - Line 3: First 150 chars of `citation.text` (passage excerpt), dimmed
   - Call `super().__init__(renderable=text_display, id=f"result-{result_index}")`

3. `on_click(self)`: Post `ResultSelected(index=self.index, citation=self.citation)` message upward

4. `on_key(self, event: events.Key)`: If Enter pressed, same as click

**Class `ResultsList(ScrollableContainer)`** -- container for result items:
1. DEFAULT_CSS:
   ```
   ResultsList {
       width: 100%;
       height: 1fr;
   }
   ```

2. Constructor: `__init__(self)` -- `super().__init__(id="results-list")`
   - `self._status = Static("Search the library to see results", id="results-status")`

3. `def update_results(self, citations: list[Citation])`:
   - Remove all current children
   - If no citations: mount status widget with "No results found" text
   - Else: mount a `Static` header showing `f"{len(citations)} results"` then mount `ResultItem(c, i)` for each citation
   - Focus first result if any

4. `def update_status(self, text: str)`:
   - Clear children, mount single `Static(text, id="results-status")`
   - Used for "Searching...", "Error: ...", etc.

5. `def select_index(self, index: int)`:
   - Remove `-selected` class from all ResultItems
   - Add `-selected` class to the ResultItem at the given index
   - Scroll to make it visible

Import `ScrollableContainer` from `textual.containers`, `Static` from `textual.widgets`, `Citation` from `objlib.models`, `ResultSelected` from `objlib.tui.messages`.
  </action>
  <verify>
    `python -c "from objlib.tui.widgets.results import ResultsList, ResultItem; print('ResultsList importable')"` -- passes
    `python -c "from objlib.models import Citation; c = Citation(index=1, title='test.txt', uri=None, text='Sample text', document_name=None, confidence=0.9); from objlib.tui.widgets.results import ResultItem; ri = ResultItem(c, 0); print('ResultItem created')"` -- passes
  </verify>
  <done>ResultsList and ResultItem widgets exist. ResultItem renders citation metadata as a card. ResultsList manages a scrollable list with update/status/selection methods. ResultSelected messages posted on click/enter.</done>
</task>

<task type="auto">
  <name>Task 2: Create PreviewPane widget with highlighting and citation jump</name>
  <files>src/objlib/tui/widgets/preview.py</files>
  <action>
Create `src/objlib/tui/widgets/preview.py` with class `PreviewPane(RichLog)`:

1. **DEFAULT_CSS**:
   ```
   PreviewPane {
       width: 100%;
       height: 1fr;
       background: $surface;
       scrollbar-gutter: stable;
   }
   ```

2. **Constructor**: `__init__(self)` -- `super().__init__(id="preview", highlight=True, markup=True, wrap=True)`
   - `self._current_content: str | None = None` -- raw text for search/scroll
   - `self._current_file_path: str | None = None`

3. **`def show_document(self, content: str, file_path: str, highlight_terms: list[str] | None = None)`**:
   - `self.clear()`
   - Store `self._current_content = content` and `self._current_file_path = file_path`
   - Build Rich `Text` object from content
   - If highlight_terms provided:
     - For each term, call `text.highlight_words([term], style="bold yellow on dark_green")`
   - Call `self.write(text)`

4. **`def show_citation_detail(self, citation: Citation)`**:
   - `self.clear()`
   - Build Rich Panel with:
     - Title: citation.title (filename)
     - Body: citation.text (full passage)
     - Metadata table: course, year, difficulty, topics from citation.metadata
   - Call `self.write(panel)`
   - Store `self._current_content = None` (no full document loaded yet)

5. **`def scroll_to_citation(self, citation_text: str)`**:
   - Text-search fallback implementation (per CONTEXT.md decision):
   - If `self._current_content` is None: return (no document loaded)
   - `pos = self._current_content.lower().find(citation_text.lower()[:100])`
   - If pos >= 0:
     - Estimate line number: `line_number = self._current_content[:pos].count('\n')`
     - `self.scroll_to(y=line_number, animate=True)`
   - If pos < 0: `self.write(Text("[Citation excerpt not found in document]", style="dim italic"))` appended at bottom

6. **`def show_placeholder(self, message: str = "Select a result to preview")`**:
   - `self.clear()`
   - `self.write(Text(message, style="dim italic"))`
   - `self._current_content = None`

7. **`def show_unavailable(self)`**:
   - `self.clear()`
   - `self.write(Text("Document not available (disk not mounted?)\n\nMetadata and search results are still accessible.", style="dim italic"))`
   - Handles graceful degradation per Canon rule #11 and research open question #4

Import `RichLog` from `textual.widgets`, `Text` from `rich.text`, `Panel` from `rich.panel`, `Table` from `rich.table`, `Citation` from `objlib.models`.
  </action>
  <verify>
    `python -c "from objlib.tui.widgets.preview import PreviewPane; print('PreviewPane importable')"` -- passes
    `python -c "from objlib.tui.widgets.preview import PreviewPane; p = PreviewPane(); print(p.id)"` -- prints "preview"
  </verify>
  <done>PreviewPane widget exists with document display, search term highlighting, citation jump via text-search fallback, citation detail view, placeholder state, and graceful degradation for unavailable files.</done>
</task>

</tasks>

<verification>
1. `python -c "from objlib.tui.widgets.results import ResultsList; from objlib.tui.widgets.preview import PreviewPane; print('Both widgets importable')"` -- passes
2. `grep 'ResultSelected' src/objlib/tui/widgets/results.py` -- found (message posting)
3. `grep 'scroll_to_citation' src/objlib/tui/widgets/preview.py` -- found (text-search fallback)
4. `grep 'show_unavailable' src/objlib/tui/widgets/preview.py` -- found (graceful degradation)
5. Existing tests still pass: `pytest tests/ -x -q`
</verification>

<success_criteria>
- ResultsList renders Citation objects as styled cards with metadata
- ResultItem posts ResultSelected on click/enter
- PreviewPane displays documents with keyword highlighting
- Citation jump uses text-search fallback (finds excerpt, scrolls to line)
- Preview gracefully degrades when file unavailable
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-interactive-tui/07-04-SUMMARY.md`
</output>
