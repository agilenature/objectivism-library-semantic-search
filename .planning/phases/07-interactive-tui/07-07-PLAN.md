---
phase: 07-interactive-tui
plan: 07
type: execute
wave: 5
depends_on: ["07-06"]
files_modified:
  - src/objlib/tui/app.py
  - Canon.json
autonomous: false

must_haves:
  truths:
    - "`objlib tui` launches an interactive terminal interface with live search"
    - "Browse mode displays navigable tree with categories -> courses -> files"
    - "Three-pane layout shows navigation, results, and preview simultaneously"
    - "Filters provide interactive selection for category, difficulty, course"
    - "Search history accessible with arrow keys"
    - "Document viewer shows text with search term highlighting"
    - "Citation jump scrolls to relevant excerpt in document"
    - "TUI responds to terminal resize (3-pane -> 2-pane -> stacked)"
    - "Ctrl+P opens command palette with all major actions"
  artifacts:
    - path: "src/objlib/tui/app.py"
      provides: "Complete TUI application"
      contains: "class ObjlibApp"
    - path: "src/objlib/services/__init__.py"
      provides: "Services facade"
      contains: "SearchService"
  key_links:
    - from: "src/objlib/cli.py"
      to: "src/objlib/tui/__init__.py"
      via: "tui command -> run_tui()"
      pattern: "run_tui"
---

<objective>
Final integration testing, bug fixes, and Canon.json update for the complete TUI.

Purpose: Verify the TUI works end-to-end with the real library database and Gemini API. Fix any integration issues discovered during live testing. Update Canon.json to reflect the new TUI module.

Output: A polished, tested TUI application with all Phase 7 success criteria met.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-interactive-tui/07-CONTEXT.md
@.planning/phases/07-interactive-tui/07-06-SUMMARY.md
@Canon.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration smoke test and bug fixes</name>
  <files>
    src/objlib/tui/app.py
  </files>
  <action>
Run a series of integration checks against the actual codebase:

1. Verify all imports resolve without errors:
   ```
   python -c "from objlib.tui import run_tui; from objlib.tui.app import ObjlibApp; from objlib.tui.widgets import NavTree, SearchBar, ResultsList, PreviewPane, FilterPanel; from objlib.tui.providers import ObjlibCommands; print('ALL IMPORTS OK')"
   ```

2. Verify service facade works with real database:
   ```
   python -c "
   import asyncio
   from objlib.services import LibraryService
   svc = LibraryService('data/library.db')
   cats = asyncio.run(svc.get_categories())
   print(f'Categories: {len(cats)}')
   courses = asyncio.run(svc.get_courses())
   print(f'Courses: {len(courses)}')
   count = asyncio.run(svc.get_file_count())
   print(f'Files: {count}')
   "
   ```

3. Verify Textual can instantiate the app (headless):
   ```
   python -c "
   from objlib.tui.app import ObjlibApp
   app = ObjlibApp(None, None, None)
   print(f'App type: {type(app).__name__}')
   print(f'CSS length: {len(app.CSS)}')
   print(f'Bindings: {len(app.BINDINGS)}')
   "
   ```

4. Run all existing tests to confirm no regressions: `pytest tests/ -x -q`

5. Fix any import errors, missing attributes, or wiring issues discovered in steps 1-4. Common issues to watch for:
   - Circular imports between tui modules
   - Missing `__init__.py` files
   - Textual API mismatches (check method signatures against v5.x)
   - Widget ID conflicts (duplicate IDs)
   - Reactive property initialization order issues

6. Update Canon.json:
   - Add `"src/objlib/tui/"` to the `folders` array (it's a public-facing module, should be indexed)
   - Verify `"src/objlib/services/"` is already in folders (should be from 06.3-08)
  </action>
  <verify>
    All import checks pass. Service facade returns real data from library.db. All existing tests pass. Canon.json updated.
  </verify>
  <done>All integration checks pass. No import errors. Services return real data. Tests green. Canon.json reflects TUI module.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Interactive TUI (Phase 7) with:
- Live search with 300ms debounce and auto-cancellation
- Three-pane layout (navigation / results / preview)
- Category/course/file tree navigation
- Interactive filters (category, difficulty, course)
- Document preview with search term highlighting
- Citation text-search jump
- Search history (up/down arrows)
- Command palette (Ctrl+P)
- Responsive layout (resize terminal to test)
- Session save/load
- Bookmarks
  </what-built>
  <how-to-verify>
1. Launch the TUI:
   ```
   python -m objlib tui
   ```

2. **Live search (TUI-01):**
   - Type "What is the nature of rights?" -- results should appear after brief delay
   - Type quickly -- no flicker, only final query executes
   - Press Up arrow -- previous query restored

3. **Browse (TUI-02):**
   - Click on tree nodes to expand categories and courses
   - Verify file count badges next to each category/course
   - Click a file -- preview shows document text

4. **Three-pane layout (TUI-03):**
   - Verify navigation on left, results in center, preview on right
   - Resize terminal narrow (<80 cols) -- should stack vertically
   - Resize wide (140+ cols) -- should show all three panes

5. **Filters (TUI-04):**
   - Select a category from filter dropdown -- search re-triggers
   - Select a difficulty level -- results filter
   - Clear filters -- full results return

6. **Session & Bookmarks (TUI-05):**
   - Press Ctrl+P, type "New Session" -- session started notification
   - Press Ctrl+P, type "Bookmark" -- current document bookmarked
   - Press Ctrl+P, type "Save Session" -- session saved notification

7. **Document viewer (TUI-06):**
   - Click a search result -- document loads in preview
   - Search terms highlighted in document text
   - Scrollable document

8. **Command palette (TUI-08):**
   - Ctrl+P -- palette opens with fuzzy search
   - Type "synth" -- "Synthesize Results" appears
   - Type "shortcuts" -- shows keyboard help

9. **Error handling:**
   - If disk not mounted: preview shows "Document not available" message
   - If API error: error notification appears, TUI doesn't crash
  </how-to-verify>
  <resume-signal>Type "approved" if TUI meets Phase 7 success criteria, or describe specific issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. `python -m objlib tui` launches without crash
2. Live search returns results from Gemini
3. Tree navigation shows library structure
4. Filter changes affect search results
5. Document preview works with highlighting
6. Ctrl+P command palette is functional
7. Responsive layout changes on resize
8. All existing tests pass
</verification>

<success_criteria>
Phase 7 success criteria (from ROADMAP.md):
1. Running `objlib tui` launches an interactive terminal interface with live search input that updates results as you type
2. Browse mode displays a navigable tree view (categories -> courses -> files) with keyboard controls and file count badges
3. The interface uses split-pane layout with search/navigation on the left, results in the middle, and document preview on the right
4. Interactive filters provide checkboxes/selectors for category, difficulty, year ranges
5. TUI preserves search history, allows bookmarking, can save/load research sessions
6. Document viewer supports scrolling, search term highlighting, and citation linking
7. TUI supports both keyboard shortcuts and mouse interaction
8. All existing CLI functionality accessible through command palette
</success_criteria>

<output>
After completion, create `.planning/phases/07-interactive-tui/07-07-SUMMARY.md`
</output>
