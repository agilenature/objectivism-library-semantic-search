---
phase: 07-interactive-tui
plan: 06
type: execute
wave: 4
depends_on: ["07-05"]
files_modified:
  - src/objlib/tui/app.py
  - src/objlib/tui/providers.py
autonomous: true

must_haves:
  truths:
    - "Layout responds to terminal resize: 3-pane at 140+, 2-pane at 80-139, stacked at <80 columns"
    - "Ctrl+P opens command palette with fuzzy-searched commands for all major TUI actions"
    - "Bookmarks can be toggled via command palette or keyboard shortcut"
    - "Session save/load works through command palette and keyboard shortcuts"
    - "Status bar reflects current mode, result count, and active filters"
  artifacts:
    - path: "src/objlib/tui/providers.py"
      provides: "ObjlibCommands provider for CommandPalette"
      contains: "class ObjlibCommands"
    - path: "src/objlib/tui/app.py"
      provides: "Responsive on_resize handler and session/bookmark actions"
      contains: "on_resize"
  key_links:
    - from: "src/objlib/tui/app.py"
      to: "src/objlib/tui/providers.py"
      via: "COMMANDS class set includes ObjlibCommands"
      pattern: "ObjlibCommands"
    - from: "src/objlib/tui/providers.py"
      to: "src/objlib/tui/app.py"
      via: "provider.app.run_action() calls app action methods"
      pattern: "run_action"
---

<objective>
Add responsive layout, command palette, bookmark management, and session save/load -- completing the TUI polish features.

Purpose: This plan delivers the remaining TUI requirements: responsive layout (TUI-03 width adaptation), command palette (TUI-08 all CLI functionality accessible), bookmarks (TUI-05), and session management (TUI-05). After this plan, the Phase 7 TUI is feature-complete.

Output: Responsive three-breakpoint layout. Command palette with fuzzy search over all actions. Bookmark toggle and list. Session save/load through the TUI.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-interactive-tui/07-CONTEXT.md
@.planning/phases/07-interactive-tui/07-RESEARCH.md
@.planning/phases/07-interactive-tui/07-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommandPalette provider and add responsive layout handler</name>
  <files>
    src/objlib/tui/providers.py
    src/objlib/tui/app.py
  </files>
  <action>
1. Create `src/objlib/tui/providers.py` with class `ObjlibCommands(Provider)`:
   - Import `Provider, Hit, Hits` from `textual.command`
   - Import `partial` from `functools`

   - Define `COMMANDS` dict mapping display names to App action method names:
     ```python
     COMMANDS = {
         "Search Library": "focus_search",
         "Clear Search": "clear_search",
         "Toggle Navigation Panel": "toggle_nav",
         "Browse by Category": "browse_categories",
         "Browse by Course": "browse_courses",
         "Reset Filters": "reset_filters",
         "Bookmark Current Document": "toggle_bookmark",
         "View Bookmarks": "show_bookmarks",
         "New Session": "new_session",
         "Save Session": "save_session",
         "Load Session": "load_session",
         "Export Session": "export_session",
         "Synthesize Results": "synthesize_results",
         "Toggle Fullscreen Preview": "toggle_fullscreen_preview",
         "Show Keyboard Shortcuts": "show_shortcuts",
     }
     ```

   - `async def search(self, query: str) -> Hits`:
     - Use `self.matcher(query)` for fuzzy matching
     - For each command name/action, compute score via `matcher.match(name)`
     - If score > 0: `yield Hit(score, matcher.highlight(name), partial(self.app.run_action, action))`

2. Update `src/objlib/tui/app.py`:

   **Register CommandPalette provider:**
   - Add class attribute: `COMMANDS = App.COMMANDS | {ObjlibCommands}`
   - Import `ObjlibCommands` from `objlib.tui.providers`

   **Responsive layout -- `on_resize(self, event: events.Resize)`:**
   - Constants: `WIDE_THRESHOLD = 140`, `MEDIUM_THRESHOLD = 80`
   - Get width from `event.size.width`
   - Remove all layout classes: `self.remove_class("layout-wide", "layout-medium", "layout-narrow")`
   - Apply appropriate class based on width:
     - `>= WIDE_THRESHOLD`: `self.add_class("layout-wide")`
     - `>= MEDIUM_THRESHOLD`: `self.add_class("layout-medium")` -- hides nav pane
     - `< MEDIUM_THRESHOLD`: `self.add_class("layout-narrow")` -- stacks panes vertically
   - CSS rules for these classes already exist from 07-02. Verify they work. If medium layout needs adjustment (e.g., filter panel moves to a different position), adjust the CSS.

   **Bookmark actions:**
   - `action_toggle_bookmark(self)`:
     - Get current preview file_path from PreviewPane._current_file_path
     - If no file loaded: `self.notify("No document to bookmark", severity="warning"); return`
     - Check if already bookmarked: search `self.bookmarks` list
     - If yes: remove from list
     - If no: add `Bookmark(file_path=..., filename=...)`
     - Log bookmark event to session: `await self.session_service.add_event(self.active_session_id, "bookmark", {"file_path": ..., "filename": ...})`
     - Notify user: `self.notify("Bookmarked" or "Bookmark removed")`

   - `action_show_bookmarks(self)`:
     - Update ResultsList with bookmark entries (show bookmarked files as results)

   **Session actions:**
   - `action_new_session(self)`:
     - Create session via `await self.session_service.create_session()`
     - Set `self.active_session_id = session_id`
     - Notify: `self.notify(f"Session started: {session_id[:8]}")`

   - `action_save_session(self)`:
     - If no active session: create one first
     - Save current filter state as note event: `await self.session_service.add_event(session_id, "note", {"type": "filter_state", "filters": self.active_filters.__dict__})`
     - Save bookmarks as note event: `await self.session_service.add_event(session_id, "note", {"type": "bookmarks", "bookmarks": [asdict(b) for b in self.bookmarks]})`
     - Notify: `self.notify("Session saved")`

   - `action_load_session(self)`:
     - List sessions via `await self.session_service.list_sessions()`
     - If no sessions: `self.notify("No sessions to load", severity="warning"); return`
     - For now: load the most recent session (full session picker deferred to future enhancement)
     - Get events: `events = await self.session_service.get_events(session_id)`
     - Restore bookmarks from the last "bookmarks" note event
     - Restore filters from the last "filter_state" note event
     - Restore search history from search events
     - Set `self.active_session_id = session_id`
     - Notify: `self.notify(f"Session loaded: {session.name}")`

   - `action_synthesize_results(self)`:
     - If no results or fewer than 2: `self.notify("Need at least 2 results to synthesize", severity="warning"); return`
     - Call `result = await self.search_service.synthesize(self.query, self.results)`
     - Display synthesis output in preview pane

   **Status bar updates:**
   - Create a `_update_status_bar(self)` method that builds status text from:
     - Session name (if active)
     - Active filter count
     - Bookmark count
     - Current layout mode
   - Call from relevant watchers (watch_active_session_id, watch_active_filters, watch_bookmarks)

   **Additional action stubs** for command palette completeness:
   - `action_browse_categories(self)`: focus nav tree, expand categories
   - `action_browse_courses(self)`: focus nav tree, expand courses
   - `action_reset_filters(self)`: call FilterPanel.reset_filters()
   - `action_export_session(self)`: placeholder -- notify "Export coming soon" (or implement via SessionManager.export_markdown if available)
   - `action_toggle_fullscreen_preview(self)`: toggle CSS class that hides nav + results panes
   - `action_show_shortcuts(self)`: show bindings in preview pane via self.notify or RichLog
  </action>
  <verify>
    1. `python -c "from objlib.tui.providers import ObjlibCommands; print('Provider importable')"` -- passes
    2. `python -c "from objlib.tui.app import ObjlibApp; assert hasattr(ObjlibApp, 'COMMANDS'); print('COMMANDS registered')"` -- passes
    3. `grep 'on_resize' src/objlib/tui/app.py` -- found
    4. `grep 'action_toggle_bookmark\|action_save_session\|action_load_session' src/objlib/tui/app.py` -- all found
    5. `grep 'ObjlibCommands' src/objlib/tui/app.py` -- found in COMMANDS set
    6. Existing tests still pass: `pytest tests/ -x -q`
  </verify>
  <done>Command palette provides fuzzy-searchable access to all TUI actions. Responsive layout switches at 140/80 col breakpoints. Bookmarks can be toggled and viewed. Sessions can be created, saved, and loaded. Synthesis available through command palette. Status bar shows session/filter/bookmark state.</done>
</task>

</tasks>

<verification>
1. `python -c "from objlib.tui.providers import ObjlibCommands; print(len(ObjlibCommands.COMMANDS), 'commands registered')"` -- shows 15 commands
2. `grep -c 'action_' src/objlib/tui/app.py` -- 10+ action methods
3. `grep 'WIDE_THRESHOLD\|MEDIUM_THRESHOLD' src/objlib/tui/app.py` -- responsive thresholds present
4. `grep 'bookmark' src/objlib/tui/app.py` -- bookmark logic present
5. `grep 'session' src/objlib/tui/app.py` -- session logic present
6. Existing tests still pass: `pytest tests/ -x -q`
</verification>

<success_criteria>
- Ctrl+P opens command palette with 15+ fuzzy-searchable commands
- Terminal resize triggers layout mode switch (3-pane/2-pane/stacked)
- Bookmarks toggleable via shortcut or command palette
- Session save persists search history, filters, bookmarks
- Session load restores state
- Synthesis accessible via command palette
- Status bar shows current state
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-interactive-tui/07-06-SUMMARY.md`
</output>
