# CLARIFICATIONS-ANSWERED.md

## Phase 11: Wave 3 ‚Äî display_name Stability and Import Reliability

**Generated:** 2026-02-20
**Mode:** YOLO (balanced strategy ‚Äî synthesis recommendations)
**Source:** Auto-generated by meta-gsd:discuss-phase-ai --yolo

---

## Decision Summary

**Total questions:** 6
**Tier 1 (Blocking):** 3 answered
**Tier 2 (Important):** 2 answered
**Tier 3 (Polish):** 1 answered

---

## Tier 1: Blocking Decisions

### Q1: What counts as "SDK source evidence" for display_name?

**YOLO DECISION:** **Option B ‚Äî SDK inspection + round-trip verification**

**Rationale:**
- Confidence level: ‚úÖ Consensus (both providers rejected SDK-only)
- HOSTILE distrust stance requires positive evidence of API behavior, not just client code behavior
- Round-trip is cheap: 10 test files, string comparison ‚Äî trivial to add to the spike
- If API normalizes display names, we discover it here rather than in Phase 12 with 1,748 files

**Implementation specifics:**
1. Locate installed google-genai package: `python -c "import google.genai; print(google.genai.__file__)"`
2. Find the `display_name` parameter in the document import/upload code path
3. Record: file path, line number, and the parameter name exactly
4. Run 10 round-trip tests: compare `submitted_display_name == returned_display_name` (case-sensitive)

**Sub-decision on normalization:**
If round-trip reveals any mismatch ‚Üí SC1 answer becomes "display_name IS modified by API; normalization rule is [X]." The gate still PASSES if the normalization is documented and deterministic. Phase 12 must pre-apply the normalization before DB storage.

---

### Q2: Definition of "visible" for lag measurement

**YOLO DECISION:** **Option A ‚Äî stop when document appears in list_store_documents() (any state)**

**Rationale:**
- Confidence level: ‚úÖ Project-team aligned, both providers' FSM analysis supports this
- The FSM transition to INDEXED is triggered by "we can capture gemini_store_doc_id," not "document is fully embedded"
- `list_store_documents()` presence = we have the doc ID = FSM can record it
- Searchability gate is covered by Phase 12 SC5 (`check_stability.py` STABLE)
- If the API exposes a state field per document, record it in the measurement data but don't block on it

**Measurement protocol:**
- Start timer: immediately after `documents.import_()` returns (wall clock, `time.perf_counter()`)
- Poll with exponential backoff: initial=0.5s, factor=1.5, max_interval=10s
- Stop timer: first poll where the document's `name` appears in `list_store_documents()` results
- Record P50/P95/P99 across all 10+ test files

---

### Q3: PROCESSING‚ÜíINDEXED trigger strategy

**YOLO DECISION:** **Option A ‚Äî non-blocking background polling, no new FSM states**

**Rationale:**
- Confidence level: ‚úÖ Consensus (Gemini and Perplexity both recommended this)
- Non-blocking: upload pipeline continues immediately after `import_()` returns
- FSM enters PROCESSING state; background poller drives PROCESSING‚ÜíINDEXED
- No new VERIFYING state ‚Äî PROCESSING semantically covers "waiting for visibility confirmation"
- Consistent with Phase 10 write-ahead intent pattern

**Polling parameters (to be validated by lag measurement in Phase 11):**
- Initial interval: 0.5 seconds
- Backoff factor: 1.5
- Max interval: 10 seconds
- Absolute timeout: 300 seconds (5 minutes) ‚Üí PROCESSING‚ÜíFAILED on timeout
- Recovery: existing RecoveryCrawler handles FAILED state on startup

**Phase 11 deliverable:** The plan must include a spike that validates these parameters against the measured lag data and either confirms them or proposes adjusted values.

---

## Tier 2: Important Decisions

### Q4: P99 lag threshold for Phase 11 gate

**YOLO DECISION:** **Option C for gate (no threshold) + Option B for timeout (5 minutes)**

**Rationale:**
- Confidence level: ‚ö†Ô∏è Hybrid (Gemini was stricter; Perplexity more pragmatic)
- Phase 11 gate passes when empirical characterization is complete and documented ‚Äî not on hitting a latency target
- We cannot set a meaningful threshold before measuring; Gemini's 30s threshold was based on expected behavior, not measured data
- The 5-minute polling timeout is a hard engineering constraint, not a measurement gate
- If measured P99 > 60 seconds for small .txt files, document as risk for Phase 12 planning

**Phase 11 report must include:**
- P50, P95, P99 latency values (absolute)
- File sizes tested (range in KB)
- Whether any correlation between file size and lag was observed
- Recommended polling timeout for Phase 12 based on P99

---

### Q5: PROCESSING state error handling

**YOLO DECISION:** **Option A ‚Äî PROCESSING ‚Üí FAILED, reuse existing RecoveryCrawler**

**Rationale:**
- Confidence level: ‚ö†Ô∏è Gemini primary, fully consistent with Phase 10 design
- Phase 10 explicitly designed FAILED‚ÜíUNTRACKED escape for this purpose
- No new FSM states; RecoveryCrawler already handles FAILED recovery on startup
- Record the error type for observability (timeout vs API-reported failure)

**Two trigger conditions for PROCESSING‚ÜíFAILED:**
1. `list_store_documents()` returns document with API error state (if exposed)
2. Polling absolute timeout (5 minutes) exceeded with no visibility

**Error recording:** Store error type string in `gemini_state_error` column (add to schema if not present) or in `metadata_json` ‚Äî to be decided during plan writing.

---

## Tier 3: Polish

### Q6: display_name normalization handling

**YOLO DECISION:** **Option A ‚Äî document normalization rule if detected; pre-apply in Phase 12**

**Rationale:**
- Confidence level: üîç Contingency only
- If SC1 round-trip passes (exact string match), this decision is moot
- If normalization is detected: record the rule, Phase 12 upload must pre-apply it before DB storage
- No code changes needed in Phase 11 spike itself

---

## Phase 11 Spike Design (Summary)

Based on all decisions above, Phase 11 consists of two plans:

**Plan 11-01:** SDK source inspection + import lag measurement spike
- Locate `display_name` parameter in google-genai SDK source
- Run round-trip verification (10+ files, exact string equality check)
- Measure import-to-visible lag with exponential backoff polling
- Record P50/P95/P99; test files of varying sizes
- Document any display_name normalization discovered

**Plan 11-02:** PROCESSING‚ÜíINDEXED trigger strategy decision and documentation
- Analyze lag data from 11-01
- Validate or adjust polling parameters (0.5s start, 1.5x factor, 10s max, 5min timeout)
- Write decision document with data justification
- Confirm strategy: non-blocking polling, PROCESSING‚ÜíFAILED on timeout
- Document: no new FSM states needed

**Gate criteria (BLOCKING for Phase 12):**
- SC1: SDK source file/line documented + round-trip pass/fail recorded
- SC2: P50/P95/P99 latencies measured and documented
- SC3: Strategy committed with data-justified rationale

---

*Auto-generated by meta-gsd:discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Generated: 2026-02-20*
