# CLARIFICATIONS-ANSWERED.md

## Phase 16.3: Gemini File Search Retrievability Research ‚Äî Stakeholder Decisions

**Generated:** 2026-02-24
**Mode:** YOLO (balanced strategy ‚Äî synthesis recommendations applied)
**Source:** Auto-generated by discuss-phase-ai --yolo
**Phase 16.2 achievements incorporated:** All 1,885 files satisfy invariant; MOTM 468/468, Other-stem 443/443 at 100% `primary_topics`; metadata ready for H1 injection

---

## Decision Summary

**Total questions:** 7
**Tier 1 (Blocking):** 2 answered
**Tier 2 (Important):** 3 answered
**Tier 3 (Polish):** 2 answered

---

## Tier 1: Blocking Decisions

### Q1: Primary Fix Target

**YOLO DECISION:** **Option A ‚Äî H1 metadata header injection as primary path, with Option C (H4 fallback for Category B) if H1 proves insufficient for generic MOTM files**

**Rationale:**
- Confidence: ‚úÖ Consensus (both Gemini Pro and Perplexity)
- H1 fixes real user retrievability, not just the test instrument
- Phase 16.2 completion means all `primary_topics` are populated in SQLite ‚Äî the metadata for headers is ready with zero additional work
- H4 (document_name exact-match) may be used to SUPPLEMENT A7 for files where semantic discrimination is genuinely impossible (e.g., generic MOTM with common topics), but cannot replace semantic query as the primary assertion
- Strategy: Confirm/falsify H1 in 16.3-01 spike first; design 16.3-02 intervention based on confirmed root cause

**Sub-decisions:**
- SC1 scope: 16.3-01 spike explicitly tests H4 availability (check if `retrieved_context.document_name` is populated in live responses) as part of the falsification protocol ‚Äî confirms whether H4 is even viable before committing to it as fallback
- Interim fix: If H1 deployment takes >1 week, run with H4 interim (pass A7 via assertion redesign) while H1 re-upload proceeds in background. This is acceptable ‚Äî phase goal is A7=0 at zero tolerance; if H4 achieves that while H1 remediation is in flight, the phase can gate-pass with a documented note.

---

### Q2: Test Isolation

**YOLO DECISION:** **Option A ‚Äî Ephemeral test store (`objectivism-library-retrieval-test`)**

**Rationale:**
- Confidence: ‚úÖ Consensus
- Clean isolation guarantees zero contamination of 1,749 sacred files
- The existing codebase already supports `--store` flag switching; dynamic store selection for a test run requires no architecture changes
- Store creation is immediate; indexing 6-22 files takes <5 minutes
- Delete the test store after SC2 validation completes ‚Äî confirmed by running `store-sync` against the test store name to verify 0 remaining documents before deletion
- SC2 test design (Perplexity extended): Upload 10 Category A files with headers + 5 without headers (control) + 5 Category B with headers + 2 without (control) + 10 from working files (regression check). This gives quantitative evidence for H1 confirmation AND verifies no regression on working files.

---

## Tier 2: Important Decisions

### Q3: Metadata Header Format

**YOLO DECISION:** **Option A (structured) for initial SC2 testing; switch to C (hybrid) if A underperforms**

**Rationale:**
- Confidence: ‚ö†Ô∏è Recommended
- Structured format is more testable and debuggable ‚Äî each field is explicit and verifiable
- SC2 intervention test will empirically compare both formats against the 6 known-failing files
- Header content to use (drawing from Phase 16.2 SQLite data):
  - `Title:` = filename stem (e.g., "Objectivist Logic - Class 09-02")
  - `Course:` = path component above the file (parsed from file_path)
  - `Class:` = class-number extracted from filename (regex: `Class \d+-\d+` or `\d+-\d+`)
  - `Topic:` = scanner `metadata_json->>'topic'` (the MOTM/course discriminating field)
  - `Tags:` = `primary_topics` joined with spaces (all 8 tags from Phase 16.2)
  - Max 200 tokens total
- For MOTM Category B files: Replace `Class:` with `Session:` and use MOTM date/title if available

**Sub-decisions:**
- SQLite field priority: `Topic:` uses scanner `metadata_json->>'topic'` (single authoritative discriminating field); `Tags:` uses all 8 `primary_topics` from `file_primary_topics` table
- Header applied to Category A+B only (surgical; not all 1,749 files)

---

### Q4: A7 Success Threshold

**YOLO DECISION:** **Option B ‚Äî Top-10 threshold**

**Rationale:**
- Confidence: ‚ö†Ô∏è Recommended
- Phase 15 documented that Gemini search ranking has documented volatility (~5-20% query-specificity gap)
- Top-10 is consistent with the existing `top_k=20` retrieval ‚Äî a file in top-10 out of 20 is clearly indexed and retrievable
- Top-5 risks false-negatives due to ranking noise, not actual retrieval failures
- A7 query strategy after H1 fix:
  - **Other-stem (Category A):** Query = `"{course_name} {class_identifier}"` (e.g., "Objectivist Logic 09-02") ‚Äî class identifier is now injected in header
  - **MOTM (Category B):** Query = `"{topic}"` ‚Äî MOTM files have meaningful topic fields; H1 fix reinforces the connection
  - **Other-discriminating:** Query = `"{topic}"` unchanged ‚Äî these already work
  - **Episode files:** Excluded from A7 sampling ‚Äî no discriminating metadata (already documented in assertion code)
- Top-10 check is verifiable in the code: `any(c.retrieved_context.title == target for c in chunks[:10])`

---

### Q5: Production Re-upload Batch Size and Sequence

**YOLO DECISION:** **Option B ‚Äî Upload-first sequence; batch size 10 files with 3-second delays**

**Rationale:**
- Confidence: ‚ö†Ô∏è Recommended
- Upload-first is the write-ahead intent pattern proven in Phases 10-12; consistent with existing architecture
- No data loss risk: old store document remains live until new one is verified
- Operation sequence for each file:
  1. Build content with metadata header from SQLite data
  2. Write temporary file, upload to Files API ‚Üí `new_gemini_file_id`
  3. Import to production store ‚Üí `new_store_doc_name`; poll `operation.done`
  4. Verify: query store for `new_store_doc_name` (confirm present)
  5. Delete old store document via `delete_store_document(old_store_doc_id)` ‚Äî this is the MEMORY.md permanent fix being implemented
  6. Delete old raw file via `delete_file(old_gemini_file_id)` (48hr file may already be expired ‚Äî handle 404 as success)
  7. Update SQLite: `gemini_file_id`, `gemini_store_doc_id` columns
  8. Remove temp file
- Run `store-sync --dry-run` after each batch of 50 files to verify 0 orphan accumulation
- This re-upload also implements the MEMORY.md "PERMANENT FIX REQUIRED" for `_reset_existing_files()` ‚Äî aligning with standing debt

---

## Tier 3: Polish Decisions

### Q6: Header Scope

**YOLO DECISION:** **Category A+B only (surgical ‚Äî ~454 files)**

**Rationale:**
- üîç One provider; safe default
- Applying headers to all 1,749 files risks degrading the 1,295 working files by changing chunk boundaries
- SC2 regression check (10 working files with headers in test store) will validate this assumption empirically
- If SC2 shows zero regression for working files, can revisit full standardization as a separate future phase

---

### Q7: SC4 Freshness Gap

**YOLO DECISION:** **1 hour gap between two fresh-session A7 runs**

**Rationale:**
- üîç Phase 16.3 protocol uses 1 hour (different from 12-15 temporal stability which required 4h/24h/36h)
- SC4 tests ranking stability after re-upload, not long-term temporal drift
- 1 hour is sufficient to clear transient caching and allow any background Gemini re-indexing to settle
- Two runs of `check_stability.py --sample-count 20` each take ~5-10 minutes; total gate time is ~70-80 minutes
- If either run fails, the gate fails ‚Äî no implicit retry loop

---

## Phase 16.3 Plan Architecture (for gsd:plan-phase)

Based on all answered decisions, the three plans should cover:

**16.3-01 (Diagnosis Spike):**
- Inspect 5 Category A transcripts: does the string "09-02" (or similar class identifier) appear in the transcript text? (H3 test)
- Inspect upload pipeline code: does `build_enriched_metadata()` or any pre-upload step add a metadata header, or does it send raw transcript? (H1 test)
- Make 3 live Gemini queries and inspect `retrieved_context.document_name` in responses: is it populated? Is it the filename? (H4 test)
- Run A7 twice on same fixed 6-file set (3 Category A + 3 Category B from 16.1-03 failures) 30 minutes apart: are same files failing? (H2 test for consistency)
- Output: Root cause confirmed, others falsified. Go/no-go signal for H1 fix.

**16.3-02 (Intervention Test):**
- Create `objectivism-library-retrieval-test` ephemeral store
- Upload 22 files (10 Cat A with headers, 5 without; 5 Cat B with headers, 2 without; 10 working files with headers)
- Run targeted queries for all 22 files ‚Äî record top-10 hit rate by condition
- Confirm: Cat A/B WITH headers retrieve successfully; baseline without headers fail (confirms H1); working files maintain hit rate (no regression)
- Document evidence that fix works before production rollout
- Delete test store after validation

**16.3-03 (Production Remediation):**
- Generate `data/retrieval-fix-manifest.json` (Category A + B files by SQL query)
- Implement metadata header builder in upload pipeline (reads from SQLite `primary_topics` + scanner `topic`)
- Execute upload-first re-upload sequence for all manifest files in batches of 10
- Implement MEMORY.md permanent fix for `_reset_existing_files()` (delete store document before raw file)
- Run `check_stability.py --sample-count 20` in fresh session ‚Üí must exit 0
- Wait 1 hour minimum
- Run `check_stability.py --sample-count 20` in second fresh session ‚Üí must exit 0
- Run `store-sync --dry-run` ‚Üí confirm 0 orphans
- Commit new T=0 baseline

---

## Phase 16.2 Achievements Note

The following Phase 16.2 outcomes directly reduce implementation complexity for Phase 16.3:

| Phase 16.2 Achievement | Phase 16.3 Benefit |
|------------------------|-------------------|
| All 1,885 files have `primary_topics` | H1 fix has its data ‚Äî no separate enrichment pass needed |
| MOTM 468/468, Other-stem 443/443 at 100% | Category A+B files are all approved ‚Äî eligible for re-upload immediately |
| `metadata audit` exits 0 | Starting point is clean ‚Äî no latent data debt to resolve before re-upload |
| filename coherence check in validator | Future batch-extracts will catch wrong-context extractions before they reach approved status, preventing future A7-class failures |
| `needs_review` escalation | Future soft validation warnings surface visibly ‚Äî operational hygiene maintained |

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Human review recommended before final implementation*
*Generated: 2026-02-24*
