# 16.3-T0-DIAGNOSIS.md

**Date:** 2026-02-24
**Phase:** 16.3 Diagnosis Spike (Plan 01)
**Investigator:** Claude Opus 4.6

## Hypothesis Verdicts

| Hypothesis | Verdict | Evidence Type |
|------------|---------|---------------|
| H1: No metadata header injected into content | **PARTIALLY FALSIFIED** | Code inspection |
| H2: Silent random indexing failures | **FALSIFIED** | Cross-run consistency |
| H3: Class numbers absent from transcript content | **CONFIRMED** | Transcript read |
| H4: document_name populated for exact-match | **FALSIFIED** | Live API response |

**Root Cause:** H1 (refined) + H3 combined. The upload pipeline DOES inject a Tier 4 AI analysis header -- but this header contains only semantic concepts (summary, key_arguments, philosophical_positions). It does NOT inject the filename, class number, course identifier, or topic string. H3 confirms that class numbers are absent from transcript content. Therefore, for "Other-stem" files (topic == filename stem), the discriminating identifier (e.g., "Class 09-02") exists ONLY in the Gemini `display_name` field, which is not used in semantic search ranking.

---

## H1 Evidence (Upload Pipeline -- Content Injection)

### What was expected
H1 asked: "Does the upload pipeline prepend any metadata header to transcript content before sending to Gemini Files API, or raw transcript only?"

### What was found
The pipeline DOES inject a header, but it lacks identity metadata.

**File:** `src/objlib/upload/content_preparer.py`

The function `prepare_enriched_content()` (lines 21-113) creates a temporary file with an `[AI Analysis]` header prepended to the original transcript. The header format (lines 66-90):

```
[AI Analysis]
Category: {category} | Difficulty: {difficulty}

Summary: {tier4_summary}

Key Arguments:
- {argument_1}
- {argument_2}

Philosophical Positions:
- {position_1}

[Original Content]
{original file text}
```

**What is included:** category, difficulty, summary, key_arguments, philosophical_positions (all from `ai_metadata.semantic_description`)

**What is NOT included:**
- Filename (e.g., "Objectivist Logic - Class 09-02")
- Class number (e.g., "09-02")
- Course name (e.g., "Objectivist Logic")
- Scanner topic (e.g., "Objectivist Logic - Class 09-02")
- primary_topics (e.g., ["epistemology", "concept_formation", ...])
- Title or display_title (both NULL for all 1,749 files anyway)

**The `CustomMetadata` builder** (`src/objlib/upload/metadata_builder.py`, lines 18-105) sends `primary_topics` as `string_list_value` in CustomMetadata -- but CustomMetadata is structured metadata for filtering, NOT indexed content that participates in semantic search embedding. The discriminating signal is in the metadata sidecar, not in the searchable content.

**Orchestrator call chain** (confirmed in `src/objlib/upload/orchestrator.py`):
- Line 915: `temp_path = prepare_enriched_content(file_path, ai_metadata)` -- uses only ai_metadata dict
- Line 916: `upload_path = temp_path if temp_path is not None else file_path` -- uploads enriched if available, raw otherwise
- Line 908: `custom_metadata = build_enriched_metadata(phase1_metadata, ai_metadata, entity_names)` -- separate from content

### Verdict: PARTIALLY FALSIFIED

H1 (as originally stated: "no metadata header injected") is technically falsified -- a header IS injected. But the header does not contain the **identity-discriminating** metadata (filename, class number, topic). The fix is not "add a header" (one already exists) but "extend the existing header with identity fields."

---

## H2 Evidence (Transience -- Cross-run Consistency)

### Prior runs
Two independent A7 runs with different random samples (different files selected each run):

**Run 1 (16.1-02, n=20, 2026-02-24 ~13:45 UTC):** 4 failures
- Category A: `Perception - Class 07-01 - Office Hour.txt`, `Objectivist Logic - Class 04-02 - Office Hours.txt`
- Category B: `MOTM_2024-05-05_New-Thoughts-on-the-Problem-of-Universals.txt`, `MOTM_2022-04-17_History-of-the-Objectivist-Movement-personal-Part.txt`

**Run 2 (16.1-03 / T0-BASELINE, n=20, 2026-02-24 15:47:47 UTC):** 8 failures
- Category A: `Objectivist Logic - Class 09-02.txt`, `ITOE Advanced Topics - Class 02-02.txt`, `Objectivist Logic - Class 02-02 - Office Hours.txt`, `ITOE Advanced Topics - Class 05-02 Office Hour.txt`, `ITOE Advanced Topics - Class 13-02 - Office Hour.txt`
- Category B: `MOTM_2019-03-03_Passages-from-and-positions-of-Ayn-Rand.txt`, `MOTM_2021-06-13_History-of-the-Objectivist-movement-a-personal-account-part.txt`, `MOTM_2022-08-21_Thinking-In-Examples.txt`

### Cross-run analysis
The two runs used **different random samples** but both exhibit the same two failure categories:
- **Category A failures:** Course class-number files where topic == filename stem. Different specific files fail in each run (07-01, 04-02 in Run 1; 09-02, 02-02, 05-02, 13-02 in Run 2), but ALL are from the same structural category (~440 "Other-stem" files = 31% of non-Episode corpus).
- **Category B failures:** MOTM files with generic topics. Different specific files, same structural pattern (topics too generic for Gemini to rank-discriminate).

No files from outside these two categories failed in either run. Files with discriminating topics (e.g., "Formulations of the Categorical Imperative and Duties") always pass.

### Verdict: FALSIFIED

H2 (random transient indexing failures) is falsified. If failures were random/transient, we would expect: (a) some overlap in specific failing files between runs, and (b) failures from random categories. Instead, we see: (a) zero specific-file overlap (different files fail each time), and (b) 100% category overlap (same two structural categories every time). This is a **structural** failure pattern, not a transient noise pattern.

---

## H3 Evidence (Class Number in Transcript)

### File 1: Objectivist Logic - Class 09-02.txt

**Path:** `/Volumes/U32 Shadow/Objectivism Library/Courses/Objectivist Logic/Objectivist Logic - Class 09-02.txt`
**Search for:** "09-02", "09.02", "class 09", "Class 09", "ninth"

**Result:** NOT FOUND. `grep -i` for patterns `09-02|09.02|class 09|Class 09|nine.*two|ninth` returned zero matches across the entire file. The transcript begins with "Today I was, I am going to take up package deals as invalid concepts." -- it is a lecture recording with no self-referential class identifier in the transcript text.

**First 5 lines of transcript:**
```
Today I was, I am going to take up package deals as invalid concepts.
Then I thought, well, let's set the context.
Why are there valid and invalid concepts?
No one else has this idea.
I mean, somebody probably Aristotle, he talks about imaginary concept...
```

### File 2: ITOE Advanced Topics - Class 02-02.txt

**Path:** `/Volumes/U32 Shadow/Objectivism Library/Courses/ITOE Advanced Topics/ITOE Advanced Topics - Class 02-02.txt`
**Search for:** "02-02", "02.02", "class 02", "Class 02", "second class", "class two"

**Result:** NOT FOUND. `grep -i` for patterns `02-02|02.02|class 02|Class 02|second.*class|class.*two` returned zero matches across the entire file. The transcript begins with "you you you you okay let me just check yeah I think I think it's got some right microphone does my audio sound okay" -- a typical lecture recording opening with no class identifier.

**First 5 lines of transcript:**
```
you
you
you
you
okay let me just check
```

### AI metadata for these files (confirming they have Tier 4 content)

Both files have AI metadata with full Tier 4 extraction:
- **Objectivist Logic - Class 09-02.txt:** category=course_transcript, difficulty=intermediate, summary present (200+ chars), 10 key_arguments, 10 philosophical_positions, primary_topics=[epistemology, concept_formation, reason, logic, metaphysics, objective_reality, individual_rights, intrinsicism]
- **ITOE Advanced Topics - Class 02-02.txt:** category=concept_exploration, difficulty=advanced, summary present (200+ chars), 10 key_arguments, 10 philosophical_positions, primary_topics=[epistemology, metaphysics, logic, concept_formation, objective_reality, causality, values]

Both files received the `[AI Analysis]` header with their semantic descriptions during upload. But the header contains "epistemology, concept_formation, logic" -- generic terms shared by dozens of Objectivist Logic and ITOE files. The header does NOT contain "09-02" or "02-02".

### Verdict: CONFIRMED

H3 is confirmed. The class-number string does not appear anywhere in the raw transcript content for either file. Since the `content_preparer.py` header also does not inject the class number, the string "09-02" (or "02-02") exists ONLY in:
1. The SQLite `filename` column
2. The SQLite `metadata_json.topic` field (which == filename stem)
3. The Gemini Files API `display_name` (set to filename)

None of these participate in Gemini's semantic search ranking.

---

## H4 Evidence (document_name in API Response)

### Test execution

Script: inline Python using raw `genai` SDK (no objlib dependency). Three queries against production store `objectivism-library` (resource: `fileSearchStores/objectivismlibrary-9xl9top0qu6u`), model `gemini-2.5-flash`.

### Results

**Schema inspection (from `model_fields` attribute dump):**
```python
'document_name': FieldInfo(
    annotation=Union[str, NoneType],
    required=False,
    default=None,
    alias='documentName',
    description='Output only. The full document name for the referenced Vertex AI Search document.'
)
```

Note the description: "Vertex AI Search document" -- this field is for Vertex AI Search, not File Search (Gemini's consumer API). File Search uses a different backend.

**Values across all 15 chunks inspected (3 queries x 5 chunks each):**
- `document_name`: **None** (all 15 chunks)
- `uri`: **None** (all 15 chunks)
- `title`: **12-char file resource ID** (all 15 chunks) -- e.g., `0hd1jyrpgqul`, `ob1j4sxseset`
- `text`: **Chunk text content** (populated for all chunks)

Only `text` and `title` are populated. `model_fields_set` confirms: `{'text', 'title'}`.

### What Gemini returned for class-number queries

**Query "Objectivist Logic Class 09-02":**
Top 5 results (by file ID -> DB lookup):
1. `Objectivist Logic - Class 09-01.txt` (0hd1jyrpgqul) -- WRONG CLASS
2. `Objectivism Seminar - Foundations - Year 2 - Q1 - Week 2 - Objectivity [continued].txt` (ob1j4sxseset) -- WRONG COURSE
3. `MOTM_2018-04-08_the-WSJs-attack-on-the-enlightenment-Trump-and-economic-vs-political-power-postmodernism.txt` (xp56jomykyxq) -- COMPLETELY UNRELATED
4. `Objectivism Seminar - Foundations - Year 2 - Q1 - Week 3 - Logic context and hierarchy.txt` (ecb2hzhyqpqk)
5. `Objectivist Logic - Class 05-01.txt` (q4209kub9wbz) -- WRONG CLASS

Target file `Objectivist Logic - Class 09-02.txt` (prefix `7cmpmah8t2yp`) NOT in top 5.

**Query "ITOE Advanced Topics Class 02-02":**
Top 5 results:
1. `ITOE - Class 04-01 - Office Hours.txt` (k8vdlewgbvxw) -- WRONG CLASS
2. `ITOE - Class 01-01.txt` (6fz51zjbx4fc) -- WRONG CLASS
3. `ITOE - Class 01-01.txt` (6fz51zjbx4fc) -- DUPLICATE
4. `Objectivist Logic - Class 17-01.txt` (h66qixesriw7) -- WRONG COURSE
5. `ITOE - Class 01-02.txt` (m42knfaq3qiz) -- WRONG CLASS

Target file `ITOE Advanced Topics - Class 02-02.txt` (prefix `um2c338d0vv6`) NOT in top 5.

**Query "Passages from and positions of Ayn Rand":**
Top 5 results:
1. `Ayn Rand - The Voice of Reason - Essays in Objectivist Thought.txt` (nhj2ud1qb99v) -- Ayn Rand book, not the MOTM
2. `Leonard Peikoff - Understanding Objectivism - A Guide to Learning Ayn Rands Philosophy (2012).txt` (jiavv1uqdpb5)
3. `existence doesn't mean physical existence.txt` (lt2s1uo8qk69)
4. `existence doesn't mean physical existence.txt` (lt2s1uo8qk69) -- DUPLICATE
5. `Leonard Peikoff - Objectivism - The Philosophy of Ayn Rand.txt` (k9q9gbso44xh)

Target file `MOTM_2019-03-03_Passages-from-and-positions-of-Ayn-Rand.txt` (prefix `6fpwx5ev58em`) NOT in top 5.

### Verdict: FALSIFIED

H4 is falsified. `document_name` is not populated in Gemini File Search API responses -- it is a Vertex AI Search-only field. There is no exact-match document identifier in the search response beyond `title` (the 12-char file resource ID), and this ID carries no semantic meaning. A7 cannot be redesigned to use exact-match document_name lookup because the field is NULL.

---

## Root Cause Conclusion

### Primary Root Cause: H1 (refined) + H3

The A7 failures for both Category A and Category B files share a single root cause: **the discriminating identifier for each file is absent from the indexed content that Gemini uses for semantic search.**

Specifically:
1. **Category A (Other-stem, ~440 files):** The class number (e.g., "09-02") is not in the transcript (H3 confirmed). The `[AI Analysis]` header prepended during upload contains only generic semantic concepts (epistemology, concept_formation, logic) that are shared across dozens of files in the same course. The course name IS in the transcript headers but without the class number, Gemini cannot distinguish Class 09-01 from Class 09-02.

2. **Category B (generic MOTM, ~14 files):** The topic string (e.g., "Passages from and positions of Ayn Rand") is in the `[AI Analysis]` header's Summary field, but the summary discusses the same concepts as dozens of other files about Ayn Rand's philosophy. The topic title itself is not injected as a discrete, searchable string.

### Fix Confirmed: Extend Existing Content Header with Identity Fields

The fix is NOT "add a metadata header" (one already exists via `content_preparer.py`). The fix is **extend the existing header to include identity-discriminating fields**:

- **Filename** (includes class number for Category A files)
- **Course name** (for course files)
- **Class identifier** (e.g., "09-02", extracted from filename)
- **Scanner topic** (the discriminating string for MOTM files)
- **primary_topics** as space-separated tags (enriches the semantic surface area)

This extends `prepare_enriched_content()` to accept Phase 1 metadata (for filename, course, topic) in addition to AI metadata. The function currently takes only `(original_file_path, ai_metadata)` -- it would also need `phase1_metadata` and/or `filename`.

### H4 as Supplementary (Not Primary)

H4 (document_name) is falsified -- it cannot be used for exact-match lookup. However, the existing `title` field (12-char file resource ID) IS used successfully for A7 matching already. No change needed to the matching logic.

### Plan 16.3-02 Can Proceed: YES

The diagnosis confirms the intervention approach proposed in 16.3-CONTEXT.md: extend the content header with identity fields, then re-upload failing files. The metadata needed (`primary_topics`, scanner `topic`, `filename`) is 100% available in SQLite (confirmed by Phase 16.2 audit).

**One refinement:** The existing `content_preparer.py` header should be extended (not replaced) -- the Tier 4 semantic content is valuable for search quality on non-failing files. The identity fields should be added at the TOP of the header, before the `[AI Analysis]` section, so they appear in the first chunk that Gemini indexes.
