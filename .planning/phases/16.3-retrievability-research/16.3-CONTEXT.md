# CONTEXT.md ‚Äî Phase 16.3: Gemini File Search Retrievability Research

**Generated:** 2026-02-24
**Phase Goal:** Every indexed file is independently retrievable in Gemini File Search via a targeted query -- root cause diagnosed with affirmative evidence, fix tested on failing files, and applied at production scale so A7 exits 0/N at zero tolerance.
**Synthesis Source:** Multi-provider AI analysis (Gemini Pro + Perplexity Sonar Deep Research; OpenAI gpt-5.2 query timed out ‚Äî 2 providers sufficient)

---

## Overview

Phase 16.3 resolves the A7 assertion failures confirmed in Phase 16.1: two independent runs showed 4/20 then 8/20 miss rates at zero tolerance. The failures cluster into two categories: ~440 "Other-stem" course files (class-number filenames, topic==filename stem) and ~14 generic MOTM files (generic philosophy topics, no discriminating query signal). Phase 16.2 is now complete ‚Äî all 1,885 files have `primary_topics` in SQLite ‚Äî providing the metadata needed for any fix that requires content injection.

The phase has three plans: (1) diagnosis spike to falsify H1/H2/H3/H4 with affirmative evidence, (2) intervention test on 6 known-failing files in isolated context, (3) production remediation with two fresh-session A7=0 confirmations.

**Confidence markers:**
- ‚úÖ **Consensus** ‚Äî Both providers identified this as critical
- ‚ö†Ô∏è **Recommended** ‚Äî One provider identified, high-confidence recommendation
- üîç **Needs Clarification** ‚Äî Identified by one provider, situational

---

## Phase 16.2 Achievements (Feed-Forward Context)

The following Phase 16.2 outcomes directly enable Phase 16.3:

- **All 1,885 files satisfy the metadata invariant** ‚Äî 1,708 approved-with-`primary_topics`, 137 skipped-with-reason, 40 `failed_validation` (retriable Episode files)
- **MOTM 468/468 and Other-stem 443/443 at 100%** ‚Äî `primary_topics` is fully populated for all files that will participate in any metadata-header injection fix
- **`primary_topics` data is in SQLite** ‚Äî 8 controlled-vocabulary topics per file, semantically selected by Mistral. These are immediately available to the upload pipeline without any additional API calls.
- **Filename coherence check implemented** ‚Äî validator now soft-flags extractions where no filename content word appears in summary/aspects. Future batch-extracts will surface wrong-context extractions before they reach `approved` status.
- **`needs_review` escalation implemented** ‚Äî soft warnings are now persisted to `error_message` and surfaced in `metadata audit` Condition 5. Operational visibility for the approval workflow.

---

## Gray Areas Identified

### ‚úÖ 1. H1 vs H4: Fix the Data vs Fix the Assertion (Consensus)

**What needs to be decided:**
Whether the root cause is "metadata not in indexed content" (H1 ‚Äî fix the upload pipeline to prepend a metadata header) or "document_name exact-match is available" (H4 ‚Äî redesign A7 to use exact-match lookup instead of semantic query). These are structurally different fixes with different risk and scope.

**Why it's ambiguous:**
H4 would make A7 pass with zero code changes to the upload pipeline and zero re-uploads of files. H1 requires modifying the pipeline, constructing metadata headers, re-uploading ~454 files, and managing store document swaps without orphan accumulation. But H4 fixes the **test** without fixing the **user experience** ‚Äî a real user querying "Class 09-02 epistemology lecture" would still get no results if the class number isn't in the transcript.

**Provider synthesis:**
- **Gemini Pro:** "Prioritize H1 (Content Injection). A7 should remain a semantic search test. H4 should only be used as a fallback if H1 fails to move the needle on relevance."
- **Perplexity:** "H1 > H3 > H2 > H4 priority. H1 and H3 address root causes and together likely explain the majority of failures. Treat this as a data quality and pipeline issue ‚Äî not primarily a File Search API issue."

**Proposed implementation decision:**
**Fix H1 (content injection) as the primary path.** A7 must remain a semantic search test ‚Äî it tests real user retrievability, not just that files exist. H4 (document_name matching) may be used to **supplement** A7 assertion logic as a secondary check, but cannot replace semantic retrievability.

H3 (class numbers absent from transcript) must be confirmed or ruled out during the diagnosis spike ‚Äî if class numbers are absent from transcripts, H1 alone is sufficient (injecting the class number via metadata header brings the discriminating signal into the indexed content).

**Open questions:**
- Does the Gemini indexing pipeline weight the beginning of a file heavily enough that a ~200-token header changes retrieval rankings? (Must be verified empirically in SC2 test store)
- Should H1 fix be applied to **all** 1,749 files (standardization) or only Category A+B (surgical)? (Perplexity recommends surgical to minimize churn on sacred corpus)

**Confidence:** ‚úÖ Both providers agree H1 is the right fix; H4 is a fallback only

---

### ‚úÖ 2. Metadata Header Format for Gemini Indexing (Consensus)

**What needs to be decided:**
Exact format, length, and content of the metadata header to prepend to transcripts before re-upload, to ensure Gemini's chunking and embedding pipeline treats the metadata as part of the semantic content.

**Why it's ambiguous:**
Gemini File Search uses semantic embeddings ‚Äî the content needs to participate in the embedding space, not just be present as bytes. JSON or CSV formats may be tokenized as syntax rather than semantic content. The header must be long enough to matter but short enough not to bury the transcript content in secondary chunks. The available metadata (from Phase 16.2) includes: filename, `primary_topics[8]`, scanner `topic` field, `difficulty`, `category`, `semantic_description.summary`.

**Provider synthesis:**
- **Gemini Pro:** Simple structured header: `Title: [Filename]\nTopic: [Topic]\n\n[Transcript...]`. For Category A files, the class number must appear explicitly in the header.
- **Perplexity:** Two options:
  - Option A (structured): `=== COURSE METADATA ===\nFilename: [stem]\nClass: [class-number]\nCourse: [course-name]\nTopic: [primary_topic]\n=== TRANSCRIPT BEGINS ===\n`
  - Option B (narrative): `"This is a recording of [Course], [Class identifier], on the topic of [primary_topic]. The following is a transcript of the lecture:\n"`
  - ~200 tokens max for header; includes class identifier redundantly in both Filename and Class fields; narrative format may embed better in semantic space.

**Proposed implementation decision:**
Use **narrative + structured hybrid**, optimized for Gemini's embedding model:

```
--- DOCUMENT METADATA ---
Title: Objectivist Logic - Class 09-02
Course: Objectivist Logic
Class: 09-02
Topic: epistemology
Tags: concept_formation, induction, logic, objective_reality
--- TRANSCRIPT ---
[raw transcript content]
```

Keep header under 200 tokens. Include `primary_topics` from SQLite as space-separated "Tags" ‚Äî this injects controlled vocabulary that search queries may use. For MOTM files (Category B), include the MOTM session description as the semantic anchor.

**Open questions:**
- Which field from SQLite should drive the narrative "Topic" line ‚Äî `scanner topic` or `primary_topics[0]`? (Primary_topics are richer; scanner topic is the discriminating field for MOTM files)
- Should the header be identical for all 1,749 files or only Category A+B? (Risk: header on working files could change chunk boundaries)

**Confidence:** ‚úÖ Both providers agree on ~200-token header with class identifier and topic fields

---

### ‚úÖ 3. Safe Selective Re-upload Without Orphan Accumulation (Consensus)

**What needs to be decided:**
The exact operation sequence for "updating" a file in the Gemini store (which has no UPDATE operation ‚Äî only CREATE and DELETE) without creating orphaned store documents.

**Why it's ambiguous:**
The Phase 16.1 bug (and MEMORY.md) documents exactly this pattern: `_reset_existing_files()` called `delete_file()` (deletes the 48hr raw file) but NOT `delete_store_document()` (the permanent indexed entry). Every re-upload without explicitly deleting the store document accumulates orphans. The store has no native deduplication.

**Provider synthesis:**
- **Gemini Pro:** "Swap" workflow: (1) Upload new file ‚Üí (2) Add to store ‚Üí (3) Verify in store ‚Üí (4) Delete old store document ‚Üí (5) Update SQLite. If step 4 fails, log warning but proceed (duplicate better than loss).
- **Perplexity:** Match store documents by `display_name`, delete store document first, then upload new version. Batch in groups of 5-10 with 5-second delays to avoid 503 errors. Never do bulk delete operations.

**Proposed implementation decision:**
Follow the **existing `_reset_existing_files()` pattern** but with the missing store-document deletion included (the MEMORY.md permanent fix not yet implemented):

1. For each Category A/B file: find its store document via `find_store_document_name()` (already implemented on `GeminiFileSearchClient`)
2. Upload new content (with header) to Files API ‚Üí get `new_file_id`
3. Import `new_file_id` to store ‚Üí get new store document
4. Delete old store document (the one found in step 1) via `delete_store_document()`
5. Delete old raw file (48hr) via `delete_file(old_file_id)`
6. Update SQLite with `new_file_id`, `new_store_doc_id`
7. Process in batches of 10 with 3-second delays

This is also the opportunity to implement the MEMORY.md "permanent fix" for `_reset_existing_files()`.

**Open questions:**
- Are current `gemini_store_doc_id` values reliable in SQLite for all 454 Category A+B files? (Must be verified before any deletion ‚Äî if NULL, must do a store list scan first)
- Should this be a new CLI command (e.g., `objlib upload re-enrich-retrieval`) or extend the existing `fsm-upload` with a `--re-enrich-failing` flag?

**Confidence:** ‚úÖ Both providers agree: explicit store document deletion is required; batch in small groups

---

### ‚ö†Ô∏è 4. Test Isolation Strategy for SC2 (Recommended)

**What needs to be decided:**
Where SC2 hypothesis testing occurs ‚Äî a separate ephemeral Gemini store, a dedicated sub-section of the production store, or 6 new test files uploaded to the production store with unique markers.

**Why it's ambiguous:**
The roadmap says "not the production store, no `--reset-existing` on the full corpus." A separate test store is cleanest but requires the codebase to support dynamic store switching. Uploading test files to production with unique markers avoids store creation but risks contaminating the sacred corpus.

**Provider synthesis:**
- **Gemini Pro:** Create an ephemeral test store (`objlib-retrieval-test`), upload 6 files with headers, run queries, delete store after validation. Confirms the code supports dynamic store switching.
- **Perplexity:** Extended test design with control groups (baseline without headers + experimental with headers + sample of working files). 22 files total: 10 Category A with headers, 5 without, 5 Category B with headers, 2 without, 10 from working files.

**Proposed implementation decision:**
**Create ephemeral test store** named `objectivism-library-retrieval-test` for SC2. This isolates all hypothesis testing from the 1,749 sacred files. After SC2 validation, delete the test store. The existing codebase already supports `--store` flag switching.

**Open questions:**
- Does creating a test store incur indexing costs? (Likely minimal for 6-22 files)
- How long should the test store live before querying? (Wait for Gemini indexing to complete ‚Äî same as production: poll `operation.done` + allow 10s for search index propagation)

**Confidence:** ‚ö†Ô∏è Recommended ‚Äî both providers agree on isolation; test store size/composition varies

---

### ‚ö†Ô∏è 5. A7 Assertion Redesign After Fix (Recommended)

**What needs to be decided:**
How `check_stability.py`'s A7 assertion should be redesigned after the content-injection fix ‚Äî specifically: (a) what query to construct, (b) what "success" threshold to use (top-1 vs top-5), (c) whether to add retry logic for ranking volatility.

**Why it's ambiguous:**
Currently A7 constructs a query from `topic` field (MOTM) or `topic == filename stem` (Other-stem), which is exactly why it fails ‚Äî the query has no semantic content beyond the class number that's not in the transcript. After H1 fix, the query should match the injected header content. But Gemini search ranking has volatility ‚Äî top-1 may be brittle.

**Provider synthesis:**
- **Gemini Pro:** "Top-5 Tolerance using Constructed Queries. A7 assertion logic constructs query using exact fields we injected (e.g., query string = file.title). File must appear in Top 5."
- **Perplexity:** Multi-strategy query (class number ‚Üí topic ‚Üí generic). For SC4 freshness check: rank must stay in top-5 AND not move more than 2 positions between runs.

**Proposed implementation decision:**
After H1 fix: A7 query strategy becomes:
- **MOTM files:** Query = `{topic} Month of the Month` (same as current but now the header reinforces the connection)
- **Other-stem files:** Query = `{course_name} {class_number}` (e.g., "Objectivist Logic 09-02") ‚Äî the class number is now injected in the header
- **Other-discriminating files:** Query = `{topic}` (unchanged ‚Äî these already work)
- **Episode files:** Excluded from sampling (no discriminating metadata; documented in A7 assertion code)
- **Success threshold:** File must appear in top-10 (not top-1 ‚Äî ranking has documented volatility; top-10 confirms retrievability while tolerating ranking noise)

**Open questions:**
- Should A7 explicitly exclude Category B files from sampling if generic topic doesn't improve after H1 fix? (SC1 must falsify this before deciding)
- Is 1 hour enough gap between SC4 freshness runs? (Perplexity recommends 24 hours; current protocol uses T+1h which may be sufficient for this non-temporal check)

**Confidence:** ‚ö†Ô∏è Recommended ‚Äî both providers agree on top-5/top-10 threshold and query-from-header strategy

---

### üîç 6. Category A/B File Identification Manifest (Gemini Only)

**What needs to be decided:**
How to programmatically identify the exact set of ~454 files (Category A + Category B) that require re-upload, and how to validate the list before any bulk operation.

**Why it's ambiguous:**
Category A definition from Phase 16.1: `json_extract(metadata_json, '$.topic') == filename_stem AND file_path NOT LIKE '%/MOTM/%'`. Category B: MOTM files with generic/historical topics (previously identified as ~14 files in two 16.1 runs). The SQL definitions from Phase 16.2 audit command are authoritative.

**Provider synthesis:**
- **Gemini Pro:** Filter by `primary_topic == filename stem` AND/OR filename matches class-number regex (`Class \d+`, `Lecture \d+`). Save as JSON manifest before bulk operation for manual spot-checking.

**Proposed implementation decision:**
Use the Phase 16.2 audit query definitions:
- **Category A:** `files WHERE json_extract(metadata_json, '$.topic') = filename_stem AND file_path NOT LIKE '%/MOTM/%' AND ai_metadata_status = 'approved'` (the Other-stem group at 100% ready)
- **Category B:** MOTM files where A7 failed ‚Äî need one run of A7 to capture the specific failing file IDs, then re-upload those

Generate a JSON manifest (`data/retrieval-fix-manifest.json`) before any bulk operation, showing file count, category breakdown, and 5 sample filenames per category for human spot-check.

**Confidence:** üîç One provider (Gemini) ‚Äî but aligns with Phase 16.1/16.2 data model

---

## Summary: Decision Checklist

**Tier 1 (Blocking ‚Äî must decide before 16.3-01 spike):**
- [x] H1 is primary hypothesis to confirm/falsify (semantic content injection vs assertion redesign) ‚Äî **confirmed: H1 is primary**
- [x] Test isolation: ephemeral test store for SC2 ‚Äî **confirmed: ephemeral store**
- [x] Sacred constraint: no `--reset-existing` on full corpus ‚Äî **confirmed from roadmap**

**Tier 2 (Important ‚Äî decide before 16.3-02 intervention test):**
- [ ] Metadata header format: structured vs narrative vs hybrid ‚Äî propose hybrid with class number + Tags line
- [ ] Success threshold: top-5 vs top-10 for A7 assertion ‚Äî propose top-10
- [ ] Store document swap sequence: upload-first vs delete-first ‚Äî propose upload-first (safer)
- [ ] Batch size for production re-upload: 5 vs 10 files ‚Äî propose 10 with 3s delays

**Tier 3 (Polish ‚Äî decide during implementation):**
- [ ] Which SQLite field drives the "Topic" header line: scanner topic or primary_topics[0]
- [ ] Whether to apply metadata headers to all 1,749 files or only Category A+B
- [ ] Whether SC4 freshness gap should be 1 hour or 24 hours

---

*Multi-provider synthesis by: Gemini Pro + Perplexity Sonar Deep Research*
*Note: OpenAI gpt-5.2 query timed out during generation; 2-provider synthesis sufficient per error handling protocol*
*Generated: 2026-02-24*
