---
phase: 16.3-retrievability-research
plan: 01
subsystem: search, upload
tags: [gemini-file-search, retrievability, diagnosis, hypothesis-testing, content-injection]

# Dependency graph
requires:
  - phase: 16.2
    provides: All 1,885 files satisfy metadata invariant; MOTM 468/468 and Other-stem 443/443 at 100% primary_topics coverage
  - phase: 16.1
    provides: T0-BASELINE with A7 failure data (2 independent runs), identity contract confirmation
provides:
  - Root cause diagnosis with affirmative evidence for all four hypotheses (H1/H2/H3/H4)
  - Confirmed fix path: extend existing content_preparer.py header with identity fields (filename, class number, course, topic, primary_topics)
  - H4 definitively ruled out as alternative fix (document_name is NULL in File Search API)
affects: [16.3-02, 16.3-03, 16-02]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "GroundingChunkRetrievedContext.document_name is Vertex AI Search only -- NULL for File Search API"
    - "content_preparer.py injects Tier 4 semantic header but not identity metadata (filename, class number, topic)"

key-files:
  created:
    - .planning/phases/16.3-retrievability-research/16.3-T0-DIAGNOSIS.md
  modified: []

key-decisions:
  - "H1 (refined) + H3 = root cause: discriminating identifiers absent from indexed content. Fix = extend existing header, not create new one"
  - "H4 (document_name exact-match) ruled out as alternative -- field is NULL in File Search API responses"
  - "Plan 16.3-02 can proceed with content header extension approach"
  - "Existing Tier 4 header is valuable and should be retained; identity fields go at TOP of header"

# Metrics
duration: 5min
completed: 2026-02-24
---

# Phase 16.3 Plan 01: Diagnosis Spike Summary

**Root cause diagnosed: content header exists but lacks identity fields (filename, class number, topic); class numbers absent from transcripts; document_name NULL in File Search API**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-24T20:56:18Z
- **Completed:** 2026-02-24T21:01:23Z
- **Tasks:** 3 (all research/measurement -- no code changes)
- **Files created:** 1

## Accomplishments

- Diagnosed root cause of A7 structural failures with affirmative evidence for all four hypotheses
- H1 PARTIALLY FALSIFIED: upload pipeline DOES inject a header via `content_preparer.py` (Tier 4 AI analysis: summary, key_arguments, philosophical_positions) -- but header lacks identity fields (filename, class number, course, topic, primary_topics)
- H2 FALSIFIED: two independent runs with different random samples show same two failure categories (Category A = Other-stem class-number files, Category B = generic MOTM) -- structural, not transient
- H3 CONFIRMED: class number strings ("09-02", "02-02") absent from raw transcript content -- confirmed by grep of full files (zero matches)
- H4 FALSIFIED: `retrieved_context.document_name` is NULL for all 15 chunks across 3 live API queries; field description says "Vertex AI Search document" (not File Search)
- Confirmed that Gemini returns wrong files for class-number queries: "Objectivist Logic Class 09-02" returns Class 09-01, Class 05-01 -- NOT 09-02; "ITOE Advanced Topics Class 02-02" returns Class 04-01, Class 01-01, Class 01-02 -- NOT 02-02
- Validated Plan 16.3-02 approach: extend existing content_preparer.py header with identity fields at TOP of header

## Task Commits

Each task was committed atomically:

1. **Tasks 1-3: H1+H2+H3+H4 diagnosis** - `a582626` (docs) -- all three tasks contribute to single diagnosis document

## Files Created/Modified

- `.planning/phases/16.3-retrievability-research/16.3-T0-DIAGNOSIS.md` - Complete diagnosis with 4 hypothesis verdicts, verbatim evidence (code line numbers, transcript excerpts, API response fields), root cause conclusion

## Decisions Made

1. **Root cause = H1 (refined) + H3 combined** -- The discriminating identifier for each file is absent from the indexed content. Fix: extend existing `prepare_enriched_content()` to include filename, class number, course, scanner topic, and primary_topics in the content header.

2. **H4 (document_name) ruled out** -- The field is NULL in Gemini File Search API responses. It is a Vertex AI Search-only field. No alternative assertion design is possible via exact-match document_name lookup.

3. **Extend header, don't replace** -- The existing Tier 4 AI analysis header (summary, key_arguments, philosophical_positions) is valuable for semantic search quality on non-failing files. Identity fields should be prepended at the TOP of the existing header, before `[AI Analysis]`.

4. **Plan 16.3-02 can proceed: YES** -- All metadata needed for the fix (filename, primary_topics, scanner topic) is 100% available in SQLite (confirmed by Phase 16.2 audit: MOTM 468/468, Other-stem 443/443).

## Deviations from Plan

None -- plan executed exactly as written.

## Issues Encountered

None.

## Next Phase Readiness

**Plan 16.3-02 (Intervention Test) is UNBLOCKED:**
- Root cause confirmed with affirmative evidence
- Fix approach validated: extend `content_preparer.py` header with identity fields
- Test isolation confirmed: ephemeral test store (per 16.3-CONTEXT.md)
- Metadata available: all Category A+B files have `primary_topics` and scanner `topic` in SQLite

**Key input for 16.3-02:**
- `prepare_enriched_content()` must be extended to accept `phase1_metadata` or `filename` parameter
- Identity fields go at TOP of header (before `[AI Analysis]` section)
- Re-upload only Category A+B files (~454 total) to test store first, then production
- Existing `build_enriched_metadata()` CustomMetadata pipeline unchanged (metadata is sidecar, not content)

## Self-Check: PASSED

- 16.3-T0-DIAGNOSIS.md: FOUND
- 16.3-01-SUMMARY.md: FOUND
- Commit a582626: FOUND
