---
phase: 06.3-test-foundation-canon-governance
plan: 08
type: execute
wave: 3
depends_on: ["06.3-01", "06.3-02", "06.3-03", "06.3-04", "06.3-06", "06.3-07"]
files_modified:
  - Canon.json
autonomous: true

must_haves:
  truths:
    - "canon-update audit detects drift (or confirms no drift) on this project's Canon.json"
    - "Canon.json _canon_workflow field is set to 'gsd'"
    - "Canon.json folders and excludeFolders match actual codebase structure"
    - "Full test suite passes (all new tests from plans 01-04 + all existing tests)"
    - "Coverage report generated showing per-module line coverage"
  artifacts:
    - path: "Canon.json"
      provides: "Verified Canon.json with _canon_workflow and accurate Layer 1 configuration"
      contains: "_canon_workflow"
    - path: "tests/"
      provides: "Complete retroactive test suite (100+ new tests across 8 new test files)"
  key_links:
    - from: "Canon.json"
      to: "src/objlib/"
      via: "folders and excludeFolders match actual module structure"
      pattern: "src/objlib"
    - from: "tests/"
      to: "src/objlib/"
      via: "Tests import and verify all major modules"
      pattern: "from objlib"
---

<objective>
Apply canon-update to this project's Canon.json, run the full retroactive test suite from plans 01-04, and verify zero regressions. This is the final integration gate for Phase 6.3.

Purpose: Proves the system is stable (green test suite) and governed (accurate Canon.json) before Phase 7 TUI work begins.
Output: Updated Canon.json (if drift found), full test suite green, coverage report.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.3-test-foundation-canon-governance/CANON-CONTEXT.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-01-SUMMARY.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-02-SUMMARY.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-03-SUMMARY.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-04-SUMMARY.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-06-SUMMARY.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-07-SUMMARY.md
@Canon.json
@docs/architecture/client-interface.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply canon-update audit to this project</name>
  <files>Canon.json</files>
  <action>
Perform a manual canon-update audit on this project's Canon.json by following the canon-update SKILL.md algorithm:

**Step 1: Detect workflow**
- Read Canon.json — if `_canon_workflow` field exists, use it
- If not, check for GSD artifacts (.planning/STATE.md + .planning/ROADMAP.md)
- Expected result: GSD workflow

**Step 2: Read current Canon.json**
- Parse folders, excludeFolders, excludeFiles, rules arrays

**Step 3: Scan codebase**
- List all directories under `src/objlib/`
- Classify each as public or internal

**Step 4: Layer 1 drift detection**

Check for:
- New directories under `src/objlib/` not accounted for in Canon.json
- Stale directories in Canon.json that no longer exist
- New constraints from Phase 4/5/6.x work that should be rules
- Verify `_canon_workflow` field exists (add "gsd" if missing)

Expected drift items based on project history:
- `src/objlib/session/` may not be in excludeFolders (added in Phase 4)
- `src/objlib/sync/` should be in excludeFolders (internal pipeline)
- `_canon_workflow` field should be "gsd"
- Rules may need updating for Phase 5 sync constraints

**Step 5: Apply updates**

If drift found:
- Update Canon.json with corrected folders and excludeFolders
- Add `"_canon_workflow": "gsd"` if not present
- Add any new rules discovered from STATE.md decisions
- Ensure client-interface.md is still accurate (update if public surface changed)

If no drift:
- Confirm Canon.json is current

**Step 6: Report**
Output what was checked and what was changed (or "no drift").
  </action>
  <verify>
```bash
python -c "
import json
with open('Canon.json') as f:
    canon = json.load(f)
assert '_canon_workflow' in canon, 'Missing _canon_workflow'
assert canon['_canon_workflow'] == 'gsd', f'Expected gsd, got {canon[\"_canon_workflow\"]}'
print(f'Workflow: {canon[\"_canon_workflow\"]}')
print(f'Public folders: {canon[\"folders\"]}')
print(f'Excluded folders: {len(canon[\"excludeFolders\"])} items')
print(f'Rules: {len(canon[\"rules\"])} rules')
print('Canon.json verified OK')
"
```
  </verify>
  <done>Canon.json audited and updated. _canon_workflow is "gsd". folders and excludeFolders match current codebase. Rules reflect accumulated decisions from all phases.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite with coverage and verify zero regressions</name>
  <files></files>
  <action>
Run the complete test suite including all new tests from plans 01-04 and all existing tests:

```bash
cd /Users/david/projects/objectivism-library-semantic-search
python -m pytest tests/ -v --cov=src/objlib --cov-report=html --cov-report=term-missing --tb=short 2>&1
```

**Expected test files (new from plans 01-04):**
- tests/test_schema.py (plan 01)
- tests/test_database_crud.py (plan 01)
- tests/test_scanner_pyfakefs.py (plan 02)
- tests/test_metadata_edge.py (plan 02)
- tests/test_expansion.py (plan 03)
- tests/test_reranker.py (plan 03)
- tests/test_synthesizer.py (plan 03)
- tests/test_sync.py (plan 04)
- tests/test_session.py (plan 04)

**Expected existing test files (should still pass):**
- tests/test_database.py
- tests/test_scanner.py
- tests/test_metadata.py
- tests/test_search.py
- tests/test_entity_extraction.py
- tests/test_formatter.py
- tests/test_browse_filter.py
- tests/test_upload.py
- tests/test_integration.py

**Success criteria:**
- ALL tests pass (zero failures)
- Coverage report generated (HTML at htmlcov/)
- Line coverage >= 80% for modules covered by plans 01-04 (excluding cli.py)
- If any tests fail: diagnose and fix in this task (these are tests written by previous plans)

**If failures found:**
1. Read the failure output carefully
2. Determine if the failure is in a new test (test logic issue) or existing test (regression)
3. For new test issues: fix the test to match actual code behavior
4. For regressions: investigate what changed and fix the source code or test
5. Re-run until all green

**Coverage report:**
After all tests pass, note the per-module coverage percentages. The coverage gate (fail_under=80) may not pass for all modules in this retroactive suite, but the test infrastructure should demonstrate significant improvement over the baseline.

If coverage gate causes pytest to exit non-zero despite all tests passing, note the modules below 80% in the summary. Do NOT remove the coverage gate — it serves as a target for future work.
  </action>
  <verify>
```bash
cd /Users/david/projects/objectivism-library-semantic-search
python -m pytest tests/ -q --tb=line 2>&1 | tail -5
```

Verify zero failures. Then check coverage:
```bash
python -m pytest tests/ -q --cov=src/objlib --cov-report=term 2>&1 | tail -30
```

Note the coverage percentages.
  </verify>
  <done>Full test suite passes (zero failures across all new and existing tests). Coverage report generated. Canon.json verified and up-to-date. Phase 6.3 is complete — the system is stable and governed, ready for Phase 7 TUI work.</done>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -q --tb=line` — 0 failures
- `python -c "import json; c=json.load(open('Canon.json')); assert c.get('_canon_workflow')=='gsd'"` — passes
- `ls htmlcov/index.html` — coverage HTML report exists
- All 9 new test files exist and pass
- All 9 existing test files still pass (no regressions)
</verification>

<success_criteria>
- Canon.json has _canon_workflow: "gsd" and accurate folders/excludeFolders/rules
- Full test suite: zero failures across 18+ test files (9 new + 9 existing)
- Coverage report generated (HTML + terminal output)
- No regressions: existing tests pass unchanged
- Phase 6.3 can be marked as complete in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/06.3-test-foundation-canon-governance/06.3-08-SUMMARY.md`
</output>
