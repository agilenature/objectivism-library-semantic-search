---
phase: 06.3-test-foundation-canon-governance
plan: 06
type: execute
wave: 2
depends_on: ["06.3-05"]
files_modified:
  - ~/.claude/skills/canon-init/SKILL.md
  - ~/.claude/skills/canon-init/templates/Canon.json.template
  - ~/.claude/skills/canon-init/templates/client-interface.template.md
  - ~/.claude/skills/canon-init/rules/gsd-rules.md
  - ~/.claude/skills/canon-init/rules/ralph-rules.md
  - ~/.claude/skills/canon-init/rules/bmad-rules.md
autonomous: true

must_haves:
  truths:
    - "canon-init SKILL.md detects GSD/Ralph/BMAD/Generic workflow from project files"
    - "canon-init generates Canon.json from template with correct project-specific values"
    - "canon-init generates client-interface.md describing the public API boundary"
    - "Detection priority: existing _canon_workflow > BMAD config > GSD artifacts > Ralph artifacts > Generic"
    - "Ambiguous detection outputs warning and does NOT silently pick one"
    - "Generated Canon.json includes _canon_workflow metadata field"
  artifacts:
    - path: "~/.claude/skills/canon-init/SKILL.md"
      provides: "Main skill prompt with detection algorithm and template filling logic"
      min_lines: 80
    - path: "~/.claude/skills/canon-init/templates/Canon.json.template"
      provides: "Single Canon.json template with {{PLACEHOLDER}} variables"
      contains: "{{PROJECT_TITLE}}"
    - path: "~/.claude/skills/canon-init/templates/client-interface.template.md"
      provides: "client-interface.md template for public API boundary documentation"
      contains: "{{PROJECT_TITLE}}"
    - path: "~/.claude/skills/canon-init/rules/gsd-rules.md"
      provides: "GSD-specific rules for Canon.json rules array"
      min_lines: 10
  key_links:
    - from: "~/.claude/skills/canon-init/SKILL.md"
      to: "~/.claude/skills/canon-init/workflows/*.md"
      via: "Detection algorithm reads workflow reference files"
      pattern: "workflows/"
    - from: "~/.claude/skills/canon-init/SKILL.md"
      to: "~/.claude/skills/canon-init/templates/Canon.json.template"
      via: "Template filling with detected values"
      pattern: "Canon\\.json\\.template"
---

<objective>
Implement the `~/.claude/skills/canon-init/` skill: a global Claude Code skill that detects a project's workflow type (GSD/Ralph/BMAD/Generic), analyzes its codebase structure, and generates Canon.json + client-interface.md with workflow-appropriate configuration.

Purpose: This skill is the first of two Canon governance skills, providing repeatable, workflow-aware project initialization for any Claude Code project. It replaces manual Canon.json creation.
Output: SKILL.md (main prompt), Canon.json.template, client-interface.template.md, 3 rules files (GSD, Ralph, BMAD).
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.3-test-foundation-canon-governance/CANON-CONTEXT.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-CONTEXT.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-05-SUMMARY.md
@Canon.json
@docs/architecture/client-interface.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Canon.json template and rules files</name>
  <files>~/.claude/skills/canon-init/templates/Canon.json.template, ~/.claude/skills/canon-init/templates/client-interface.template.md, ~/.claude/skills/canon-init/rules/gsd-rules.md, ~/.claude/skills/canon-init/rules/ralph-rules.md, ~/.claude/skills/canon-init/rules/bmad-rules.md</files>
  <action>
Create directories first:
```bash
mkdir -p ~/.claude/skills/canon-init/templates
mkdir -p ~/.claude/skills/canon-init/rules
```

**File 1: `templates/Canon.json.template`**

Create a single Canon.json template with `{{PLACEHOLDER}}` variables:

```json
{
  "$schema": "https://canon.so/schema/canon.json",
  "projectTitle": "{{PROJECT_TITLE}}",
  "description": "{{PROJECT_DESCRIPTION}}",
  "branch": "{{BRANCH}}",
  "folders": [
    {{PUBLIC_FOLDERS}}
  ],
  "excludeFolders": [
    {{EXCLUDE_FOLDERS}}
  ],
  "excludeFiles": [
    {{EXCLUDE_FILES}}
  ],
  "rules": [
    {{RULES}}
  ],
  "_canon_workflow": "{{WORKFLOW}}",
  "previousVersions": [],
  "branchVersions": []
}
```

**File 2: `templates/client-interface.template.md`**

Create a template for the client-interface.md documentation:

```markdown
# Client Interface — {{PROJECT_TITLE}}

## Public API Surface

The following modules are part of the public API and safe for external clients (TUI, scripts, integrations) to import from:

{{PUBLIC_MODULES}}

## Internal Modules (Do Not Import)

The following modules are internal implementation details. They may change without notice:

{{INTERNAL_MODULES}}

## Usage Rules

{{USAGE_RULES}}

## Service Contracts

{{SERVICE_CONTRACTS}}

---

_Generated by canon-init ({{WORKFLOW}} workflow). Last updated: {{DATE}}_
```

**File 3: `rules/gsd-rules.md`**

GSD-specific rules for the Canon.json `rules` array. These are rules that apply to projects using the GSD workflow:

```markdown
# GSD Workflow Rules

Rules to include in Canon.json when project uses GSD workflow:

1. Phase execution creates new modules — run canon-update after each phase completion to detect folder drift
2. .planning/ directory is internal — never include in Canon.json folders
3. State tracking files (STATE.md, ROADMAP.md) are workflow control documents, not documentation — exclude from public surface
4. Test files are internal — tests/ directory excluded from Canon.json folders
5. Data files (databases, caches) are internal — data/ directory excluded
```

**File 4: `rules/ralph-rules.md`**

Ralph-specific rules based on plan 05 research findings. Include rules about Ralph's control document conventions and what Ralph clients should/shouldn't access.

**File 5: `rules/bmad-rules.md`**

BMAD-specific rules based on plan 05 research findings. Include rules about BMAD's configuration conventions and what BMAD clients should/shouldn't access.

Use the plan 05 SUMMARY for Ralph and BMAD specifics. If the research found distinct patterns, encode them. If Ralph/BMAD patterns are similar to GSD, note the commonalities but keep separate files for extensibility.
  </action>
  <verify>
Verify all template and rules files exist:
```bash
ls -la ~/.claude/skills/canon-init/templates/
ls -la ~/.claude/skills/canon-init/rules/
grep "PROJECT_TITLE" ~/.claude/skills/canon-init/templates/Canon.json.template
grep "PROJECT_TITLE" ~/.claude/skills/canon-init/templates/client-interface.template.md
```
  </verify>
  <done>Canon.json.template with {{PLACEHOLDER}} variables, client-interface.template.md, and 3 workflow-specific rules files created. Templates support all workflow types via placeholder substitution.</done>
</task>

<task type="auto">
  <name>Task 2: Create SKILL.md with detection algorithm and template-filling logic</name>
  <files>~/.claude/skills/canon-init/SKILL.md</files>
  <action>
Create the main SKILL.md file with YAML frontmatter and the skill's instruction prompt.

**Frontmatter:**
```yaml
---
name: canon-init
description: Initialize Canon.json and client-interface.md for a project with workflow-aware configuration
user-invocable: true
argument-hint: [project_root]
---
```

**Skill body structure:**

The SKILL.md IS the prompt that Claude executes when the skill is invoked. Write it as clear step-by-step instructions for Claude to follow.

**Step 1: Detect Workflow Type**

Detection algorithm (per locked decision #12):
1. Check for existing Canon.json with `_canon_workflow` field → use that workflow
2. Check for BMAD config files (from `workflows/bmad.md` detection signals)
3. Check for GSD artifacts: `.planning/STATE.md` AND `.planning/ROADMAP.md` present
4. Check for Ralph artifacts (from `workflows/ralph.md` detection signals)
5. If no match: auto-default to Generic (proceed without asking)
6. If multiple matches (signals for 2+ workflows): output WARNING listing matches, do NOT silently pick one. Ask user which to use.

Include instructions to read the workflow reference files from `~/.claude/skills/canon-init/workflows/{detected}.md` for project state reading guidance.

**Step 2: Read Project Context**

Using the detected workflow's reference file, read:
- Project title and description
- Current branch (from `git branch --show-current`)
- Public surface folders (analyze src/ or equivalent)
- Internal/excluded folders
- Key constraints/rules

**Step 3: Analyze Codebase Structure**

Instructions for Claude to:
- List top-level directories and identify public vs internal
- Identify the main source directory (src/, lib/, or root-level modules)
- Identify test directories, build output, config files
- For GSD: read `.planning/STATE.md` for accumulated decisions that become rules

**Step 4: Fill Templates**

Read `~/.claude/skills/canon-init/templates/Canon.json.template` and replace all `{{PLACEHOLDER}}` variables with detected values:
- `{{PROJECT_TITLE}}` — from manifest or README
- `{{PROJECT_DESCRIPTION}}` — from manifest, README, or PROJECT.md
- `{{BRANCH}}` — from git
- `{{PUBLIC_FOLDERS}}` — quoted, comma-separated folder paths
- `{{EXCLUDE_FOLDERS}}` — quoted, comma-separated folder paths
- `{{EXCLUDE_FILES}}` — quoted, comma-separated file names
- `{{RULES}}` — from rules/{workflow}-rules.md + project-specific rules discovered in Step 3
- `{{WORKFLOW}}` — detected workflow name (gsd, ralph, bmad, generic)

Write `Canon.json` to project root.

Read `~/.claude/skills/canon-init/templates/client-interface.template.md` and fill similarly. Write to `docs/architecture/client-interface.md` (creating directory if needed).

**Step 5: Report**

Output a summary of what was created:
- Workflow detected and why
- Canon.json location and key fields
- client-interface.md location
- Public surface vs excluded folders
- Number of rules generated

**Important prompt engineering details:**
- The skill should be written as instructions TO Claude, not code that runs
- Reference supporting files with `@~/.claude/skills/canon-init/` paths
- Include explicit "Read this file:" instructions for template and workflow files
- Include error handling instructions (what to do if git fails, if no manifest found, etc.)
  </action>
  <verify>
Verify SKILL.md exists with correct frontmatter:
```bash
head -10 ~/.claude/skills/canon-init/SKILL.md
```

Verify the full directory structure:
```bash
find ~/.claude/skills/canon-init/ -type f | sort
```

Should show:
- SKILL.md
- templates/Canon.json.template
- templates/client-interface.template.md
- rules/gsd-rules.md
- rules/ralph-rules.md
- rules/bmad-rules.md
- workflows/gsd.md (from plan 05)
- workflows/ralph.md (from plan 05)
- workflows/bmad.md (from plan 05)
- workflows/generic.md (from plan 05)
  </verify>
  <done>canon-init skill complete: SKILL.md with 5-step detection and generation process, Canon.json.template, client-interface.template.md, and 3 rules files. Detection algorithm follows locked priority order. Ambiguity outputs warning. Auto-defaults to Generic when no match.</done>
</task>

</tasks>

<verification>
- `find ~/.claude/skills/canon-init/ -type f | wc -l` — at least 10 files (SKILL.md + 2 templates + 3 rules + 4 workflows)
- `grep "canon-init" ~/.claude/skills/canon-init/SKILL.md` — frontmatter present
- `grep "PROJECT_TITLE" ~/.claude/skills/canon-init/templates/Canon.json.template` — placeholder present
- `grep "_canon_workflow" ~/.claude/skills/canon-init/templates/Canon.json.template` — workflow metadata field present
- `grep "detection" ~/.claude/skills/canon-init/SKILL.md` — detection algorithm documented
</verification>

<success_criteria>
- SKILL.md has valid frontmatter (name, description, user-invocable, argument-hint)
- Detection algorithm follows locked priority: existing _canon_workflow > BMAD > GSD > Ralph > Generic
- Ambiguity produces warning (does not silently pick)
- No-match auto-defaults to Generic
- Canon.json.template has all 7 placeholder variables
- client-interface.template.md has public/internal module sections
- Rules files exist for GSD, Ralph, BMAD
- _canon_workflow field included in Canon.json template
- client-interface.md generated in same execution (per locked decision #10)
</success_criteria>

<output>
After completion, create `.planning/phases/06.3-test-foundation-canon-governance/06.3-06-SUMMARY.md`
</output>
