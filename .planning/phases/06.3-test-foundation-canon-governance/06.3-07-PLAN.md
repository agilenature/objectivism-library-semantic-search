---
phase: 06.3-test-foundation-canon-governance
plan: 07
type: execute
wave: 2
depends_on: ["06.3-05"]
files_modified:
  - ~/.claude/skills/canon-update/SKILL.md
  - .claude/commands/update-docs.md
autonomous: true

must_haves:
  truths:
    - "canon-update SKILL.md performs Layer 1 audit comparing Canon.json against actual codebase"
    - "canon-update detects new public modules not in Canon.json folders"
    - "canon-update detects new internal modules not in Canon.json excludeFolders"
    - "canon-update identifies new rules from recent project decisions"
    - "canon-update reports drift or confirms no drift detected"
    - "/update-docs includes a lightweight Canon.json Layer 1 audit step"
  artifacts:
    - path: "~/.claude/skills/canon-update/SKILL.md"
      provides: "Main skill prompt with Layer 1 audit algorithm and drift detection"
      min_lines: 60
    - path: ".claude/commands/update-docs.md"
      provides: "Updated update-docs command with Canon.json audit step added"
      contains: "canon-update"
  key_links:
    - from: "~/.claude/skills/canon-update/SKILL.md"
      to: "Canon.json"
      via: "Reads current Canon.json for drift comparison"
      pattern: "Canon\\.json"
    - from: ".claude/commands/update-docs.md"
      to: "~/.claude/skills/canon-update/SKILL.md"
      via: "References canon-update audit in update-docs flow"
      pattern: "canon"
---

<objective>
Implement the `~/.claude/skills/canon-update/` skill for Layer 1 Canon.json audit and update, then hook a lightweight audit into the existing `/update-docs` command.

Purpose: canon-update ensures Canon.json stays in sync with the codebase as it evolves across phases. Hooking into /update-docs means the audit happens naturally as part of the existing documentation workflow.
Output: canon-update SKILL.md, updated update-docs.md with Canon audit step.
</objective>

<execution_context>
@/Users/david/.claude/get-shit-done/workflows/execute-plan.md
@/Users/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.3-test-foundation-canon-governance/CANON-CONTEXT.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-CONTEXT.md
@.planning/phases/06.3-test-foundation-canon-governance/06.3-05-SUMMARY.md
@.claude/commands/update-docs.md
@Canon.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canon-update SKILL.md</name>
  <files>~/.claude/skills/canon-update/SKILL.md</files>
  <action>
The canon-update/workflows/ directory should already exist from plan 05. Create SKILL.md in the canon-update directory.

**Frontmatter:**
```yaml
---
name: canon-update
description: Audit Canon.json Layer 1 against current codebase and update if drift detected
user-invocable: true
argument-hint: [project_root]
---
```

**Skill body — Layer 1 Audit Algorithm:**

Write step-by-step instructions for Claude to execute when this skill is invoked.

**Step 1: Detect Workflow**

Same detection algorithm as canon-init (per locked decision #12):
1. Read existing Canon.json → check `_canon_workflow` field first
2. If no `_canon_workflow`, fall through detection chain: BMAD > GSD > Ralph > Generic
3. Read the appropriate `~/.claude/skills/canon-update/workflows/{workflow}.md` for audit guidance

**Step 2: Read Current Canon.json**

Parse current Canon.json from project root. Extract:
- `folders` (current public surface)
- `excludeFolders` (current exclusions)
- `excludeFiles` (current file exclusions)
- `rules` (current rules)
- `_canon_workflow` (if present)

If Canon.json doesn't exist, report error and suggest running `/canon-init` instead.

**Step 3: Scan Codebase**

Instructions to:
- List all directories under the source root (e.g., `src/objlib/` for Python projects)
- For each directory, classify as public or internal
- List all top-level source files
- Compare against Canon.json `folders` and `excludeFolders`

**Step 4: Layer 1 Drift Detection**

Check each dimension:

**Folder drift:**
- New directories in source that are NOT in `folders` AND NOT in `excludeFolders` → report as "unclassified module"
- Directories in `folders` that no longer exist → report as "stale public folder"
- Directories in `excludeFolders` that no longer exist → report as "stale exclusion" (informational)

**Rule drift:**
- Read workflow-specific audit checklist from workflows/{workflow}.md
- For GSD: read `.planning/STATE.md` accumulated decisions. Check if any recent decision should become a new rule
- For Generic: check README, CHANGELOG for new constraints

**File exclusion drift:**
- Files in `excludeFiles` that no longer exist → report as "stale file exclusion"

**Step 5: Update or Report**

If drift detected:
- Present a summary of all drift items with recommended changes
- Apply changes to Canon.json (update folders, excludeFolders, rules as needed)
- Update client-interface.md if public surface changed
- Report what was updated

If no drift detected:
- Report "No Layer 1 drift detected. Canon.json is current."

**Layer 2 check (informational only):**
- Check if project is at a milestone boundary (for GSD: check if a major phase just completed)
- If yes: suggest that `previousVersions` should be updated (but do NOT auto-update — Layer 2 is milestone-cadence)

**Step 6: Summary**

Output:
- Workflow detected
- Drift items found (or "none")
- Changes made (or "none")
- Layer 2 advisory (if applicable)
  </action>
  <verify>
Verify SKILL.md exists with correct frontmatter:
```bash
head -10 ~/.claude/skills/canon-update/SKILL.md
grep "canon-update" ~/.claude/skills/canon-update/SKILL.md | head -3
```

Verify the full directory structure:
```bash
find ~/.claude/skills/canon-update/ -type f | sort
```

Should show SKILL.md plus 4 workflow files from plan 05.
  </verify>
  <done>canon-update SKILL.md complete with 6-step audit algorithm: workflow detection, Canon.json parsing, codebase scanning, Layer 1 drift detection (folders, rules, files), update/report, and Layer 2 advisory. Uses same detection priority as canon-init.</done>
</task>

<task type="auto">
  <name>Task 2: Hook lightweight Canon audit into /update-docs</name>
  <files>.claude/commands/update-docs.md</files>
  <action>
Read the existing `.claude/commands/update-docs.md` and add a new step for Canon.json Layer 1 audit (per locked decision #13).

**Add a new Step 5 (after existing Step 4: Report What Changed) that performs a lightweight Canon audit:**

```markdown
---

## Step 5: Canon.json Layer 1 Audit

After updating documentation, perform a lightweight Canon governance check.

**If Canon.json exists at project root:**

1. Read Canon.json `folders` and `excludeFolders` arrays
2. List all directories under the source root (e.g., `src/objlib/`)
3. Check for:
   - New directories NOT in `folders` AND NOT in `excludeFolders` (unclassified)
   - Directories in `folders` that no longer exist (stale)
4. If drift detected: append to the Step 4 report with a "Canon Drift" section listing the unclassified or stale directories
5. If no drift: add "Canon.json: no drift detected" to the report

**If Canon.json does not exist:** Skip this step silently.

This is a lightweight check only — it does NOT modify Canon.json. For full audit and update, run `/canon-update` directly.
```

**Important:** This is a lightweight READ-ONLY check added to update-docs. It reports drift but does not auto-fix. The full canon-update skill handles actual updates.

Do NOT modify any existing steps (1-4). Only ADD step 5 after step 4. Keep the existing Constraints section at the bottom.
  </action>
  <verify>
```bash
grep -c "Canon" /Users/david/projects/objectivism-library-semantic-search/.claude/commands/update-docs.md
```
Should return 3+ (references to Canon.json audit step).

```bash
grep "Step 5" /Users/david/projects/objectivism-library-semantic-search/.claude/commands/update-docs.md
```
Should show the new Canon audit step.
  </verify>
  <done>update-docs.md has new Step 5 performing lightweight Canon.json Layer 1 drift check. Reports unclassified/stale directories without modifying Canon.json. Full updates deferred to /canon-update skill.</done>
</task>

</tasks>

<verification>
- `head -10 ~/.claude/skills/canon-update/SKILL.md` — correct frontmatter
- `find ~/.claude/skills/canon-update/ -type f | wc -l` — at least 5 files (SKILL.md + 4 workflows)
- `grep "Step 5" .claude/commands/update-docs.md` — Canon audit step present
- `grep "Canon" .claude/commands/update-docs.md` — Canon references present
- Existing update-docs steps 1-4 unchanged
</verification>

<success_criteria>
- canon-update SKILL.md has valid frontmatter and 6-step audit algorithm
- Layer 1 drift detection covers folders, rules, and file exclusions
- Layer 2 check is advisory only (no auto-update)
- update-docs.md has lightweight Canon audit as Step 5
- Step 5 is read-only (reports drift, does not modify Canon.json)
- Existing update-docs steps 1-4 preserved unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06.3-test-foundation-canon-governance/06.3-07-SUMMARY.md`
</output>
