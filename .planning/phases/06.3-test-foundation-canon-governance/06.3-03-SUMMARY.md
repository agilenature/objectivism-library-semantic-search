---
phase: 06.3-test-foundation-canon-governance
plan: 03
subsystem: testing
tags: [pytest, search, expansion, reranker, synthesizer, MMR, citations, metadata-filters]

# Dependency graph
requires:
  - phase: 04-quality-enhancements
    provides: "Search pipeline: expansion engine, reranker, synthesizer, MMR diversity, citation validation"
provides:
  - "54 retroactive tests for search pipeline covering expansion, reranking, synthesis, MMR, citations, metadata filters"
  - "Mocked Gemini client boundary tests for reranker scoring"
  - "Pure logic tests for citation validation, MMR diversity, normalization"
affects: [06.3-test-foundation-canon-governance]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Mocking at client.models.generate_content boundary with RankedResults JSON"
    - "SimpleNamespace for Gemini grounding metadata mocks"
    - "In-memory DB fixture reuse from conftest.py for enrichment tests"

key-files:
  created:
    - tests/test_expansion.py
    - tests/test_reranker.py
    - tests/test_synthesizer.py
  modified: []

key-decisions:
  - "build_metadata_filter takes list[str] not dict -- adapted tests to match actual API (CLI-style 'field:value' strings)"
  - "Reranker mock uses model_dump_json() on RankedResults for response.text (not response.parsed) matching actual code path"
  - "Pre-existing test failures in test_formatter.py and test_search.py documented but not in scope to fix"

patterns-established:
  - "_make_citation helper: Standardized Citation construction for search tests"
  - "_make_claim helper: Standardized Claim/CitationRef construction for validation tests"
  - "_mock_rerank_response helper: Build mock generate_content responses from simple dicts"

# Metrics
duration: 3min
completed: 2026-02-18
---

# Phase 06.3 Plan 03: Search Pipeline Tests Summary

**54 retroactive tests for query expansion, LLM reranker with difficulty bucketing, MMR diversity, citation validation, metadata filters, and grounding extraction -- all mocked at API boundary**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-18T20:46:17Z
- **Completed:** 2026-02-18T20:50:12Z
- **Tasks:** 2
- **Files created:** 3

## Accomplishments
- 16 expansion tests covering synonym lookup, multi-word phrases, term boosting, case-insensitivity, and glossary loading
- 10 reranker tests covering score ordering, difficulty bucketing (learn/research modes), window-size mechanics, and API failure graceful degradation
- 28 synthesizer tests covering citation validation (exact, whitespace-normalized, case-insensitive, fabricated), MMR diversity (same-file dedup, course preference), metadata filter generation (string, numeric, comparison operators), grounding extraction, DB enrichment, and text normalization
- Zero API calls in test suite -- all Gemini interactions mocked

## Task Commits

Each task was committed atomically:

1. **Task 1: Query expansion and reranker tests** - `260d307` (test)
2. **Task 2: Synthesizer, citation validation, MMR, and metadata filter tests** - `33ee164` (test)

## Files Created/Modified
- `tests/test_expansion.py` (163 lines) - Query expansion: synonym lookup, phrase matching, boosting, case sensitivity, glossary loading
- `tests/test_reranker.py` (226 lines) - LLM reranker: score ordering, difficulty ordering, window-size, API failure handling
- `tests/test_synthesizer.py` (420 lines) - Citation validation, MMR diversity, metadata filters, grounding extraction, DB enrichment, normalization

## Decisions Made
- `build_metadata_filter` takes `list[str]` (CLI-style `"field:value"` strings), not a `dict` as plan suggested -- adapted tests to match actual API
- Reranker uses `response.text` with `model_validate_json()` (not `response.parsed`) -- mocked accordingly
- Two pre-existing test failures noted (test_formatter score bars, test_search _FakeDB missing method) -- not in scope for this plan

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Adapted metadata filter tests to actual API signature**
- **Found during:** Task 2 (metadata filter tests)
- **Issue:** Plan described `build_metadata_filter` as taking `{"course": "OPAR"}` dict, but actual function takes `["course:OPAR"]` list of strings
- **Fix:** Read actual `citations.py` source, wrote tests matching the real `list[str]` API
- **Files modified:** tests/test_synthesizer.py
- **Verification:** All 7 metadata filter tests pass
- **Committed in:** 33ee164

**2. [Rule 3 - Blocking] Adapted reranker mock to match actual response parsing**
- **Found during:** Task 1 (reranker tests)
- **Issue:** Plan suggested mocking `response.parsed`, but actual code uses `response.text` with `model_validate_json()`
- **Fix:** Mock returns `RankedResults.model_dump_json()` as `response.text`
- **Files modified:** tests/test_reranker.py
- **Verification:** All 10 reranker tests pass
- **Committed in:** 260d307

---

**Total deviations:** 2 auto-fixed (both Rule 3 - blocking: API signature mismatches)
**Impact on plan:** Both fixes necessary to test actual code paths. No scope creep.

## Issues Encountered
- Pre-existing test failure in `test_formatter.py::test_display_search_results_score_bars` (score bars removed per commit f0601e2, test not updated) -- not caused by this plan
- Pre-existing test failure in `test_search.py::TestEnrichCitations::test_unmatched` (`_FakeDB` missing `get_file_metadata_by_gemini_ids` method) -- not caused by this plan

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Search pipeline fully tested with 54 tests (expansion, reranking, synthesis, citations, filters)
- Test patterns established (helpers, mocking strategy) reusable for future search feature tests
- Two pre-existing test failures should be addressed in a future plan

---
*Phase: 06.3-test-foundation-canon-governance*
*Completed: 2026-02-18*
