# CLARIFICATIONS-ANSWERED.md

## Phase 1: Foundation ‚Äî Stakeholder Decisions

**Generated:** 2026-02-15
**Mode:** YOLO (balanced strategy)
**Source:** Auto-generated by discuss-phase-ai

---

## Decision Summary

**Total questions:** 8
**Tier 1 (Blocking):** 5 answered
**Tier 2 (Important):** 2 answered
**Tier 3 (Polish):** 1 answered

---

## Tier 1: Blocking Decisions

### Q1: Primary Key Strategy for File Tracking

**Question:** Should the database use file path or content hash as the primary key?

**YOLO DECISION:** **Option A - File path as primary key**

**Rationale:**
- Confidence level: ‚úÖ Consensus (both Gemini and Perplexity recommended)
- File path reflects pedagogical structure encoded in folder hierarchy
- A file moved from `/Course/Drafts/` to `/Course/Final/` has different metadata ‚Üí correct to re-extract
- UNIQUE constraint on content_hash prevents duplicate uploads
- Strategy: Balanced (pick consensus option with strong architectural rationale)

**Sub-decisions:**
- Duplicate content handling: **Upload separately if paths differ** (folder structure = metadata, different metadata = different semantic context)
- Primary key: `file_path TEXT PRIMARY KEY`
- Deduplication: `UNIQUE INDEX idx_content_hash ON files(content_hash)`

---

### Q2: Metadata Storage Strategy

**Question:** Should extracted metadata use dedicated SQL columns or JSON blob?

**YOLO DECISION:** **Option A - Hybrid schema (core columns + JSON blob)**

**Rationale:**
- Confidence level: ‚úÖ Consensus (both providers recommended hybrid approach)
- Quick iteration on metadata extraction without schema migrations
- Efficient status queries (`WHERE status = 'PENDING'`)
- Future-proof: can promote high-value fields to columns later if querying becomes critical
- Strategy: Balanced (pick consensus option that maximizes flexibility)

**Sub-decisions:**
- Core columns: `file_path`, `content_hash`, `status`, `filename`, `file_size`, `metadata_quality`, `gemini_file_id`, `upload_timestamp`, `remote_expiration_ts`, `embedding_model_version`, `created_at`, `updated_at`
- JSON column: `metadata_json` (stores all extracted fields: course, year, quarter, week, topic, instructor, difficulty, etc.)
- Validation tracking: `metadata_quality` enum column (complete, partial, minimal, none)
- Future promotion: Defer until Phase 3 reveals which fields are queried most frequently

---

### Q3: Unknown Metadata Handling

**Question:** How should the scanner handle files that don't match expected naming patterns?

**YOLO DECISION:** **Option A - Permissive extraction with quality tracking**

**Rationale:**
- Confidence level: ‚úÖ Consensus (both providers recommended graceful degradation)
- Better to have file searchable with limited metadata than missing entirely
- Quality tracking enables later review of problematic patterns
- Supports discovery of unexpected naming conventions in 1,749-file corpus
- Strategy: Balanced (pick consensus option that prioritizes availability over perfection)

**Sub-decisions:**
- Always create DB record: **Yes** (even if regex fails completely)
- Failed extractions: **Store as `null` in `metadata_json`**
- Quality enum: **Set to `minimal` or `none` based on extraction success**
- Extraction failures table: **Create `_extraction_failures` table to log unparsed patterns**
- Junk files: **Skip `.DS_Store`, `Thumbs.db`, `.git/`, `__pycache__/` explicitly**
- Manual review flag: **Defer to Phase 1 execution** (generate report of `metadata_quality = 'none'` files after first scan)

---

### Q4: 48-Hour Expiration Tracking

**Question:** How to model the 48-hour expiration in the database schema?

**YOLO DECISION:** **Option A - Track upload timestamp + explicit expiration timestamp**

**Rationale:**
- Confidence level: ‚úÖ Consensus (both providers recommended explicit tracking)
- Prevents edge cases with clock skew or timezone issues
- Upload timestamp useful for audit trail and debugging
- Explicit expiration timestamp enables efficient queries (`WHERE remote_expiration_ts < NOW()`)
- Strategy: Balanced (pick consensus option that is most robust)

**Sub-decisions:**
- Columns: `upload_timestamp DATETIME` and `remote_expiration_ts DATETIME` (both null in Phase 1)
- Set timing: **During Phase 2 upload** (set `upload_timestamp = NOW()`, `remote_expiration_ts = NOW() + INTERVAL 48 HOUR`)
- Expiration scope: **Raw uploaded files** (indexed/vector data persists indefinitely per Gemini docs)
- Auto re-upload: **No** (require manual `sync` command, prevent unexpected API costs)

---

### Q5: Metadata Extraction Pattern Specification

**Question:** What are the exact folder naming conventions in the library?

**YOLO DECISION:** **Option A - Three-tier pattern matching with discovered patterns**

**Rationale:**
- Confidence level: ‚úÖ **RESOLVED** (actual library examples analyzed)
- Two distinct patterns discovered: Simple (dominant, ~76 courses) and Complex (rare, 1 course)
- Three-tier approach handles both patterns plus future variations
- Strategy: Pattern-specific extraction with graceful fallback

**Discovered Patterns:**

**Pattern 1: Simple (Dominant - ~99% of courses)**
- Folder structure: `Courses/{Course Name}/`
- Filename pattern: `{Course Name} - Lesson {NN} - {Topic}.txt`
- No hierarchical year/quarter/week folders
- Examples:
  - `Induction in Physics and Philosophy - Lesson 01 - The Axioms of Induction, Part 1.txt`
  - `The DIM Hypothesis I - Lesson 01 - Integration.txt`
  - `Eight Great Plays - Lesson 01 - Antigone by Sophocles _ a Literary and Philosophical Analysis.txt`

**Pattern 2: Complex (Rare - 1 instance: "Objectivism Seminar - Foundations")**
- Folder structure: `Courses/{Course Name}/Year{N}/Q{N}/`
- Filename pattern: `{Course Name} - Year {N} - Q{N} - Week {N} - {Topic}.txt`
- Hierarchical with Year/Quarter folders
- Example:
  - `Objectivism Seminar - Foundations - Year 1 - Q1 - Week 1 - Objectivism and Its View of Philosophy.txt`

**Sub-decisions:**

**Tier 1 - Pattern-specific regex:**
```python
# Simple pattern (dominant)
SIMPLE_PATTERN = r'^(?P<course>.+?) - Lesson (?P<lesson>\d{2}) - (?P<topic>.+?)\.txt$'

# Complex pattern (hierarchical)
COMPLEX_PATTERN = r'^(?P<course>.+?) - Year (?P<year>\d+) - Q(?P<quarter>\d+) - Week (?P<week>\d+) - (?P<topic>.+?)\.txt$'
```

**Tier 2 - Folder hierarchy detection:**
- Detect pattern by checking if file is in `Year{N}/Q{N}/` subfolder
- If yes ‚Üí use Complex pattern
- If no ‚Üí use Simple pattern
- Extract course name from parent folder name (e.g., "Courses/Induction in Physics and Philosophy/" ‚Üí course = "Induction in Physics and Philosophy")

**Tier 3 - Fallback for variations:**
- If neither pattern matches, store unparsed components in `metadata_json` with `_unparsed_` prefix
- Set `metadata_quality = 'minimal'`
- Log to `_extraction_failures` table for review

**Metadata extraction mapping:**

**Simple pattern extracts:**
- `course`: From folder name (parent directory)
- `lesson_number`: From filename regex group `lesson`
- `topic`: From filename regex group `topic`
- `year`, `quarter`, `week`: `null` (not applicable)

**Complex pattern extracts:**
- `course`: From folder name (grandparent directory, 2 levels up)
- `year`: From filename regex group `year`
- `quarter`: From filename regex group `quarter`
- `week`: From filename regex group `week`
- `topic`: From filename regex group `topic`
- `lesson_number`: Use `week` value (week = lesson in this context)

**Additional metadata from config file:**
- Create `metadata_mappings.json` for course-level metadata (difficulty, instructor, etc.)
- Map course name ‚Üí known metadata
- Example: `{"Objectivism Seminar - Foundations": {"difficulty": "comprehensive", "instructor": "TBD"}}`

---

## Tier 2: Important Decisions

### Q6: File Type Allow-List

**Question:** Which file extensions should be processed during scanning?

**YOLO DECISION:** **Option A - Strict allow-list with defaults**

**Rationale:**
- Confidence level: ‚ö†Ô∏è Recommended (architectural best practice)
- Avoid processing non-content files (images, executables, system files)
- 1,749-file corpus likely contains some non-text artifacts
- Configurable for future expansion (e.g., PDF support in v2)
- Strategy: Balanced (pick recommended option with safe defaults)

**Sub-decisions:**
- Extensions: **`{'.txt', '.md', '.pdf', '.epub', '.docx', '.html'}`**
- Hidden files: **Skip all files starting with `.`**
- Minimum size: **1 KB** (skip empty or near-empty files)
- Skipped files log: **Create `_skipped_files` table** (file_path, reason, timestamp)
- Configuration: **Store in `scanner_config.json`** for easy tuning
- Image files: **Skip in v1** (defer scanned manuscript support to v2)

---

### Q7: Orphaned Database Records

**Question:** What happens to DB records when a file is deleted from disk?

**YOLO DECISION:** **Option A - Soft delete with cleanup workflow**

**Rationale:**
- Confidence level: ‚ö†Ô∏è Recommended (standard distributed system pattern)
- Need `gemini_file_id` to send delete command to Gemini API in Phase 2
- Preserves audit trail of what was uploaded and removed
- Prevents accidental data loss from temporary file moves
- Strategy: Balanced (pick recommended option that is safest)

**Sub-decisions:**
- Detection: **Scanner compares disk files vs. DB records each run**
- Marking: **Set `status = 'LOCAL_DELETE'` for missing files**
- Preservation: **Keep record until Phase 2 confirms Gemini cleanup** (or manual purge)
- Purge command: **Add `purge` CLI command** (`purge --older-than 30d --confirmed-deleted`)
- Auto-purge: **Manual only** (prevent accidental cleanup, require explicit user action)

---

## Tier 3: Implementation Details

### Q8: Symlink Handling Strategy

**Question:** Should symbolic links be followed, ignored, or treated as special cases?

**YOLO DECISION:** **Option A - Follow symlinks with cycle detection**

**Rationale:**
- Confidence level: üîç Implementation detail (safe default available)
- Cycle detection prevents infinite loops
- Enables cross-referencing if library uses symlinks intentionally
- Minimal performance overhead (inode tracking)
- Strategy: Choose safest option with flexibility

**Sub-decisions:**
- Follow symlinks: **Yes** (unless they create cycles)
- Cycle detection: **Track `visited_inodes` set** (device + inode pairs)
- Circular references: **Log as warnings** (don't fail scan, continue with remaining files)
- Path metadata: **Use symlink path** (not resolved path) for folder structure extraction
- Configuration: **Add `follow_symlinks` flag** to `scanner_config.json` (default: true)

---

## Implementation Summary

### Recommended SQLite Schema (Based on Decisions)

```sql
-- Core files table
CREATE TABLE files (
    file_path TEXT PRIMARY KEY,
    content_hash BLOB NOT NULL,
    filename TEXT NOT NULL,
    file_size INTEGER NOT NULL,

    -- Metadata (JSON blob for flexibility)
    metadata_json TEXT,
    metadata_quality TEXT DEFAULT 'unknown' CHECK(metadata_quality IN ('complete', 'partial', 'minimal', 'none', 'unknown')),

    -- State management
    status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'uploading', 'uploaded', 'failed', 'LOCAL_DELETE')),
    error_message TEXT,

    -- API integration (null in Phase 1)
    gemini_file_uri TEXT,
    gemini_file_id TEXT,
    upload_timestamp DATETIME,
    remote_expiration_ts DATETIME,
    embedding_model_version TEXT,

    -- Timestamps
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_content_hash ON files(content_hash);
CREATE INDEX idx_status ON files(status);
CREATE INDEX idx_metadata_quality ON files(metadata_quality);
CREATE INDEX idx_file_size ON files(file_size);

-- Extraction failures for pattern discovery
CREATE TABLE _extraction_failures (
    failure_id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    unparsed_folder_name TEXT,
    unparsed_filename TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (file_path) REFERENCES files(file_path)
);

-- Skipped files log
CREATE TABLE _skipped_files (
    skip_id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    reason TEXT NOT NULL,
    file_size INTEGER,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Processing log for audit trail
CREATE TABLE _processing_log (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    old_status TEXT,
    new_status TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    error_details TEXT,
    FOREIGN KEY (file_path) REFERENCES files(file_path)
);

-- WAL mode configuration
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = -10000;  -- 10 MB cache
PRAGMA foreign_keys = ON;
PRAGMA temp_store = MEMORY;
```

### Configuration Files

**`scanner_config.json`:**
```json
{
  "allowed_extensions": [".txt", ".md", ".pdf", ".epub", ".docx", ".html"],
  "min_file_size_bytes": 1024,
  "skip_hidden_files": true,
  "skip_patterns": [".DS_Store", "Thumbs.db", ".git", "__pycache__"],
  "follow_symlinks": true,
  "library_path": "/Volumes/U32 Shadow/Objectivism Library"
}
```

**`metadata_mappings.json`** (example structure, needs real data):
```json
{
  "courses": {
    "OPAR": {
      "course_name": "Objectivism: The Philosophy of Ayn Rand",
      "difficulty": "comprehensive"
    },
    "ITOE": {
      "course_name": "Introduction to Objectivist Epistemology",
      "difficulty": "advanced"
    }
  },
  "folder_patterns": {
    "year": "\\d{4}",
    "quarter": "Q[1-4]|Quarter-[1-4]",
    "week": "Week-\\d{2}|W\\d{2}"
  }
}
```

---

## ‚úÖ All Blockers Resolved

All 8 questions have been answered, including Q5 which has been finalized with actual library pattern analysis:
- **Simple pattern** (dominant): `{Course Name} - Lesson {NN} - {Topic}.txt`
- **Complex pattern** (rare): `{Course Name} - Year {N} - Q{N} - Week {N} - {Topic}.txt`

No blocking issues remain. Ready to proceed to planning.

---

## Next Steps

1. ‚úÖ Clarifications answered (YOLO mode with balanced strategy)
2. ‚úÖ Q5 metadata patterns finalized (actual library analysis complete)
3. ‚è≠Ô∏è Ready to proceed to `/gsd:plan-phase 1`

**Recommended next command:**
```bash
/gsd:plan-phase 1
```

This will create a detailed execution plan (PLAN.md) incorporating these decisions and discovered patterns.

---

*Auto-generated by discuss-phase-ai --yolo (balanced strategy)*
*Synthesis: Gemini Pro + Perplexity Sonar Deep Research*
*Patterns finalized via actual library exploration*
*Generated: 2026-02-15, Updated: 2026-02-15 (patterns discovered)*
