---
phase: 06.2-metadata-enriched-gemini-upload
plan: 02
subsystem: upload, cli
tags: [gemini, enriched-upload, orchestrator, cli, idempotency, content-injection, string-list-value]

# Dependency graph
requires:
  - phase: 06.2-01
    provides: build_enriched_metadata, compute_upload_hash, prepare_enriched_content, get_enriched_pending_files, schema v5
  - phase: 06-ai-powered-metadata
    provides: AI metadata in file_metadata_ai table
  - phase: 06.1-entity-extraction
    provides: Entity data in transcript_entity/person tables
provides:
  - EnrichedUploadOrchestrator with enriched metadata upload pipeline
  - CLI enriched-upload command with staged testing support (--limit)
  - Upload hash idempotency preventing duplicate uploads
  - Reset flow for re-uploading 17 already-uploaded files with enriched metadata
affects: [phase-4, phase-5, full-library-upload]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Subclass orchestrator pattern: EnrichedUploadOrchestrator extends UploadOrchestrator for specialized upload flow"
    - "Conservative concurrency: Semaphore(2) with 1-second staggered task launches via asyncio.sleep"
    - "Upload hash idempotency: SHA-256 of (phase1 + ai + entities + content_hash) stored in last_upload_hash"
    - "Gemini file reset flow: delete_file -> reset status -> re-upload with enriched metadata"

key-files:
  created: []
  modified:
    - src/objlib/upload/orchestrator.py
    - src/objlib/cli.py

key-decisions:
  - "Conservative concurrency default of 2 (not 7) with 1-second stagger per locked decision"
  - "Default store name objectivism-library-test (not objectivism-library-v1) for enriched uploads per MEMORY.md"
  - "Reset flow deletes from Gemini before re-upload, handles already-expired files gracefully"
  - "Dry-run mode shows AI category, entity count, and topics for each pending file"

patterns-established:
  - "Enriched upload as subclass: reuses parent circuit breaker, rate limiter, progress tracker, signal handling, lock management"
  - "Staged testing via --limit flag: 20 -> 100 -> 250 -> full for progressive validation"
  - "Temp file lifecycle: prepare_enriched_content creates, try/finally cleanup_temp_file destroys"

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 6.2 Plan 02: Enriched Upload Orchestrator and CLI Command Summary

**EnrichedUploadOrchestrator with 4-tier AI metadata, Tier 4 content injection, upload hash idempotency, and staged enriched-upload CLI command**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-17T07:07:04Z
- **Completed:** 2026-02-17T07:10:04Z
- **Tasks:** 1 (auto) + 1 (checkpoint, awaiting human verification)
- **Files modified:** 2

## Accomplishments
- EnrichedUploadOrchestrator subclasses UploadOrchestrator with enriched metadata building, content injection, temp file cleanup, upload hash idempotency, and conservative Semaphore(2) concurrency
- CLI enriched-upload command provides --limit for staged testing (20/100/250), --dry-run for preview, and --reset-existing for re-uploading the 17 already-uploaded files
- Upload hash idempotency via compute_upload_hash prevents duplicate uploads on re-run
- Reset flow identifies already-uploaded/failed files with enriched metadata, deletes from Gemini, and resets for re-upload

## Task Commits

Each task was committed atomically:

1. **Task 1: Enriched upload orchestrator and CLI command** - `0e64596` (feat)

## Files Created/Modified
- `src/objlib/upload/orchestrator.py` - EnrichedUploadOrchestrator with run_enriched(), _upload_enriched_file(), _reset_existing_files(), _process_enriched_batch()
- `src/objlib/cli.py` - enriched-upload CLI command with --store, --limit, --dry-run, --concurrency, --reset-existing, --include-needs-review

## Decisions Made
- Conservative concurrency (Semaphore(2) with 1-second stagger) per locked decision, much lower than parent's default 7
- Store name defaults to "objectivism-library-test" for enriched uploads (matching MEMORY.md project store)
- Reset flow uses try/except for Gemini delete_file to handle already-expired 48hr TTL files gracefully
- Dry-run shows enriched file details (AI category, entity count, topics) not just file paths

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - uses existing Gemini API key from system keyring (objlib-gemini).

## Next Phase Readiness
- Enriched upload pipeline ready for staged testing (--limit 20, 100, 250)
- Entity extraction (Phase 6.1) must be run on corpus before enriched uploads find files
- Checkpoint: user verification of three-stage testing approach before full deployment

---
*Phase: 06.2-metadata-enriched-gemini-upload*
*Completed: 2026-02-17*
