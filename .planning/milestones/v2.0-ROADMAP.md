# Milestone v2.0: Gemini File Lifecycle FSM

**Status:** ✅ SHIPPED 2026-02-27
**Phases:** 8–18 (plus decimal phases 16.1–16.6)
**Total Plans:** 55 (48 with formal SUMMARY.md; 7 completed via artifacts/superseded)

## Overview

Implemented a formal finite state machine governing every file's Gemini lifecycle so that `[Unresolved file #N]` never appears in search results — permanently. The milestone began with a store migration precondition and proceeded through 9 validation waves, each with a BLOCKING gate before the next could proceed. Key challenges: HOSTILE-distrust wave design, corpus-wide retrievability failures requiring 6 inserted phases, and a codebase-wide RxPY reactive migration across all async modules.

**Definition of done achieved:** `check_stability.py --sample-count 60` exits 0 (7/7 PASS, 60/60 files retrievable, 0 orphans). TUI search verified by user — 0 `[Unresolved file #N]` in 5 queries.

---

## Phases

### Phase 8: Store Migration Precondition

**Goal**: The system starts from a clean, known baseline — old store deleted, permanent store created, DB schema extended, stability instrument operational
**Depends on**: Nothing (first phase of v2.0)
**Plans**: 3 plans

Plans:
- [x] 08-01-PLAN.md — DB schema migration (V9 columns, state reset, metadata preservation verification)
- [x] 08-02-PLAN.md — Store migration (pre-flight check, create permanent store, delete old store)
- [x] 08-03-PLAN.md — check_stability.py v2 rewrite (FSM-aware assertions, exit code verification)

---

### Phase 9: Wave 1 — Async FSM Library Spike

**Goal**: A specific FSM approach (library or hand-rolled) is selected with affirmative evidence of correct async behavior under concurrent load
**Depends on**: Phase 8
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md — Spike infrastructure, Protocol, FSM adapter, full adversarial test harness
- [x] 09-02-PLAN.md — Approach selection documentation with test matrix and evidence

---

### Phase 10: Wave 2 — Transition Atomicity Spike

**Goal**: Every identified crash point in multi-API-call FSM transitions has a tested automatic recovery path
**Depends on**: Phase 9 gate passed
**Plans**: 2 plans

Plans:
- [x] 10-01-PLAN.md — Extended DB schema, FSM without final states, safe_delete wrappers, ResetTransitionManager, crash point tests
- [x] 10-02-PLAN.md — RecoveryCrawler startup recovery, FAILED escape path, SC3 simplicity measurement

---

### Phase 11: Wave 3 — display_name Stability and Import Reliability

**Goal**: `display_name` confirmed caller-controlled, import-to-visible lag measured and bounded, PROCESSING-to-INDEXED trigger strategy decided
**Depends on**: Phase 10 gate passed
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md — SDK source inspection + round-trip verification + import lag measurement spike
- [x] 11-02-PLAN.md — PROCESSING-to-INDEXED trigger strategy decision and Phase 11 gate documentation

---

### Phase 12: Wave 4 — 50-File Fresh FSM-Managed Upload

**Goal**: 50 test files complete the full FSM lifecycle (UNTRACKED through INDEXED) with correct `gemini_store_doc_id` for every file
**Depends on**: Phase 11 gate passed
**Plans**: 6 plans (with temporal stability protocol)

Plans:
- [x] 12-01-PLAN.md — V10 DB migration + FSM core (FileLifecycleSM, OCCConflictError, transition methods)
- [x] 12-02-PLAN.md — FSM orchestrator integration + _reset_existing_files fix + RecoveryCrawler + tests
- [x] 12-03-PLAN.md — 50-file FSM upload + T=0 baseline (check_stability, DB counts, store-sync, 5 TUI queries)
- [x] 12-04-PLAN.md — T+4h drift check [fresh session]
- [x] 12-05-PLAN.md — T+24h gate [fresh session] — BLOCKING for Phase 13; PASSED 2026-02-22
- [x] 12-06-PLAN.md — T+36h confirmation [fresh session]

---

### Phase 13: Wave 5 — State Column Retirement and Serialization

**Goal**: All query sites using legacy `status` column mapped to `gemini_state` equivalents, FSM state persists as plain string enum
**Depends on**: Phase 12 gate passed
**Plans**: 2 plans

Plans:
- [x] 13-01-PLAN.md — Precondition verification and status inventory artifact
- [x] 13-02-PLAN.md — V11 migration execution, all code rewrites, FileStatus removal, test suite update

---

### Phase 14: Wave 6 — Batch Performance Benchmark

**Goal**: FSM transition overhead measured under realistic batch conditions, bottleneck identified, acceptable throughput defined
**Depends on**: Phase 13 gate passed
**Plans**: 3 plans (2 baseline + 1 gap closure)

Plans:
- [x] 14-01-PLAN.md — Benchmark harness (yappi + explicit spans), 818-file simulation, 6 configurations, baseline measurement
- [x] 14-02-PLAN.md — VLID-06 gate verdict: PASS (PATH A, baseline passed both thresholds with 337×/66× margin)
- [x] 14-03-PLAN.md — Gap closure: shared-connection mitigation test with before/after measurements

---

### Phase 15: Wave 7 — FSM Consistency and store-sync Contract

**Goal**: Import-to-searchable lag empirically characterized, store-sync's ongoing role explicitly defined
**Depends on**: Phase 14 gate passed
**Plans**: 3 plans

Plans:
- [x] 15-01-PLAN.md — Lag measurement script + 20-file measurement run
- [x] 15-02-PLAN.md — FSM/store-sync contract, downgrade_to_failed(), temporal stability (T=0/T+4h/T+24h)
- [x] 15-03-PLAN.md — check_stability.py Assertion 7: per-file searchability sample (5 random indexed files)

---

### Phase 16: Wave 8 — Full Library Upload

**Goal**: All ~1,748 files uploaded through FSM-managed pipeline, `[Unresolved file #N]` never appears in any TUI search result
**Depends on**: Phase 15 gate passed, STAB-04 temporal stability protocol
**Plans**: 4 plans (2 complete, 1 via supersession, 1 completed via Phase 18 TUI validation)

Plans:
- [x] 16-01-PLAN.md — Bug fixes + full library upload execution + post-upload remediation + T=0 stability check
- [x] 16-02-PLAN.md — Temporal stability protocol (T=0/T+4h/T+24h/T+36h) — absorbed into Phase 16.5 gate runs
- [~] 16-03-PLAN.md — Phase 07-07 TUI smoke test — validated via Phase 18-05 TUI invariant suite (7/7 pass)
- [x] 16-04-PLAN.md — TUI-09: top_k=20, --top-k CLI flag, citation count banner, rank display, scroll hints

---

### Phase 16.1: Stability Instrument Correctness Audit (INSERTED)

**Goal**: Prove `check_stability.py` A6 and A7 assertions have no false-negative modes at full corpus scale
**Depends on**: Phase 16 T+24h check revealed A6/A7 failures
**Plans**: 3 plans (2 with SUMMARY + 1 delivered structurally via 16.3)

Plans:
- [x] 16.1-01-PLAN.md — HOSTILE spike: resolve all 7 identity/matching/query challenges
- [x] 16.1-02-PLAN.md — Fix implementation: A6 exact-match lookup, A7 per-pattern query strategy
- [x] 16.1-03-PLAN.md — Temporal re-validation (structural fix delivered via Phase 16.3)

---

### Phase 16.2: Metadata Completeness Invariant Enforcement (INSERTED)

**Goal**: Every file either has `primary_topics` populated or has `ai_metadata_status='skipped'` with a named reason
**Depends on**: Phase 16.1
**Plans**: 2 plans

Plans:
- [x] 16.2-01-PLAN.md — mark-unsupported command + .md extension fix + batch-extract backfill + audit command
- [x] 16.2-02-PLAN.md — Verify audit exits 0; all 1,885 files satisfy invariant

---

### Phase 16.3: Gemini File Search Retrievability Research (INSERTED)

**Goal**: Every indexed file independently retrievable in Gemini File Search via a targeted query
**Depends on**: Phase 16.2
**Plans**: 3 plans

Plans:
- [x] 16.3-01-PLAN.md — Diagnosis spike: H1-H4 hypothesis falsification; root cause = identity fields absent from indexed content
- [x] 16.3-02-PLAN.md — Intervention test: header_builder.py + ephemeral test store validation; GO decision
- [x] 16.3-03-PLAN.md — Production remediation: all 1,749 files re-uploaded with identity headers; gate PASSED 2026-02-25

---

### Phase 16.4: Metadata Pipeline Invariant + Comprehensive Retrievability Audit (INSERTED)

**Goal**: Every non-book file satisfies metadata completeness invariant AND is independently retrievable
**Depends on**: Phase 16.3
**Plans**: 4 plans (3 complete; 04 SUPERSEDED by Phase 16.5)

Plans:
- [x] 16.4-01-PLAN.md — Routing invariant audit + fix: BOOK_SIZE_BYTES constant, reset 40 Episodes
- [x] 16.4-02-PLAN.md — Structural metadata quality audit: 40 Episodes batch-extracted + re-uploaded
- [x] 16.4-03-PLAN.md — Comprehensive retrievability audit: S1 96.7%, S2 97.5%, 12 structural failures documented
- [~] 16.4-04-PLAN.md — SUPERSEDED by Phase 16.5 (root cause investigation proved S4 is viable)

---

### Phase 16.5: Strategy 4 Rarest-Aspect Exhaustive Audit (INSERTED)

**Goal**: S4 query strategy validated, 0/1,749 misses confirmed, A7 updated to zero-tolerance
**Depends on**: Phase 16.4
**Plans**: 4 plans (completed via artifacts; gate PASSED 2026-02-26)

Plans:
- [x] 16.5-01-PLAN.md — Implement S4 in retrievability_audit.py; 12/12 known failures PASS via validate_s4.py
- [x] 16.5-02-PLAN.md — Exhaustive S1→S4a→S4b audit of all 1,749 files; 0/1,749 misses
- [x] 16.5-03-PLAN.md — Exhaustive metadata quality audit: objlib metadata audit exits 0
- [x] 16.5-04-PLAN.md — A7 update + two consecutive fresh-session STABLE runs confirmed

---

### Phase 16.6: CRAD — Corpus-Relative Aspect Differentiation (INSERTED)

**Goal**: 63 S1-failing files acquire deterministic discrimination phrases; A7 uses CRAD phrases deterministically
**Depends on**: Phase 16-02 temporal stability
**Plans**: 3 plans

Plans:
- [x] 16.6-01-PLAN.md — CRAD pilot: 3-pass script, DB schema, 3 pilot files all at rank ≤5; gate PASSED
- [x] 16.6-02-PLAN.md — Full CRAD run: 63 files grouped by series; updated headers; re-uploaded; store-sync 0 orphans; all 63 phrases at rank ≤5
- [x] 16.6-03-PLAN.md — A7 update + stability gate: 3 consecutive fresh-session STABLE runs; zero stochastic variance

---

### Phase 17: RxPY Reactive Observable Pipeline for TUI Event Streams

**Goal**: Replace TUI's manual debounce timer, generation-tracking, `@work(exclusive=True)`, and scattered filter-refire logic with composable RxPY observable pipeline
**Depends on**: Phase 16.4
**Plans**: 4 plans

Plans:
- [x] 17-01-PLAN.md — RxPY + asyncio + Textual spike: 5 affirmative-evidence tests; HOSTILE gate PASSED
- [x] 17-02-PLAN.md — Pre-implementation UAT baseline: 7 behavioral invariant tests, measured baselines
- [x] 17-03-PLAN.md — RxPY pipeline implementation: rx_pipeline.py + SearchBar Subject refactor + combine_latest/switch_map
- [x] 17-04-PLAN.md — Post-implementation UAT validation: 7/7 UATs match; 470/470 full suite green

---

### Phase 18: RxPY Codebase-Wide Async Migration

**Goal**: Migrate all remaining async code outside `src/objlib/tui/` to uniform RxPY reactive paradigm
**Depends on**: Phase 17 complete
**Plans**: 5 plans

Plans:
- [x] 18-01-PLAN.md — Spike: 5 high-risk operator patterns validated (HOSTILE gate); design doc committed
- [x] 18-02-PLAN.md — Tier 3 migration: services/search.py, services/library.py, search/client.py; _operators.py created
- [x] 18-03-PLAN.md — Tier 2 migration: extraction/batch_client.py, extraction/orchestrator.py
- [x] 18-04-PLAN.md — Tier 1 migration: upload/orchestrator.py, client.py, recovery.py; 5 custom operators
- [x] 18-05-PLAN.md — Post-migration validation: 476 tests, 0 asyncio primitives, STABLE 60/60, Canon.json updated

---

## Milestone Summary

**Decimal Phases (all inserted to address discovered problems):**
- Phase 16.1: Stability instrument false-negative modes (A6 NULL lookup, A7 query strategy)
- Phase 16.2: Metadata completeness — _get_pending_files() silently excluded .md files
- Phase 16.3: Retrievability failure — identity fields absent from indexed content (H3 confirmed)
- Phase 16.4: Metadata pipeline invariant — no structural rule enforcing non-book extraction path
- Phase 16.5: S4 rarest-aspect query strategy validated exhaustively (replaces 16.4-04)
- Phase 16.6: CRAD discrimination phrases for 63 S1-deaf files

**Key Decisions:**
- python-statemachine 2.6.0 selected as FSM library (affirmative concurrent evidence, Phase 9)
- Intent columns on files table (not separate table) for OCC recovery
- gemini_store_doc_id stores document name suffix only (12-char prefix = file resource ID)
- BOOK_SIZE_BYTES = 830,000 — all files below this threshold must complete batch-extract
- Identity header prepended before [AI Analysis] header in all indexed content
- S4 query strategy (rarest aspects, no preamble) + CRAD phrases for S1-deaf files
- AsyncIOScheduler with Future-based subscription pattern for RxPY in async contexts
- Two-signal shutdown_gate (stop_accepting + force_kill Subjects at different pipeline points)
- ops.map(factory).pipe(ops.merge(max_concurrent=N)) — RxPY 3.x bounded concurrency idiom

**Issues Resolved:**
- [Unresolved file #N] root cause: orphaned store documents (store-sync fixes; FSM prevents recurrence)
- Stability instrument false negatives: A6 SUBSTR exact-match; A7 S4a/S4b fallback chain
- Retrievability failures: identity headers injected into content at upload time
- CLI search commands blocked after async migration: asyncio.run() bridge added

**Issues Deferred to v3.0:**
- STALE-01/STALE-02: Automated STALE detection (not needed at current scale)
- CONC-01: Concurrency lockfile (personal use only)
- Phase 16-03 / 07-07: Formal TUI smoke test plan — validated in practice via Phase 18-05 TUI invariants (7/7 pass)
- _reset_existing_files() store document deletion: documented in MEMORY.md; implement before next bulk fsm-upload --reset-existing

**Technical Debt:**
- dynamic_semaphore in _operators.py has dead code (parallel implementation; active path works correctly)
- services/session.py retains 5 asyncio.to_thread calls (explicitly out of scope for Phase 18)
- tenacity remains in pyproject.toml dependencies (zero imports in src/ but not removed)

---

_For current project status, see .planning/ROADMAP.md_
