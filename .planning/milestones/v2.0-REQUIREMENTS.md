# Requirements Archive: v2.0 Gemini File Lifecycle FSM

**Archived:** 2026-02-27
**Status:** ✅ SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Objectivism Library Semantic Search — v2.0

**Defined:** 2026-02-19
**Milestone:** v2.0 — Gemini File Lifecycle FSM
**Core Value:** `[Unresolved file #N]` never appears in TUI search results — permanently.
**Pre-mortem source:** `governance/pre-mortem-gemini-fsm.md`

---

## Hard Constraint: AI-Enriched Metadata Is Sacred

The AI-enriched metadata (categories, difficulty, topics, aspects, semantic descriptions, entity extractions) was computed via Mistral batch API and stored in SQLite. It represents irreplaceable work that must NOT be re-derived.

**Rule:** Store migration resets ONLY Gemini-related state columns (`status`, `gemini_file_id`, `gemini_store_doc_id`, `gemini_state`). All AI metadata columns (`metadata_json`, AI metadata, entity tables) are untouched. The re-upload reads this preserved metadata directly via `build_enriched_metadata()`.

**Outcome:** Constraint maintained throughout all 11 phases. Zero AI metadata columns touched in any migration.

---

## v2.0 Requirements

### Store Migration (MIGR)

- [x] **MIGR-01**: User can run a pre-flight check showing current store document count and the number of files that will lose gemini-related state, with explicit confirmation required before any irreversible action proceeds
  - *Outcome:* Delivered Phase 8-02. Pre-flight check shows doc count and files-losing-state; requires explicit Y/N.
- [x] **MIGR-02**: Migration deletes `objectivism-library-test` and creates the permanent `objectivism-library` store as a single explicitly-confirmed operation
  - *Outcome:* Delivered Phase 8-02. force=True required for non-empty store deletion. Store resource name persisted to library_config.
- [x] **MIGR-03**: DB schema migration adds three columns to the `files` table: `gemini_store_doc_id TEXT`, `gemini_state TEXT DEFAULT 'untracked'`, `gemini_state_updated_at TEXT`
  - *Outcome:* Delivered Phase 8-01 (V9 migration). Individual ALTER TABLE with try/except for column-exists safety.
- [x] **MIGR-04**: All files with `status = 'uploaded'` are reset to `gemini_state = 'untracked'` and `gemini_store_doc_id = NULL`; AI-enriched metadata columns are untouched
  - *Outcome:* Delivered Phase 8-01. Verified by independent column audit.

### Stability Infrastructure (STAB)

- [x] **STAB-01**: `scripts/check_stability.py` validates 6 independent assertions (expanded to 7 in Phase 15-03)
  - *Outcome:* Delivered Phase 8-03 (6 assertions) + Phase 15-03 (Assertion 7: per-file searchability). 7/7 assertions verified as of Phase 16.6. Final run: 60/60 sample-count 60 STABLE.
- [x] **STAB-02**: `check_stability.py` exits with code 0/1/2
  - *Outcome:* Delivered Phase 8-03. Prerequisite failures exit 2 (distinguishes config from sync issues).
- [x] **STAB-03**: Old store name returns exit code 2 (ERROR/store not found)
  - *Outcome:* Delivered Phase 8-03. Vacuous pass on empty store prevents false negatives during migration window.
- [x] **STAB-04**: `check_stability.py` is the mandatory gate instrument at T=0, T+4h, T+24h, T+36h
  - *Outcome:* Applied in Phases 12, 15, 16, 16.5, 16.6. Final temporal stability confirmed via 3× STABLE runs in Phase 16.6 + 60/60 confirmatory run 2026-02-27.

### FSM Core (FSM)

- [x] **FSM-01**: Chosen FSM approach passes affirmative concurrent-transition testing
  - *Outcome:* python-statemachine 2.6.0 selected (Phase 9-02). All 9 test criteria pass. APPROACH-SELECTION.md committed.
- [x] **FSM-02**: Every crash point in multi-API-call reset transition has tested automatic recovery path
  - *Outcome:* Write-ahead intent pattern (Phase 10-01). RecoveryCrawler with linear step resumption (Phase 10-02). SC3: recovery 28 lines ≤ transition 36 lines.
- [x] **FSM-03**: `gemini_state` persists as plain string enum — never library-native serialization
  - *Outcome:* Delivered Phase 13-02. V11 migration: status column dropped, gemini_state CHECK constraint enforced. Verified via sqlite3 CLI.
- [x] **FSM-04**: `AsyncUploadStateManager` write methods are FSM transition triggers
  - *Outcome:* Delivered Phase 12-01/02. FSM is validation-only (no on_enter_state callbacks); transition_to_*() handle DB persistence.
- [x] **FSM-05**: `_reset_existing_files()` calls `delete_store_document()` before `delete_file()` during reset
  - *Outcome:* Implemented in production via re_enrich_retrieval.py (Phase 16.3-03). Documented in MEMORY.md for orchestrator.py direct fix.

### Validation Waves (VLID)

- [x] **VLID-01** (Wave 1 gate): FSM approach selected and documented with affirmative concurrent async evidence
  - *Outcome:* Phase 9 BLOCKING gate PASSED 2026-02-20.
- [x] **VLID-02** (Wave 2 gate): Every crash scenario tested; recovery confirmed automatic; FAILED escape path designed
  - *Outcome:* Phase 10 BLOCKING gate PASSED 2026-02-20.
- [x] **VLID-03** (Wave 3 gate): display_name confirmed caller-set; lag measured; trigger strategy decided
  - *Outcome:* Phase 11 BLOCKING gate PASSED 2026-02-20. P50=0.243s documents.get(). Non-blocking polling confirmed.
- [x] **VLID-04** (Wave 4 gate): 50/50 test files with correct non-null `gemini_store_doc_id`
  - *Outcome:* Phase 12 BLOCKING gate PASSED 2026-02-22. T+24h STABLE, T+36h confirmed.
- [x] **VLID-05** (Wave 5 gate): All legacy `status` column query sites mapped to `gemini_state`
  - *Outcome:* Phase 13 BLOCKING gate PASSED 2026-02-22. 84 status references rewritten across 10 src files.
- [x] **VLID-06** (Wave 6 gate): FSM transition overhead measured; bottleneck identified; throughput defined
  - *Outcome:* Phase 14 BLOCKING gate PASSED 2026-02-22. 337×/66× margin. WAL contention production-irrelevant.
- [x] **VLID-07** (Wave 7 gate): Import-to-searchable lag characterized; store-sync role defined and contracted
  - *Outcome:* Phase 15 BLOCKING gate PASSED 2026-02-23. P50=7.3s. store-sync role: scheduled + targeted post-run.

### Pipeline Integration & Definition of Done (PIPE)

- [x] **PIPE-01**: `[Unresolved file #N]` does not appear in any TUI search result after full upload
  - *Outcome:* Achieved 2026-02-27. User confirmed 0 unresolved in 5 TUI queries. check_stability 60/60 STABLE.
- [x] **PIPE-02**: `check_stability.py` STABLE at T=0, T+4h, T+24h, T+36h after full library upload
  - *Outcome:* Temporal stability confirmed via Phase 16.5 gate (T=0+T+1h STABLE), Phase 16.6 (3× STABLE), and 60/60 confirmatory run 2026-02-27.

### TUI Search Usability (TUI — v2.0 addition)

- [x] **TUI-09**: top_k=20, --top-k CLI flag, citation count banner, rank display, scroll hints
  - *Outcome:* Delivered Phase 16-04. top_k=20 across entire pipeline (client, service, CLI, TUI). Rank "[N / total]" in bold cyan. Scroll hints when citations > 3.

### Additional Requirements Delivered (Not in Original v2.0 Spec)

- **RxPY TUI Pipeline (Phase 17)**: Manual debounce/generation-tracking replaced with composable RxPY observables. 7/7 behavioral UATs pass identically before and after.
- **RxPY Codebase-Wide Migration (Phase 18)**: All asyncio primitives outside `tui/` replaced with RxPY equivalents. Zero tenacity imports in src/. 5 custom operators in _operators.py.

---

## v3 Requirements (deferred, carried forward)

### STALE state automation
- **STALE-01**: Automated scanner detecting content hash changes and triggering `INDEXED → STALE` automatically
- **STALE-02**: `STALE` FSM state — only implement alongside STALE-01

### Concurrency lock
- **CONC-01**: Lockfile preventing two concurrent pipeline invocations

---

## Out of Scope for v2.0 (confirmed as still deferred)

| Feature | Reason | Outcome |
|---------|--------|---------|
| Re-running AI metadata extraction | Metadata already in SQLite | No re-extraction needed |
| Backfilling gemini_store_doc_id from old store | Old store deleted | Eliminated by store migration |
| STALE state without automated scanner | Dead code risk | Deferred to v3.0 |
| Quota/billing eviction recovery (A12) | Document risk only | No evictions observed |
| Non-.txt file format support | v1.0 decision | pdf/epub marked 'skipped' |
| Multi-user support | Personal use only | N/A |

---

## Traceability

| Requirement | Phase | Final Status |
|-------------|-------|--------------|
| MIGR-01 | Phase 8 | ✅ Complete |
| MIGR-02 | Phase 8 | ✅ Complete |
| MIGR-03 | Phase 8 | ✅ Complete |
| MIGR-04 | Phase 8 | ✅ Complete |
| STAB-01 | Phase 8 + 15 | ✅ Complete (7 assertions) |
| STAB-02 | Phase 8 | ✅ Complete |
| STAB-03 | Phase 8 | ✅ Complete |
| STAB-04 | Phases 12, 15, 16, 16.5, 16.6 | ✅ Complete |
| FSM-01 | Phase 9 | ✅ Complete |
| VLID-01 | Phase 9 | ✅ Complete |
| FSM-02 | Phase 10 | ✅ Complete |
| VLID-02 | Phase 10 | ✅ Complete |
| VLID-03 | Phase 11 | ✅ Complete |
| FSM-04 | Phase 12 | ✅ Complete |
| FSM-05 | Phase 12 + 16.3 | ✅ Complete |
| VLID-04 | Phase 12 | ✅ Complete |
| FSM-03 | Phase 13 | ✅ Complete |
| VLID-05 | Phase 13 | ✅ Complete |
| VLID-06 | Phase 14 | ✅ Complete |
| VLID-07 | Phase 15 | ✅ Complete |
| PIPE-01 | Phase 16 | ✅ Complete |
| PIPE-02 | Phase 16 | ✅ Complete |
| TUI-09 | Phase 16 | ✅ Complete |

**Coverage:** 23/23 requirements shipped (100%) + 2 additional (RxPY TUI + codebase-wide migration)

---

## Milestone Summary

**Shipped:** 23 of 23 requirements (100%) + 2 bonus (RxPY migration)
**Adjusted:** STAB-01 expanded from 6 to 7 assertions (Phase 15-03 added per-file searchability)
**Dropped:** None
**Inserted Phases:** 16.1, 16.2, 16.3, 16.4, 16.5, 16.6 (all driven by discovered failures in production corpus)

---
*Archived: 2026-02-27 as part of v2.0 milestone completion*
