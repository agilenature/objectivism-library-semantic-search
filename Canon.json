{
  "$schema": "https://canon.so/schema/canon.json",
  "_canon_workflow": "gsd",
  "projectTitle": "objlib",
  "description": "Service library and CLI for semantic search over a curated Objectivism Library — 1,749 philosophical texts indexed via Google Gemini File Search with AI-enriched 4-tier metadata (category, difficulty, topics, aspects, descriptions) and entity extraction",
  "branch": "main",
  "folders": [
    "docs/user/",
    "docs/architecture/",
    "src/objlib/services/",
    "src/objlib/tui/",
    "src/objlib/tui/widgets/"
  ],
  "excludeFolders": [
    "docs/archive/",
    "logs",
    "src/objlib/__pycache__",
    "src/objlib/upload",
    "src/objlib/extraction",
    "src/objlib/entities",
    "src/objlib/sync",
    "src/objlib/search",
    "src/objlib/session",
    "src/objlib/search/__pycache__",
    "src/objlib/session/__pycache__",
    ".planning",
    "data",
    "tests",
    "scripts"
  ],
  "excludeFiles": [
    "cli.py"
  ],
  "rules": [
    "Import only from objlib.services — never from objlib.cli, objlib.upload, objlib.extraction, objlib.entities, or objlib.sync; those are internal pipeline modules, not part of the public API.",
    "Initialize services with db_path and api_key strings: SearchService(api_key, store_resource_name, db_path), LibraryService(db_path), SessionService(db_path) — all three form the complete client backend.",
    "SearchService.search() is async with 300ms–2s Gemini latency — always await it in an async context or background worker (asyncio.run_coroutine_threadsafe); never block the TUI main thread.",
    "Always call LibraryService.enrich_citations(citations, db) after SearchService.search() before rendering — unenriched Citations have file_path=None and metadata=None.",
    "Enriched Citation fields: index (rank), title (filename), text (excerpt), confidence (0–1), file_path, metadata (keys: course, year, difficulty, primary_topics, topic_aspects, description, entities).",
    "Use Database as a context manager ('with Database(db_path) as db:') — never hold a connection open across async await boundaries.",
    "The active Gemini store name is read from AppState.store_resource_name — never hardcode a store name in client code.",
    "For browse/filter without a search query, use LibraryService — it provides file listing, filtering, and document retrieval with no Gemini API call or disk mount.",
    "Filter syntax: 'field:value' for strings ('course:OPAR'), 'field:N' for numeric ('year:2023'), 'field:>=N' for comparison — pass lists to LibraryService filter methods; never write raw SQL.",
    "Session events are append-only — use SessionService.add_event(); there are no update or delete methods for session records.",
    "Disk commands (scan, upload, sync) require /Volumes/U32 Shadow mounted — query commands (search, browse, filter, view) work without it; design clients to degrade gracefully when the disk is absent.",
    "CLI: 'python -m objlib --store NAME search QUERY' (search); 'python -m objlib browse' (list all); 'python -m objlib tui' (interactive TUI) — --store precedes search but follows 'view --show-related'."
  ],
  "previousVersions": [],
  "branchVersions": []
}
